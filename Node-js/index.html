<!DOCTYPE html>
<html class="has-navbar-fixed-top">
<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
<title>My learning journey in Node.js - Ray&#39;s Coding Journey</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="description" content="前言This is the notes I take during my learning, and it’s still unorganised, so there will no be English version of this article">
<meta name="keywords" content="Node.js">
<meta property="og:type" content="article">
<meta property="og:title" content="My learning journey in Node.js">
<meta property="og:url" content="https://tn710617.github.io/Node-js/index.html">
<meta property="og:site_name" content="Ray&#39;s Coding Journey">
<meta property="og:description" content="前言This is the notes I take during my learning, and it’s still unorganised, so there will no be English version of this article">
<meta property="og:locale" content="en">
<meta property="og:image" content="https://i.imgur.com/Du0jyDX.png">
<meta property="og:image" content="https://i.imgur.com/tsNtBxJ.png">
<meta property="og:image" content="https://i.imgur.com/XWOUhI8.png">
<meta property="og:image" content="https://i.imgur.com/mZeysti.png">
<meta property="og:image" content="https://i.imgur.com/oiukxDe.png">
<meta property="og:image" content="https://i.imgur.com/zM3e160.png">
<meta property="og:image" content="https://i.imgur.com/6kiYnv9.png">
<meta property="og:image" content="https://i.imgur.com/JswUc2Z.png">
<meta property="og:image" content="https://i.imgur.com/LG8jTvQ.png">
<meta property="og:image" content="https://i.imgur.com/R93HoCB.png">
<meta property="og:image" content="https://i.imgur.com/Izad8Ix.png">
<meta property="og:image" content="https://i.imgur.com/StDKTwU.png">
<meta property="og:updated_time" content="2019-05-25T05:44:16.043Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="My learning journey in Node.js">
<meta name="twitter:description" content="前言This is the notes I take during my learning, and it’s still unorganised, so there will no be English version of this article">
<meta name="twitter:image" content="https://i.imgur.com/Du0jyDX.png">


<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.css">


    <link href="/zh-tw/Node-js/" rel="alternate" hreflang="zh-TW">








    <meta name="description" content="前言This is the notes I take during my learning, and it’s still unorganised, so there will no be English version of this article">
<meta name="keywords" content="Node.js">
<meta property="og:type" content="article">
<meta property="og:title" content="My learning journey in Node.js">
<meta property="og:url" content="https://tn710617.github.io/Node-js/index.html">
<meta property="og:site_name" content="Ray&#39;s Coding Journey">
<meta property="og:description" content="前言This is the notes I take during my learning, and it’s still unorganised, so there will no be English version of this article">
<meta property="og:locale" content="en">
<meta property="og:image" content="https://i.imgur.com/Du0jyDX.png">
<meta property="og:image" content="https://i.imgur.com/tsNtBxJ.png">
<meta property="og:image" content="https://i.imgur.com/XWOUhI8.png">
<meta property="og:image" content="https://i.imgur.com/mZeysti.png">
<meta property="og:image" content="https://i.imgur.com/oiukxDe.png">
<meta property="og:image" content="https://i.imgur.com/zM3e160.png">
<meta property="og:image" content="https://i.imgur.com/6kiYnv9.png">
<meta property="og:image" content="https://i.imgur.com/JswUc2Z.png">
<meta property="og:image" content="https://i.imgur.com/LG8jTvQ.png">
<meta property="og:image" content="https://i.imgur.com/R93HoCB.png">
<meta property="og:image" content="https://i.imgur.com/Izad8Ix.png">
<meta property="og:image" content="https://i.imgur.com/StDKTwU.png">
<meta property="og:updated_time" content="2019-05-25T05:44:16.043Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="My learning journey in Node.js">
<meta name="twitter:description" content="前言This is the notes I take during my learning, and it’s still unorganised, so there will no be English version of this article">
<meta name="twitter:image" content="https://i.imgur.com/Du0jyDX.png">





    <link rel="icon" href="/images/favicon.png">


<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bulma/0.6.2/css/bulma.min.css">


    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/justifiedGallery/3.6.5/css/justifiedGallery.min.css">


<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/sunburst.min.css">

<link rel="stylesheet" href="/css/style.css">

<script defer src="//use.fontawesome.com/releases/v5.0.8/js/all.js"></script>


    
        
    
        
    
        
    
        
    
        
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-135063928-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-135063928-1');
</script>


    


</head>
<body>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="/">
                
                    
                    Ray&#39;s Coding Journey
                    
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item " href="/archives">Archives</a>
            
            <a class="navbar-item " href="/categories">Categories</a>
            
            <a class="navbar-item " href="/tags">Tags</a>
            
            <a class="navbar-item " href="/schedule">Schedule</a>
            
            <a class="navbar-item " href="/about">About</a>
            
            <a class="navbar-item " href="/friends">Friends</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            <a class="navbar-item search" title="Search" href="javascript:;">
                <i class="fas fa-search"></i>
            </a>
            
            
            <div class="navbar-item is-hoverable has-dropdown is-hidden-mobile is-hidden-tablet-only toc">
                <a class="navbar-item" title="Table of Contents">
                    <i class="fa fa-list"></i>
                </a>
                <div class="navbar-dropdown is-right">
                    
                    
                    
                    
                    <a class="navbar-item" href="#前言">1&nbsp;&nbsp;<b>前言</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#正文">2&nbsp;&nbsp;<b>正文</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#使用-fs-module">2.1&nbsp;&nbsp;使用 fs module</a>
                    
                    
                    
                    <a class="navbar-item" href="#停止這個-loop">2.2&nbsp;&nbsp;停止這個 loop</a>
                    
                    
                    
                    <a class="navbar-item" href="#從-request-中取得我們想要的資訊">2.3&nbsp;&nbsp;從 request 中取得我們想要的資訊</a>
                    
                    
                    
                    <a class="navbar-item" href="#設定-response">2.4&nbsp;&nbsp;設定 response</a>
                    
                    
                    
                    <a class="navbar-item" href="#簡易的-request-routing">2.5&nbsp;&nbsp;簡易的 request routing</a>
                    
                    
                    
                    <a class="navbar-item" href="#簡單的-redirect-request">2.6&nbsp;&nbsp;簡單的 redirect request</a>
                    
                    
                    
                    <a class="navbar-item" href="#Parsing-request-bodies">2.7&nbsp;&nbsp;Parsing request bodies</a>
                    
                    
                    
                    <a class="navbar-item" href="#了解事件驅動代碼的執行">2.8&nbsp;&nbsp;了解事件驅動代碼的執行</a>
                    
                    
                    
                    <a class="navbar-item" href="#Blocking-and-Non-Blocking-Code">2.9&nbsp;&nbsp;Blocking and Non-Blocking Code</a>
                    
                    
                    
                    <a class="navbar-item" href="#簡述事件迴圈">2.10&nbsp;&nbsp;簡述事件迴圈</a>
                    
                    
                    
                    <a class="navbar-item" href="#深談事件迴圈">2.11&nbsp;&nbsp;深談事件迴圈</a>
                    
                    
                    
                    <a class="navbar-item" href="#各階段概述">2.11.1&nbsp;&nbsp;各階段概述</a>
                    
                    
                    
                    <a class="navbar-item" href="#libuv-各階段詳述">2.11.2&nbsp;&nbsp;libuv 各階段詳述</a>
                    
                    
                    
                    <a class="navbar-item" href="#setImmediate-vs-setTimeout">2.11.3&nbsp;&nbsp;setImmediate() vs setTimeout()</a>
                    
                    
                    
                    <a class="navbar-item" href="#process-nextTick">2.11.4&nbsp;&nbsp;process.nextTick()</a>
                    
                    
                    
                    <a class="navbar-item" href="#一個-tick-到底是多長？">2.11.5&nbsp;&nbsp;一個 tick 到底是多長？</a>
                    
                    
                    
                    <a class="navbar-item" href="#process-nextTick-vs-setImmediate">2.11.6&nbsp;&nbsp;process.nextTick() vs setImmediate()</a>
                    
                    
                    
                    <a class="navbar-item" href="#Promise">2.11.7&nbsp;&nbsp;Promise</a>
                    
                    
                    
                    <a class="navbar-item" href="#事件迴圈總結">2.11.8&nbsp;&nbsp;事件迴圈總結</a>
                    
                    
                    
                    <a class="navbar-item" href="#Express-js">2.12&nbsp;&nbsp;Express.js</a>
                    
                    
                    
                    <a class="navbar-item" href="#建立一個-app-server">2.12.1&nbsp;&nbsp;建立一個 app server</a>
                    
                    
                    
                    <a class="navbar-item" href="#指定-status-code">2.12.2&nbsp;&nbsp;指定 status code</a>
                    
                    
                    
                    <a class="navbar-item" href="#Promise-1">2.12.3&nbsp;&nbsp;Promise</a>
                    
                    
                    
                    <a class="navbar-item" href="#建立-Datastore-Model">2.12.4&nbsp;&nbsp;建立 Datastore Model</a>
                    
                    
                    
                    <a class="navbar-item" href="#建立一個-Controller">2.12.5&nbsp;&nbsp;建立一個 Controller</a>
                    
                    
                    
                    <a class="navbar-item" href="#Route">2.12.6&nbsp;&nbsp;Route</a>
                    
                    
                    
                    <a class="navbar-item" href="#Root-address">2.12.7&nbsp;&nbsp;Root address</a>
                    
                    
                    
                    <a class="navbar-item" href="#Path">2.12.8&nbsp;&nbsp;Path</a>
                    
                    
                    
                    <a class="navbar-item" href="#object-assign">2.12.9&nbsp;&nbsp;object.assign</a>
                    
                    
                    
                    <a class="navbar-item" href="#test">2.12.10&nbsp;&nbsp;test</a>
                    
                    
                    
                    <a class="navbar-item" href="#時間">2.12.11&nbsp;&nbsp;時間</a>
                    
                    
                    
                    <a class="navbar-item" href="#同時異步多請求">2.12.12&nbsp;&nbsp;同時異步多請求</a>
                    
                </div>
            </div>
            

            
<div class="column is-narrow has-text-centered">
    <div class="dropdown is-up is-right is-hoverable" style="margin-top: -0.2em;">
        <div class="dropdown-trigger">
            <button class="button is-small" aria-haspopup="true" aria-controls="dropdown-menu7">
                <span class="icon">
                    <i class="fas fa-globe"></i>
                </span>
                <span>English</span>
                <span class="icon is-small">
            <i class="fas fa-angle-down" aria-hidden="true"></i>
          </span>
            </button>
        </div>
        <div class="dropdown-menu has-text-left" role="menu" style="top:100%">
            <div class="dropdown-content">
            
                <a href="/Node-js/" class="dropdown-item">
                    English
                </a>
            
                <a href="/zh-tw/Node-js/" class="dropdown-item">
                    繁體中文
                </a>
            
            </div>
        </div>
    </div>
</div>

        </div>
    </div>
</nav>

    <section class="section">
    <div class="container">
    <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            My learning journey in Node.js
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            <time datetime="2019-04-23T02:16:58.000Z" itemprop="datePublished">Apr 23 2019</time>
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="/categories/Node-js/">Node.js</a>
        </span>
        
        
        <span class="column is-narrow">
            
            
            an hour read (About 6847 words)
        </span>
        
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>This is the notes I take during my learning, and it’s still unorganised, so there will no be English version of this article</p>
<a id="more"></a>
<h2 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h2><h3 id="使用-fs-module"><a href="#使用-fs-module" class="headerlink" title="使用 fs module"></a>使用 fs module</h3><ul>
<li>fs.writeFileSync<br><code>const fs = require(&#39;fs);</code><br>在 Node.js 裏頭，如果要引用一個 module ，要用一個變數引用，然後之後就可以使用它<br>例如<figure class="highlight javascript hljs"><table><tr><td class="code"><pre><span class="line">fs.writeFileSync(<span class="hljs-string">'hello.txt'</span>, <span class="hljs-string">'Hello fromNode.js'</span>);</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>上面的 function ，是將 <code>Hello fromNode.js</code> 寫進 <code>hello.txt</code> 這個檔案<br><figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">### 建立一個最簡單的 server</span><br><span class="line">首先，我們先引用 `http` module，當我們要調用本地 module 時，我們可以指定路徑，像是 `./http` ，但我們要調用 global 的 module 時，我們不加任何路徑， 如下</span><br><span class="line">```javascript</span><br><span class="line">const http = require(&apos;http&apos;);</span><br></pre></td></tr></table></figure></p>
<p>接下來，我們利用剛剛引用的 <code>http</code> module 來建立一個 server ，如下：<br><figure class="highlight javascript hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">const</span> server = http.createServer(<span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="hljs-built_in">console</span>.log(req);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>or<br><figure class="highlight javascript hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">const</span> server = http.createServer(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>)</span>&#123;</span><br><span class="line">    <span class="hljs-built_in">console</span>.log(req);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>or </p>
<figure class="highlight javascript hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">rqListener</span>(<span class="hljs-params">req, res</span>) </span>&#123;</span><br><span class="line">    <span class="hljs-built_in">console</span>.log(req);</span><br><span class="line">&#125;</span><br><span class="line"><span class="hljs-keyword">const</span> server = http.createServer(rqListener);</span><br></pre></td></tr></table></figure>
<p>最後，我們雖然已經建立了 server ，但是我們還沒有指定它的位址。 我們指定 3000 port 給這個 server ，如下：<br><figure class="highlight javascript hljs"><table><tr><td class="code"><pre><span class="line">server.listen(<span class="hljs-number">3000</span>);</span><br></pre></td></tr></table></figure></p>
<p>此時，我們可以從瀏覽器，輸入 <code>localhost:3000</code> 來拜訪這個 server</p>
<h3 id="停止這個-loop"><a href="#停止這個-loop" class="headerlink" title="停止這個 loop"></a>停止這個 loop</h3><figure class="highlight javascript hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">const</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">'http'</span>);</span><br><span class="line"><span class="hljs-keyword">const</span> server = http.createServer(<span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="hljs-built_in">console</span>.log(req);</span><br><span class="line">    process.exit();</span><br><span class="line">&#125;);</span><br><span class="line">server.listen(<span class="hljs-number">3000</span>);</span><br></pre></td></tr></table></figure>
<h3 id="從-request-中取得我們想要的資訊"><a href="#從-request-中取得我們想要的資訊" class="headerlink" title="從 request 中取得我們想要的資訊"></a>從 request 中取得我們想要的資訊</h3><p>舉例來說，我們要取得 <code>url</code> , <code>method</code> , 以及 <code>header</code> 三項資訊，如下：<br><figure class="highlight javascript hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">const</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">'http'</span>);</span><br><span class="line"><span class="hljs-keyword">const</span> server = http.createServer(<span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="hljs-built_in">console</span>.log(req.url, req.method, req.header);</span><br><span class="line">    <span class="hljs-comment">// process.exit();</span></span><br><span class="line">&#125;);</span><br><span class="line">server.listen(<span class="hljs-number">3000</span>);</span><br></pre></td></tr></table></figure></p>
<p>下圖，我們可以看到我們特別指定的三項資訊:</p>
<p><img src="https://i.imgur.com/Du0jyDX.png" alt></p>
<h3 id="設定-response"><a href="#設定-response" class="headerlink" title="設定 response"></a>設定 response</h3><p>我們可以在 server 中，指定 response ，如下：<br><figure class="highlight javascript hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">const</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">'http'</span>);</span><br><span class="line"><span class="hljs-keyword">const</span> server = http.createServer(<span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="hljs-built_in">console</span>.log(req.url, req.method, req.header);</span><br><span class="line">    <span class="hljs-comment">// process.exit();</span></span><br><span class="line">    res.setHeader(<span class="hljs-string">'Content-Type'</span>, <span class="hljs-string">'text/html'</span>);</span><br><span class="line">    res.write(<span class="hljs-string">'&lt;html&gt;'</span>);</span><br><span class="line">    res.write(<span class="hljs-string">'&lt;head&gt;&lt;title&gt;My First Page&lt;/title&gt;&lt;/head&gt;'</span>);</span><br><span class="line">    res.write(<span class="hljs-string">'&lt;body&gt;&lt;ht&gt;Hello from my NOde.js Server&lt;/ht&gt;&lt;/body&gt;'</span>);</span><br><span class="line">    res.write(<span class="hljs-string">'&lt;/html&gt;'</span>);</span><br><span class="line">    res.end();</span><br><span class="line">&#125;);</span><br><span class="line">server.listen(<span class="hljs-number">3000</span>);</span><br></pre></td></tr></table></figure></p>
<p><img src="https://i.imgur.com/tsNtBxJ.png" alt></p>
<p>然後打開開發者工具，我們可以看到我們剛剛設定的 header<br><img src="https://i.imgur.com/XWOUhI8.png" alt></p>
<p>然後 response 的地方可以看到我們剛剛設定的 response<br><img src="https://i.imgur.com/mZeysti.png" alt></p>
<h3 id="簡易的-request-routing"><a href="#簡易的-request-routing" class="headerlink" title="簡易的 request routing"></a>簡易的 request routing</h3><p>我們可以指定觸發特定 response 的 url ，當 client 呼叫這個 url 時，就會觸發我們指定的 response ，反之，則觸發另外的 response</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">const http = require(<span class="hljs-string">'http'</span>);</span><br><span class="line">const server = http.createServer((req, res) =&gt; &#123;</span><br><span class="line">    const url = req.url;</span><br><span class="line">    <span class="hljs-keyword">if</span> (url === <span class="hljs-string">'/'</span>) &#123;</span><br><span class="line">        res.write(<span class="hljs-string">'&lt;html&gt;'</span>);</span><br><span class="line">        res.write(<span class="hljs-string">'&lt;head&gt;&lt;title&gt;Enter Message&lt;/title&gt;&lt;/head&gt;'</span>);</span><br><span class="line">        res.write(<span class="hljs-string">'&lt;body&gt;&lt;form action="/message" method="post"&gt;&lt;input type="text" name="message"&gt;&lt;button type="submit"&gt;Send&lt;/button&gt;&lt;/form&gt;&lt;/body&gt;'</span>);</span><br><span class="line">        res.write(<span class="hljs-string">'&lt;/html&gt;'</span>);</span><br><span class="line">        <span class="hljs-built_in">return</span> res.end();</span><br><span class="line">    &#125;</span><br><span class="line">    res.setHeader(<span class="hljs-string">'Content-Type'</span>, <span class="hljs-string">'text/html'</span>);</span><br><span class="line">    res.write(<span class="hljs-string">'&lt;html&gt;'</span>);</span><br><span class="line">    res.write(<span class="hljs-string">'&lt;head&gt;&lt;title&gt;My First Page&lt;/title&gt;&lt;/head&gt;'</span>);</span><br><span class="line">    res.write(<span class="hljs-string">'&lt;body&gt;&lt;ht&gt;Hello from my NOde.js Server&lt;/ht&gt;&lt;/body&gt;'</span>);</span><br><span class="line">    res.write(<span class="hljs-string">'&lt;/html&gt;'</span>);</span><br><span class="line">    res.end();</span><br><span class="line">&#125;);</span><br><span class="line">server.listen(3000);</span><br></pre></td></tr></table></figure>
<p>由上面的 code 可以看到，我們指定 <code>req.url</code> 必須要絕對等於 <code>/</code> 才會觸發條件內，我們指定的 response 如下：<br><img src="https://i.imgur.com/oiukxDe.png" alt></p>
<p>當我們按下 send ，會執行 <code>post</code> method, action <code>/message</code> ，如下：<br><img src="https://i.imgur.com/zM3e160.png" alt></p>
<p>因為 action 的關係，會嘗試拜訪 <code>message</code> url ，而因為這個 url 並不符合我們設定的條件，所以會執行預設 response</p>
<h3 id="簡單的-redirect-request"><a href="#簡單的-redirect-request" class="headerlink" title="簡單的 redirect request"></a>簡單的 redirect request</h3><p>現在，我們要簡易的 redirect 我們的 request ，如下：<br><figure class="highlight javascript hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">const</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">'http'</span>);</span><br><span class="line"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">const</span> server = http.createServer(<span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="hljs-keyword">const</span> url = req.url;</span><br><span class="line">    <span class="hljs-keyword">const</span> method = req.method;</span><br><span class="line">    <span class="hljs-keyword">if</span> (url === <span class="hljs-string">'/'</span>) &#123;</span><br><span class="line">        res.write(<span class="hljs-string">'&lt;html&gt;'</span>);</span><br><span class="line">        res.write(<span class="hljs-string">'&lt;head&gt;&lt;title&gt;Enter Message&lt;/title&gt;&lt;/head&gt;'</span>);</span><br><span class="line">        res.write(<span class="hljs-string">'&lt;body&gt;&lt;form action="/message" method="post"&gt;&lt;input type="text" name="message"&gt;&lt;button type="submit"&gt;Send&lt;/button&gt;&lt;/form&gt;&lt;/body&gt;'</span>);</span><br><span class="line">        res.write(<span class="hljs-string">'&lt;/html&gt;'</span>);</span><br><span class="line">        <span class="hljs-keyword">return</span> res.end();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-keyword">if</span> (url === <span class="hljs-string">'/message'</span> &amp;&amp; method === <span class="hljs-string">'POST'</span>) &#123;</span><br><span class="line">        fs.writeFileSync(<span class="hljs-string">'message.txt'</span>, <span class="hljs-string">'DUMMY'</span>);</span><br><span class="line">        res.statusCode = <span class="hljs-number">302</span>;</span><br><span class="line">        res.setHeader(<span class="hljs-string">'Location'</span>, <span class="hljs-string">'/'</span>);</span><br><span class="line">        <span class="hljs-keyword">return</span> res.end();</span><br><span class="line">    &#125;</span><br><span class="line">    res.setHeader(<span class="hljs-string">'Content-Type'</span>, <span class="hljs-string">'text/html'</span>);</span><br><span class="line">    res.write(<span class="hljs-string">'&lt;html&gt;'</span>);</span><br><span class="line">    res.write(<span class="hljs-string">'&lt;head&gt;&lt;title&gt;My First Page&lt;/title&gt;&lt;/head&gt;'</span>);</span><br><span class="line">    res.write(<span class="hljs-string">'&lt;body&gt;&lt;ht&gt;Hello from my NOde.js Server&lt;/ht&gt;&lt;/body&gt;'</span>);</span><br><span class="line">    res.write(<span class="hljs-string">'&lt;/html&gt;'</span>);</span><br><span class="line">    res.end();</span><br><span class="line">&#125;);</span><br><span class="line">server.listen(<span class="hljs-number">3000</span>);</span><br></pre></td></tr></table></figure></p>
<p>從上面的 code 可以看到，我們新增了第二個 if statement。<br>如果 url 等於 <code>//message</code> 以及 method 等於 <code>post</code> ，雙重條件都符合之下，就會觸發我們設定的條件<br>我們使用了之前我們曾經使用的 <code>fs</code> module ，如果條件觸發，我們就會將 <code>DUMMY</code> 寫入一個叫做 <code>message.txt</code> 的檔案<br>接著回傳 status code 302<br>最後回導到 <code>/</code><br>在 <code>res.end()</code> 之後，我們不可以在 define 新的 res ，否則就會出現錯誤，因為這邊我們要使用 return ，後續的代碼就不會再執行</p>
<h3 id="Parsing-request-bodies"><a href="#Parsing-request-bodies" class="headerlink" title="Parsing request bodies"></a>Parsing request bodies</h3><p>本章節，我們將解析 request 裡頭的 body 資料<br>並且初次接觸到了 stream 以及 buffer 的概念。<br>首先，我們先設定一個事件。 當接收到 <code>data</code> 時，觸發一個 function 並且帶入 chunk ， chunk 是資料的最小單位。<br>接著我們使用了 <code>console.log</code> 來把 chunk 印出來！<br>同時，我們建立一個 body 常數 array ，並且將每一次觸發 data 事件時，我們都將 chunk 丟到這個 array 裏頭， 代碼如下：<br><figure class="highlight javascript hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">const</span> body = [];</span><br><span class="line">req.on(<span class="hljs-string">'data'</span>, (chunk) =&gt; &#123;</span><br><span class="line">    <span class="hljs-built_in">console</span>.log(chunk);</span><br><span class="line">    body.push(chunk);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>接著，我們在建立一個事件，當 request 接收完成，我們在定義一個常數，叫做 parsedBody ， 至於這個常數的內容，我們使用 buffer 物件，來將 body array 裡頭的 chunk 都串起來，然後轉換成 string 。<br>最後，我們使用 <code>console.log</code> 把常數 parsedBody 印出來，代碼如下：<br><figure class="highlight javascript hljs"><table><tr><td class="code"><pre><span class="line">req.on(<span class="hljs-string">'end'</span>, () =&gt; &#123;</span><br><span class="line">   <span class="hljs-keyword">const</span> parsedBody = Buffer.concat(body).toString();</span><br><span class="line">   <span class="hljs-built_in">console</span>.log(parsedBody);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>結果如下：<br><img src="https://i.imgur.com/6kiYnv9.png" alt></p>
<p>接下來，我們在定義一個常數 message ，它的內容是用 ‘=’ 來將常數 parsedBody 分隔，變成一個 array ，然後我們取 [1] ，就是 array 中的第二項資料。<br>然後，我們將這個常數 message 一方面利用 <code>console.log</code> 印出來，一方面利用 <code>fs</code> module 來寫到一個叫做 <code>message.txt</code> 的檔案中。<br>代碼如下：<br><figure class="highlight javascript hljs"><table><tr><td class="code"><pre><span class="line">req.on(<span class="hljs-string">'end'</span>, () =&gt; &#123;</span><br><span class="line">    <span class="hljs-keyword">const</span> parsedBody = Buffer.concat(body).toString();</span><br><span class="line">    <span class="hljs-keyword">const</span> message = parsedBody.split(<span class="hljs-string">'='</span>)[<span class="hljs-number">1</span>];</span><br><span class="line">    <span class="hljs-built_in">console</span>.log(message);</span><br><span class="line">    fs.writeFileSync(<span class="hljs-string">'message.txt'</span>, message);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>至此, 此 episode 告一段落，最後全部的 code 如下：<br><figure class="highlight javascript hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">const</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">'http'</span>);</span><br><span class="line"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">const</span> server = http.createServer(<span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="hljs-keyword">const</span> url = req.url;</span><br><span class="line">    <span class="hljs-keyword">const</span> method = req.method;</span><br><span class="line">    <span class="hljs-keyword">if</span> (url === <span class="hljs-string">'/'</span>) &#123;</span><br><span class="line">        res.write(<span class="hljs-string">'&lt;html&gt;'</span>);</span><br><span class="line">        res.write(<span class="hljs-string">'&lt;head&gt;&lt;title&gt;Enter Message&lt;/title&gt;&lt;/head&gt;'</span>);</span><br><span class="line">        res.write(<span class="hljs-string">'&lt;body&gt;&lt;form action="/message" method="post"&gt;&lt;input type="text" name="message"&gt;&lt;button type="submit"&gt;Send&lt;/button&gt;&lt;/form&gt;&lt;/body&gt;'</span>);</span><br><span class="line">        res.write(<span class="hljs-string">'&lt;/html&gt;'</span>);</span><br><span class="line">        <span class="hljs-keyword">return</span> res.end();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-keyword">if</span> (url === <span class="hljs-string">'/message'</span> &amp;&amp; method === <span class="hljs-string">'POST'</span>) &#123;</span><br><span class="line">        <span class="hljs-keyword">const</span> body = [];</span><br><span class="line">        req.on(<span class="hljs-string">'data'</span>, (chunk) =&gt; &#123;</span><br><span class="line">            <span class="hljs-built_in">console</span>.log(chunk);</span><br><span class="line">            body.push(chunk);</span><br><span class="line">        &#125;);</span><br><span class="line">        req.on(<span class="hljs-string">'end'</span>, () =&gt; &#123;</span><br><span class="line">            <span class="hljs-keyword">const</span> parsedBody = Buffer.concat(body).toString();</span><br><span class="line">            <span class="hljs-keyword">const</span> message = parsedBody.split(<span class="hljs-string">'='</span>)[<span class="hljs-number">1</span>];</span><br><span class="line">            <span class="hljs-built_in">console</span>.log(message);</span><br><span class="line">            fs.writeFileSync(<span class="hljs-string">'message.txt'</span>, message);</span><br><span class="line">        &#125;);</span><br><span class="line">        res.statusCode = <span class="hljs-number">302</span>;</span><br><span class="line">        res.setHeader(<span class="hljs-string">'Location'</span>, <span class="hljs-string">'/'</span>);</span><br><span class="line">        <span class="hljs-keyword">return</span> res.end();</span><br><span class="line">    &#125;</span><br><span class="line">    res.setHeader(<span class="hljs-string">'Content-Type'</span>, <span class="hljs-string">'text/html'</span>);</span><br><span class="line">    res.write(<span class="hljs-string">'&lt;html&gt;'</span>);</span><br><span class="line">    res.write(<span class="hljs-string">'&lt;head&gt;&lt;title&gt;My First Page&lt;/title&gt;&lt;/head&gt;'</span>);</span><br><span class="line">    res.write(<span class="hljs-string">'&lt;body&gt;&lt;ht&gt;Hello from my NOde.js Server&lt;/ht&gt;&lt;/body&gt;'</span>);</span><br><span class="line">    res.write(<span class="hljs-string">'&lt;/html&gt;'</span>);</span><br><span class="line">    res.end();</span><br><span class="line">&#125;);</span><br><span class="line">server.listen(<span class="hljs-number">3000</span>);</span><br></pre></td></tr></table></figure></p>
<h3 id="了解事件驅動代碼的執行"><a href="#了解事件驅動代碼的執行" class="headerlink" title="了解事件驅動代碼的執行"></a>了解事件驅動代碼的執行</h3><p>本章節介紹了事件驅動代碼的執行規則以及順序<br>舉例來說，如果我們對目前的代碼做了一些調整，如下:<br><figure class="highlight javascript hljs"><table><tr><td class="code"><pre><span class="line">req.on(<span class="hljs-string">'end'</span>, () =&gt; &#123;</span><br><span class="line">    <span class="hljs-keyword">const</span> parsedBody = Buffer.concat(body).toString();</span><br><span class="line">    <span class="hljs-keyword">const</span> message = parsedBody.split(<span class="hljs-string">'='</span>)[<span class="hljs-number">1</span>];</span><br><span class="line">    fs.writeFileSync(<span class="hljs-string">'message.txt'</span>, message);</span><br><span class="line">    res.statusCode = <span class="hljs-number">302</span>;</span><br><span class="line">    res.setHeader(<span class="hljs-string">'Location'</span>, <span class="hljs-string">'/'</span>);</span><br><span class="line">    <span class="hljs-keyword">return</span> res.end();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>首先，在一開始我們就引用了 <code>http</code> module 以及 <code>fs</code> module ，然後我們利用 <code>http</code> module 來建立一個 server ，並且讓這個 server 聽 3000 port 。<br>當有任何 requets 呼叫這個 server 時，都會觸發這個 server 。我們帶入 request 以及 response ， 在 server 內可以用。<br>首先，我們定義發請求的 url 為常數 <code>url</code> ， 再來，我們定義發請求的方法為常數 <code>method</code><br>如果常數 <code>url</code> 等於 <code>/</code> 時，會觸發一系列的 response ，並且 return <code>res.end();</code> 做結束。<br>如果常數 <code>url</code> 等於 <code>/message</code> 且常數 <code>method</code> 等於 <code>POST</code> 的話，定義常數 <code>body</code> 為 array。<br>接下來進入事件驅動, 當開始解析 request 時，我們帶入 chunk ，印出 chunk ，並且將 chunk 放入一個叫做 body 的 array 常數<br>另外一個事件，當 request 解析完成後， 定義一個常數叫做 parsedBody ，它是利用 <code>buffer</code> 物件來將在常數 <code>body</code> 內的所有 chunk 串連起來，然後變成 string<br>在定義一個常數叫做 message ， 首先， 常數 parsedBody 是一個 string ，我們將這個 string 用 <code>=</code> 為分隔點，將這個 string 變成 array 之後，取 [1] ，就是這個 array 的第二項資料，這個就是常數 message 的值<br>接下來，我們利用一開始引用的 <code>fs</code> module ， 將常數 message 的內容寫入一個叫做 <code>message.txt</code> 的檔案。<br>接下來，定義 response 的 status code 為 302<br>定義 response 跳轉的 location 為 <code>/</code><br>最後， return <code>res.end();</code></p>
<p>出了事件驅動之後，是定義 header ，然後定義另外一些 html 的 response ， 最後是 <code>res.end();</code></p>
<p>Server 內的執行部分到此做一個結尾。</p>
<p>由於 js 的事件驅動屬性，事件 <code>end</code> 並不會先被執行，反之，後面的代碼會先被執行。<br>所以這個更動會造成一個錯誤，那就是當 <code>res.end();</code> 已經被執行了，才開始執行 <code>end</code> 事件內的 <code>setHeader</code> 以及 <code>statusCode</code> ，這樣就會造成如下的錯誤<br><img src="https://i.imgur.com/JswUc2Z.png" alt></p>
<p>如果，我們在 <code>end</code> 事件之下加了 return ，那錯誤就不會出現 ， 修改代碼如下：<br><figure class="highlight javascript hljs"><table><tr><td class="code"><pre><span class="line">req.on(<span class="hljs-string">'end'</span>, () =&gt; &#123;</span><br><span class="line">    <span class="hljs-keyword">const</span> parsedBody = Buffer.concat(body).toString();</span><br><span class="line">    <span class="hljs-keyword">const</span> message = parsedBody.split(<span class="hljs-string">'='</span>)[<span class="hljs-number">1</span>];</span><br><span class="line">    fs.writeFileSync(<span class="hljs-string">'message.txt'</span>, message);</span><br><span class="line">    res.statusCode = <span class="hljs-number">302</span>;</span><br><span class="line">    res.setHeader(<span class="hljs-string">'Location'</span>, <span class="hljs-string">'/'</span>);</span><br><span class="line">    <span class="hljs-keyword">return</span> res.end();</span><br><span class="line">&#125;);</span><br><span class="line"><span class="hljs-keyword">return</span>;</span><br></pre></td></tr></table></figure></p>
<p>因為 <code>end</code> 事件之下的 <code>res.setHeader(&#39;Content-Type&#39;, &#39;text/html&#39;);</code> 就不會被執行了。<br>注意！ 在 return 的當下，其實 <code>end</code> 的監聽事件是還沒有被執行的，但是當 <code>server</code> 裡頭的動作執行完畢之後， <code>request</code> 被解析完成，觸發了 <code>end</code> 的監聽事件，然後才開始執行這個事件裡頭的動作。</p>
<p>至此，此 Episode 告一段落，截至目前的完整程式碼如下：<br><figure class="highlight javascript hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">const</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">'http'</span>);</span><br><span class="line"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">const</span> server = http.createServer(<span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="hljs-keyword">const</span> url = req.url;</span><br><span class="line">    <span class="hljs-keyword">const</span> method = req.method;</span><br><span class="line">    <span class="hljs-keyword">if</span> (url === <span class="hljs-string">'/'</span>) &#123;</span><br><span class="line">        res.write(<span class="hljs-string">'&lt;html&gt;'</span>);</span><br><span class="line">        res.write(<span class="hljs-string">'&lt;head&gt;&lt;title&gt;Enter Message&lt;/title&gt;&lt;/head&gt;'</span>);</span><br><span class="line">        res.write(<span class="hljs-string">'&lt;body&gt;&lt;form action="/message" method="post"&gt;&lt;input type="text" name="message"&gt;&lt;button type="submit"&gt;Send&lt;/button&gt;&lt;/form&gt;&lt;/body&gt;'</span>);</span><br><span class="line">        res.write(<span class="hljs-string">'&lt;/html&gt;'</span>);</span><br><span class="line">        <span class="hljs-keyword">return</span> res.end();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-keyword">if</span> (url === <span class="hljs-string">'/message'</span> &amp;&amp; method === <span class="hljs-string">'POST'</span>) &#123;</span><br><span class="line">        <span class="hljs-keyword">const</span> body = [];</span><br><span class="line">        req.on(<span class="hljs-string">'data'</span>, (chunk) =&gt; &#123;</span><br><span class="line">            <span class="hljs-built_in">console</span>.log(chunk);</span><br><span class="line">            body.push(chunk);</span><br><span class="line">        &#125;);</span><br><span class="line">        req.on(<span class="hljs-string">'end'</span>, () =&gt; &#123;</span><br><span class="line">            <span class="hljs-keyword">const</span> parsedBody = Buffer.concat(body).toString();</span><br><span class="line">            <span class="hljs-keyword">const</span> message = parsedBody.split(<span class="hljs-string">'='</span>)[<span class="hljs-number">1</span>];</span><br><span class="line">            fs.writeFileSync(<span class="hljs-string">'message.txt'</span>, message);</span><br><span class="line">            res.statusCode = <span class="hljs-number">302</span>;</span><br><span class="line">            res.setHeader(<span class="hljs-string">'Location'</span>, <span class="hljs-string">'/'</span>);</span><br><span class="line">            <span class="hljs-keyword">return</span> res.end();</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="hljs-keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    res.setHeader(<span class="hljs-string">'Content-Type'</span>, <span class="hljs-string">'text/html'</span>);</span><br><span class="line">    res.write(<span class="hljs-string">'&lt;html&gt;'</span>);</span><br><span class="line">    res.write(<span class="hljs-string">'&lt;head&gt;&lt;title&gt;My First Page&lt;/title&gt;&lt;/head&gt;'</span>);</span><br><span class="line">    res.write(<span class="hljs-string">'&lt;body&gt;&lt;ht&gt;Hello from my NOde.js Server&lt;/ht&gt;&lt;/body&gt;'</span>);</span><br><span class="line">    res.write(<span class="hljs-string">'&lt;/html&gt;'</span>);</span><br><span class="line">    res.end();</span><br><span class="line">&#125;);</span><br><span class="line">server.listen(<span class="hljs-number">3000</span>);</span><br></pre></td></tr></table></figure></p>
<h3 id="Blocking-and-Non-Blocking-Code"><a href="#Blocking-and-Non-Blocking-Code" class="headerlink" title="Blocking and Non-Blocking Code"></a>Blocking and Non-Blocking Code</h3><p>所以，fs.writeFile 跟 fs.writeFileSync 差在哪？<br>fs.writeFileSync 會待這個檔案寫入的任務完成之後，才會繼續向後執行，而 fs.writeFIle 會異步執行，儘管檔案寫入的任務還沒完成，程式一樣會繼續向後執行，並且，我們可以在任務完成時執行一項 callback ，修改代碼如下：</p>
<figure class="highlight javascript hljs"><table><tr><td class="code"><pre><span class="line">req.on(<span class="hljs-string">'end'</span>, () =&gt; &#123;</span><br><span class="line">    <span class="hljs-keyword">const</span> parsedBody = Buffer.concat(body).toString();</span><br><span class="line">    <span class="hljs-keyword">const</span> message = parsedBody.split(<span class="hljs-string">'='</span>)[<span class="hljs-number">1</span>];</span><br><span class="line">    fs.writeFile(<span class="hljs-string">'message.txt'</span>, message, (err)=&gt;&#123;</span><br><span class="line">    res.statusCode = <span class="hljs-number">302</span>;</span><br><span class="line">    res.setHeader(<span class="hljs-string">'Location'</span>, <span class="hljs-string">'/'</span>);</span><br><span class="line">    <span class="hljs-keyword">return</span> res.end();</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>從以上的代碼來看，當程式執行到寫入檔案那一行， <code>fs.writeFile</code> ，程式不會停下來等待 <code>fs.writeFile</code> 執行完畢，反之，程式會繼續往下跑 ， 而當 <code>fs.writeFile</code> 執行完畢後，會觸發我們設定的 <code>callback</code> ，進而執行以下的代碼<br><figure class="highlight javascript hljs"><table><tr><td class="code"><pre><span class="line">res.statusCode = <span class="hljs-number">302</span>;</span><br><span class="line">res.setHeader(<span class="hljs-string">'Location'</span>, <span class="hljs-string">'/'</span>);</span><br><span class="line"><span class="hljs-keyword">return</span> res.end();</span><br></pre></td></tr></table></figure></p>
<h3 id="簡述事件迴圈"><a href="#簡述事件迴圈" class="headerlink" title="簡述事件迴圈"></a>簡述事件迴圈</h3><p>本章節主要參閱<a href="https://github.com/nodejs/node/blob/v4.x/doc/topics/the-event-loop-timers-and-nexttick.md#phases-in-detail" target="_blank" rel="noopener">官方文件</a> ， 以及這位大大的<a href="https://www.eebreakdown.com/2016/09/nodejs-eventemitter.html" target="_blank" rel="noopener">文章</a> 。<br>在本章節中，主要是搞懂 Node.js 中事件迴圈的概念。</p>
<ul>
<li>Node.js 的架構圖<br><img src="https://i.imgur.com/LG8jTvQ.png" alt></li>
</ul>
<p>上圖可以看到，除了 V8 Engine ， Node.js 使用了 <code>libuv</code> 來處理 I/O 的部分，提供了 asynchronous 以及 Non-Blocking API 以及事件迴圈 ， 下面提到的事件迴圈，主要與 <code>libuv</code> 有關。</p>
<ul>
<li>什麼是事件迴圈？<br>事件迴圈，藉由將工作量分擔給 Kernel 來處理，使 Node.js 得以做非阻塞 I/O 的操作，儘管 JsvaScript 是單線程的。</li>
</ul>
<p>因為目前新型的 Kernel 都是多線程的，它們可以在背景運行多個程序。當其中一個程序完成了， Kernel 會通知 Node.js ，所以 Node.js 會調整將適合的 callback 加到 poll 階段的 queue 當中 ，這些 callback 最終將會被執行。</p>
<h3 id="深談事件迴圈"><a href="#深談事件迴圈" class="headerlink" title="深談事件迴圈"></a>深談事件迴圈</h3><p>以下是事件迴圈各個階段圖，以及運行順序<br><img src="https://i.imgur.com/R93HoCB.png" alt></p>
<p>每個階段都有自己的 <code>先進先出</code> 的要被執行的 callback queue 。<br>每個階段都有自己特別的運行方式，一般來說，當事件迴圈跑到一個特定的階段，事件迴圈將會執行這個特定階段裡頭的操作，然後執行它的 callback ，這個執行的動作會重複，直到該階段內的 callback 都被執行完畢了，或者已經達到最大的執行數量。<br>當 queue 裡頭的工作都被處理完了，或者已達最大執行數量限制，事件迴圈會進入下一個階段，反覆循環。</p>
<p>因為上述提到的這些程序很有可能排定更多的程序，且由 <code>poll</code> 階段處理的事件將被 <code>kernel</code> 佇列著 ， 所以 <code>poll</code> 事件可以在被佇列的同時也被執行。 造成的結果是，一個耗時較長的 callback ， 會允許 <code>poll</code> 階段執行的久一點，甚至讓 <code>timer</code> 階段的工作等待。</p>
<h4 id="各階段概述"><a href="#各階段概述" class="headerlink" title="各階段概述"></a>各階段概述</h4><ul>
<li>timers: 這個階段主要處理 <code>setTimeout()</code> 以及 <code>setInterval()</code> 排程的 callback</li>
<li>I/O callbacks: 除了 <code>timers</code>, <code>setImmediate()</code>, <code>close</code> 之外的多數類型</li>
<li>idle, prepare: 只供內部使用</li>
<li>poll: 取回新的 I/O 事件; 某些情況， node 將會阻塞在這裡</li>
<li>check: <code>setImmediate()</code> callbacks 將會在這階段被觸發</li>
<li>close callbacks: socket, on …</li>
</ul>
<h4 id="libuv-各階段詳述"><a href="#libuv-各階段詳述" class="headerlink" title="libuv 各階段詳述"></a>libuv 各階段詳述</h4><h5 id="timers"><a href="#timers" class="headerlink" title="timers:"></a>timers:</h5><p>簡單來說， <code>timers</code> 階段將處理 <code>setTimeout()</code> 以及 <code>setInterval()</code> 的工作。 <code>timers</code> 並不保證可以準確地在給予的時間點執行 callback ， 反之 ，給予的時間更像是一個最低的門檻，唯有過了這個給予的時間點， callback 才會被執行，這視乎當時的工作狀態。 系統的排程或者是其他 callback 的運行都可能會延遲 <code>timers</code> 執行的確切時間。總而言之，過了指定的時間點之後， <code>timers</code> 會盡可能地盡快執行排程的 callback<br>可以看看以下的範例：</p>
<figure class="highlight javascript hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">someAsyncOperation</span> (<span class="hljs-params">callback</span>) </span>&#123;</span><br><span class="line">    <span class="hljs-comment">// Assume this takes 0 ms to complete</span></span><br><span class="line">    fs.readFile(<span class="hljs-string">'/path/to/file'</span>, callback);</span><br><span class="line">&#125;</span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">anotherAsyncOperation</span> (<span class="hljs-params">callback</span>) </span>&#123;</span><br><span class="line">    <span class="hljs-comment">// Assume this takes 0 ms to complete</span></span><br><span class="line">    fs.readFile(<span class="hljs-string">'/path/to/file'</span>, callback);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">var</span> timeoutScheduled = <span class="hljs-built_in">Date</span>.now();</span><br><span class="line"></span><br><span class="line">setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">var</span> delay = <span class="hljs-built_in">Date</span>.now() - timeoutScheduled;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-built_in">console</span>.log(delay + <span class="hljs-string">"ms have passed since I was scheduled"</span>);</span><br><span class="line">&#125;, <span class="hljs-number">100</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// do someAsyncOperation which takes 200 ms to complete</span></span><br><span class="line">someAsyncOperation(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">var</span> startCallback = <span class="hljs-built_in">Date</span>.now();</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// do something that will take 10ms...</span></span><br><span class="line">    <span class="hljs-keyword">while</span> (<span class="hljs-built_in">Date</span>.now() - startCallback &lt; <span class="hljs-number">200</span>) &#123;</span><br><span class="line">        ; <span class="hljs-comment">// do nothing</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// do anotherSyncOperation which takes 200 ms to complete</span></span><br><span class="line">anotherAsyncOperation(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">var</span> startCallback = <span class="hljs-built_in">Date</span>.now();</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// do something that will take 10ms...</span></span><br><span class="line">    <span class="hljs-keyword">while</span> (<span class="hljs-built_in">Date</span>.now() - startCallback &lt; <span class="hljs-number">200</span>) &#123;</span><br><span class="line">        ; <span class="hljs-comment">// do nothing</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>從上面的範例中可以看到， <code>setTimeout</code> 任務原定 100 ms 之後被執行，但是 <code>someAsyncOperation</code> 任務花了 0 + 200 ms ，當執行這個任務時，事件迴圈正處在 <code>poll</code> 階段，所以在一個循環中, 需等待 <code>poll</code> 階段中的任務完全處理完畢，或者達到最大處理數量限制。<br>所以在上面的範例中，需等待 <code>poll</code> 階段的任務 <code>someSyncOperation</code> 以及 <code>anotherSyncOperation</code> 被執行完畢，總共花費 400 ms 左右， 之後才會執行 <code>setTimeout()</code> 的任務。</p>
<h5 id="I-O-callbacks"><a href="#I-O-callbacks" class="headerlink" title="I/O callbacks"></a>I/O callbacks</h5><p>這個階段主要執行系統端操作的 callbacks, 像是 TCP 錯誤。<br>舉例來說，當試圖連接時，如果一個 TCP socket 接收到 <code>ECONNREFUSED</code>, 某個 <code>*nix</code> 系統想要等待並回報錯誤，這些都會在 <code>I/O callbacks</code> 階段被佇列。</p>
<h5 id="poll"><a href="#poll" class="headerlink" title="poll"></a>poll</h5><p><code>poll</code> 階段有兩種主要功能:</p>
<ol>
<li>替時間點已經到的 <code>timers</code> 執行腳本</li>
<li>處理 <code>poll</code> queue 當中的事件</li>
</ol>
<p>當事件進入 <code>poll</code> 階段，且沒有 <code>timers</code> 排程事件 ， 下面兩件事中，其中一件會發生:</p>
<ul>
<li>如果 <code>poll</code> 階段不為空，事件迴圈將會執行佇列中的所有 callbacks ，又或者達到最大 callbacks 處理上限</li>
<li>如果 <code>poll</code> 階段為空，以下兩件事中，其中一件會發生：<ul>
<li>如果腳本已經被 <code>setImmediate()</code> 排程，事件迴圈將會結束 <code>poll</code> 階段，並且繼續進入到 <code>check</code> 階段來處理該佇列中的排程</li>
<li>如果腳本沒有 <code>setImmediate()</code> 的排程，那事件迴圈將會等待新的事件被加入到佇列，然後立即處理他們</li>
</ul>
</li>
</ul>
<p>一旦 <code>poll</code> 循環為空，事件迴圈將會檢查 <code>timer</code> 中有沒有可以執行的 callback。 如果有一個或多個可以執行了, 事件迴圈會回去執行 <code>timer</code> 階段的 callback</p>
<h5 id="check"><a href="#check" class="headerlink" title="check"></a>check</h5><p>這個階段允許在 <code>poll</code> 階段完成後，立即執行 callback。<br>如果 <code>poll</code> 階段處於空轉，或者已經有 <code>setImmediate()</code> 的排程，事件迴圈將會繼續進入到 <code>check</code> 階段，而不會等待。</p>
<p><code>setImmediate()</code> 事實上，是一個很特別的 <code>timer</code> 階段，它跟 <code>timer</code> 在事件迴圈內跑在不同的階段。 它使用 <code>libuv</code> API ，這個 API 排程 callback 使之在 <code>poll</code> 階段結束後被執行</p>
<p>通常，事件迴圈會停在 <code>poll</code> 階段等待新的 request 或 connection ，但是當 <code>setImmediate()</code> 有排程，且 <code>poll</code> 階段處於空轉, 那事件迴圈將會結束 <code>poll</code> 階段，並且進入 <code>check</code> 階段</p>
<h5 id="close-callbacks"><a href="#close-callbacks" class="headerlink" title="close callbacks"></a>close callbacks</h5><p>如果一個 socket 或 handle 忽然被關閉， <code>close</code> 事件將會被置於這個階段，除非我們指定 <code>process.nextTick</code> 來執行它</p>
<h4 id="setImmediate-vs-setTimeout"><a href="#setImmediate-vs-setTimeout" class="headerlink" title="setImmediate() vs setTimeout()"></a>setImmediate() vs setTimeout()</h4><p><code>setImmediate()</code> 和 <code>setTimeout()</code> 很類似，但根據被呼叫的時機不一樣，行為也不同。</p>
<ul>
<li><code>setImmediate()</code> 被設計為，一旦 <code>poll</code> 階段結束時執行</li>
<li><code>setTimeout()</code> 排程任務，在特定的時間之後執行</li>
</ul>
<p>兩者之間執行的順序，根據被呼叫時的情況而有所不同。如果兩者都在主模組的時候被呼叫，那順序將由當時的程序的表現所決定，意思就是說，順序無法預測。<br>範例如下：<br><figure class="highlight javascript hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-comment">// timeout_vs_immediate.js</span></span><br><span class="line">setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">timeout</span> (<span class="hljs-params"></span>) </span>&#123;</span><br><span class="line">  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'timeout'</span>);</span><br><span class="line">&#125;,<span class="hljs-number">0</span>);</span><br><span class="line"></span><br><span class="line">setImmediate(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">immediate</span> (<span class="hljs-params"></span>) </span>&#123;</span><br><span class="line">  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'immediate'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>然而，如果兩者是在 I/O cycle 中被呼叫，那 <code>sedImmediate()</code> 將會優先於 <code>setTimeout()</code></p>
<figure class="highlight javascript hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-comment">// timeout_vs_immediate.js</span></span><br><span class="line"><span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>)</span><br><span class="line"></span><br><span class="line">fs.readFile(__filename, () =&gt; &#123;</span><br><span class="line">  setTimeout(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'timeout'</span>)</span><br><span class="line">  &#125;, <span class="hljs-number">0</span>)</span><br><span class="line">  setImmediate(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'immediate'</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>對比 <code>setTimeout()</code> , 使用 <code>setImmediate()</code> 的主要優勢為，如果在  <code>I/O cycle</code> 中， <code>setImmediate()</code> 將會被優先執行，不管 <code>setTimeout()</code> 有幾個</p>
<h4 id="process-nextTick"><a href="#process-nextTick" class="headerlink" title="process.nextTick()"></a>process.nextTick()</h4><h5 id="理解-process-nextTick"><a href="#理解-process-nextTick" class="headerlink" title="理解 process.nextTick()"></a>理解 process.nextTick()</h5><p>你可能已經注意到， <code>process.nextTick()</code> 並沒有被顯示在圖表上，儘管它也是 asynchronous API 的一部分。 這是因為 <code>process.nextTick()</code> 技術上來說不算是事件迴圈的一部分。 <code>nextTickQueue</code> 將會在目前操作完成後，立即被執行，不管目前是在事件迴圈內的哪一個循環。</p>
<p>看看我們的圖表，不管在什麼時候，只要你在特定的階段呼叫 <code>process.nextTick()</code> ， 所以經由 <code>process.nextTick()</code> 送出的 callbacks 將會在事件迴圈啟動下一個階段之前全部都處理完畢。 這樣的模式可能會造成一些不好的情況發生，因為如果你遞迴的使用 <code>process.nextTick()</code>  callback ，就會造成所謂的 <code>I/O 飢餓</code> ，事件迴圈將會無法進入 <code>poll</code> 階段</p>
<h5 id="為什麼這樣的行為會被容許？"><a href="#為什麼這樣的行為會被容許？" class="headerlink" title="為什麼這樣的行為會被容許？"></a>為什麼這樣的行為會被容許？</h5><p>你可能會想，為什麼這樣的行為在 Node.js 終會被容許？ Node.js 部分的設計哲學是， API 總是異步的，不管是否必要，可以參考以下範例:<br><figure class="highlight javascript hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-comment">// this has an asynchronous signature, but calls callback synchronously</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">someAsyncApiCall</span> (<span class="hljs-params">callback</span>) </span>&#123; callback(); &#125;;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// the callback is called before `someAsyncApiCall` completes.</span></span><br><span class="line">someAsyncApiCall(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// since someAsyncApiCall has completed, bar hasn't been assigned any value</span></span><br><span class="line">  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'bar'</span>, bar); <span class="hljs-comment">// undefined</span></span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">var</span> bar = <span class="hljs-number">1</span>;</span><br></pre></td></tr></table></figure></p>
<p>如果我們執行上面的代碼，會出現輸出如下：<br><img src="https://i.imgur.com/Izad8Ix.png" alt></p>
<p>因為 <code>someAsyncApiCall</code> 並沒有做任何異步的動作，照同步的流程跑到 <code>console.log</code> 時， bar 還沒有被定義</p>
<p>如果我們將代碼改成以下：<br><figure class="highlight javascript hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">someAsyncApiCall</span> (<span class="hljs-params">callback</span>) </span>&#123;</span><br><span class="line">  process.nextTick(callback);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">someAsyncApiCall(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'bar'</span>, bar); <span class="hljs-comment">// 1</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">var</span> bar = <span class="hljs-number">1</span>;</span><br></pre></td></tr></table></figure></p>
<p>可以得到以下的輸出：<br><img src="https://i.imgur.com/StDKTwU.png" alt></p>
<p>如上所述， <code>process.nextTick()</code> 的執行時間，是在當前的階段內所有的工作都完成了，在進入下個階段之前，會將所有的 <code>process.nextTick()</code> 處理完畢。<br>在上面的例子中， <code>process.nextTick()</code> 會等到所有在此階段的代碼都被執行完畢，也就是待 <code>var bar = 1</code> 執行後，才去執行這個 <code>callback</code> ，所以不會出現 undefined 的情況。<br>請注意！這沒有最大處理數量限制，所以如果利用 <code>process.nextTick()</code> 指派遞迴任務，那就會造成 <code>I/O 飢餓</code> 情況， 事件迴圈將無法接收到新的 request</p>
<h4 id="一個-tick-到底是多長？"><a href="#一個-tick-到底是多長？" class="headerlink" title="一個 tick 到底是多長？"></a>一個 tick 到底是多長？</h4><p>一個 tick 的時間長度，是 Event Loop 繞完一圈，把所有 queues 中的 callbacks 依序且同步地執行完，所消耗的總時間。因此，一個 tick 的值是不固定的。可能很長，可能很短，但我們希望它能盡量地短。</p>
<h4 id="process-nextTick-vs-setImmediate"><a href="#process-nextTick-vs-setImmediate" class="headerlink" title="process.nextTick() vs setImmediate()"></a>process.nextTick() vs setImmediate()</h4><p>千萬不要被這兩個階段的命名搞混了！</p>
<ul>
<li><p>process.nextTick():<br>在當前階段結束前執行完畢</p>
</li>
<li><p>setImmediate():<br>在下一個階段，或者下一個事件迴圈的 tick 中執行</p>
</li>
</ul>
<p>基本上，這兩個命名應該是要互換。 <code>process.nextTick()</code> 比 <code>setImmediate()</code> 更快地被觸發。<br>這算是一個很難更動的部分，因為當初命名錯誤之後，隨時時間的推移，越來越多 npm 的 package 都是使用這樣的命名，所以一旦這命名變更了，影響會非常的大。</p>
<p>官方文件上建議開發者，在任何情況中，都使用 <code>setImmediate()</code> ，因為它可以更簡單的被邏輯思考，然後在不同的環境上，有著更廣的相容性。</p>
<h4 id="Promise"><a href="#Promise" class="headerlink" title="Promise"></a>Promise</h4><p>從下面的原始碼可以看到 <code>Promise</code> ， 或者又稱為 <code>microtasks</code> 的執行優先順序<br>依照原始碼的執行順序來看，在一個階段結束之前，<code>process.nextTick()</code> 會先被執行，緊接著, 執行 <code>Promise</code> 。</p>
<figure class="highlight javascript hljs"><table><tr><td class="code"><pre><span class="line">startup.processNextTick = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>&#123;</span><br><span class="line">    <span class="hljs-keyword">var</span> nextTickQueue = [];   <span class="hljs-comment">// Callbacks 會排進這個 queue!!</span></span><br><span class="line">    <span class="hljs-keyword">var</span> pendingUnhandledRejections = [];</span><br><span class="line">    <span class="hljs-keyword">var</span> microtasksScheduled = <span class="hljs-literal">false</span>;</span><br><span class="line">    <span class="hljs-keyword">var</span> _runMicrotasks = &#123;&#125;;</span><br><span class="line">    <span class="hljs-comment">// ... 略</span></span><br><span class="line">    process.nextTick = nextTick;  <span class="hljs-comment">// nextTick 函式在下面</span></span><br><span class="line">    <span class="hljs-comment">// ... 略</span></span><br><span class="line">    <span class="hljs-comment">// process._setupNextTick 在 node.cc 中, 我認為意思到了, 就不用再挖下去了</span></span><br><span class="line">    <span class="hljs-keyword">const</span> tickInfo = process._setupNextTick(_tickCallback, _runMicrotasks);</span><br><span class="line">    _runMicrotasks = _runMicrotasks.runMicrotasks;</span><br><span class="line">    <span class="hljs-comment">// ... 略</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_tickCallback</span>(<span class="hljs-params"></span>) </span>&#123;</span><br><span class="line">      <span class="hljs-keyword">var</span> callback, args, tock;</span><br><span class="line"></span><br><span class="line">      <span class="hljs-keyword">do</span> &#123;</span><br><span class="line">        <span class="hljs-keyword">while</span> (tickInfo[kIndex] &lt; tickInfo[kLength]) &#123;</span><br><span class="line">        <span class="hljs-comment">// callbacks 從 queue 中一個一個被挖出來執行</span></span><br><span class="line">          tock = nextTickQueue[tickInfo[kIndex]++];</span><br><span class="line">          callback = tock.callback;</span><br><span class="line">          args = tock.args;</span><br><span class="line"></span><br><span class="line">          <span class="hljs-keyword">if</span> (args === <span class="hljs-literal">undefined</span>) &#123;</span><br><span class="line">            nextTickCallbackWith0Args(callback);</span><br><span class="line">          &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">            <span class="hljs-keyword">switch</span> (args.length) &#123;</span><br><span class="line">              <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:</span><br><span class="line">                nextTickCallbackWith1Arg(callback, args[<span class="hljs-number">0</span>]);</span><br><span class="line">              <span class="hljs-comment">// ...</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="hljs-keyword">if</span> (<span class="hljs-number">1e4</span> &lt; tickInfo[kIndex])</span><br><span class="line">            tickDone();</span><br><span class="line">        &#125;</span><br><span class="line">        tickDone();</span><br><span class="line">        <span class="hljs-comment">// process.nextTick 的 callbacks 跑完, 接著跑 Promise 的 microtasks</span></span><br><span class="line">        _runMicrotasks();</span><br><span class="line">        emitPendingUnhandledRejections();</span><br><span class="line">      &#125; <span class="hljs-keyword">while</span> (tickInfo[kLength] !== <span class="hljs-number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// ...略</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">nextTick</span>(<span class="hljs-params">callback</span>) </span>&#123;</span><br><span class="line">      <span class="hljs-keyword">var</span> args;</span><br><span class="line">      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">arguments</span>.length &gt; <span class="hljs-number">1</span>) &#123;</span><br><span class="line">        args = [];</span><br><span class="line">        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-built_in">arguments</span>.length; i++)</span><br><span class="line">          args.push(<span class="hljs-built_in">arguments</span>[i]);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="hljs-comment">// 將 callback 連它的 arguments 用一個物件存起來推進 queue</span></span><br><span class="line">      nextTickQueue.push(<span class="hljs-keyword">new</span> TickObject(callback, args));</span><br><span class="line">      tickInfo[kLength]++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// ...</span></span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>
<h4 id="事件迴圈總結"><a href="#事件迴圈總結" class="headerlink" title="事件迴圈總結"></a>事件迴圈總結</h4><ul>
<li><p>順序:<br>timers &rarr; I/O callbacks &rarr; idle, pare &rarr; poll &rarr; check &rarr; close callbacks &rarr; timers … 往復循環</p>
</li>
<li><p>順序細節</p>
<ul>
<li><code>timers</code> 設定的時間過了之後，才會被’盡快’的執行。<br>如果 <code>poll</code> 階段內還有工作還沒做完，會先做完，才會執行 <code>timers</code> 的工作，所以可能會延遲</li>
<li>當處於 <code>I/O</code> 程序中，比如說， <code>fs</code> 模組中， <code>setImmediate()</code> 順序一定大於 <code>setTimeout()</code> ，因為 <code>check</code> 階段緊接在 <code>poll</code> 階段之後</li>
<li>當處於主要模組中， <code>setImmediate()</code> 以及 <code>setTimeout</code> 的優先順序，取決於運行狀況，這個狀態下，次序無法確定</li>
<li><code>process.nextTick()</code> 將在當前階段的工作結束前，在進入下一個階段之前執行, 所以他的優先性是第一名的</li>
<li><code>promise</code> 的執行次序緊接在 <code>process.nextTick()</code> 之後，也是在當前階段結束前執行完畢</li>
</ul>
</li>
</ul>
<h3 id="Express-js"><a href="#Express-js" class="headerlink" title="Express.js"></a>Express.js</h3><h4 id="建立一個-app-server"><a href="#建立一個-app-server" class="headerlink" title="建立一個 app server"></a>建立一個 app server</h4><ol>
<li><figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">npm install --save</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>2.<br><figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">npm install --save express</span><br></pre></td></tr></table></figure></p>
<ol start="3">
<li><figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">npm install --save-dev nodemon</span><br></pre></td></tr></table></figure>
</li>
<li><p>Set script as nodemon fileName.js</p>
</li>
</ol>
<h4 id="指定-status-code"><a href="#指定-status-code" class="headerlink" title="指定 status code"></a>指定 status code</h4><p>res.status (statusCode);</p>
<h4 id="Promise-1"><a href="#Promise-1" class="headerlink" title="Promise"></a>Promise</h4><p>以下的範例中， function test 中，我們 return 了一個 <code>Promise</code> ，如果帶入 test function 中的 argument 是 1 ，那就走 <code>resolve</code> 路線 ， 而除了 1 之外所有的 argument, 都走 <code>reject</code> 路線。<br>在 function main 中, 我們使用了 function test, 並帶入 argument 1, Ray 個人覺得這有點像是 PHP 當中的 <code>ternary</code> 用法。<br>當 argument 等於我們在 <code>promise</code> 當中指定的 1 時，走 resolve 路線, 而 <code>then</code> 就是當 promise 為 resolve 路線時該做的事。<br>當 argument 等於是除了 1 之外的任何數，也就是會走 <code>promise</code> 當中的 reject 路線, 此時將會執行 <code>catch</code> 的動作。<br>我們在 promise 當中指定，當走 <code>resolve</code> 路線時，輸出為字串 Success, 所以在 <code>then</code> 的 closure 當中，被帶入的 argument 就是 Success<br>反之，當走 <code>reject</code> 路線時，輸出字串為 Error, 所以在 <code>catch</code> 的 closure 當中，被帶入的 argument 則為 Error<br><figure class="highlight javascript hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">test</span>(<span class="hljs-params">number</span>) </span>&#123;</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="hljs-keyword">if</span> (number === <span class="hljs-number">1</span>) &#123;</span><br><span class="line">            resolve(<span class="hljs-string">"Success"</span>)</span><br><span class="line">        &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">            reject(<span class="hljs-string">"Failed"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">main</span>(<span class="hljs-params"></span>) </span>&#123;</span><br><span class="line">    test(<span class="hljs-number">1</span>).then(<span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="hljs-comment">// result === "Success"</span></span><br><span class="line">        <span class="hljs-built_in">console</span>.log(result)</span><br><span class="line">    &#125;).catch(<span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="hljs-comment">// 不會被執行, 因為狀態是成功</span></span><br><span class="line">    &#125;)</span><br><span class="line">    test(<span class="hljs-number">2</span>).then(<span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="hljs-comment">// 不會被執行, 因為狀態是成功</span></span><br><span class="line">        <span class="hljs-built_in">console</span>.log(result)</span><br><span class="line">    &#125;).catch(<span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="hljs-comment">// error === "Failed"</span></span><br><span class="line">        <span class="hljs-built_in">console</span>.log(error)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="建立-Datastore-Model"><a href="#建立-Datastore-Model" class="headerlink" title="建立 Datastore Model"></a>建立 Datastore Model</h4><figure class="highlight javascript hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-comment">// 從 google SDK 引用 Datastore function</span></span><br><span class="line"><span class="hljs-keyword">const</span> &#123;Datastore&#125; = <span class="hljs-built_in">require</span>(<span class="hljs-string">'@google-cloud/datastore'</span>);</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// 輸入 project_id</span></span><br><span class="line"><span class="hljs-keyword">const</span> projectId = <span class="hljs-string">'balmy-sanctuary-238903'</span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// 初始一個 Datastore instance</span></span><br><span class="line"><span class="hljs-keyword">const</span> datastore = <span class="hljs-keyword">new</span> Datastore(&#123;</span><br><span class="line">    projectId: projectId,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// 匯出這個 module</span></span><br><span class="line"><span class="hljs-built_in">module</span>.exports = datastore;</span><br></pre></td></tr></table></figure>
<h4 id="建立一個-Controller"><a href="#建立一個-Controller" class="headerlink" title="建立一個 Controller"></a>建立一個 Controller</h4><figure class="highlight javascript hljs"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="hljs-comment">// 匯出這個 function</span></span><br><span class="line">exports.test = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">quickStart</span>(<span class="hljs-params"></span>) </span>&#123;</span><br><span class="line">        <span class="hljs-comment">// The kind for the new entity</span></span><br><span class="line">        <span class="hljs-keyword">const</span> kind = <span class="hljs-string">'abc'</span>;</span><br><span class="line">        <span class="hljs-comment">// The name/ID for the new entity</span></span><br><span class="line">        <span class="hljs-keyword">const</span> name = <span class="hljs-string">'sampletask1'</span>;</span><br><span class="line">        <span class="hljs-comment">// The Cloud Datastore key for the new entity</span></span><br><span class="line">        <span class="hljs-keyword">const</span> taskKey = datastore.key([kind, name]);</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">// Prepares the new entity</span></span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">const</span> task = &#123;</span><br><span class="line">            key: taskKey,</span><br><span class="line">            data: &#123;</span><br><span class="line">                description: <span class="hljs-string">'Buy milk'</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-built_in">console</span>.log(datastore.key([<span class="hljs-string">'name'</span>, <span class="hljs-string">'kind'</span>]));</span><br><span class="line">        <span class="hljs-comment">// Saves the entity</span></span><br><span class="line">        <span class="hljs-keyword">await</span> datastore.save(task);</span><br><span class="line">        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`Saved <span class="hljs-subst">$&#123;task.key.name&#125;</span>: <span class="hljs-subst">$&#123;task.data.description&#125;</span>`</span>);</span><br><span class="line">        res.send(<span class="hljs-string">`Saved <span class="hljs-subst">$&#123;task.key.name&#125;</span>: <span class="hljs-subst">$&#123;task.data.description&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    quickStart().catch(<span class="hljs-built_in">console</span>.error);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="Route"><a href="#Route" class="headerlink" title="Route"></a>Route</h4><figure class="highlight javascript hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">var</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);</span><br><span class="line"><span class="hljs-keyword">var</span> router = express.Router();</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// 導入 controller 模組, 並給予名稱</span></span><br><span class="line"><span class="hljs-keyword">var</span> datastore = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../controllers/datastoreController'</span>);</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/* GET home page. */</span></span><br><span class="line">router.get(<span class="hljs-string">'/'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) </span>&#123;</span><br><span class="line">  res.render(<span class="hljs-string">'index'</span>, &#123; <span class="hljs-attr">title</span>: <span class="hljs-string">'Express'</span> &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="hljs-comment">// 建一個 router, 並且導向 datastoreController 裡頭的 test function</span></span><br><span class="line">router.get(<span class="hljs-string">'/test'</span>, datastore.test);</span><br><span class="line"></span><br><span class="line"><span class="hljs-built_in">module</span>.exports = router;</span><br></pre></td></tr></table></figure>
<h4 id="Root-address"><a href="#Root-address" class="headerlink" title="Root address"></a>Root address</h4><figure class="highlight javascript hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-comment">// 找一個地方新增一個檔案，輸入以下的 code</span></span><br><span class="line"><span class="hljs-comment">// 之後我們就可以在任何一個檔案中，透過 require 這個檔案來 const rootDir</span></span><br><span class="line"><span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);</span><br><span class="line"><span class="hljs-built_in">module</span>.exports = path.dirname(<span class="hljs-string">'/Users/ray/code/datastore/app.js'</span>);</span><br></pre></td></tr></table></figure>
<p>若我們 console.log 上面 exports 的值，可以得到該專案下的 root 位址</p>
<h4 id="Path"><a href="#Path" class="headerlink" title="Path"></a>Path</h4><p>利用 path module 來指定路徑<br><figure class="highlight javascript hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-comment">// p 會等於專案根目錄下, data 資料夾之下的一個叫做 `products.json` 的檔案</span></span><br><span class="line"><span class="hljs-comment">// 專案根目錄請參考 `root address` 章節</span></span><br><span class="line"><span class="hljs-keyword">const</span> p = path.join(rootDir, <span class="hljs-string">'data'</span>, <span class="hljs-string">'products.json'</span>)</span><br></pre></td></tr></table></figure></p>
<h4 id="object-assign"><a href="#object-assign" class="headerlink" title="object.assign"></a>object.assign</h4><ul>
<li>可用來複製或覆蓋目標物件<figure class="highlight javascript hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">let</span> exampleObject = &#123;<span class="hljs-attr">a</span>:<span class="hljs-number">1</span>, <span class="hljs-attr">b</span>:<span class="hljs-number">2</span>, <span class="hljs-attr">c</span>:<span class="hljs-number">3</span>, <span class="hljs-attr">c</span>:<span class="hljs-number">4</span>&#125;;</span><br><span class="line"><span class="hljs-keyword">let</span> copy = object.assign(&#123;&#125;,</span><br><span class="line"> exampleObject,</span><br><span class="line">  &#123;<span class="hljs-attr">a</span>:<span class="hljs-number">4</span>, <span class="hljs-attr">b</span>:<span class="hljs-number">4</span>, <span class="hljs-attr">c</span>:<span class="hljs-number">4</span>, <span class="hljs-attr">d</span>:<span class="hljs-number">4</span>&#125;);</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="test"><a href="#test" class="headerlink" title="test"></a>test</h4><ul>
<li>用來確認該 string 是否符合該 regex patten<figure class="highlight javascript hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">var</span> str = <span class="hljs-string">"Hello world!"</span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// look for "Hello"</span></span><br><span class="line"><span class="hljs-keyword">var</span> patt = <span class="hljs-regexp">/Hello/g</span>;</span><br><span class="line"><span class="hljs-keyword">var</span> result = patt.test(str);</span><br><span class="line"><span class="hljs-comment">// result = true</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="時間"><a href="#時間" class="headerlink" title="時間"></a>時間</h4><figure class="highlight javascript hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">var</span> moment = <span class="hljs-built_in">require</span>(<span class="hljs-string">'moment-timezone'</span>);</span><br><span class="line"><span class="hljs-keyword">var</span> test = moment(createdDate).tz(<span class="hljs-string">"Asia/Taipei"</span>).format(<span class="hljs-string">'YYYY-MM-DD HH:MM:SS'</span>);</span><br><span class="line"><span class="hljs-built_in">console</span>.log(test); </span><br><span class="line"><span class="hljs-comment">// 2019-05-21 08:05:44</span></span><br></pre></td></tr></table></figure>
<h4 id="同時異步多請求"><a href="#同時異步多請求" class="headerlink" title="同時異步多請求"></a>同時異步多請求</h4><figure class="highlight javascript hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-comment">// 需安裝兩個套件 `request-promise` 以及 `p-limit`</span></span><br><span class="line"><span class="hljs-keyword">const</span> request = <span class="hljs-built_in">require</span>(<span class="hljs-string">'request-promise'</span>);</span><br><span class="line"><span class="hljs-keyword">const</span> pLimit = <span class="hljs-built_in">require</span>(<span class="hljs-string">'p-limit'</span>);</span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HealthCheckService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> getHealthCheckResults(sites) &#123;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// 指定 limit 同時最多發十個 request</span></span><br><span class="line">        <span class="hljs-keyword">const</span> limit = pLimit(<span class="hljs-number">10</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// 利用 map 從 sites 中拿到我們要發請求的 url</span></span><br><span class="line"><span class="hljs-comment">// 然後利用套件 `limit` 來限制同時發請求的數量，再來使用 `request-promise` 套件來對上面拿到的 url 發請求</span></span><br><span class="line">        <span class="hljs-keyword">let</span> promises = sites.map(<span class="hljs-function">(<span class="hljs-params">site</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="hljs-keyword">let</span> url = <span class="hljs-string">`https://asia-northeast1-qcdn-20180401.cloudfunctions.net/qcdn-monitor/site/dig_and_test?host=<span class="hljs-subst">$&#123;site.host&#125;</span>&amp;cname=<span class="hljs-subst">$&#123;site.cname&#125;</span>`</span>;</span><br><span class="line">            <span class="hljs-keyword">return</span> limit(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> request(url));</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// 上面的每一個 promises, 都是一個請求。 現在我們利用 `Promise.all`, 待所有的結果都回來之後，在 return</span></span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-built_in">Promise</span>.all(promises);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

    
    </div>
    
    <div class="columns is-variable is-1 is-multiline is-mobile">
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/tags/Node-js/">#Node.js</a></span>
    
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop  article-nav-prev">
            
            <a href="/gitlabCICDOnGCP/">Deploy project on GCP virtual machine via Gitlab CI/CD</a>
            
        </span>
        <span class="column is-12-mobile is-half-desktop  article-nav-next">
            
            <a href="/Linux/">My learning journey in Linux</a>
            
        </span>
    </div>
    
</article>


<div class="sharebox">
    
<div class="sharethis-inline-share-buttons"></div>
<script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5c72643b9ea706001139fd89&amp;product=inline-share-buttons" async="async"></script>

</div>



<div class="comments">
    <h3 class="title is-4">Comments</h3>
    
<script>
    var disqus_config = function () {
        this.page.url = 'https://tn710617.github.io/Node-js/';
        this.page.identifier = 'Node-js/';
        
        this.language = 'en';
        
    };
    (function() {
        var d = document, s = d.createElement('script');  
        s.src = '//' + 'rayscodingjourney' + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>

<div id="disqus_thread">
    
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</div>

    </div>
</section>
    <footer class="footer">
    <div class="container">
        <div class="columns content">
            <div class="column is-narrow has-text-centered">
                &copy; 2019 Ray&nbsp;
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a href="http://github.com/ppoffice/hexo-theme-minos">Minos</a>
            </div>
            <div class="column is-hidden-mobile"></div>

            
            
                       <a class="navbar-item" title="GitHub" href="https://github.com/tn710617">
                           
                           <i class="fab fa-github"></i>
                           
                       </a>
                          
                       <a class="navbar-item" title="E-Mail" href="mailto:tn710617@gmail.com">
                           
                           <i class="far fa-envelope"></i>
                           
                       </a>
                          
                       <a class="navbar-item" title="Linkedin" href="https://www.linkedin.com/in/ray-lee-99315315a">
                           
                           <i class="fab fa-linkedin"></i>
                           
                       </a>
                          
                       <a class="navbar-item" title="Facebook" href="https://www.facebook.com/profile.php?id=100001626039430">
                           
                           <i class="fab fa-facebook"></i>
                           
                       </a>
                          
                       <a class="navbar-item" title="Skype" href="skype:adad0310?call|chat">
                           
                           <i class="fab fa-skype"></i>
                           
                       </a>
                          
                       
        </div>
    </div>
</footer>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script>

<!-- test if the browser is outdated -->
<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/">Update my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.js"></script>
<script>
    $(document).ready(function () {
        // plugin function, place inside DOM ready function
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        })
    });
</script>

<script>
    window.FontAwesomeConfig = {
        searchPseudoElements: true
    }
    moment.locale("en-AU");
</script>


    
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<script>
    MathJax.Hub.Config({
        "HTML-CSS": {matchFontHeight: false},
        SVG: {matchFontHeight: false},
        CommonHTML: {matchFontHeight: false}
    });
</script>

    
    
    
    
<script src="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/js/lightgallery-all.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/justifiedGallery/3.6.5/js/jquery.justifiedGallery.min.js"></script>
<script>
    (function ($) {
        $(document).ready(function () {
            if (typeof($.fn.lightGallery) === 'function') {
                $('.article.gallery').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof($.fn.justifiedGallery) === 'function') {
                $('.justified-gallery').justifiedGallery();
            }
        });
    })(jQuery);
</script>

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <style>
        .hljs {
            position: relative;
        }

        .hljs .clipboard-btn {
            float: right;
            color: #9a9a9a;
            background: none;
            border: none;
        }

        .hljs > .clipboard-btn {
            display: none;
            position: absolute;
            right: 4px;
            top: 4px;
        }

        .hljs:hover > .clipboard-btn {
            display: inline;
        }

        .hljs > figcaption > .clipboard-btn {
            margin-right: 4px;
        }
    </style>
    <script>
      $(document).ready(function () {
        $('figure.hljs').each(function(i, figure) {
          var codeId = 'code-' + i;
          var code = figure.querySelector('.code');
          var copyButton = $('<button>Copy <i class="far fa-clipboard"></i></button>');
          code.id = codeId;
          copyButton.addClass('clipboard-btn');
          copyButton.attr('data-clipboard-target-id', codeId);

          var figcaption = figure.querySelector('figcaption');

          if (figcaption) {
            figcaption.append(copyButton[0]);
          } else {
            figure.prepend(copyButton[0]);
          }
        })

        var clipboard = new ClipboardJS('.clipboard-btn', {
          target: function(trigger) {
            return document.getElementById(trigger.getAttribute('data-clipboard-target-id'));
          }
        });
      })
    </script>

    
    

    


<script src="/js/script.js"></script>

    
    <div class="searchbox ins-search">
    <div class="searchbox-mask"></div>
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="Type something...">
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: 'Posts',
                PAGES: 'Pages',
                CATEGORIES: 'Categories',
                TAGS: 'Tags',
                UNTITLED: '(Untitled)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script src="/js/insight.js"></script>
    
</body>
</html>