<!DOCTYPE html>
<html class="has-navbar-fixed-top">
<head>
    <meta charset="utf-8">
<title>Implement a transaction via PayPal Payment Standard and PayPal IPN Message - Learn or Die</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="description" content="IntroductionIf you’ve once tried PayPal Payment service, you should know that PayPal provides several ways for users to pay and receive paymentThose are included in this article:  How to pay via PayPa">
<meta property="og:type" content="article">
<meta property="og:title" content="Implement a transaction via PayPal Payment Standard and PayPal IPN Message">
<meta property="og:url" content="https://tn710617.github.io/implementATransactionViaPayPalIPN/index.html">
<meta property="og:site_name" content="Learn or Die">
<meta property="og:description" content="IntroductionIf you’ve once tried PayPal Payment service, you should know that PayPal provides several ways for users to pay and receive paymentThose are included in this article:  How to pay via PayPa">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://i.imgur.com/oCOCdLi.png">
<meta property="og:image" content="https://i.imgur.com/FQ90eUB.png">
<meta property="og:image" content="https://i.imgur.com/EAPA4y3.png">
<meta property="og:image" content="https://i.imgur.com/RY4BEJ1.png">
<meta property="og:image" content="https://i.imgur.com/rs3VIBN.png">
<meta property="og:image" content="https://i.imgur.com/NfzG9Cj.png">
<meta property="og:image" content="https://i.imgur.com/ZCmPwAd.png">
<meta property="article:published_time" content="2019-03-04T03:18:09.000Z">
<meta property="article:modified_time" content="2019-06-20T01:28:16.976Z">
<meta property="article:author" content="Ray">
<meta property="article:tag" content="PayPal Payment Standard">
<meta property="article:tag" content="PayPal IPN">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.imgur.com/oCOCdLi.png">


<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.css">


    <link href="/zh-tw/implementATransactionViaPayPalIPN/" rel="alternate"
          hreflang="zh-TW"/>








    <meta name="description" content="IntroductionIf you’ve once tried PayPal Payment service, you should know that PayPal provides several ways for users to pay and receive paymentThose are included in this article:  How to pay via PayPa">
<meta property="og:type" content="article">
<meta property="og:title" content="Implement a transaction via PayPal Payment Standard and PayPal IPN Message">
<meta property="og:url" content="https://tn710617.github.io/implementATransactionViaPayPalIPN/index.html">
<meta property="og:site_name" content="Learn or Die">
<meta property="og:description" content="IntroductionIf you’ve once tried PayPal Payment service, you should know that PayPal provides several ways for users to pay and receive paymentThose are included in this article:  How to pay via PayPa">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://i.imgur.com/oCOCdLi.png">
<meta property="og:image" content="https://i.imgur.com/FQ90eUB.png">
<meta property="og:image" content="https://i.imgur.com/EAPA4y3.png">
<meta property="og:image" content="https://i.imgur.com/RY4BEJ1.png">
<meta property="og:image" content="https://i.imgur.com/rs3VIBN.png">
<meta property="og:image" content="https://i.imgur.com/NfzG9Cj.png">
<meta property="og:image" content="https://i.imgur.com/ZCmPwAd.png">
<meta property="article:published_time" content="2019-03-04T03:18:09.000Z">
<meta property="article:modified_time" content="2019-06-20T01:28:16.976Z">
<meta property="article:author" content="Ray">
<meta property="article:tag" content="PayPal Payment Standard">
<meta property="article:tag" content="PayPal IPN">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.imgur.com/oCOCdLi.png">





    <link rel="icon" href="/images/favicon.png">


<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bulma/0.6.2/css/bulma.min.css">


    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/justifiedGallery/3.6.5/css/justifiedGallery.min.css">


<link rel="stylesheet"
      href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/sunburst.min.css">


<link rel="stylesheet" href="/css/style.css">


<script defer src="//use.fontawesome.com/releases/v5.0.8/js/all.js"></script>


    
        
    
        
    
        
    
        
    
        
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-135063928-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-135063928-1');
</script>


    


<meta name="generator" content="Hexo 6.2.0"></head>
<body>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="/">
                
                    
                    Learn or Die
                    
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item "
               href="/archives">Archives</a>
            
            <a class="navbar-item "
               href="/categories">Categories</a>
            
            <a class="navbar-item "
               href="/tags">Tags</a>
            
            <a class="navbar-item "
               href="/schedule">Schedule</a>
            
            <a class="navbar-item "
               href="/about">About</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            <a class="navbar-item search" title="Search" href="javascript:;">
                <i class="fas fa-search"></i>
            </a>
            
            
            <div class="navbar-item is-hoverable has-dropdown is-hidden-mobile is-hidden-tablet-only toc">
                <a class="navbar-item" title="Table of Contents">
                    <i class="fa fa-list"></i>
                </a>
                <div class="navbar-dropdown is-right">
                    
                    
                    
                    
                    <a class="navbar-item" href="#Introduction">1&nbsp;&nbsp;<b>Introduction</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#Validation">2&nbsp;&nbsp;<b>Validation</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#Collect-required-information">3&nbsp;&nbsp;<b>Collect required information.</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#Splitting-point">4&nbsp;&nbsp;<b>Splitting point</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#Make-a-payment-order">5&nbsp;&nbsp;<b>Make a payment order</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#Make-a-URL-for-submitting-the-payment-request-to-PayPal">6&nbsp;&nbsp;<b>Make a URL for submitting the payment request to PayPal</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#Pay-the-payment">7&nbsp;&nbsp;<b>Pay the payment</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#Verify-payment-state">8&nbsp;&nbsp;<b>Verify payment state</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#Conclusion">9&nbsp;&nbsp;<b>Conclusion</b></a>
                    
                </div>
            </div>
            

            
<div class="column is-narrow has-text-centered">
    <div class="dropdown is-up is-right is-hoverable" style="margin-top: -0.2em;">
        <div class="dropdown-trigger">
            <button class="button is-small" aria-haspopup="true" aria-controls="dropdown-menu7">
                <span class="icon">
                    <i class="fas fa-globe"></i>
                </span>
                <span>English</span>
                <span class="icon is-small">
            <i class="fas fa-angle-down" aria-hidden="true"></i>
          </span>
            </button>
        </div>
        <div class="dropdown-menu has-text-left" role="menu" style="top:100%">
            <div class="dropdown-content">
            
                <a href="/implementATransactionViaPayPalIPN/" class="dropdown-item">
                    English
                </a>
            
                <a href="/zh-tw/implementATransactionViaPayPalIPN/" class="dropdown-item">
                    繁體中文
                </a>
            
            </div>
        </div>
    </div>
</div>

        </div>
    </div>
</nav>

    <section class="section">
    <div class="container">
    <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            Implement a transaction via PayPal Payment Standard and PayPal IPN Message
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            <time datetime="2019-03-04T03:18:09.000Z" itemprop="datePublished">Mar 4 2019</time>
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="/categories/Payment-Gateway/">Payment Gateway</a>
        </span>
        
        
        <span class="column is-narrow">
            
            
            16 minutes read (About 2445 words)
        </span>
        
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>If you’ve once tried PayPal Payment service, you should know that PayPal provides several ways for users to pay and receive payment<br>Those are included in this article:</p>
<ol>
<li>How to pay via PayPal Payment Standard</li>
<li>How to validate the payment result via PayPal IPN Message</li>
<li>With PayPal Payment Standard, how to submit several items with their names, unit prices, and quantities.<span id="more"></span></li>
</ol>
<p>In this article, the language I use is Laravel, the framework of PHP.<br>Since this article basically is a record of a project I was working, there may be some parts that don’t have so much to do with payment service.<br>You could skip those parts and start from ‘Make a payment order’</p>
<h2 id="Validation"><a href="#Validation" class="headerlink" title="Validation"></a>Validation</h2><p>It’s part of the whole process, and doesn’t have anything to do with payment service. You could just skip it.</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-variable">$toBeValidatedCondition</span> = [</span><br><span class="line">    <span class="hljs-string">&#x27;order_id&#x27;</span> =&gt; <span class="hljs-string">&#x27;required|array&#x27;</span>,</span><br><span class="line">];</span><br><span class="line"><span class="hljs-variable">$failMessage</span> = <span class="title class_">Helpers</span>::<span class="title function_ invoke__">validation</span>(<span class="hljs-variable">$toBeValidatedCondition</span>, <span class="hljs-variable">$request</span>);</span><br><span class="line"><span class="hljs-keyword">if</span> (<span class="hljs-variable">$failMessage</span>)</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="title class_">Helpers</span>::<span class="title function_ invoke__">result</span>(<span class="hljs-literal">false</span>, <span class="hljs-variable">$failMessage</span>, <span class="hljs-number">400</span>);</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">if</span> (!<span class="title class_">Helpers</span>::<span class="title function_ invoke__">checkIfIDExists</span>(<span class="hljs-variable">$request</span>, <span class="hljs-keyword">new</span> <span class="title class_">Order</span>(), <span class="hljs-string">&#x27;order_id&#x27;</span>))</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="title class_">Helpers</span>::<span class="title function_ invoke__">result</span>(<span class="hljs-literal">false</span>, <span class="hljs-string">&#x27;The orders doesn\&#x27;t exist&#x27;</span>, <span class="hljs-number">400</span>);</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">if</span> (!<span class="title class_">Helpers</span>::<span class="title function_ invoke__">checkIfBelongToTheUser</span>(<span class="hljs-variable">$request</span>, <span class="hljs-keyword">new</span> <span class="title class_">Order</span>(), <span class="hljs-string">&#x27;order_id&#x27;</span>))</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="title class_">Helpers</span>::<span class="title function_ invoke__">result</span>(<span class="hljs-literal">false</span>, <span class="hljs-string">&#x27;The order doesn\&#x27;t belong to this user&#x27;</span>, <span class="hljs-number">400</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="hljs-variable">$orders</span> = <span class="title class_">Order</span>::<span class="title function_ invoke__">whereIn</span>(<span class="hljs-string">&#x27;id&#x27;</span>, <span class="hljs-variable">$request</span>-&gt;order_id)-&gt;<span class="title function_ invoke__">get</span>();</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">if</span> (<span class="title class_">Order</span>::<span class="title function_ invoke__">checkIfOrderPaid</span>(<span class="hljs-variable">$orders</span>))</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="title class_">Helpers</span>::<span class="title function_ invoke__">result</span>(<span class="hljs-literal">false</span>, <span class="hljs-string">&#x27;The order has already been paid&#x27;</span>, <span class="hljs-number">400</span>);</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">if</span> (<span class="title class_">Order</span>::<span class="title function_ invoke__">checkIfOrderExpired</span>(<span class="hljs-variable">$orders</span>))</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="title class_">Helpers</span>::<span class="title function_ invoke__">result</span>(<span class="hljs-literal">false</span>, <span class="hljs-string">&#x27;The order has expired&#x27;</span>, <span class="hljs-number">400</span>);</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">if</span> (<span class="hljs-variable">$recipient</span>-&gt;user_id !== <span class="title class_">User</span>::<span class="title function_ invoke__">getUserID</span>(<span class="hljs-variable">$request</span>))</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="title class_">Helpers</span>::<span class="title function_ invoke__">result</span>(<span class="hljs-literal">false</span>, <span class="hljs-string">&#x27;The recipient doesn\&#x27;t belong to the user&#x27;</span>, <span class="hljs-number">400</span>);</span><br></pre></td></tr></table></figure>

<h2 id="Collect-required-information"><a href="#Collect-required-information" class="headerlink" title="Collect required information."></a>Collect required information.</h2><p>When I was working, it seemed that I had more time than front end, lol, so I decided to take care as mush information as possible, managing to let front end do more things with the least information.</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-variable">$toBeSavedInfo</span> = [</span><br><span class="line">    <span class="hljs-string">&#x27;total_amount&#x27;</span> =&gt; <span class="title class_">Order</span>::<span class="title function_ invoke__">getTotalAmountForPayments</span>(<span class="hljs-variable">$orders</span>),</span><br><span class="line">    <span class="hljs-string">&#x27;orders_name&#x27;</span> =&gt; <span class="title class_">Order</span>::<span class="title function_ invoke__">getOrdersNameForPayments</span>(<span class="hljs-variable">$orders</span>),</span><br><span class="line">    <span class="hljs-string">&#x27;merchant_trade_no&#x27;</span> =&gt; <span class="title function_ invoke__">time</span>() . <span class="title class_">Helpers</span>::<span class="title function_ invoke__">createAUniqueNumber</span>(),</span><br><span class="line">    <span class="hljs-string">&#x27;merchant_trade_date&#x27;</span> =&gt; <span class="title function_ invoke__">date</span>(<span class="hljs-string">&#x27;Y/m/d H:i:s&#x27;</span>),</span><br><span class="line">    <span class="hljs-string">&#x27;trade_desc&#x27;</span> =&gt; <span class="hljs-string">&#x27;BuyBuyGo&#x27;</span>,</span><br><span class="line">    <span class="hljs-string">&#x27;quantity&#x27;</span> =&gt; <span class="hljs-number">1</span>,</span><br><span class="line">    <span class="hljs-string">&#x27;user_id&#x27;</span> =&gt; <span class="title class_">User</span>::<span class="title function_ invoke__">getUserID</span>(<span class="hljs-variable">$request</span>),</span><br><span class="line">    <span class="hljs-string">&#x27;payment_service&#x27;</span> =&gt; <span class="hljs-variable">$thirdPartyPaymentService</span>,</span><br><span class="line">    <span class="hljs-string">&#x27;expiry_time&#x27;</span> =&gt; (<span class="hljs-keyword">new</span> <span class="title class_">Carbon</span>())-&gt;<span class="title function_ invoke__">now</span>()-&gt;<span class="title function_ invoke__">addDay</span>(<span class="hljs-number">1</span>)-&gt;<span class="title function_ invoke__">toDateTimeString</span>(),</span><br><span class="line">    <span class="hljs-string">&#x27;orders&#x27;</span> =&gt; <span class="hljs-variable">$orders</span>,</span><br><span class="line">    <span class="hljs-string">&#x27;mc_currency&#x27;</span> =&gt; <span class="hljs-string">&#x27;TWD&#x27;</span>,</span><br><span class="line">    <span class="hljs-string">&#x27;ClintBackURL&#x27;</span> =&gt; <span class="hljs-variable">$request</span>-&gt;ClintBackURL</span><br><span class="line">];</span><br></pre></td></tr></table></figure>


<h2 id="Splitting-point"><a href="#Splitting-point" class="headerlink" title="Splitting point"></a>Splitting point</h2><p>Since I use two payment services in this project, so I need a place to determine where the request is from and should go</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">switch</span> (<span class="hljs-variable">$thirdPartyPaymentService</span>-&gt;id)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:</span><br><span class="line">        <span class="hljs-variable">$error</span> = (<span class="hljs-keyword">new</span> <span class="title class_">AllPay</span>)-&gt;<span class="title function_ invoke__">make</span>(<span class="hljs-variable">$toBeSavedInfo</span>, <span class="hljs-variable">$request</span>, <span class="hljs-variable">$recipient</span>);</span><br><span class="line">        <span class="hljs-keyword">if</span>(<span class="hljs-variable">$error</span>)</span><br><span class="line">            <span class="hljs-keyword">return</span> <span class="title class_">Helpers</span>::<span class="title function_ invoke__">result</span>(<span class="hljs-literal">false</span>, <span class="hljs-variable">$error</span>,<span class="hljs-number">400</span>);</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">return</span> (<span class="hljs-keyword">new</span> <span class="title class_">AllPay</span>())-&gt;<span class="title function_ invoke__">send</span>(<span class="hljs-variable">$toBeSavedInfo</span>, <span class="hljs-variable">$request</span>);</span><br><span class="line">        <span class="hljs-keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:</span><br><span class="line">        <span class="hljs-variable">$error</span> = (<span class="hljs-keyword">new</span> <span class="title class_">PayPal</span>)-&gt;<span class="title function_ invoke__">make</span>(<span class="hljs-variable">$toBeSavedInfo</span>, <span class="hljs-variable">$request</span>, <span class="hljs-variable">$recipient</span>);</span><br><span class="line">        <span class="hljs-keyword">if</span>(<span class="hljs-variable">$error</span>)</span><br><span class="line">            <span class="hljs-keyword">return</span> <span class="title class_">Helpers</span>::<span class="title function_ invoke__">result</span>(<span class="hljs-literal">false</span>, <span class="hljs-variable">$error</span>, <span class="hljs-number">400</span>);</span><br><span class="line"></span><br><span class="line">        <span class="hljs-variable">$url</span> = (<span class="hljs-keyword">new</span> <span class="title class_">PayPal</span>)-&gt;<span class="title function_ invoke__">send</span>(<span class="hljs-variable">$toBeSavedInfo</span>, <span class="hljs-variable">$request</span>, <span class="hljs-variable">$recipient</span>);</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="title class_">Helpers</span>::<span class="title function_ invoke__">result</span>(<span class="hljs-literal">true</span>, <span class="hljs-variable">$url</span>, <span class="hljs-number">200</span>);</span><br><span class="line">        <span class="hljs-keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Make-a-payment-order"><a href="#Make-a-payment-order" class="headerlink" title="Make a payment order"></a>Make a payment order</h2><p>Whenever the user call <code>PAY API</code>, a temporary order will be built, which is only between the seller and PayPal.<br>Because I’m going to insert data into two tables at a time, we I am going to use Laravel’s Transaction to implement the data inserting work. If you are interested in Transaction of Laravel, you could refer to a short <a href="https://tn710617.github.io/zh-tw/AllPayPaymentService/#%E5%BB%BA%E7%AB%8B%E9%87%91%E6%B5%81%E8%A8%82%E5%96%AE-%E9%80%99%E9%83%A8%E5%88%86%E5%B1%AC%E5%80%8B%E4%BA%BA%E8%A1%A8%E6%A0%BC%E8%A8%AD%E8%A8%88%EF%BC%8C%E5%B8%B6%E5%85%A5%E5%8F%83%E6%95%B8%E6%AF%8F%E5%80%8B%E4%BA%BA%E9%83%BD%E4%B8%8D%E5%90%8C">section</a> in my another article, which I mentioned a bit.</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">make</span>(<span class="hljs-params">Array <span class="hljs-variable">$toBeSavedInfo</span>, Request <span class="hljs-variable">$request</span>, Recipient <span class="hljs-variable">$recipient</span></span>)</span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    DB::<span class="title function_ invoke__">beginTransaction</span>();</span><br><span class="line">    <span class="hljs-keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="hljs-variable">$PayPal</span> = <span class="hljs-keyword">new</span> <span class="hljs-built_in">self</span>();</span><br><span class="line"></span><br><span class="line">        <span class="hljs-variable">$PayPal</span>-&gt;user_id = <span class="hljs-variable">$toBeSavedInfo</span>[<span class="hljs-string">&#x27;user_id&#x27;</span>];</span><br><span class="line">        <span class="hljs-variable">$PayPal</span>-&gt;payment_service_id = <span class="hljs-variable">$toBeSavedInfo</span>[<span class="hljs-string">&#x27;payment_service&#x27;</span>]-&gt;id;</span><br><span class="line">        <span class="hljs-variable">$PayPal</span>-&gt;expiry_time = <span class="hljs-variable">$toBeSavedInfo</span>[<span class="hljs-string">&#x27;expiry_time&#x27;</span>];</span><br><span class="line">        <span class="hljs-variable">$PayPal</span>-&gt;merchant_trade_no = <span class="hljs-variable">$toBeSavedInfo</span>[<span class="hljs-string">&#x27;merchant_trade_no&#x27;</span>];</span><br><span class="line">        <span class="hljs-variable">$PayPal</span>-&gt;total_amount = <span class="hljs-variable">$toBeSavedInfo</span>[<span class="hljs-string">&#x27;total_amount&#x27;</span>];</span><br><span class="line">        <span class="hljs-variable">$PayPal</span>-&gt;trade_desc = <span class="hljs-variable">$toBeSavedInfo</span>[<span class="hljs-string">&#x27;trade_desc&#x27;</span>];</span><br><span class="line">        <span class="hljs-variable">$PayPal</span>-&gt;item_name = <span class="hljs-variable">$toBeSavedInfo</span>[<span class="hljs-string">&#x27;orders_name&#x27;</span>];</span><br><span class="line">        <span class="hljs-variable">$PayPal</span>-&gt;mc_currency = <span class="hljs-variable">$toBeSavedInfo</span>[<span class="hljs-string">&#x27;mc_currency&#x27;</span>];</span><br><span class="line">        <span class="hljs-variable">$PayPal</span>-&gt;recipient_id = <span class="hljs-variable">$recipient</span>-&gt;id;</span><br><span class="line">        <span class="hljs-variable">$PayPal</span>-&gt;<span class="title function_ invoke__">save</span>();</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$toBeSavedInfo</span>[<span class="hljs-string">&#x27;orders&#x27;</span>] <span class="hljs-keyword">as</span> <span class="hljs-variable">$order</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="hljs-variable">$order_relations</span> = <span class="hljs-keyword">new</span> <span class="title class_">OrderRelations</span>();</span><br><span class="line">            <span class="hljs-variable">$order_relations</span>-&gt;payment_service_id = <span class="hljs-variable">$toBeSavedInfo</span>[<span class="hljs-string">&#x27;payment_service&#x27;</span>]-&gt;id;</span><br><span class="line">            <span class="hljs-variable">$order_relations</span>-&gt;payment_service_order_id = <span class="hljs-variable">$PayPal</span>-&gt;id;</span><br><span class="line">            <span class="hljs-variable">$order_relations</span>-&gt;order_id = <span class="hljs-variable">$order</span>-&gt;id;</span><br><span class="line">            <span class="hljs-variable">$order_relations</span>-&gt;<span class="title function_ invoke__">save</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="hljs-keyword">catch</span> (<span class="hljs-built_in">Exception</span> <span class="hljs-variable">$e</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        DB::<span class="title function_ invoke__">rollBack</span>();</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;something went wrong with DB&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    DB::<span class="title function_ invoke__">commit</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Make-a-URL-for-submitting-the-payment-request-to-PayPal"><a href="#Make-a-URL-for-submitting-the-payment-request-to-PayPal" class="headerlink" title="Make a URL for submitting the payment request to PayPal"></a>Make a URL for submitting the payment request to PayPal</h2><p>Here we will use a lot of variables of PayPal Payment Standard. You could refer to the usage of every of them from this <a href="https://tn710617.github.io/zh-tw/submitMultipleItemsInPayPalIPNmethod/">article</a><br>By the way, because when Ray doing this project, the front end’s schedule was a bit tighter than Ray, so Ray decided to handle as much information as possible. The backend will collect all those information from orders that have been built, and feed PayPal with those information. So basically the front end only has to let me know what orders the user want to pay.</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">send</span>(<span class="hljs-params">Array <span class="hljs-variable">$toBeSavedInfo</span>, Request <span class="hljs-variable">$request</span>, Recipient <span class="hljs-variable">$recipient</span></span>)</span></span><br><span class="line"><span class="hljs-function"></span>&#123;   </span><br><span class="line">    <span class="hljs-variable">$enableSandbox</span> = <span class="title function_ invoke__">env</span>(<span class="hljs-string">&#x27;PAYPAL_SANDBOX_ENABLESANDBOX&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="hljs-variable">$paypalUrl</span> = <span class="hljs-variable">$enableSandbox</span> ? <span class="hljs-string">&#x27;https://www.sandbox.paypal.com/cgi-bin/webscr&#x27;</span> : <span class="hljs-string">&#x27;https://www.paypal.com/cgi-bin/webscr&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-variable">$data</span> = [];</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// Set PayPal account. You might need to apply test account of either seller or buyer via the link below. We will need to enter seller&#x27;s account here, so whenever an order is paid, the payment will be automatically transferred into this account. </span></span><br><span class="line">    <span class="hljs-comment">// https://developer.paypal.com/developer/accounts/</span></span><br><span class="line">    <span class="hljs-variable">$data</span>[<span class="hljs-string">&#x27;business&#x27;</span>] = <span class="title function_ invoke__">env</span>(<span class="hljs-string">&#x27;PAYPAL_SANDBOX_MAIL&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// Set the PayPal return addresses, after the transaction is completed, the user could be back via this URL.</span></span><br><span class="line">    <span class="hljs-variable">$data</span>[<span class="hljs-string">&#x27;return&#x27;</span>] = <span class="hljs-variable">$toBeSavedInfo</span>[<span class="hljs-string">&#x27;ClintBackURL&#x27;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// During the transaction process on PayPal&#x27;s site, the user could cancel the transaction and go back via this URL.</span></span><br><span class="line">    <span class="hljs-variable">$data</span>[<span class="hljs-string">&#x27;cancel_return&#x27;</span>] = <span class="title function_ invoke__">env</span>(<span class="hljs-string">&#x27;PAYPAL_SANDBOX_CANCEL_URL&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// After the transaction is completed, PayPal will send IPN message to this URL.</span></span><br><span class="line">    <span class="hljs-variable">$data</span>[<span class="hljs-string">&#x27;notify_url&#x27;</span>] = <span class="title function_ invoke__">env</span>(<span class="hljs-string">&#x27;PAYPAL_SANDBOX_NOFITY_URL&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// Set the details about the products being purchased, including the price for every individual</span></span><br><span class="line">    <span class="hljs-comment">// and currency so that these aren&#x27;t overridden by the form data.</span></span><br><span class="line">    <span class="hljs-variable">$i</span> = <span class="hljs-number">1</span>;</span><br><span class="line">    <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$toBeSavedInfo</span>[<span class="hljs-string">&#x27;orders&#x27;</span>] <span class="hljs-keyword">as</span> <span class="hljs-variable">$order</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="hljs-variable">$data</span>[<span class="hljs-string">&quot;item_name_<span class="hljs-subst">$i</span>&quot;</span>] = <span class="hljs-variable">$order</span>-&gt;item_name;</span><br><span class="line">        <span class="hljs-variable">$data</span>[<span class="hljs-string">&quot;item_number_<span class="hljs-subst">$i</span>&quot;</span>] = <span class="hljs-variable">$order</span>-&gt;quantity;</span><br><span class="line">        <span class="hljs-variable">$data</span>[<span class="hljs-string">&quot;amount_<span class="hljs-subst">$i</span>&quot;</span>] = <span class="hljs-variable">$order</span>-&gt;total_amount;</span><br><span class="line">        <span class="hljs-variable">$i</span>++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// Here we specify the currency, you could refer to the supported currency from the link below</span></span><br><span class="line">    <span class="hljs-comment">// https://developer.paypal.com/docs/classic/api/currency_codes/</span></span><br><span class="line">    <span class="hljs-variable">$data</span>[<span class="hljs-string">&#x27;currency_code&#x27;</span>] = <span class="hljs-variable">$toBeSavedInfo</span>[<span class="hljs-string">&#x27;mc_currency&#x27;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// Add any custom fields for the query string. We will pass this value to PayPal, and it will return along with IPN Message from PayPal. In this case, I pass the order number of payment order.</span></span><br><span class="line">    <span class="hljs-variable">$data</span>[<span class="hljs-string">&#x27;custom&#x27;</span>] = <span class="hljs-variable">$toBeSavedInfo</span>[<span class="hljs-string">&#x27;merchant_trade_no&#x27;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// Add recipient&#x27;s information, and show it on paying process</span></span><br><span class="line">    <span class="hljs-variable">$data</span>[<span class="hljs-string">&#x27;address_override&#x27;</span>] = <span class="hljs-number">1</span>;</span><br><span class="line">    <span class="hljs-variable">$data</span>[<span class="hljs-string">&#x27;country&#x27;</span>] = <span class="hljs-variable">$recipient</span>-&gt;country_code;</span><br><span class="line">    <span class="hljs-variable">$data</span>[<span class="hljs-string">&#x27;city&#x27;</span>] = <span class="hljs-variable">$recipient</span>-&gt;city;</span><br><span class="line">    <span class="hljs-variable">$data</span>[<span class="hljs-string">&#x27;address1&#x27;</span>] = <span class="hljs-variable">$recipient</span>-&gt;others;</span><br><span class="line">    <span class="hljs-variable">$data</span>[<span class="hljs-string">&#x27;zip&#x27;</span>] = <span class="hljs-variable">$recipient</span>-&gt;postcode;</span><br><span class="line">    <span class="hljs-variable">$data</span>[<span class="hljs-string">&#x27;first_name&#x27;</span>] = <span class="hljs-variable">$recipient</span>-&gt;name;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// This setting allow to add multiple items with IPN method</span></span><br><span class="line">    <span class="hljs-variable">$data</span>[<span class="hljs-string">&#x27;upload&#x27;</span>] = <span class="hljs-string">&#x27;1&#x27;</span>;</span><br><span class="line">    <span class="hljs-variable">$data</span>[<span class="hljs-string">&#x27;cmd&#x27;</span>] = <span class="hljs-string">&quot;_cart&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// Add charset</span></span><br><span class="line">    <span class="hljs-variable">$data</span>[<span class="hljs-string">&#x27;charset&#x27;</span>] = <span class="hljs-string">&#x27;utf-8&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// Build the query string from the data.</span></span><br><span class="line">    <span class="hljs-variable">$queryString</span> = <span class="title function_ invoke__">http_build_query</span>(<span class="hljs-variable">$data</span>);</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// Build the URL to PayPal</span></span><br><span class="line">    <span class="hljs-variable">$url</span> = <span class="hljs-variable">$paypalUrl</span> . <span class="hljs-string">&#x27;?&#x27;</span> . <span class="hljs-variable">$queryString</span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-variable">$url</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="Pay-the-payment"><a href="#Pay-the-payment" class="headerlink" title="Pay the payment"></a>Pay the payment</h2><ol>
<li>The user reach the PayPal payment page via the URL we produced above. Please register test account via link <a target="_blank" rel="noopener" href="https://developer.paypal.com/developer/accounts/">here</a></li>
</ol>
<p><img src="https://i.imgur.com/oCOCdLi.png"></p>
<ol start="2">
<li><p>Reach payment page<br><img src="https://i.imgur.com/FQ90eUB.png"></p>
</li>
<li><p>Here we could see the items in detail, including price and quantity. Click continue to go on<br><img src="https://i.imgur.com/EAPA4y3.png"></p>
</li>
<li><p>Here we could see the shipping address we designated<br><img src="https://i.imgur.com/RY4BEJ1.png"></p>
</li>
<li><p>Transaction completed, and here we could see all the details<br><img src="https://i.imgur.com/rs3VIBN.png"></p>
</li>
</ol>
<h2 id="Verify-payment-state"><a href="#Verify-payment-state" class="headerlink" title="Verify payment state"></a>Verify payment state</h2><p>After the payment is completed, PayPal will send an IPN message to us. You could check the IPN in detail through the <a target="_blank" rel="noopener" href="https://developer.paypal.com/docs/classic/products/instant-payment-notification/">official document</a></p>
<ol>
<li><p>Firstly, let’s install PayPal’s official <a target="_blank" rel="noopener" href="https://github.com/paypal/ipn-code-samples">IPN CODE SAMPLES</a></p>
<figure class="highlight plaintext hljs"><table><tr><td class="code"><pre><span class="line">git clone https://github.com/paypal/ipn-code-samples</span><br></pre></td></tr></table></figure></li>
<li><p>In <code>php</code> directory</p>
<figure class="highlight plaintext hljs"><table><tr><td class="code"><pre><span class="line">cd ipn-code-samples/php</span><br></pre></td></tr></table></figure></li>
<li><p>And then, let’s copy <code>PaypalIPN.php into our project</code>, Ray personally put it under <code>app</code></p>
</li>
<li><p>Now, put the folder <code>cert</code> that is under <code>ipn-code-samples</code> also into <code>app</code> as image below:<br><img src="https://i.imgur.com/NfzG9Cj.png"></p>
</li>
<li><p>In <code>composer.json file</code>, search <code>files</code> under <code>autoload-dev</code>, and add <code>PaypalIPN.php</code>. If there is no <code>files</code> in your <code>composer.json</code>, you might need to create one yourself</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-string">&quot;autoload-dev&quot;</span>: &#123;</span><br><span class="line">    <span class="hljs-string">&quot;psr-4&quot;</span>: &#123;</span><br><span class="line">        <span class="hljs-string">&quot;Tests\\&quot;</span>: <span class="hljs-string">&quot;tests/&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="hljs-string">&quot;files&quot;</span>: [</span><br><span class="line">        <span class="hljs-string">&quot;app/Helpers.php&quot;</span>,</span><br><span class="line">        <span class="hljs-string">&quot;app/AllPay.Payment.Integration.php&quot;</span>,</span><br><span class="line">        <span class="hljs-string">&quot;app/PaypalIPN.php&quot;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure></li>
<li><p>On <code>terminal</code> window, in our project folder, execute <code>composer</code> command</p>
<figure class="highlight plaintext hljs"><table><tr><td class="code"><pre><span class="line">composer install</span><br></pre></td></tr></table></figure></li>
<li><p>Now basically we have everything except for the one last step. Copy the content of <code>example_usage_advanced.php</code> into wherever you want. It could be one of your controllers, or a function under certain class as follows:<br>The code below is a bit long. It should be almost the same as the original sample code except for some I put comment to, so you don’t have to go through every of them.</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">listen</span>(<span class="hljs-params">Request <span class="hljs-variable">$request</span></span>)</span></span><br><span class="line"><span class="hljs-function">    </span>&#123;</span><br><span class="line">        <span class="hljs-comment">// Since the offical sample is to catch $_POST, so I convert the request of Laravel into POST. You could modify it on your own.</span></span><br><span class="line">        <span class="hljs-variable">$_POST</span> = <span class="hljs-variable">$request</span>-&gt;<span class="title function_ invoke__">post</span>();</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">// It shows if the payment is cleared.</span></span><br><span class="line">        <span class="hljs-variable">$payment_status</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;payment_status&#x27;</span>];</span><br><span class="line">        </span><br><span class="line">        <span class="hljs-comment">// Remember the payment service order we passed to PayPal that I mentioned earlier</span></span><br><span class="line">        <span class="hljs-variable">$merchant_trade_no</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;custom&#x27;</span>];</span><br><span class="line">        </span><br><span class="line">        <span class="hljs-comment">// Very important. We will use it later</span></span><br><span class="line">        <span class="hljs-variable">$txn_id</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;txn_id&#x27;</span>];</span><br><span class="line">        </span><br><span class="line">        <span class="hljs-variable">$txn_type</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;txn_type&#x27;</span>];</span><br><span class="line">        </span><br><span class="line">        <span class="hljs-comment">// When the payment is paid</span></span><br><span class="line">        <span class="hljs-variable">$payment_date</span> = <span class="title class_">Carbon</span>::<span class="title function_ invoke__">parse</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;payment_date&#x27;</span>])-&gt;<span class="title function_ invoke__">setTimezone</span>(<span class="hljs-string">&#x27;UTC&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="hljs-comment">// The total amount </span></span><br><span class="line">        <span class="hljs-variable">$mc_gross</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;mc_gross&#x27;</span>];</span><br><span class="line">        </span><br><span class="line">        <span class="hljs-variable">$mc_currency</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;mc_currency&#x27;</span>];</span><br><span class="line"></span><br><span class="line">        <span class="hljs-variable">$enable_sandbox</span> = <span class="title function_ invoke__">env</span>(<span class="hljs-string">&#x27;PAYPAL_SANDBOX_ENABLESANDBOX&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// Use this to specify all of the email addresses that you have attached to paypal:</span></span><br><span class="line">        <span class="hljs-variable">$my_email_addresses</span> = <span class="hljs-keyword">array</span>(<span class="title function_ invoke__">env</span>(<span class="hljs-string">&#x27;PAYPAL_SANDBOX_MAIL&#x27;</span>));</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// Set this to true to send a confirmation email:</span></span><br><span class="line">        <span class="hljs-variable">$send_confirmation_email</span> = <span class="title function_ invoke__">env</span>(<span class="hljs-string">&#x27;PAYPAL_SANDBOX_SEND_CONFIRMATION_EMAIL&#x27;</span>);</span><br><span class="line">        <span class="hljs-variable">$confirmation_email_address</span> = <span class="hljs-string">&quot;buybuybuygogo@gmail.com&quot;</span>;</span><br><span class="line">        <span class="hljs-variable">$from_email_address</span> = <span class="hljs-string">&quot;test@gmail.com&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// Set this to true to save a log file:</span></span><br><span class="line">        <span class="hljs-variable">$save_log_file</span> = <span class="title function_ invoke__">env</span>(<span class="hljs-string">&#x27;PAYPAL_SANDBOX_SAVE_LOG_FILE&#x27;</span>);</span><br><span class="line">        <span class="hljs-variable">$log_file_dir</span> = <span class="title function_ invoke__">storage_path</span>() . <span class="hljs-string">&quot;/app/payment_logs&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// Here is some information on how to configure sendmail:</span></span><br><span class="line"><span class="hljs-comment">// http://php.net/manual/en/function.mail.php#118210</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// Here is the function verifying the IPN message.</span></span><br><span class="line">        <span class="hljs-variable">$ipn</span> = <span class="hljs-keyword">new</span> <span class="title function_ invoke__">PaypalIPN</span>();</span><br><span class="line">        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$enable_sandbox</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="hljs-variable">$ipn</span>-&gt;<span class="title function_ invoke__">useSandbox</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-variable">$verified</span> = <span class="hljs-variable">$ipn</span>-&gt;<span class="title function_ invoke__">verifyIPN</span>();</span><br><span class="line"></span><br><span class="line">        <span class="hljs-variable">$data_text</span> = <span class="hljs-string">&quot;&quot;</span>;</span><br><span class="line">        <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$_POST</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$key</span> =&gt; <span class="hljs-variable">$value</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="hljs-variable">$data_text</span> .= <span class="hljs-variable">$key</span> . <span class="hljs-string">&quot; = &quot;</span> . <span class="hljs-variable">$value</span> . <span class="hljs-string">&quot;\r\n&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-variable">$test_text</span> = <span class="hljs-string">&quot;&quot;</span>;</span><br><span class="line">        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&quot;test_ipn&quot;</span>] == <span class="hljs-number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="hljs-variable">$test_text</span> = <span class="hljs-string">&quot;Test &quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// Check the receiver email to see if it matches your list of paypal email addresses</span></span><br><span class="line">        <span class="hljs-variable">$receiver_email_found</span> = <span class="hljs-literal">false</span>;</span><br><span class="line">        <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$my_email_addresses</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$a</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="hljs-keyword">if</span> (<span class="title function_ invoke__">strtolower</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&quot;receiver_email&quot;</span>]) == <span class="title function_ invoke__">strtolower</span>(<span class="hljs-variable">$a</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="hljs-variable">$receiver_email_found</span> = <span class="hljs-literal">true</span>;</span><br><span class="line">                <span class="hljs-keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">date_default_timezone_set</span>(<span class="hljs-string">&quot;America/Los_Angeles&quot;</span>);</span><br><span class="line">        <span class="hljs-keyword">list</span>(<span class="hljs-variable">$year</span>, <span class="hljs-variable">$month</span>, <span class="hljs-variable">$day</span>, <span class="hljs-variable">$hour</span>, <span class="hljs-variable">$minute</span>, <span class="hljs-variable">$second</span>, <span class="hljs-variable">$timezone</span>) = <span class="title function_ invoke__">explode</span>(<span class="hljs-string">&quot;:&quot;</span>, <span class="title function_ invoke__">date</span>(<span class="hljs-string">&quot;Y:m:d:H:i:s:T&quot;</span>));</span><br><span class="line">        <span class="hljs-variable">$date</span> = <span class="hljs-variable">$year</span> . <span class="hljs-string">&quot;-&quot;</span> . <span class="hljs-variable">$month</span> . <span class="hljs-string">&quot;-&quot;</span> . <span class="hljs-variable">$day</span>;</span><br><span class="line">        <span class="hljs-variable">$timestamp</span> = <span class="hljs-variable">$date</span> . <span class="hljs-string">&quot; &quot;</span> . <span class="hljs-variable">$hour</span> . <span class="hljs-string">&quot;:&quot;</span> . <span class="hljs-variable">$minute</span> . <span class="hljs-string">&quot;:&quot;</span> . <span class="hljs-variable">$second</span> . <span class="hljs-string">&quot; &quot;</span> . <span class="hljs-variable">$timezone</span>;</span><br><span class="line">        <span class="hljs-variable">$dated_log_file_dir</span> = <span class="hljs-variable">$log_file_dir</span> . <span class="hljs-string">&quot;/&quot;</span> . <span class="hljs-variable">$year</span> . <span class="hljs-string">&quot;/&quot;</span> . <span class="hljs-variable">$month</span>;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-variable">$paypal_ipn_status</span> = <span class="hljs-string">&quot;VERIFICATION FAILED&quot;</span>;</span><br><span class="line">        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$verified</span>)</span><br><span class="line">        &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="hljs-comment">// When it passes the if below, it means that the IPN is verified, so we could do something after that.</span></span><br><span class="line">            <span class="hljs-variable">$paypal_ipn_status</span> = <span class="hljs-string">&quot;RECEIVER EMAIL MISMATCH&quot;</span>;</span><br><span class="line">            <span class="hljs-keyword">if</span> (<span class="hljs-variable">$receiver_email_found</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="hljs-variable">$paypal_ipn_status</span> = <span class="hljs-string">&quot;Completed Successfully&quot;</span>;</span><br><span class="line"></span><br><span class="line">                <span class="hljs-variable">$PayPal</span> = (<span class="hljs-keyword">new</span> <span class="title class_">PayPal</span>())-&gt;<span class="title function_ invoke__">where</span>(<span class="hljs-string">&#x27;merchant_trade_no&#x27;</span>, <span class="hljs-variable">$merchant_trade_no</span>)-&gt;<span class="title function_ invoke__">first</span>();</span><br><span class="line"></span><br><span class="line">                <span class="hljs-comment">// Here we check a few things as follows:</span></span><br><span class="line">                <span class="hljs-comment">// 1. Check txd_id to prevent double processing some transaction that was previously processed. If this txd_id already exists in our database, we should ignore it.</span></span><br><span class="line">                <span class="hljs-comment">// 2. Check mc_gross, which should be exactly the same as the total amount in our payment service order.</span></span><br><span class="line">                <span class="hljs-comment">// 3. Check mc_currency to make sure it&#x27;s the same as the one in our payment service order.</span></span><br><span class="line">                <span class="hljs-comment">// 4. Check payment_status to make sure that the transaction is completed.</span></span><br><span class="line">                </span><br><span class="line">                <span class="hljs-keyword">if</span> ((!<span class="title class_">PayPal</span>::<span class="title function_ invoke__">checkIfTxnIdExists</span>(<span class="hljs-variable">$txn_id</span>)) &amp;&amp; (<span class="hljs-variable">$mc_gross</span> == <span class="hljs-variable">$PayPal</span>-&gt;total_amount) &amp;&amp; (<span class="hljs-variable">$mc_currency</span> == <span class="hljs-variable">$PayPal</span>-&gt;mc_currency) &amp;&amp; (<span class="hljs-variable">$payment_status</span> == <span class="hljs-string">&#x27;Completed&#x27;</span>))</span><br><span class="line">                &#123;</span><br><span class="line">                <span class="hljs-comment">// Insert txd_id into the payment service order and update some values, which shows if this order is cleared or not.</span></span><br><span class="line">                    <span class="hljs-variable">$PayPal</span>-&gt;<span class="title function_ invoke__">update</span>([<span class="hljs-string">&#x27;txn_id&#x27;</span> =&gt; <span class="hljs-variable">$txn_id</span>, <span class="hljs-string">&#x27;txn_type&#x27;</span> =&gt; <span class="hljs-variable">$txn_type</span>, <span class="hljs-string">&#x27;payment_date&#x27;</span> =&gt; <span class="hljs-variable">$payment_date</span>, <span class="hljs-string">&#x27;status&#x27;</span> =&gt; <span class="hljs-number">1</span>, <span class="hljs-string">&#x27;expiry_time&#x27;</span> =&gt; <span class="hljs-literal">null</span>]);</span><br><span class="line">                    <span class="hljs-variable">$recipient</span> = <span class="hljs-variable">$PayPal</span>-&gt;recipient;</span><br><span class="line"></span><br><span class="line">                    <span class="hljs-variable">$orderRelations</span> = <span class="hljs-variable">$PayPal</span>-&gt;orderRelations-&gt;<span class="title function_ invoke__">where</span>(<span class="hljs-string">&#x27;payment_service_id&#x27;</span>, <span class="hljs-number">2</span>);</span><br><span class="line"></span><br><span class="line">                <span class="hljs-comment">// After updating the payment service order, we update the user order accordingly.</span></span><br><span class="line">                    <span class="title class_">Order</span>::<span class="title function_ invoke__">updateStatus</span>(<span class="hljs-variable">$orderRelations</span>, <span class="hljs-variable">$recipient</span>);</span><br><span class="line"></span><br><span class="line">                <span class="hljs-comment">// After everything is perfectly done, we send a notification mail to the buyer and seller</span></span><br><span class="line">                    <span class="title class_">Helpers</span>::<span class="title function_ invoke__">mailWhenPaid</span>(<span class="hljs-variable">$PayPal</span>, <span class="hljs-variable">$orderRelations</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="hljs-keyword">elseif</span> (<span class="hljs-variable">$enable_sandbox</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="hljs-keyword">if</span> (<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&quot;test_ipn&quot;</span>] != <span class="hljs-number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="hljs-variable">$paypal_ipn_status</span> = <span class="hljs-string">&quot;RECEIVED FROM LIVE WHILE SANDBOXED&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="hljs-keyword">elseif</span> (<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&quot;test_ipn&quot;</span>] == <span class="hljs-number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="hljs-variable">$paypal_ipn_status</span> = <span class="hljs-string">&quot;RECEIVED FROM SANDBOX WHILE LIVE&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$save_log_file</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="hljs-comment">// Create log file directory</span></span><br><span class="line">            <span class="hljs-keyword">if</span> (!<span class="title function_ invoke__">is_dir</span>(<span class="hljs-variable">$dated_log_file_dir</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="hljs-keyword">if</span> (!<span class="title function_ invoke__">file_exists</span>(<span class="hljs-variable">$dated_log_file_dir</span>))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="title function_ invoke__">mkdir</span>(<span class="hljs-variable">$dated_log_file_dir</span>, <span class="hljs-number">0777</span>, <span class="hljs-literal">true</span>);</span><br><span class="line">                    <span class="hljs-keyword">if</span> (!<span class="title function_ invoke__">is_dir</span>(<span class="hljs-variable">$dated_log_file_dir</span>))</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="hljs-variable">$save_log_file</span> = <span class="hljs-literal">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="hljs-keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="hljs-variable">$save_log_file</span> = <span class="hljs-literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="hljs-comment">// Restrict web access to files in the log file directory</span></span><br><span class="line">            <span class="hljs-variable">$htaccess_body</span> = <span class="hljs-string">&quot;RewriteEngine On&quot;</span> . <span class="hljs-string">&quot;\r\n&quot;</span> . <span class="hljs-string">&quot;RewriteRule .* - [L,R=404]&quot;</span>;</span><br><span class="line">            <span class="hljs-keyword">if</span> (<span class="hljs-variable">$save_log_file</span> &amp;&amp; (!<span class="title function_ invoke__">is_file</span>(<span class="hljs-variable">$log_file_dir</span> . <span class="hljs-string">&quot;/.htaccess&quot;</span>) || <span class="title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$log_file_dir</span> . <span class="hljs-string">&quot;/.htaccess&quot;</span>) !== <span class="hljs-variable">$htaccess_body</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="hljs-keyword">if</span> (!<span class="title function_ invoke__">is_dir</span>(<span class="hljs-variable">$log_file_dir</span> . <span class="hljs-string">&quot;/.htaccess&quot;</span>))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="title function_ invoke__">file_put_contents</span>(<span class="hljs-variable">$log_file_dir</span> . <span class="hljs-string">&quot;/.htaccess&quot;</span>, <span class="hljs-variable">$htaccess_body</span>);</span><br><span class="line">                    <span class="hljs-keyword">if</span> (!<span class="title function_ invoke__">is_file</span>(<span class="hljs-variable">$log_file_dir</span> . <span class="hljs-string">&quot;/.htaccess&quot;</span>) || <span class="title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$log_file_dir</span> . <span class="hljs-string">&quot;/.htaccess&quot;</span>) !== <span class="hljs-variable">$htaccess_body</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="hljs-variable">$save_log_file</span> = <span class="hljs-literal">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="hljs-keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="hljs-variable">$save_log_file</span> = <span class="hljs-literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="hljs-keyword">if</span> (<span class="hljs-variable">$save_log_file</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="hljs-comment">// Save data to text file</span></span><br><span class="line">                <span class="title function_ invoke__">file_put_contents</span>(<span class="hljs-variable">$dated_log_file_dir</span> . <span class="hljs-string">&quot;/&quot;</span> . <span class="hljs-variable">$test_text</span> . <span class="hljs-string">&quot;paypal_ipn_&quot;</span> . <span class="hljs-variable">$date</span> . <span class="hljs-string">&quot;.txt&quot;</span>, <span class="hljs-string">&quot;paypal_ipn_status = &quot;</span> . <span class="hljs-variable">$paypal_ipn_status</span> . <span class="hljs-string">&quot;\r\n&quot;</span> . <span class="hljs-string">&quot;paypal_ipn_date = &quot;</span> . <span class="hljs-variable">$timestamp</span> . <span class="hljs-string">&quot;\r\n&quot;</span> . <span class="hljs-variable">$data_text</span> . <span class="hljs-string">&quot;\r\n&quot;</span>, FILE_APPEND);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$send_confirmation_email</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="hljs-comment">// Send confirmation email</span></span><br><span class="line">            <span class="title function_ invoke__">mail</span>(<span class="hljs-variable">$confirmation_email_address</span>, <span class="hljs-variable">$test_text</span> . <span class="hljs-string">&quot;PayPal IPN : &quot;</span> . <span class="hljs-variable">$paypal_ipn_status</span>, <span class="hljs-string">&quot;paypal_ipn_status = &quot;</span> . <span class="hljs-variable">$paypal_ipn_status</span> . <span class="hljs-string">&quot;\r\n&quot;</span> . <span class="hljs-string">&quot;paypal_ipn_date = &quot;</span> . <span class="hljs-variable">$timestamp</span> . <span class="hljs-string">&quot;\r\n&quot;</span> . <span class="hljs-variable">$data_text</span>, <span class="hljs-string">&quot;From: &quot;</span> . <span class="hljs-variable">$from_email_address</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// Reply with an empty 200 response to indicate to paypal the IPN was received correctly</span></span><br><span class="line">        <span class="title function_ invoke__">header</span>(<span class="hljs-string">&quot;HTTP/1.1 200 OK&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>Above mentioned is the whole process of using PayPal Payment Standard and PayPal IPN Message to complete a transaction.<br>Here is breakdown of every individual step:<br><img src="https://i.imgur.com/ZCmPwAd.png"></p>
<ol>
<li>A user clicks a PayPal button to kick off a checkout flow; your web application makes an API call; your back-office system makes an API call; or PayPal observes an event.</li>
<li>PayPal HTTPS POSTs your listener an IPN message that notifies you of this event.</li>
<li>Your listener returns an empty HTTP 200 response.</li>
<li>Your listener HTTPS POSTs the complete, unaltered message back to PayPal.</li>
<li>PayPal sends a single word back - either VERIFIED (if the message matches the original) or INVALID (if the message does not match the original).</li>
</ol>

    
    </div>
    
    <div class="columns is-variable is-1 is-multiline is-mobile">
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/tags/PayPal-Payment-Standard/">#PayPal Payment Standard</a></span>
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/tags/PayPal-IPN/">#PayPal IPN</a></span>
    
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop  article-nav-prev">
            
            <a href="/PayPalRestAPI/">Easy Payment Gateway with PayPal REST API</a>
            
        </span>
        <span class="column is-12-mobile is-half-desktop  article-nav-next">
            
            <a href="/submitMultipleItemsInPayPalIPNmethod/">Add multiple items on PayPal IPN method</a>
            
        </span>
    </div>
    
</article>


<div class="sharebox">
    
<div class="sharethis-inline-share-buttons"></div>
<script type='text/javascript' src='//platform-api.sharethis.com/js/sharethis.js#property=5c72643b9ea706001139fd89&amp;product=inline-share-buttons' async='async'></script>

</div>



<div class="comments">
    <h3 class="title is-4">Comments</h3>
    
<script>
    var disqus_config = function () {
        this.page.url = 'https://tn710617.github.io/implementATransactionViaPayPalIPN/';
        this.page.identifier = 'implementATransactionViaPayPalIPN/';
        
        this.language = 'en';
        
    };
    (function() {
        var d = document, s = d.createElement('script');  
        s.src = '//' + 'rayscodingjourney' + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>

<div id="disqus_thread">
    
    <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</div>

    </div>
</section>
    <footer class="footer">
    <div class="container">
        <div class="columns content">
            <div class="column is-narrow has-text-centered">
                &copy; 2022 Ray&nbsp;
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a
                        target="_blank" rel="noopener" href="http://github.com/ppoffice/hexo-theme-minos">Minos</a>
            </div>
            <div class="column is-hidden-mobile"></div>

            <script src='https://unpkg.com/mermaid@7.1.2/dist/mermaid.min.js'></script>
            <script>
                mermaid.initialize({ theme: 'default' });
            </script>

            
            
            <a class="navbar-item" title="GitHub" target="_blank" rel="noopener" href="https://github.com/tn710617">
                
                    <i class="fab fa-github"></i>
                
            </a>
            
            <a class="navbar-item" title="Medium" target="_blank" rel="noopener" href="https://medium.com/@raycodingjourney">
                
                    <i class="fab fa-medium"></i>
                
            </a>
            
            <a class="navbar-item" title="Linkedin" target="_blank" rel="noopener" href="https://www.linkedin.com/in/ray-lee-99315315a">
                
                    <i class="fab fa-linkedin"></i>
                
            </a>
            
            <a class="navbar-item" title="Facebook" target="_blank" rel="noopener" href="https://www.facebook.com/profile.php?id=100001626039430">
                
                    <i class="fab fa-facebook"></i>
                
            </a>
            
            <a class="navbar-item" title="CakeResume" target="_blank" rel="noopener" href="https://www.cakeresume.com/resumes/ray-6edaef/edit">
                
                    <i class="far fa-address-card"></i>
                
            </a>
            
            <a class="navbar-item" title="E-Mail" href="mailto:tn710617@gmail.com">
                
                    <i class="far fa-envelope"></i>
                
            </a>
            
            <a class="navbar-item" title="Skype" href="skype:adad0310?call|chat">
                
                    <i class="fab fa-skype"></i>
                
            </a>
            
            

        </div>
    </div>
</footer>

    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script>

<!-- test if the browser is outdated -->
<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" target="_blank" rel="noopener" href="http://outdatedbrowser.com/">Update my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.js"></script>
<script>
    $(document).ready(function () {
        // plugin function, place inside DOM ready function
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        })
    });
</script>

<script>
    window.FontAwesomeConfig = {
        searchPseudoElements: true
    }
    moment.locale("en-AU");
</script>


    
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<script>
    MathJax.Hub.Config({
        "HTML-CSS": {matchFontHeight: false},
        SVG: {matchFontHeight: false},
        CommonHTML: {matchFontHeight: false}
    });
</script>

    
    
    
    
<script src="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/js/lightgallery-all.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/justifiedGallery/3.6.5/js/jquery.justifiedGallery.min.js"></script>
<script>
    (function ($) {
        $(document).ready(function () {
            if (typeof($.fn.lightGallery) === 'function') {
                $('.article.gallery').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof($.fn.justifiedGallery) === 'function') {
                $('.justified-gallery').justifiedGallery();
            }
        });
    })(jQuery);
</script>

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <style>
        .hljs {
            position: relative;
        }

        .hljs .clipboard-btn {
            float: right;
            color: #9a9a9a;
            background: none;
            border: none;
            cursor: pointer;
        }

        .hljs .clipboard-btn:hover {
          color: #8a8a8a;
        }

        .hljs > .clipboard-btn {
            display: none;
            position: absolute;
            right: 4px;
            top: 4px;
        }

        .hljs:hover > .clipboard-btn {
            display: inline;
        }

        .hljs > figcaption > .clipboard-btn {
            margin-right: 4px;
        }
    </style>
    <script>
      $(document).ready(function () {
        $('figure.hljs').each(function(i, figure) {
          var codeId = 'code-' + i;
          var code = figure.querySelector('.code');
          var copyButton = $('<button>Copy <i class="far fa-clipboard"></i></button>');
          code.id = codeId;
          copyButton.addClass('clipboard-btn');
          copyButton.attr('data-clipboard-target-id', codeId);

          var figcaption = figure.querySelector('figcaption');

          if (figcaption) {
            figcaption.append(copyButton[0]);
          } else {
            figure.prepend(copyButton[0]);
          }
        })

        var clipboard = new ClipboardJS('.clipboard-btn', {
          target: function(trigger) {
            return document.getElementById(trigger.getAttribute('data-clipboard-target-id'));
          }
        });
        clipboard.on('success', function(e) {
          e.clearSelection();
        })
      })
    </script>

    
    

    



<script src="/js/script.js"></script>


    
    <div class="searchbox ins-search">
    <div class="searchbox-mask"></div>
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="Type something..." />
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: 'Posts',
                PAGES: 'Pages',
                CATEGORIES: 'Categories',
                TAGS: 'Tags',
                UNTITLED: '(Untitled)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>

<script src="/js/insight.js"></script>

    
</body>
</html>