<!DOCTYPE html>
<html class="has-navbar-fixed-top">
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
<title>Laravel - Digging Deeper - Queues (官方文件原子化翻譯筆記) - Learn or Die</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="description" content="# Introduction學習一個框架, Ray 的想法是, 在深入理解底層實作的原理之前, 應該先知道這個框架的 使用方法; 先學習怎麼使用這個前人造的輪子, 再學習怎麼樣造一個輪子。所以本篇文章重點在於細讀官方文件, 並將內容理解後以 Q&amp;amp;A 的方式記錄下來, 加速學習以及查詢。">
<meta name="keywords" content="Laravel,Laravel Documentation,Laravel Queues">
<meta property="og:type" content="article">
<meta property="og:title" content="Laravel - Digging Deeper - Queues (官方文件原子化翻譯筆記)">
<meta property="og:url" content="https://tn710617.github.io/zh-tw/laravelDiggingDeeperQueues/index.html">
<meta property="og:site_name" content="Learn or Die">
<meta property="og:description" content="# Introduction學習一個框架, Ray 的想法是, 在深入理解底層實作的原理之前, 應該先知道這個框架的 使用方法; 先學習怎麼使用這個前人造的輪子, 再學習怎麼樣造一個輪子。所以本篇文章重點在於細讀官方文件, 並將內容理解後以 Q&amp;amp;A 的方式記錄下來, 加速學習以及查詢。">
<meta property="og:locale" content="zh-tw">
<meta property="og:updated_time" content="2021-04-25T05:24:21.485Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Laravel - Digging Deeper - Queues (官方文件原子化翻譯筆記)">
<meta name="twitter:description" content="# Introduction學習一個框架, Ray 的想法是, 在深入理解底層實作的原理之前, 應該先知道這個框架的 使用方法; 先學習怎麼使用這個前人造的輪子, 再學習怎麼樣造一個輪子。所以本篇文章重點在於細讀官方文件, 並將內容理解後以 Q&amp;amp;A 的方式記錄下來, 加速學習以及查詢。">


<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.css">


    <link href="/laravelDiggingDeeperQueues/" rel="alternate" hreflang="en">








    <meta name="description" content="# Introduction學習一個框架, Ray 的想法是, 在深入理解底層實作的原理之前, 應該先知道這個框架的 使用方法; 先學習怎麼使用這個前人造的輪子, 再學習怎麼樣造一個輪子。所以本篇文章重點在於細讀官方文件, 並將內容理解後以 Q&amp;amp;A 的方式記錄下來, 加速學習以及查詢。">
<meta name="keywords" content="Laravel,Laravel Documentation,Laravel Queues">
<meta property="og:type" content="article">
<meta property="og:title" content="Laravel - Digging Deeper - Queues (官方文件原子化翻譯筆記)">
<meta property="og:url" content="https://tn710617.github.io/zh-tw/laravelDiggingDeeperQueues/index.html">
<meta property="og:site_name" content="Learn or Die">
<meta property="og:description" content="# Introduction學習一個框架, Ray 的想法是, 在深入理解底層實作的原理之前, 應該先知道這個框架的 使用方法; 先學習怎麼使用這個前人造的輪子, 再學習怎麼樣造一個輪子。所以本篇文章重點在於細讀官方文件, 並將內容理解後以 Q&amp;amp;A 的方式記錄下來, 加速學習以及查詢。">
<meta property="og:locale" content="zh-tw">
<meta property="og:updated_time" content="2021-04-25T05:24:21.485Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Laravel - Digging Deeper - Queues (官方文件原子化翻譯筆記)">
<meta name="twitter:description" content="# Introduction學習一個框架, Ray 的想法是, 在深入理解底層實作的原理之前, 應該先知道這個框架的 使用方法; 先學習怎麼使用這個前人造的輪子, 再學習怎麼樣造一個輪子。所以本篇文章重點在於細讀官方文件, 並將內容理解後以 Q&amp;amp;A 的方式記錄下來, 加速學習以及查詢。">





    <link rel="icon" href="/images/favicon.png">


<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bulma/0.6.2/css/bulma.min.css">


    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/justifiedGallery/3.6.5/css/justifiedGallery.min.css">


<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/sunburst.min.css">

<link rel="stylesheet" href="/css/style.css">

<script defer src="//use.fontawesome.com/releases/v5.0.8/js/all.js"></script>


    
        
    
        
    
        
    
        
    
        
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-135063928-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-135063928-1');
</script>


    


</head>
<body>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="/zh-tw">
                
                    
                    不學會死
                    
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item " href="/zh-tw/archives">歸檔</a>
            
            <a class="navbar-item " href="/zh-tw/categories">分類</a>
            
            <a class="navbar-item " href="/zh-tw/tags">標籤</a>
            
            <a class="navbar-item " href="/zh-tw/schedule">行程</a>
            
            <a class="navbar-item " href="/zh-tw/about">關於</a>
            
            <a class="navbar-item " href="/zh-tw/japanese">日語</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            <a class="navbar-item search" title="搜尋" href="javascript:;">
                <i class="fas fa-search"></i>
            </a>
            
            
            <div class="navbar-item is-hoverable has-dropdown is-hidden-mobile is-hidden-tablet-only toc">
                <a class="navbar-item" title="目錄">
                    <i class="fa fa-list"></i>
                </a>
                <div class="navbar-dropdown is-right">
                    
                    
                    
                    
                    <a class="navbar-item" href="#Introduction">1&nbsp;&nbsp;<b># Introduction</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#Connection-Vs-Queues">2&nbsp;&nbsp;<b># Connection Vs. Queues</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？">2.1.1&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-1">2.1.2&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#Driver-Notes-amp-Prerequisites">3&nbsp;&nbsp;<b># Driver Notes &amp;amp;amp; Prerequisites</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#Database">3.1&nbsp;&nbsp;# Database</a>
                    
                    
                    
                    <a class="navbar-item" href="#在-Laravel-中-如果我使用的-driver-為-database-該如何建立-queue-table">3.1.1&nbsp;&nbsp;在 Laravel 中, 如果我使用的 driver 為 database, 該如何建立 queue table?</a>
                    
                    
                    
                    <a class="navbar-item" href="#Redis">3.2&nbsp;&nbsp;# Redis</a>
                    
                    
                    
                    <a class="navbar-item" href="#在-Laravel-的-QUEUE-當中-如果我使用-redis-為-driver-該如何設定-redis-的-database-connection">3.2.1&nbsp;&nbsp;在 Laravel 的 QUEUE 當中, 如果我使用 redis 為 driver, 該如何設定 redis 的 database connection?</a>
                    
                    
                    
                    <a class="navbar-item" href="#Redis-Cluster">3.3&nbsp;&nbsp;# Redis Cluster</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的位於-config-queue-php-Laravel-example-code-的意思是？">3.3.1&nbsp;&nbsp;以下的位於 config/queue.php Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#Blocking">3.4&nbsp;&nbsp;# Blocking</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的位於-config-queue-php-Laravel-example-code-的意思是？-1">3.4.1&nbsp;&nbsp;以下的位於 config/queue.php Laravel example code 的意思是？</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#Creating-Jobs">4&nbsp;&nbsp;<b># Creating Jobs</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#Generating-Job-Classes">4.1&nbsp;&nbsp;# Generating Job Classes</a>
                    
                    
                    
                    <a class="navbar-item" href="#Laravel-中-一般-job-都會放在哪？">4.1.1&nbsp;&nbsp;Laravel 中, 一般 job 都會放在哪？</a>
                    
                    
                    
                    <a class="navbar-item" href="#Laravel-中-如何建立一個-Job">4.1.2&nbsp;&nbsp;Laravel 中, 如何建立一個 Job?</a>
                    
                    
                    
                    <a class="navbar-item" href="#在-Laravel-中-當我們注入一個-Model-到-Job-是會整個-Model-都被注入-還是只會注入該-Model-的一個辨識物？">4.1.3&nbsp;&nbsp;在 Laravel 中, 當我們注入一個 Model 到 Job, 是會整個 Model 都被注入, 還是只會注入該 Model 的一個辨識物？</a>
                    
                    
                    
                    <a class="navbar-item" href="#在-Laravel-中-當我在-job-中注入一個-model-當這個-job-被在-queue-中被取出執行時-請入該-model-會是我當初注入時的狀態-還是目前資料庫中最新的狀態？">4.1.4&nbsp;&nbsp;在 Laravel 中, 當我在 job 中注入一個 model, 當這個 job 被在 queue 中被取出執行時, 請入該 model 會是我當初注入時的狀態, 還是目前資料庫中最新的狀態？</a>
                    
                    
                    
                    <a class="navbar-item" href="#Handling-Relationships">4.2&nbsp;&nbsp;# Handling Relationships</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下位於-job-的-Laravel-example-code-的意思是？">4.2.1&nbsp;&nbsp;以下位於 job 的 Laravel example code 的意思是？</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#Job-Middleware">5&nbsp;&nbsp;<b># Job Middleware</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#在-Laravel-Queue-中-可以建立一個-Job-middleware-嗎？">5.1.1&nbsp;&nbsp;在 Laravel Queue 中, 可以建立一個 Job middleware 嗎？</a>
                    
                    
                    
                    <a class="navbar-item" href="#在-Laravel-Queue-中-如果我想要建立一個-Job-Middleware-可以建立在什麼位置？">5.1.2&nbsp;&nbsp;在 Laravel Queue 中, 如果我想要建立一個 Job Middleware, 可以建立在什麼位置？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-2">5.1.3&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#Dispatching-Jobs">6&nbsp;&nbsp;<b># Dispatching Jobs</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-3">6.1.1&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#Delayed-Dispatching">7&nbsp;&nbsp;<b># Delayed Dispatching</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-4">7.1.1&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#在-Laravel-Queue-中-AWS-的-SQS-最多支援到-delay-多久？">7.1.2&nbsp;&nbsp;在 Laravel Queue 中, AWS 的 SQS 最多支援到 delay 多久？</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#Synchronous-Dispatching">8&nbsp;&nbsp;<b># Synchronous Dispatching</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-5">8.1.1&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#Job-Chaining">9&nbsp;&nbsp;<b># Job Chaining</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#在-Laravel-Job-chaining-中-如果其中一個-job-失敗了-後面的還會繼續執行嗎？">9.1.1&nbsp;&nbsp;在 Laravel Job chaining 中, 如果其中一個 job 失敗了, 後面的還會繼續執行嗎？</a>
                    
                    
                    
                    <a class="navbar-item" href="#在-Laravel-Job-chaining-中-如果我使用-this-gt-delete-會終止後面的-job-執行嗎？">9.1.2&nbsp;&nbsp;在 Laravel Job chaining 中, 如果我使用 $this-&amp;amp;gt;delete(), 會終止後面的 job 執行嗎？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-6">9.1.3&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#Chain-Connection-amp-Queue">9.2&nbsp;&nbsp;# Chain Connection &amp;amp;amp; Queue</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-7">9.2.1&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#Customizing-The-Queue-amp-Connection">10&nbsp;&nbsp;<b># Customizing The Queue &amp;amp;amp; Connection</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#Dispatching-To-A-Particular-Queue">10.1&nbsp;&nbsp;# Dispatching To A Particular Queue</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-8">10.1.1&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#Dispatching-To-A-Particular-Connection">10.2&nbsp;&nbsp;# Dispatching To A Particular Connection</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-9">10.2.1&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-10">10.2.2&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-11">10.2.3&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#Specifying-Max-Job-Attempts-Timeout-Values">11&nbsp;&nbsp;<b># Specifying Max Job Attempts / Timeout Values</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#Max-Attempts">11.1&nbsp;&nbsp;# Max Attempts</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-12">11.1.1&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-13">11.1.2&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#Laravel-job-當中-當我同時在-job-class-中-以及-CLI-中都指令最大嘗試次數-Laravel-會以誰為準？">11.1.3&nbsp;&nbsp;Laravel job 當中, 當我同時在 job class 中, 以及 CLI 中都指令最大嘗試次數, Laravel 會以誰為準？</a>
                    
                    
                    
                    <a class="navbar-item" href="#Time-Based-Attempts">11.2&nbsp;&nbsp;# Time Based Attempts</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-14">11.2.1&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#Timeout">11.3&nbsp;&nbsp;# Timeout</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-15">11.3.1&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-16">11.3.2&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#Laravel-job-當中-如果我再-CLI-以及-job-的-class-同時定義的-timeout-哪一個的優先權比較大？">11.3.3&nbsp;&nbsp;Laravel job 當中, 如果我再 CLI 以及 job 的 class 同時定義的 timeout, 哪一個的優先權比較大？</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#Rate-Limiting">12&nbsp;&nbsp;<b># Rate Limiting</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#Laravel-queue-當中-如果我想使用-rate-limiting-哪一個服務會是必要的？">12.1.1&nbsp;&nbsp;Laravel queue 當中, 如果我想使用 rate limiting, 哪一個服務會是必要的？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-17">12.1.2&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#下面的-Laravel-程式碼中-當我-release-該-job-這樣還會增加該-job-的-attempt-次數嗎？">12.1.3&nbsp;&nbsp;下面的 Laravel 程式碼中, 當我 release 該 job, 這樣還會增加該 job 的 attempt 次數嗎？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-18">12.1.4&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#Queueing-Closures">13&nbsp;&nbsp;<b># Queueing Closures</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#在-Laravel-中-什麼情況我們可能會需要-dispatch-一個-closure">13.1.1&nbsp;&nbsp;在 Laravel 中, 什麼情況我們可能會需要 dispatch 一個 closure?</a>
                    
                    
                    
                    <a class="navbar-item" href="#在-Laravel-中-如何-dispatch-一個-closure">13.1.2&nbsp;&nbsp;在 Laravel 中, 如何 dispatch 一個 closure?</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#Running-The-Queue-Worker">14&nbsp;&nbsp;<b># Running The Queue Worker</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#在-Laravel-中-怎麼樣啟動-worker-來執行-queued-job">14.1.1&nbsp;&nbsp;在 Laravel 中, 怎麼樣啟動 worker 來執行 queued job?</a>
                    
                    
                    
                    <a class="navbar-item" href="#在-Laravel-中-要維持-worker-持續運行-我們需要額外啟動什麼？">14.1.2&nbsp;&nbsp;在 Laravel 中, 要維持 worker 持續運行, 我們需要額外啟動什麼？</a>
                    
                    
                    
                    <a class="navbar-item" href="#在-Laravel-中-當我使用-php-artisan-queue-work-當我代碼有變更時-我需要重新啟動-queue-嗎？">14.1.3&nbsp;&nbsp;在 Laravel 中, 當我使用 php artisan queue:work, 當我代碼有變更時, 我需要重新啟動 queue 嗎？</a>
                    
                    
                    
                    <a class="navbar-item" href="#在-Laravel-中-如果我運行-php-artisan-queue-listen-然後我變更了代碼-我需要再重新啟動-queue-嗎？">14.1.4&nbsp;&nbsp;在 Laravel 中, 如果我運行 php artisan queue:listen, 然後我變更了代碼, 我需要再重新啟動 queue 嗎？</a>
                    
                    
                    
                    <a class="navbar-item" href="#在-Laravel-中-如果我不想要每次變更代碼就重新啟動-queue-我可以使用哪一個-CLI">14.1.5&nbsp;&nbsp;在 Laravel 中, 如果我不想要每次變更代碼就重新啟動 queue, 我可以使用哪一個 CLI?</a>
                    
                    
                    
                    <a class="navbar-item" href="#在-Laravel-中-php-artisan-queue-work-跟-php-artisan-queue-listen-何者較有效率？">14.1.6&nbsp;&nbsp;在 Laravel 中, php artisan queue:work 跟 php artisan queue:listen 何者較有效率？</a>
                    
                    
                    
                    <a class="navbar-item" href="#Specifying-The-Connection-amp-Queue">14.2&nbsp;&nbsp;# Specifying The Connection &amp;amp;amp; Queue</a>
                    
                    
                    
                    <a class="navbar-item" href="#在-Laravel-中-如何透過-CLI-指定-queue-connection">14.2.1&nbsp;&nbsp;在 Laravel 中, 如何透過 CLI 指定 queue connection?</a>
                    
                    
                    
                    <a class="navbar-item" href="#在-Laravel-中-如何透過-CLI-給特定的-queue-指定特定-connection">14.2.2&nbsp;&nbsp;在 Laravel 中, 如何透過 CLI 給特定的 queue 指定特定 connection?</a>
                    
                    
                    
                    <a class="navbar-item" href="#Processing-A-Single-Job">14.3&nbsp;&nbsp;# Processing A Single Job</a>
                    
                    
                    
                    <a class="navbar-item" href="#在-Laravel-中-如何透過-CLI-指定-worker-只執行-queued-job-一次">14.3.1&nbsp;&nbsp;在 Laravel 中, 如何透過 CLI 指定 worker 只執行 queued job 一次</a>
                    
                    
                    
                    <a class="navbar-item" href="#Processing-All-Queued-Jobs-amp-Then-Exiting">14.4&nbsp;&nbsp;# Processing All Queued Jobs &amp;amp;amp; Then Exiting</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-command-的意思是？">14.4.1&nbsp;&nbsp;以下的 Laravel example command 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-指令什麼時候可能會用到？">14.4.2&nbsp;&nbsp;以下的 Laravel 指令什麼時候可能會用到？</a>
                    
                    
                    
                    <a class="navbar-item" href="#Resource-Considerations">14.5&nbsp;&nbsp;# Resource Considerations</a>
                    
                    
                    
                    <a class="navbar-item" href="#在-Laravel-的-queue-中-因為會緩存在-RAM-中運行-所以如果我有執行到未釋放的資源-像是-image-之類的-那我是否要在-job-執行完成之後釋放掉這些資源？">14.5.1&nbsp;&nbsp;在 Laravel 的 queue 中, 因為會緩存在 RAM 中運行, 所以如果我有執行到未釋放的資源, 像是 image 之類的, 那我是否要在 job 執行完成之後釋放掉這些資源？</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#Queue-Priorities">15&nbsp;&nbsp;<b># Queue Priorities</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-19">15.1.1&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#Queue-Workers-amp-Deployment">16&nbsp;&nbsp;<b># Queue Workers &amp;amp;amp; Deployment</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#Job-Expiration">16.1&nbsp;&nbsp;# Job Expiration</a>
                    
                    
                    
                    <a class="navbar-item" href="#在-Laravel-的-queue-監聽程序中-我要如何重啟-queue？">16.1.1&nbsp;&nbsp;在 Laravel 的 queue 監聽程序中, 我要如何重啟 queue？</a>
                    
                    
                    
                    <a class="navbar-item" href="#在-Laravel-的-queue-監聽-CLI-php-artisan-queue-restart-會不會讓我丟失執行到一半的工作？">16.1.2&nbsp;&nbsp;在 Laravel 的 queue 監聽 CLI php artisan queue:restart, 會不會讓我丟失執行到一半的工作？</a>
                    
                    
                    
                    <a class="navbar-item" href="#Laravel-中-在沒有使用-supervisor-的情況下-如果我執行-php-artisan-queue-restart-會發生什麼事？">16.1.3&nbsp;&nbsp;Laravel 中, 在沒有使用 supervisor 的情況下, 如果我執行 php artisan queue:restart, 會發生什麼事？</a>
                    
                    
                    
                    <a class="navbar-item" href="#Laravel-中-若要使用-php-artisan-queue-restart-務必先要確認什麼服務已經設置好？">16.1.4&nbsp;&nbsp;Laravel 中, 若要使用 php artisan queue:restart, 務必先要確認什麼服務已經設置好？</a>
                    
                    
                    
                    <a class="navbar-item" href="#Laravel-中-當我使用-php-artisan-queue-restart-queue-會將-restart-的-signal-存在什麼地方？">16.1.5&nbsp;&nbsp;Laravel 中, 當我使用 php artisan queue:restart, queue 會將 restart 的 signal 存在什麼地方？</a>
                    
                    
                    
                    <a class="navbar-item" href="#Laravel-queue-中-如果我要-globally-定義-job-在執行之後多久時間之後才可以再被執行-如果沒被刪除的話-我可以怎麼做？">16.1.6&nbsp;&nbsp;Laravel queue 中, 如果我要 globally 定義 job 在執行之後多久時間之後才可以再被執行 (如果沒被刪除的話), 我可以怎麼做？</a>
                    
                    
                    
                    <a class="navbar-item" href="#Laravel-queue-中-哪一個服務無法在-queue-php-config-中設定-retry-after-參數">16.1.7&nbsp;&nbsp;Laravel queue 中, 哪一個服務無法在 queue.php config 中設定 retry_after 參數</a>
                    
                    
                    
                    <a class="navbar-item" href="#Worker-Timeouts">16.2&nbsp;&nbsp;# Worker Timeouts</a>
                    
                    
                    
                    <a class="navbar-item" href="#Laravel-queue-中-timeout-跟-retry-after-的差別在哪？">16.2.1&nbsp;&nbsp;Laravel queue 中, --timeout 跟 retry_after 的差別在哪？</a>
                    
                    
                    
                    <a class="navbar-item" href="#Laravel-queue-中-timeout-跟-retry-after-的時間-哪個長哪個短？">16.2.2&nbsp;&nbsp;Laravel queue 中, --timeout 跟 retry_after 的時間, 哪個長哪個短？</a>
                    
                    
                    
                    <a class="navbar-item" href="#Laravel-queue-中-如果-retry-after-比-timeout-設定的時間還短-可能會發生什麼事？">16.2.3&nbsp;&nbsp;Laravel queue 中, 如果 retry_after 比 --timeout 設定的時間還短, 可能會發生什麼事？</a>
                    
                    
                    
                    <a class="navbar-item" href="#Worker-Sleep-Duration">16.3&nbsp;&nbsp;# Worker Sleep Duration</a>
                    
                    
                    
                    <a class="navbar-item" href="#Laravel-queue-中-如果我要讓-worker-沒有新的-job-時會進入休眠狀態-那我可以怎麼做？">16.3.1&nbsp;&nbsp;Laravel queue 中, 如果我要讓 worker 沒有新的 job 時會進入休眠狀態, 那我可以怎麼做？</a>
                    
                    
                    
                    <a class="navbar-item" href="#Laravel-queue-中-如果我有使用-sleep-的-option-當-queue-裡頭有很多-job-還沒有執行完畢時-worker-會進入-sleep-狀態嗎？">16.3.2&nbsp;&nbsp;Laravel queue 中, 如果我有使用 --sleep 的 option, 當 queue 裡頭有很多 job 還沒有執行完畢時, worker 會進入 sleep 狀態嗎？</a>
                    
                    
                    
                    <a class="navbar-item" href="#Laravel-queue-中-如果我有使用-sleep-的-option-當-worker-處於-sleep-的狀態時-如果有新的-job-進來-worker-會等到-sleep-結束再處理-還是會立即處理？">16.3.3&nbsp;&nbsp;Laravel queue 中, 如果我有使用 --sleep 的 option, 當 worker 處於 sleep 的狀態時, 如果有新的 job 進來, worker 會等到 sleep 結束再處理, 還是會立即處理？</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#Supervisor-Configuration">17&nbsp;&nbsp;<b># Supervisor Configuration</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#Installing-Supervisor">17.1&nbsp;&nbsp;# Installing Supervisor</a>
                    
                    
                    
                    <a class="navbar-item" href="#如何安裝-supervisor">17.1.1&nbsp;&nbsp;如何安裝 supervisor ?</a>
                    
                    
                    
                    <a class="navbar-item" href="#Supervisor-的設定檔位置在哪？">17.1.2&nbsp;&nbsp;Supervisor 的設定檔位置在哪？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-supervisor-config-example-的意思是？">17.1.3&nbsp;&nbsp;以下的 supervisor config example 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#Starting-Supervisor">17.2&nbsp;&nbsp;# Starting Supervisor</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-supervisor-example-command-的意思是？">17.2.1&nbsp;&nbsp;以下的 supervisor example command 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-supervisor-example-command-的意思是？-1">17.2.2&nbsp;&nbsp;以下的 supervisor example command 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-supervisor-example-command-的意思是？-2">17.2.3&nbsp;&nbsp;以下的 supervisor example command 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#Supervisor-官方文件位址">17.2.4&nbsp;&nbsp;Supervisor 官方文件位址?</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#Dealing-With-Failed-Jobs">18&nbsp;&nbsp;<b># Dealing With Failed Jobs</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#Laravel-queue-中-當一個-job-一直執行失敗-超出了指定的-tries-的限制-那這個-job-會跑到哪裡去？">18.1.1&nbsp;&nbsp;Laravel queue 中, 當一個 job 一直執行失敗, 超出了指定的 tries 的限制, 那這個 job 會跑到哪裡去？</a>
                    
                    
                    
                    <a class="navbar-item" href="#Laravel-queue-中-如何建立-failed-jobs-table">18.1.2&nbsp;&nbsp;Laravel queue 中, 如何建立 failed_jobs table?</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-20">18.1.3&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下位於-job-的-Laravel-example-code-的意思是？-1">18.1.4&nbsp;&nbsp;以下位於 job 的 Laravel example code 的意思是？</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#Cleaning-Up-After-Failed-Jobs">19&nbsp;&nbsp;<b># Cleaning Up After Failed Jobs</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-21">19.1.1&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#Failed-Job-Events">20&nbsp;&nbsp;<b># Failed Job Events</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-22">20.1.1&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#Retrying-Failed-Jobs">21&nbsp;&nbsp;<b># Retrying Failed Jobs</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-23">21.1.1&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-24">21.1.2&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-25">21.1.3&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-26">21.1.4&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-27">21.1.5&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-28">21.1.6&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#Ignoring-Missing-Models">22&nbsp;&nbsp;<b># Ignoring Missing Models</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#Laravel-Queue-中-我們注入一個-Eloquent-model-到一個-job-當中-而當執行該-job-時-該-model-已遭刪除-這時會發生什麼事？">22.1.1&nbsp;&nbsp;Laravel Queue 中, 我們注入一個 Eloquent model 到一個 job 當中, 而當執行該 job 時, 該 model 已遭刪除, 這時會發生什麼事？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-29">22.1.2&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#Job-Events">23&nbsp;&nbsp;<b># Job Events</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-30">23.1.1&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#Laravel-Queue-中-以下的程式碼通常可以應用在什麼情況？">23.1.2&nbsp;&nbsp;Laravel Queue 中, 以下的程式碼通常可以應用在什麼情況？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-31">23.1.3&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#Additional">24&nbsp;&nbsp;<b># Additional</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-32">24.1.1&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-33">24.1.2&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-34">24.1.3&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-35">24.1.4&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-36">24.1.5&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-37">24.1.6&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-38">24.1.7&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-Horizon-example-configuration-的意思是？">24.1.8&nbsp;&nbsp;以下的 Laravel Horizon example configuration 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-Horizon-example-configuration-的意思是？-1">24.1.9&nbsp;&nbsp;以下的 Laravel Horizon example configuration 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-Horizon-example-configuration-的意思是？-2">24.1.10&nbsp;&nbsp;以下的 Laravel Horizon example configuration 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-Horizon-example-configuration-的意思是？-3">24.1.11&nbsp;&nbsp;以下的 Laravel Horizon example configuration 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-39">24.1.12&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-40">24.1.13&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-41">24.1.14&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-42">24.1.15&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-43">24.1.16&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-44">24.1.17&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#Laravel-Vapor-中-如果我有一些-job-需要-high-memory-而有些-job-只需要比較低的-memory-建議的做法是？">24.1.18&nbsp;&nbsp;Laravel Vapor 中, 如果我有一些 job 需要 high memory, 而有些 job 只需要比較低的 memory, 建議的做法是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#Laravel-Vapor-中-以什麼計費？">24.1.19&nbsp;&nbsp;Laravel Vapor 中, 以什麼計費？</a>
                    
                    
                    
                    <a class="navbar-item" href="#Laravel-Vapor-中-什麼是-cold-start">24.1.20&nbsp;&nbsp;Laravel Vapor 中, 什麼是 cold start?</a>
                    
                    
                    
                    <a class="navbar-item" href="#SQS-可以設定哪個選項來避免-duplicated-job">24.1.21&nbsp;&nbsp;SQS 可以設定哪個選項來避免 duplicated job?</a>
                    
                    
                    
                    <a class="navbar-item" href="#Laravel-Vapor-的最大-timeout-是多久？">24.1.22&nbsp;&nbsp;Laravel Vapor 的最大 timeout 是多久？</a>
                    
                    
                    
                    <a class="navbar-item" href="#為避免-memory-leaking-Vapor-會在處理幾個-job-後重啟-worker-container">24.1.23&nbsp;&nbsp;為避免 memory leaking, Vapor 會在處理幾個 job 後重啟 worker container?</a>
                    
                    
                    
                    <a class="navbar-item" href="#AWS-的-default-concurrency-limit-是多少？">24.1.24&nbsp;&nbsp;AWS 的 default concurrency limit 是多少？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-vapor-configuration-意思是？">24.1.25&nbsp;&nbsp;以下的 vapor configuration 意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#如果要使用-Redis-在不同的用途-假如是同一個-Redis-instance-那如果有一個應用的-traffic-特別高-會影響其他的應用嗎？">24.1.26&nbsp;&nbsp;如果要使用 Redis 在不同的用途, 假如是同一個 Redis instance, 那如果有一個應用的 traffic 特別高, 會影響其他的應用嗎？</a>
                    
                    
                    
                    <a class="navbar-item" href="#如果要使用-Redis-在不同的用途-例如不同應用的-cache-以及-queue-建議-practice-是？">24.1.27&nbsp;&nbsp;如果要使用 Redis 在不同的用途, 例如不同應用的 cache 以及 queue, 建議 practice 是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-45">24.1.28&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#Laravel-中-如果使用-sync-driver-是跑在-memory-還是-database">24.1.29&nbsp;&nbsp;Laravel 中, 如果使用 sync driver, 是跑在 memory 還是 database?</a>
                    
                    
                    
                    <a class="navbar-item" href="#Laravel-中-如果使用-SQS-當作-queue-driver-可以使用-retry-after-configuration-嗎？">24.1.30&nbsp;&nbsp;Laravel 中, 如果使用 SQS 當作 queue driver, 可以使用 retry_after configuration 嗎？</a>
                    
                    
                    
                    <a class="navbar-item" href="#Laravel-中-如果使用-Sever-Redis-當作-queue-driver-可以確保-job-只被-dispatch-一次嗎？">24.1.31&nbsp;&nbsp;Laravel 中, 如果使用 Sever Redis 當作 queue driver, 可以確保 job 只被 dispatch 一次嗎？</a>
                    
                    
                    
                    <a class="navbar-item" href="#Laravel-中-如果使用-SQS-當作-queue-driver-可以確保-job-只被-dispatch-一次嗎？">24.1.32&nbsp;&nbsp;Laravel 中, 如果使用 SQS 當作 queue driver, 可以確保 job 只被 dispatch 一次嗎？</a>
                    
                    
                    
                    <a class="navbar-item" href="#Laravel-中-如果使用-SQS-當作-queue-driver-job-的最長生命週期多長？">24.1.33&nbsp;&nbsp;Laravel 中, 如果使用 SQS 當作 queue driver, job 的最長生命週期多長？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-46">24.1.34&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-47">24.1.35&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#SQS-每個-message-的-size-限制是多少？">24.1.36&nbsp;&nbsp;SQS 每個 message 的 size 限制是多少？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-48">24.1.37&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-49">24.1.38&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-50">24.1.39&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-51">24.1.40&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-52">24.1.41&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-53">24.1.42&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-54">24.1.43&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-55">24.1.44&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-56">24.1.45&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-57">24.1.46&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-58">24.1.47&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-59">24.1.48&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-cron-example-的意思是？">24.1.49&nbsp;&nbsp;以下的 cron example 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-supervisor-的意思是？">24.1.50&nbsp;&nbsp;以下的 supervisor 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#當使用-supervisor-stop-時-會中斷執行到一半的-task-嗎？">24.1.51&nbsp;&nbsp;當使用 supervisor stop 時, 會中斷執行到一半的 task 嗎？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-supervisor-example-的意思是？">24.1.52&nbsp;&nbsp;以下的 supervisor example 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#Laravel-中-如果一個-worker-吃光了-PHP-可用的所有-memory-那會發生什麼事？">24.1.53&nbsp;&nbsp;Laravel 中, 如果一個 worker 吃光了 PHP 可用的所有 memory, 那會發生什麼事？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-Testing-example-code-的意思是？">24.1.54&nbsp;&nbsp;以下的 Laravel Testing example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-Queue-example-code-的意思是？">24.1.55&nbsp;&nbsp;以下的 Laravel Queue example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#Laravel-中-如果-server-是一台-single-CPU-server-and-jobs-involve-a-lot-of-waiting-那建議啟動幾個-worker">24.1.56&nbsp;&nbsp;Laravel 中, 如果 server 是一台 single CPU server, and jobs involve a lot of waiting, 那建議啟動幾個 worker?</a>
                    
                    
                    
                    <a class="navbar-item" href="#Laravel-中-如果-server-是一台-single-CPU-server-而-job-是-CPU-intensive-job-那建議啟動幾個-worker">24.1.57&nbsp;&nbsp;Laravel 中, 如果 server 是一台 single CPU server, 而 job 是 CPU intensive job, 那建議啟動幾個 worker?</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-60">24.1.58&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-Testing-example-code-的意思是？-1">24.1.59&nbsp;&nbsp;以下的 Laravel Testing example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-61">24.1.60&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#Laravel-queue-中-使用-queue-的要點是什麼？">24.1.61&nbsp;&nbsp;Laravel queue 中, 使用 queue 的要點是什麼？</a>
                    
                    
                    
                    <a class="navbar-item" href="#Laravel-queue-中-當使用-Redis-為-queue-driver-時-務必要讓-job-越可能得越快被執行越好-為什麼？">24.1.62&nbsp;&nbsp;Laravel queue 中, 當使用 Redis 為 queue driver 時, 務必要讓 job 越可能得越快被執行越好, 為什麼？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-queue-example-code-的意思是？">24.1.63&nbsp;&nbsp;以下的 Laravel queue example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-62">24.1.64&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-63">24.1.65&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-64">24.1.66&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-65">24.1.67&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-66">24.1.68&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-67">24.1.69&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-68">24.1.70&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-job-middleware-example-code-的意思是？">24.1.71&nbsp;&nbsp;以下的 Laravel job middleware example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-job-example-code-的意思是？">24.1.72&nbsp;&nbsp;以下的 Laravel job example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下位於-job-中的-Laravel-example-code-的意思是？">24.1.73&nbsp;&nbsp;以下位於 job 中的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-69">24.1.74&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-70">24.1.75&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-71">24.1.76&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-72">24.1.77&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-73">24.1.78&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-74">24.1.79&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-75">24.1.80&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-76">24.1.81&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-77">24.1.82&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下兩個-job-class-example-差異處在於？">24.1.83&nbsp;&nbsp;以下兩個 job class example, 差異處在於？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-78">24.1.84&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-79">24.1.85&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-80">24.1.86&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-81">24.1.87&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-82">24.1.88&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-command-的意思是？-1">24.1.89&nbsp;&nbsp;以下的 Laravel example command 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-83">24.1.90&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-84">24.1.91&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-command-的意思是？-2">24.1.92&nbsp;&nbsp;以下的 Laravel example command 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-85">24.1.93&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-86">24.1.94&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-job-example-中-要是-worker-在取得-lock-之後-crash-了-那會發生什麼事？">24.1.95&nbsp;&nbsp;以下的 Laravel job example 中, 要是 worker 在取得 lock 之後 crash 了, 那會發生什麼事？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-87">24.1.96&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-88">24.1.97&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-89">24.1.98&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-90">24.1.99&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-91">24.1.100&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下位於-config-queue-php-的-Laravel-example-code-的意思是？">24.1.101&nbsp;&nbsp;以下位於 config/queue.php 的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#Laravel-Queue-中-當一個-worker-執行一個-job-時-為何其他-worker-不會執行同一個-job">24.1.102&nbsp;&nbsp;Laravel Queue 中, 當一個 worker 執行一個 job 時, 為何其他 worker 不會執行同一個 job?</a>
                    
                    
                    
                    <a class="navbar-item" href="#Laravel-Queue-中-當使用-job-的-retry-until-120-代表該-job-在-120-秒後就會立即被執行嗎？">24.1.103&nbsp;&nbsp;Laravel Queue 中, 當使用 job 的 retry_until = 120, 代表該 job 在 120 秒後就會立即被執行嗎？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-92">24.1.104&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-93">24.1.105&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-command-的意思是？-3">24.1.106&nbsp;&nbsp;以下的 Laravel example command 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-94">24.1.107&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Laravel-example-code-的意思是？-95">24.1.108&nbsp;&nbsp;以下的 Laravel example code 的意思是？</a>
                    
                </div>
            </div>
            

            
<div class="column is-narrow has-text-centered">
    <div class="dropdown is-up is-right is-hoverable" style="margin-top: -0.2em;">
        <div class="dropdown-trigger">
            <button class="button is-small" aria-haspopup="true" aria-controls="dropdown-menu7">
                <span class="icon">
                    <i class="fas fa-globe"></i>
                </span>
                <span>繁體中文</span>
                <span class="icon is-small">
            <i class="fas fa-angle-down" aria-hidden="true"></i>
          </span>
            </button>
        </div>
        <div class="dropdown-menu has-text-left" role="menu" style="top:100%">
            <div class="dropdown-content">
            
                <a href="/laravelDiggingDeeperQueues/" class="dropdown-item">
                    English
                </a>
            
                <a href="/zh-tw/laravelDiggingDeeperQueues/" class="dropdown-item">
                    繁體中文
                </a>
            
            </div>
        </div>
    </div>
</div>

        </div>
    </div>
</nav>

    <section class="section">
    <div class="container">
    <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            Laravel - Digging Deeper - Queues (官方文件原子化翻譯筆記)
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            <time datetime="2019-12-31T02:30:57.000Z" itemprop="datePublished">12月 31 2019</time>
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="/zh-tw/categories/Dev/">Dev</a>
        </span>
        
        
        <span class="column is-narrow">
            
            
            1 小时 讀完 (大概 13022 字)
        </span>
        
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <h2 id="Introduction"><a href="#Introduction" class="headerlink" title="# Introduction"></a># Introduction</h2><p>學習一個框架, Ray 的想法是, 在深入理解底層實作的原理之前, 應該先知道這個框架的 <code>使用方法</code>; 先學習怎麼<strong>使用</strong>這個前人造的輪子, 再學習怎麼樣<strong>造</strong>一個輪子。<br>所以本篇文章重點在於細讀<strong>官方文件</strong>, 並將內容理解後以 <strong>Q&amp;A</strong> 的方式記錄下來, 加速學習以及查詢。</p>
<a id="more"></a>

<br>
<br>

<h2 id="Connection-Vs-Queues"><a href="#Connection-Vs-Queues" class="headerlink" title="# Connection Vs. Queues"></a># Connection Vs. Queues</h2><h6 id="以下的-Laravel-example-code-的意思是？"><a href="#以下的-Laravel-example-code-的意思是？" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Jobs</span>\<span class="hljs-title">ProcessPodcast</span>;</span><br><span class="line"></span><br><span class="line">ProcessPodcast::dispatch();</span><br><span class="line"></span><br><span class="line">ProcessPodcast::dispatch()-&gt;onQueue(<span class="hljs-string">'emails'</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>將 job 送到 connection 定義的 default queue<br>將 job 送到 connection <strong>emails</strong> 定義的 default queue</p>
</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-1"><a href="#以下的-Laravel-example-code-的意思是？-1" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">php artisan queue:work --queue=high,default</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>啟動 queue daemon, 並排序 queue 的優先順序 high,default</p>
</li>
</ul>
<br>
<br>

<h2 id="Driver-Notes-amp-Prerequisites"><a href="#Driver-Notes-amp-Prerequisites" class="headerlink" title="# Driver Notes &amp; Prerequisites"></a># Driver Notes &amp; Prerequisites</h2><h3 id="Database"><a href="#Database" class="headerlink" title="# Database"></a># Database</h3><h6 id="在-Laravel-中-如果我使用的-driver-為-database-該如何建立-queue-table"><a href="#在-Laravel-中-如果我使用的-driver-為-database-該如何建立-queue-table" class="headerlink" title="在 Laravel 中, 如果我使用的 driver 為 database, 該如何建立 queue table?"></a><strong>在 Laravel 中, 如果我使用的 driver 為 database, 該如何建立 queue table?</strong></h6><figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">php artisan queue:table</span><br><span class="line">php artisan migrate</span><br></pre></td></tr></table></figure>

<br>

<h3 id="Redis"><a href="#Redis" class="headerlink" title="# Redis"></a># Redis</h3><h6 id="在-Laravel-的-QUEUE-當中-如果我使用-redis-為-driver-該如何設定-redis-的-database-connection"><a href="#在-Laravel-的-QUEUE-當中-如果我使用-redis-為-driver-該如何設定-redis-的-database-connection" class="headerlink" title="在 Laravel 的 QUEUE 當中, 如果我使用 redis 為 driver, 該如何設定 redis 的 database connection?"></a><strong>在 Laravel 的 QUEUE 當中, 如果我使用 <code>redis</code> 為 driver, 該如何設定 <code>redis</code> 的 database connection?</strong></h6><p>在 <code>config/database.php</code> 檔案中</p>
<br>

<h3 id="Redis-Cluster"><a href="#Redis-Cluster" class="headerlink" title="# Redis Cluster"></a># Redis Cluster</h3><h6 id="以下的位於-config-queue-php-Laravel-example-code-的意思是？"><a href="#以下的位於-config-queue-php-Laravel-example-code-的意思是？" class="headerlink" title="以下的位於 config/queue.php Laravel example code 的意思是？"></a><strong>以下的位於 config/queue.php Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">&apos;redis&apos; =&gt; [</span><br><span class="line">    &apos;driver&apos; =&gt; &apos;redis&apos;,</span><br><span class="line">    &apos;connection&apos; =&gt; &apos;default&apos;,</span><br><span class="line">    &apos;queue&apos; =&gt; &apos;&#123;default&#125;&apos;,</span><br><span class="line">    &apos;retry_after&apos; =&gt; 90,</span><br><span class="line">],</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>定義 redis cluster, 因此 queue 需 enclosed <code>{ }</code></p>
</li>
</ul>
<br>

<h3 id="Blocking"><a href="#Blocking" class="headerlink" title="# Blocking"></a># Blocking</h3><h6 id="以下的位於-config-queue-php-Laravel-example-code-的意思是？-1"><a href="#以下的位於-config-queue-php-Laravel-example-code-的意思是？-1" class="headerlink" title="以下的位於 config/queue.php Laravel example code 的意思是？"></a><strong>以下的位於 config/queue.php Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">&apos;redis&apos; =&gt; [</span><br><span class="line">    &apos;driver&apos; =&gt; &apos;redis&apos;,</span><br><span class="line">    &apos;connection&apos; =&gt; &apos;default&apos;,</span><br><span class="line">    &apos;queue&apos; =&gt; &apos;default&apos;,</span><br><span class="line">    &apos;retry_after&apos; =&gt; 90,</span><br><span class="line">    &apos;block_for&apos; =&gt; 5,</span><br><span class="line">],</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>retry_after 表示每個 job 最多維持 <strong>reserved</strong> state 90 秒, 以避免 worker crash 之後一個 job 永遠不被執行<br>block_for 表示 worker 在進入下一輪的循環之前, 會先 block 5 秒看有沒有新的 job 進來, 可參考 <a href="https://twitter.com/i/status/1232896655982284801" target="_blank" rel="noopener">Mohamed Said 的 video</a></p>
</li>
</ul>
<br>
<br>

<h2 id="Creating-Jobs"><a href="#Creating-Jobs" class="headerlink" title="# Creating Jobs"></a># Creating Jobs</h2><h3 id="Generating-Job-Classes"><a href="#Generating-Job-Classes" class="headerlink" title="# Generating Job Classes"></a># Generating Job Classes</h3><h6 id="Laravel-中-一般-job-都會放在哪？"><a href="#Laravel-中-一般-job-都會放在哪？" class="headerlink" title="Laravel 中, 一般 job 都會放在哪？"></a><strong>Laravel 中, 一般 job 都會放在哪？</strong></h6><p><code>app/Jobs</code></p>
<h6 id="Laravel-中-如何建立一個-Job"><a href="#Laravel-中-如何建立一個-Job" class="headerlink" title="Laravel 中, 如何建立一個 Job?"></a><strong>Laravel 中, 如何建立一個 Job?</strong></h6><figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">php artisan make:job jobName</span><br></pre></td></tr></table></figure>

<h6 id="在-Laravel-中-當我們注入一個-Model-到-Job-是會整個-Model-都被注入-還是只會注入該-Model-的一個辨識物？"><a href="#在-Laravel-中-當我們注入一個-Model-到-Job-是會整個-Model-都被注入-還是只會注入該-Model-的一個辨識物？" class="headerlink" title="在 Laravel 中, 當我們注入一個 Model 到 Job, 是會整個 Model 都被注入, 還是只會注入該 Model 的一個辨識物？"></a><strong>在 Laravel 中, 當我們注入一個 Model 到 Job, 是會整個 Model 都被注入, 還是只會注入該 Model 的一個辨識物？</strong></h6><p>Only an identifier will be stored in the job</p>
<h6 id="在-Laravel-中-當我在-job-中注入一個-model-當這個-job-被在-queue-中被取出執行時-請入該-model-會是我當初注入時的狀態-還是目前資料庫中最新的狀態？"><a href="#在-Laravel-中-當我在-job-中注入一個-model-當這個-job-被在-queue-中被取出執行時-請入該-model-會是我當初注入時的狀態-還是目前資料庫中最新的狀態？" class="headerlink" title="在 Laravel 中, 當我在 job 中注入一個 model, 當這個 job 被在 queue 中被取出執行時, 請入該 model 會是我當初注入時的狀態, 還是目前資料庫中最新的狀態？"></a><strong>在 Laravel 中, 當我在 job 中注入一個 model, 當這個 job 被在 queue 中被取出執行時, 請入該 model 會是我當初注入時的狀態, 還是目前資料庫中最新的狀態？</strong></h6><p>資料庫中的狀態</p>
<h3 id="Handling-Relationships"><a href="#Handling-Relationships" class="headerlink" title="# Handling Relationships"></a># Handling Relationships</h3><h6 id="以下位於-job-的-Laravel-example-code-的意思是？"><a href="#以下位於-job-的-Laravel-example-code-的意思是？" class="headerlink" title="以下位於 job 的 Laravel example code 的意思是？"></a><strong>以下位於 job 的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(Podcast $podcast)</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    <span class="hljs-keyword">$this</span>-&gt;podcast = $podcast-&gt;withoutRelations();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>當注入 model 到 job 時, 預設會載入 relations, 可指定不載入</p>
</li>
</ul>
<br>
<br>

<h2 id="Job-Middleware"><a href="#Job-Middleware" class="headerlink" title="# Job Middleware"></a># Job Middleware</h2><h6 id="在-Laravel-Queue-中-可以建立一個-Job-middleware-嗎？"><a href="#在-Laravel-Queue-中-可以建立一個-Job-middleware-嗎？" class="headerlink" title="在 Laravel Queue 中, 可以建立一個 Job middleware 嗎？"></a><strong>在 Laravel Queue 中, 可以建立一個 Job middleware 嗎？</strong></h6><p>可以</p>
<h6 id="在-Laravel-Queue-中-如果我想要建立一個-Job-Middleware-可以建立在什麼位置？"><a href="#在-Laravel-Queue-中-如果我想要建立一個-Job-Middleware-可以建立在什麼位置？" class="headerlink" title="在 Laravel Queue 中, 如果我想要建立一個 Job Middleware, 可以建立在什麼位置？"></a><strong>在 Laravel Queue 中, 如果我想要建立一個 Job Middleware, 可以建立在什麼位置？</strong></h6><p>什麼位置都可以, 官方範例位置為 <code>app/Jobs/Middleware</code></p>
<h6 id="以下的-Laravel-example-code-的意思是？-2"><a href="#以下的-Laravel-example-code-的意思是？-2" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Jobs</span>\<span class="hljs-title">Middleware</span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Support</span>\<span class="hljs-title">Facades</span>\<span class="hljs-title">Redis</span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RateLimited</span></span></span><br><span class="line"><span class="hljs-class"></span>&#123;</span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span><span class="hljs-params">($job, $next)</span></span></span><br><span class="line"><span class="hljs-function">    </span>&#123;</span><br><span class="line">        Redis::throttle(<span class="hljs-string">'key'</span>)</span><br><span class="line">                -&gt;block(<span class="hljs-number">0</span>)-&gt;allow(<span class="hljs-number">1</span>)-&gt;every(<span class="hljs-number">5</span>)</span><br><span class="line">                -&gt;then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> <span class="hljs-title">use</span> <span class="hljs-params">($job, $next)</span> </span>&#123;</span><br><span class="line">                </span><br><span class="line">                    $next($job);</span><br><span class="line">                &#125;, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> <span class="hljs-title">use</span> <span class="hljs-params">($job)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">                    $job-&gt;release(<span class="hljs-number">5</span>);</span><br><span class="line">                &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// in job class</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">middleware</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    <span class="hljs-keyword">return</span> [<span class="hljs-keyword">new</span> RateLimited];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>建立一個 job middleware, 利用 redis throttle 限制 job 每 5 秒可以執行 1 次, 並在 job 中使用該 middleware</p>
</li>
</ul>
<br>
<br>

<h2 id="Dispatching-Jobs"><a href="#Dispatching-Jobs" class="headerlink" title="# Dispatching Jobs"></a># Dispatching Jobs</h2><h6 id="以下的-Laravel-example-code-的意思是？-3"><a href="#以下的-Laravel-example-code-的意思是？-3" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Controllers</span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Controllers</span>\<span class="hljs-title">Controller</span>;</span><br><span class="line"><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Jobs</span>\<span class="hljs-title">ProcessPodcast</span>;</span><br><span class="line"><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Request</span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PodcastController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Controller</span></span></span><br><span class="line"><span class="hljs-class"></span>&#123;</span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">store</span><span class="hljs-params">(Request $request)</span></span></span><br><span class="line"><span class="hljs-function">    </span>&#123;</span><br><span class="line">        <span class="hljs-comment">// Create podcast...</span></span><br><span class="line"></span><br><span class="line">        ProcessPodcast::dispatch($podcast);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>dispatch 一個 job</p>
</li>
</ul>
<br>
<br>

<h2 id="Delayed-Dispatching"><a href="#Delayed-Dispatching" class="headerlink" title="# Delayed Dispatching"></a># Delayed Dispatching</h2><h6 id="以下的-Laravel-example-code-的意思是？-4"><a href="#以下的-Laravel-example-code-的意思是？-4" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Controllers</span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Controllers</span>\<span class="hljs-title">Controller</span>;</span><br><span class="line"><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Jobs</span>\<span class="hljs-title">ProcessPodcast</span>;</span><br><span class="line"><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Request</span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PodcastController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Controller</span></span></span><br><span class="line"><span class="hljs-class"></span>&#123;</span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">store</span><span class="hljs-params">(Request $request)</span></span></span><br><span class="line"><span class="hljs-function">    </span>&#123;</span><br><span class="line">        <span class="hljs-comment">// Create podcast...</span></span><br><span class="line"></span><br><span class="line">        ProcessPodcast::dispatch($podcast)</span><br><span class="line">                -&gt;delay(now()-&gt;addMinutes(<span class="hljs-number">10</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>delay dispatch 該 job 的時間, 10 分鐘後在 dispatch</p>
</li>
</ul>
<h6 id="在-Laravel-Queue-中-AWS-的-SQS-最多支援到-delay-多久？"><a href="#在-Laravel-Queue-中-AWS-的-SQS-最多支援到-delay-多久？" class="headerlink" title="在 Laravel Queue 中, AWS 的 SQS 最多支援到 delay 多久？"></a><strong>在 Laravel Queue 中, AWS 的 SQS 最多支援到 delay 多久？</strong></h6><p>15 分鐘</p>
<br>
<br>

<h2 id="Synchronous-Dispatching"><a href="#Synchronous-Dispatching" class="headerlink" title="# Synchronous Dispatching"></a># Synchronous Dispatching</h2><h6 id="以下的-Laravel-example-code-的意思是？-5"><a href="#以下的-Laravel-example-code-的意思是？-5" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Controllers</span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Controllers</span>\<span class="hljs-title">Controller</span>;</span><br><span class="line"><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Jobs</span>\<span class="hljs-title">ProcessPodcast</span>;</span><br><span class="line"><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Request</span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PodcastController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Controller</span></span></span><br><span class="line"><span class="hljs-class"></span>&#123;</span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">store</span><span class="hljs-params">(Request $request)</span></span></span><br><span class="line"><span class="hljs-function">    </span>&#123;</span><br><span class="line">        <span class="hljs-comment">// Create podcast...</span></span><br><span class="line"></span><br><span class="line">        ProcessPodcast::dispatchNow($podcast);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>立即 dispatch 這個 job, 不使用 queue</p>
</li>
</ul>
<br>
<br>

<h2 id="Job-Chaining"><a href="#Job-Chaining" class="headerlink" title="# Job Chaining"></a># Job Chaining</h2><h6 id="在-Laravel-Job-chaining-中-如果其中一個-job-失敗了-後面的還會繼續執行嗎？"><a href="#在-Laravel-Job-chaining-中-如果其中一個-job-失敗了-後面的還會繼續執行嗎？" class="headerlink" title="在 Laravel Job chaining 中, 如果其中一個 job 失敗了, 後面的還會繼續執行嗎？"></a><strong>在 Laravel Job chaining 中, 如果其中一個 job 失敗了, 後面的還會繼續執行嗎？</strong></h6><p>不會</p>
<h6 id="在-Laravel-Job-chaining-中-如果我使用-this-gt-delete-會終止後面的-job-執行嗎？"><a href="#在-Laravel-Job-chaining-中-如果我使用-this-gt-delete-會終止後面的-job-執行嗎？" class="headerlink" title="在 Laravel Job chaining 中, 如果我使用 $this-&gt;delete(), 會終止後面的 job 執行嗎？"></a><strong>在 Laravel Job chaining 中, 如果我使用 <code>$this-&gt;delete()</code>, 會終止後面的 job 執行嗎？</strong></h6><p>不會</p>
<h6 id="以下的-Laravel-example-code-的意思是？-6"><a href="#以下的-Laravel-example-code-的意思是？-6" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line">ProcessPodcast::withChain([</span><br><span class="line">    <span class="hljs-keyword">new</span> OptimizePodcast,</span><br><span class="line">    <span class="hljs-keyword">new</span> ReleasePodcast</span><br><span class="line">])-&gt;dispatch();</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>使用 withChain() 實現 job chaining, job 會按照順序執行</p>
</li>
</ul>
<br>

<h3 id="Chain-Connection-amp-Queue"><a href="#Chain-Connection-amp-Queue" class="headerlink" title="# Chain Connection &amp; Queue"></a># Chain Connection &amp; Queue</h3><h6 id="以下的-Laravel-example-code-的意思是？-7"><a href="#以下的-Laravel-example-code-的意思是？-7" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line">ProcessPodcast::withChain([</span><br><span class="line">    <span class="hljs-keyword">new</span> OptimizePodcast,</span><br><span class="line">    <span class="hljs-keyword">new</span> ReleasePodcast</span><br><span class="line">])-&gt;dispatch()-&gt;allOnConnection(<span class="hljs-string">'redis'</span>)-&gt;allOnQueue(<span class="hljs-string">'podcasts'</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>使用 withChain() 實現 job chaining, 並指定該 chaining 的 connection 以及 queue</p>
</li>
</ul>
<br>
<br>

<h2 id="Customizing-The-Queue-amp-Connection"><a href="#Customizing-The-Queue-amp-Connection" class="headerlink" title="# Customizing The Queue &amp; Connection"></a># Customizing The Queue &amp; Connection</h2><h3 id="Dispatching-To-A-Particular-Queue"><a href="#Dispatching-To-A-Particular-Queue" class="headerlink" title="# Dispatching To A Particular Queue"></a># Dispatching To A Particular Queue</h3><h6 id="以下的-Laravel-example-code-的意思是？-8"><a href="#以下的-Laravel-example-code-的意思是？-8" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Controllers</span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Controllers</span>\<span class="hljs-title">Controller</span>;</span><br><span class="line"><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Jobs</span>\<span class="hljs-title">ProcessPodcast</span>;</span><br><span class="line"><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Request</span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PodcastController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Controller</span></span></span><br><span class="line"><span class="hljs-class"></span>&#123;</span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">store</span><span class="hljs-params">(Request $request)</span></span></span><br><span class="line"><span class="hljs-function">    </span>&#123;</span><br><span class="line">        <span class="hljs-comment">// Create podcast...</span></span><br><span class="line"></span><br><span class="line">        ProcessPodcast::dispatch($podcast)-&gt;onQueue(<span class="hljs-string">'processing'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>使用 onQueue() 來指定 queue</p>
</li>
</ul>
<br>

<h3 id="Dispatching-To-A-Particular-Connection"><a href="#Dispatching-To-A-Particular-Connection" class="headerlink" title="# Dispatching To A Particular Connection"></a># Dispatching To A Particular Connection</h3><h6 id="以下的-Laravel-example-code-的意思是？-9"><a href="#以下的-Laravel-example-code-的意思是？-9" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?Php</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Controllers</span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Controllers</span>\<span class="hljs-title">Controller</span>;</span><br><span class="line"><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Jobs</span>\<span class="hljs-title">ProcessPodcast</span>;</span><br><span class="line"><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Request</span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PodcastController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Controller</span></span></span><br><span class="line"><span class="hljs-class"></span>&#123;</span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">store</span><span class="hljs-params">(Request $request)</span></span></span><br><span class="line"><span class="hljs-function">    </span>&#123;</span><br><span class="line">        <span class="hljs-comment">// Create podcast...</span></span><br><span class="line"></span><br><span class="line">        ProcessPodcast::dispatch($podcast)-&gt;onConnection(<span class="hljs-string">'sqs'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>如果我使用不只一個 connection, 可使用 onConnection() 指定特定的 connection</p>
</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-10"><a href="#以下的-Laravel-example-code-的意思是？-10" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Jobs</span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProcessPodcast</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ShouldQueue</span></span></span><br><span class="line"><span class="hljs-class"></span>&#123;</span><br><span class="line">    <span class="hljs-keyword">public</span> $connection = <span class="hljs-string">'sqs'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>在 job class 中, 可使用 $connection property 指定該 job 的 connection</p>
</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-11"><a href="#以下的-Laravel-example-code-的意思是？-11" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line">ProcessPodcast::dispatch($podcast)</span><br><span class="line">              -&gt;onConnection(<span class="hljs-string">'sqs'</span>)</span><br><span class="line">              -&gt;onQueue(<span class="hljs-string">'processing'</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>dispatch 時指定該 job 的 connection 以及 queue</p>
</li>
</ul>
<br>
<br>

<h2 id="Specifying-Max-Job-Attempts-Timeout-Values"><a href="#Specifying-Max-Job-Attempts-Timeout-Values" class="headerlink" title="# Specifying Max Job Attempts / Timeout Values"></a># Specifying Max Job Attempts / Timeout Values</h2><h3 id="Max-Attempts"><a href="#Max-Attempts" class="headerlink" title="# Max Attempts"></a># Max Attempts</h3><h6 id="以下的-Laravel-example-code-的意思是？-12"><a href="#以下的-Laravel-example-code-的意思是？-12" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">php artisan queue:work --tries=3</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>指定 worker 的嘗試次數, 會嘗試執行 job 最多 3 次, 第一次也算一次, release() 也算一次, 如果 3 次都失敗, 才會把它放到 failed_job table 內</p>
<h6 id="以下的-Laravel-example-code-的意思是？-13"><a href="#以下的-Laravel-example-code-的意思是？-13" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6></li>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Jobs</span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProcessPodcast</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ShouldQueue</span></span></span><br><span class="line"><span class="hljs-class"></span>&#123;</span><br><span class="line">    <span class="hljs-keyword">public</span> $tries = <span class="hljs-number">5</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>指定該 job 的最大嘗試次數, 如果 5 次都執行失敗, release() 也算 1 次, 第一次也算, 那 worker 就會將這個 job 放到 failed_job table 中, 不再嘗試執行</p>
<h6 id="Laravel-job-當中-當我同時在-job-class-中-以及-CLI-中都指令最大嘗試次數-Laravel-會以誰為準？"><a href="#Laravel-job-當中-當我同時在-job-class-中-以及-CLI-中都指令最大嘗試次數-Laravel-會以誰為準？" class="headerlink" title="Laravel job 當中, 當我同時在 job class 中, 以及 CLI 中都指令最大嘗試次數, Laravel 會以誰為準？"></a><strong>Laravel job 當中, 當我同時在 job class 中, 以及 CLI 中都指令最大嘗試次數, Laravel 會以誰為準？</strong></h6><p>job class 中指定的 property</p>
</li>
</ul>
<br>

<h3 id="Time-Based-Attempts"><a href="#Time-Based-Attempts" class="headerlink" title="# Time Based Attempts"></a># Time Based Attempts</h3><h6 id="以下的-Laravel-example-code-的意思是？-14"><a href="#以下的-Laravel-example-code-的意思是？-14" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">retryUntil</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    <span class="hljs-keyword">return</span> now()-&gt;addSeconds(<span class="hljs-number">5</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>為這個 job 定義一個可被執行的時間限制, 超過 5 秒後, 這個 job 就會被放到 failed_table 中</p>
</li>
</ul>
<br>

<h3 id="Timeout"><a href="#Timeout" class="headerlink" title="# Timeout"></a># Timeout</h3><h6 id="以下的-Laravel-example-code-的意思是？-15"><a href="#以下的-Laravel-example-code-的意思是？-15" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">php artisan queue:work --timeout=30</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>該 worker 最多執行一個 job 30 秒, 若超過 30 秒視為 timeout</p>
</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-16"><a href="#以下的-Laravel-example-code-的意思是？-16" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Jobs</span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProcessPodcast</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ShouldQueue</span></span></span><br><span class="line"><span class="hljs-class"></span>&#123;</span><br><span class="line">    <span class="hljs-keyword">public</span> $timeout = <span class="hljs-number">120</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>指定 timeout, 為該 job 可執行的最大秒數, 通過即視為失敗, 失敗超過 tries property 限制即視為 failed</p>
</li>
</ul>
<h6 id="Laravel-job-當中-如果我再-CLI-以及-job-的-class-同時定義的-timeout-哪一個的優先權比較大？"><a href="#Laravel-job-當中-如果我再-CLI-以及-job-的-class-同時定義的-timeout-哪一個的優先權比較大？" class="headerlink" title="Laravel job 當中, 如果我再 CLI 以及 job 的 class 同時定義的 timeout, 哪一個的優先權比較大？"></a><strong>Laravel job 當中, 如果我再 CLI 以及 job 的 class 同時定義的 timeout, 哪一個的優先權比較大？</strong></h6><p>job class</p>
<br>
<br>

<h2 id="Rate-Limiting"><a href="#Rate-Limiting" class="headerlink" title="# Rate Limiting"></a># Rate Limiting</h2><h6 id="Laravel-queue-當中-如果我想使用-rate-limiting-哪一個服務會是必要的？"><a href="#Laravel-queue-當中-如果我想使用-rate-limiting-哪一個服務會是必要的？" class="headerlink" title="Laravel queue 當中, 如果我想使用 rate limiting, 哪一個服務會是必要的？"></a><strong>Laravel queue 當中, 如果我想使用 rate limiting, 哪一個服務會是必要的？</strong></h6><p>redis</p>
<h6 id="以下的-Laravel-example-code-的意思是？-17"><a href="#以下的-Laravel-example-code-的意思是？-17" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line">Redis::throttle(<span class="hljs-string">'key'</span>)-&gt;allow(<span class="hljs-number">10</span>)-&gt;every(<span class="hljs-number">60</span>)-&gt;then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">    <span class="hljs-comment">// Job logic...</span></span><br><span class="line">&#125;, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">    <span class="hljs-comment">// Could not obtain lock...</span></span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;release(<span class="hljs-number">10</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>定義特定的 key, 可以是 <code>job 的類型 + 該 Eloquent Model 的 id</code><br>每 60 秒最大可執行 10 次, 若失敗的話, 10 秒後 release job </p>
</li>
</ul>
<h6 id="下面的-Laravel-程式碼中-當我-release-該-job-這樣還會增加該-job-的-attempt-次數嗎？"><a href="#下面的-Laravel-程式碼中-當我-release-該-job-這樣還會增加該-job-的-attempt-次數嗎？" class="headerlink" title="下面的 Laravel 程式碼中, 當我 release 該 job, 這樣還會增加該 job 的 attempt 次數嗎？"></a><strong>下面的 Laravel 程式碼中, 當我 release 該 job, 這樣還會增加該 job 的 attempt 次數嗎？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line">Redis::throttle(<span class="hljs-string">'key'</span>)-&gt;allow(<span class="hljs-number">10</span>)-&gt;every(<span class="hljs-number">60</span>)-&gt;then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">    <span class="hljs-comment">// Job logic...</span></span><br><span class="line">&#125;, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">    <span class="hljs-comment">// Could not obtain lock...</span></span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;release(<span class="hljs-number">10</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>會哦</p>
</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-18"><a href="#以下的-Laravel-example-code-的意思是？-18" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line">Redis::funnel(<span class="hljs-string">'yourKey'</span>)-&gt;limit(<span class="hljs-number">1</span>)-&gt;then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">    <span class="hljs-comment">// Job logic...</span></span><br><span class="line">&#125;, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">    <span class="hljs-comment">// Could not obtain lock...</span></span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;release(<span class="hljs-number">10</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>使用 redis 記錄一個 key, 並給予這個 key 一個 job, 限制有著該 key 的 job 每次只能由一個 worker 執行</p>
</li>
</ul>
<br>
<br>

<h2 id="Queueing-Closures"><a href="#Queueing-Closures" class="headerlink" title="# Queueing Closures"></a># Queueing Closures</h2><h6 id="在-Laravel-中-什麼情況我們可能會需要-dispatch-一個-closure"><a href="#在-Laravel-中-什麼情況我們可能會需要-dispatch-一個-closure" class="headerlink" title="在 Laravel 中, 什麼情況我們可能會需要 dispatch 一個 closure?"></a><strong>在 Laravel 中, 什麼情況我們可能會需要 dispatch 一個 closure?</strong></h6><p>當我們想要執行一個簡單的任務, 且需要它被在請求之外的週期執行</p>
<h6 id="在-Laravel-中-如何-dispatch-一個-closure"><a href="#在-Laravel-中-如何-dispatch-一個-closure" class="headerlink" title="在 Laravel 中, 如何 dispatch 一個 closure?"></a><strong>在 Laravel 中, 如何 dispatch 一個 closure?</strong></h6><figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line">$podcast = App\Podcast::find(<span class="hljs-number">1</span>);</span><br><span class="line"></span><br><span class="line">dispatch(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> <span class="hljs-title">use</span> <span class="hljs-params">($podcast)</span> </span>&#123;</span><br><span class="line">    $podcast-&gt;publish();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<br>
<br>

<h2 id="Running-The-Queue-Worker"><a href="#Running-The-Queue-Worker" class="headerlink" title="# Running The Queue Worker"></a># Running The Queue Worker</h2><h6 id="在-Laravel-中-怎麼樣啟動-worker-來執行-queued-job"><a href="#在-Laravel-中-怎麼樣啟動-worker-來執行-queued-job" class="headerlink" title="在 Laravel 中, 怎麼樣啟動 worker 來執行 queued job?"></a><strong>在 Laravel 中, 怎麼樣啟動 worker 來執行 queued job?</strong></h6><figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">php artisan queue:work</span><br></pre></td></tr></table></figure>

<h6 id="在-Laravel-中-要維持-worker-持續運行-我們需要額外啟動什麼？"><a href="#在-Laravel-中-要維持-worker-持續運行-我們需要額外啟動什麼？" class="headerlink" title="在 Laravel 中, 要維持 worker 持續運行, 我們需要額外啟動什麼？"></a><strong>在 Laravel 中, 要維持 worker 持續運行, 我們需要額外啟動什麼？</strong></h6><p>程序管理器, 像是 <code>supervisor</code>, 或 <code>pm2</code></p>
<h6 id="在-Laravel-中-當我使用-php-artisan-queue-work-當我代碼有變更時-我需要重新啟動-queue-嗎？"><a href="#在-Laravel-中-當我使用-php-artisan-queue-work-當我代碼有變更時-我需要重新啟動-queue-嗎？" class="headerlink" title="在 Laravel 中, 當我使用 php artisan queue:work, 當我代碼有變更時, 我需要重新啟動 queue 嗎？"></a><strong>在 Laravel 中, 當我使用 <code>php artisan queue:work</code>, 當我代碼有變更時, 我需要重新啟動 queue 嗎？</strong></h6><p>需要</p>
<h6 id="在-Laravel-中-如果我運行-php-artisan-queue-listen-然後我變更了代碼-我需要再重新啟動-queue-嗎？"><a href="#在-Laravel-中-如果我運行-php-artisan-queue-listen-然後我變更了代碼-我需要再重新啟動-queue-嗎？" class="headerlink" title="在 Laravel 中, 如果我運行 php artisan queue:listen, 然後我變更了代碼, 我需要再重新啟動 queue 嗎？"></a><strong>在 Laravel 中, 如果我運行 <code>php artisan queue:listen</code>, 然後我變更了代碼, 我需要再重新啟動 queue 嗎？</strong></h6><p>不需要</p>
<h6 id="在-Laravel-中-如果我不想要每次變更代碼就重新啟動-queue-我可以使用哪一個-CLI"><a href="#在-Laravel-中-如果我不想要每次變更代碼就重新啟動-queue-我可以使用哪一個-CLI" class="headerlink" title="在 Laravel 中, 如果我不想要每次變更代碼就重新啟動 queue, 我可以使用哪一個 CLI?"></a><strong>在 Laravel 中, 如果我不想要每次變更代碼就重新啟動 queue, 我可以使用哪一個 CLI?</strong></h6><figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">php artisan queue:listen</span><br></pre></td></tr></table></figure>

<h6 id="在-Laravel-中-php-artisan-queue-work-跟-php-artisan-queue-listen-何者較有效率？"><a href="#在-Laravel-中-php-artisan-queue-work-跟-php-artisan-queue-listen-何者較有效率？" class="headerlink" title="在 Laravel 中, php artisan queue:work 跟 php artisan queue:listen 何者較有效率？"></a><strong>在 Laravel 中, <code>php artisan queue:work</code> 跟 <code>php artisan queue:listen</code> 何者較有效率？</strong></h6><figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">php artisan queue:work</span><br></pre></td></tr></table></figure>

<br>

<h3 id="Specifying-The-Connection-amp-Queue"><a href="#Specifying-The-Connection-amp-Queue" class="headerlink" title="# Specifying The Connection &amp; Queue"></a># Specifying The Connection &amp; Queue</h3><h6 id="在-Laravel-中-如何透過-CLI-指定-queue-connection"><a href="#在-Laravel-中-如何透過-CLI-指定-queue-connection" class="headerlink" title="在 Laravel 中, 如何透過 CLI 指定 queue connection?"></a><strong>在 Laravel 中, 如何透過 CLI 指定 queue connection?</strong></h6><figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">php artisan queue:work redis</span><br></pre></td></tr></table></figure>

<h6 id="在-Laravel-中-如何透過-CLI-給特定的-queue-指定特定-connection"><a href="#在-Laravel-中-如何透過-CLI-給特定的-queue-指定特定-connection" class="headerlink" title="在 Laravel 中, 如何透過 CLI 給特定的 queue 指定特定 connection?"></a><strong>在 Laravel 中, 如何透過 CLI 給特定的 queue 指定特定 connection?</strong></h6><figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">php artisan queue:work redis --queue=emails</span><br></pre></td></tr></table></figure>

<br>

<h3 id="Processing-A-Single-Job"><a href="#Processing-A-Single-Job" class="headerlink" title="# Processing A Single Job"></a># Processing A Single Job</h3><h6 id="在-Laravel-中-如何透過-CLI-指定-worker-只執行-queued-job-一次"><a href="#在-Laravel-中-如何透過-CLI-指定-worker-只執行-queued-job-一次" class="headerlink" title="在 Laravel 中, 如何透過 CLI 指定 worker 只執行 queued job 一次"></a><strong>在 Laravel 中, 如何透過 CLI 指定 worker 只執行 queued job 一次</strong></h6><figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">php artisan queue:work --once</span><br></pre></td></tr></table></figure>

<br>

<h3 id="Processing-All-Queued-Jobs-amp-Then-Exiting"><a href="#Processing-All-Queued-Jobs-amp-Then-Exiting" class="headerlink" title="# Processing All Queued Jobs &amp; Then Exiting"></a># Processing All Queued Jobs &amp; Then Exiting</h3><h6 id="以下的-Laravel-example-command-的意思是？"><a href="#以下的-Laravel-example-command-的意思是？" class="headerlink" title="以下的 Laravel example command 的意思是？"></a><strong>以下的 Laravel example command 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">php artisan queue:work --stop-when-empty</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>該 worker 執行完所有的 queue job 之後就會關閉</p>
</li>
</ul>
<h6 id="以下的-Laravel-指令什麼時候可能會用到？"><a href="#以下的-Laravel-指令什麼時候可能會用到？" class="headerlink" title="以下的 Laravel 指令什麼時候可能會用到？"></a><strong>以下的 Laravel 指令什麼時候可能會用到？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">php artisan queue:work --stop-when-empty</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>當我們利用容器運行 worker, 而我們需要工作都完成後自動關閉 container 時</p>
</li>
</ul>
<br>

<h3 id="Resource-Considerations"><a href="#Resource-Considerations" class="headerlink" title="# Resource Considerations"></a># Resource Considerations</h3><h6 id="在-Laravel-的-queue-中-因為會緩存在-RAM-中運行-所以如果我有執行到未釋放的資源-像是-image-之類的-那我是否要在-job-執行完成之後釋放掉這些資源？"><a href="#在-Laravel-的-queue-中-因為會緩存在-RAM-中運行-所以如果我有執行到未釋放的資源-像是-image-之類的-那我是否要在-job-執行完成之後釋放掉這些資源？" class="headerlink" title="在 Laravel 的 queue 中, 因為會緩存在 RAM 中運行, 所以如果我有執行到未釋放的資源, 像是 image 之類的, 那我是否要在 job 執行完成之後釋放掉這些資源？"></a><strong>在 Laravel 的 queue 中, 因為會緩存在 RAM 中運行, 所以如果我有執行到未釋放的資源, 像是 image 之類的, 那我是否要在 job 執行完成之後釋放掉這些資源？</strong></h6><p>要哦</p>
<br>
<br>

<h2 id="Queue-Priorities"><a href="#Queue-Priorities" class="headerlink" title="# Queue Priorities"></a># Queue Priorities</h2><h6 id="以下的-Laravel-example-code-的意思是？-19"><a href="#以下的-Laravel-example-code-的意思是？-19" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">php artisan queue:work --queue=high,low</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>定義 queue 的 priority 順序</p>
</li>
</ul>
<br>
<br>

<h2 id="Queue-Workers-amp-Deployment"><a href="#Queue-Workers-amp-Deployment" class="headerlink" title="# Queue Workers &amp; Deployment"></a># Queue Workers &amp; Deployment</h2><h3 id="Job-Expiration"><a href="#Job-Expiration" class="headerlink" title="# Job Expiration"></a># Job Expiration</h3><h6 id="在-Laravel-的-queue-監聽程序中-我要如何重啟-queue？"><a href="#在-Laravel-的-queue-監聽程序中-我要如何重啟-queue？" class="headerlink" title="在 Laravel 的 queue 監聽程序中, 我要如何重啟 queue？"></a><strong>在 Laravel 的 queue 監聽程序中, 我要如何重啟 queue？</strong></h6><figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">php artisan queue:restart</span><br></pre></td></tr></table></figure>

<h6 id="在-Laravel-的-queue-監聽-CLI-php-artisan-queue-restart-會不會讓我丟失執行到一半的工作？"><a href="#在-Laravel-的-queue-監聽-CLI-php-artisan-queue-restart-會不會讓我丟失執行到一半的工作？" class="headerlink" title="在 Laravel 的 queue 監聽 CLI php artisan queue:restart, 會不會讓我丟失執行到一半的工作？"></a><strong>在 Laravel 的 queue 監聽 CLI <code>php artisan queue:restart</code>, 會不會讓我丟失執行到一半的工作？</strong></h6><p>不會哦, 它會 gracefully restart, 完成目前手邊工作之後再重啟</p>
<h6 id="Laravel-中-在沒有使用-supervisor-的情況下-如果我執行-php-artisan-queue-restart-會發生什麼事？"><a href="#Laravel-中-在沒有使用-supervisor-的情況下-如果我執行-php-artisan-queue-restart-會發生什麼事？" class="headerlink" title="Laravel 中, 在沒有使用 supervisor 的情況下, 如果我執行 php artisan queue:restart, 會發生什麼事？"></a><strong>Laravel 中, 在沒有使用 supervisor 的情況下, 如果我執行 <code>php artisan queue:restart</code>, 會發生什麼事？</strong></h6><p>worker 會關閉</p>
<h6 id="Laravel-中-若要使用-php-artisan-queue-restart-務必先要確認什麼服務已經設置好？"><a href="#Laravel-中-若要使用-php-artisan-queue-restart-務必先要確認什麼服務已經設置好？" class="headerlink" title="Laravel 中, 若要使用 php artisan queue:restart, 務必先要確認什麼服務已經設置好？"></a><strong>Laravel 中, 若要使用 <code>php artisan queue:restart</code>, 務必先要確認什麼服務已經設置好？</strong></h6><p>cache</p>
<h6 id="Laravel-中-當我使用-php-artisan-queue-restart-queue-會將-restart-的-signal-存在什麼地方？"><a href="#Laravel-中-當我使用-php-artisan-queue-restart-queue-會將-restart-的-signal-存在什麼地方？" class="headerlink" title="Laravel 中, 當我使用 php artisan queue:restart, queue 會將 restart 的 signal 存在什麼地方？"></a><strong>Laravel 中, 當我使用 <code>php artisan queue:restart</code>, queue 會將 restart 的 signal 存在什麼地方？</strong></h6><p>cache</p>
<h6 id="Laravel-queue-中-如果我要-globally-定義-job-在執行之後多久時間之後才可以再被執行-如果沒被刪除的話-我可以怎麼做？"><a href="#Laravel-queue-中-如果我要-globally-定義-job-在執行之後多久時間之後才可以再被執行-如果沒被刪除的話-我可以怎麼做？" class="headerlink" title="Laravel queue 中, 如果我要 globally 定義 job 在執行之後多久時間之後才可以再被執行 (如果沒被刪除的話), 我可以怎麼做？"></a><strong>Laravel queue 中, 如果我要 globally 定義 job 在執行之後多久時間之後才可以再被執行 (如果沒被刪除的話), 我可以怎麼做？</strong></h6><p>在 <code>queue.php</code> 的 config 檔案中, 可以設定 <strong>retry_after</strong> 的參數</p>
<h6 id="Laravel-queue-中-哪一個服務無法在-queue-php-config-中設定-retry-after-參數"><a href="#Laravel-queue-中-哪一個服務無法在-queue-php-config-中設定-retry-after-參數" class="headerlink" title="Laravel queue 中, 哪一個服務無法在 queue.php config 中設定 retry_after 參數"></a><strong>Laravel queue 中, 哪一個服務無法在 queue.php config 中設定 <code>retry_after</code> 參數</strong></h6><p>Amazon SQS</p>
<br>

<h3 id="Worker-Timeouts"><a href="#Worker-Timeouts" class="headerlink" title="# Worker Timeouts"></a># Worker Timeouts</h3><h6 id="Laravel-queue-中-timeout-跟-retry-after-的差別在哪？"><a href="#Laravel-queue-中-timeout-跟-retry-after-的差別在哪？" class="headerlink" title="Laravel queue 中, --timeout 跟 retry_after 的差別在哪？"></a><strong>Laravel queue 中, <code>--timeout</code> 跟 <code>retry_after</code> 的差別在哪？</strong></h6><p><code>--timeout</code>: queue 的 master 程序需等待多久的時間才可以殺掉一個執行同樣一個 job 的子程序<br><code>retry_after</code>: queue 的 master 程序需要隔多久才可以重啟一個子程序來執行之前執行過的 job</p>
<h6 id="Laravel-queue-中-timeout-跟-retry-after-的時間-哪個長哪個短？"><a href="#Laravel-queue-中-timeout-跟-retry-after-的時間-哪個長哪個短？" class="headerlink" title="Laravel queue 中, --timeout 跟 retry_after 的時間, 哪個長哪個短？"></a><strong>Laravel queue 中, <code>--timeout</code> 跟 <code>retry_after</code> 的時間, 哪個長哪個短？</strong></h6><p><code>--retry_after</code> 需要比 <code>--timeout</code> 來得長</p>
<h6 id="Laravel-queue-中-如果-retry-after-比-timeout-設定的時間還短-可能會發生什麼事？"><a href="#Laravel-queue-中-如果-retry-after-比-timeout-設定的時間還短-可能會發生什麼事？" class="headerlink" title="Laravel queue 中, 如果 retry_after 比 --timeout 設定的時間還短, 可能會發生什麼事？"></a><strong>Laravel queue 中, 如果 <code>retry_after</code> 比 <code>--timeout</code> 設定的時間還短, 可能會發生什麼事？</strong></h6><p>同一個 job 會被執行兩次</p>
<br>

<h3 id="Worker-Sleep-Duration"><a href="#Worker-Sleep-Duration" class="headerlink" title="# Worker Sleep Duration"></a># Worker Sleep Duration</h3><h6 id="Laravel-queue-中-如果我要讓-worker-沒有新的-job-時會進入休眠狀態-那我可以怎麼做？"><a href="#Laravel-queue-中-如果我要讓-worker-沒有新的-job-時會進入休眠狀態-那我可以怎麼做？" class="headerlink" title="Laravel queue 中, 如果我要讓 worker 沒有新的 job 時會進入休眠狀態, 那我可以怎麼做？"></a><strong>Laravel queue 中, 如果我要讓 worker 沒有新的 job 時會進入休眠狀態, 那我可以怎麼做？</strong></h6><figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">php artisan queue:work --sleep=3</span><br></pre></td></tr></table></figure>

<h6 id="Laravel-queue-中-如果我有使用-sleep-的-option-當-queue-裡頭有很多-job-還沒有執行完畢時-worker-會進入-sleep-狀態嗎？"><a href="#Laravel-queue-中-如果我有使用-sleep-的-option-當-queue-裡頭有很多-job-還沒有執行完畢時-worker-會進入-sleep-狀態嗎？" class="headerlink" title="Laravel queue 中, 如果我有使用 --sleep 的 option, 當 queue 裡頭有很多 job 還沒有執行完畢時, worker 會進入 sleep 狀態嗎？"></a><strong>Laravel queue 中, 如果我有使用 <code>--sleep</code> 的 option, 當 queue 裡頭有很多 job 還沒有執行完畢時, worker 會進入 sleep 狀態嗎？</strong></h6><p>不會, 會等到所有 job 都處理完畢, 沒有新的 job 了 worker 才會進入 sleep 狀態</p>
<h6 id="Laravel-queue-中-如果我有使用-sleep-的-option-當-worker-處於-sleep-的狀態時-如果有新的-job-進來-worker-會等到-sleep-結束再處理-還是會立即處理？"><a href="#Laravel-queue-中-如果我有使用-sleep-的-option-當-worker-處於-sleep-的狀態時-如果有新的-job-進來-worker-會等到-sleep-結束再處理-還是會立即處理？" class="headerlink" title="Laravel queue 中, 如果我有使用 --sleep 的 option, 當 worker 處於 sleep 的狀態時, 如果有新的 job 進來, worker 會等到 sleep 結束再處理, 還是會立即處理？"></a><strong>Laravel queue 中, 如果我有使用 <code>--sleep</code> 的 option, 當 worker 處於 sleep 的狀態時, 如果有新的 job 進來, worker 會等到 sleep 結束再處理, 還是會立即處理？</strong></h6><p>待 sleep 結束才會處理</p>
<br>
<br>

<h2 id="Supervisor-Configuration"><a href="#Supervisor-Configuration" class="headerlink" title="# Supervisor Configuration"></a># Supervisor Configuration</h2><h3 id="Installing-Supervisor"><a href="#Installing-Supervisor" class="headerlink" title="# Installing Supervisor"></a># Installing Supervisor</h3><h6 id="如何安裝-supervisor"><a href="#如何安裝-supervisor" class="headerlink" title="如何安裝 supervisor ?"></a><strong>如何安裝 supervisor ?</strong></h6><figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">sudo apt-get install supervisor</span><br></pre></td></tr></table></figure>

<h6 id="Supervisor-的設定檔位置在哪？"><a href="#Supervisor-的設定檔位置在哪？" class="headerlink" title="Supervisor 的設定檔位置在哪？"></a><strong>Supervisor 的設定檔位置在哪？</strong></h6><p><code>/etc/supervisor/conf.d</code></p>
<h6 id="以下的-supervisor-config-example-的意思是？"><a href="#以下的-supervisor-config-example-的意思是？" class="headerlink" title="以下的 supervisor config example 的意思是？"></a><strong>以下的 supervisor config example 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">[program:laravel-worker]</span><br><span class="line">process_name=%(program_name)s_%(process_num)02d</span><br><span class="line">command=php /home/forge/app.com/artisan queue:work sqs --sleep=3 --tries=3</span><br><span class="line">autostart=true</span><br><span class="line">autorestart=true</span><br><span class="line">user=forge</span><br><span class="line">numprocs=8</span><br><span class="line">redirect_stderr=true</span><br><span class="line">stdout_logfile=/home/forge/app.com/worker.log</span><br><span class="line">stopwaitsecs=3600</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:</p>
<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">[program:laravel-worker]</span><br><span class="line">process_name=%(program_name)s_%(process_num)02d</span><br><span class="line">command=php /home/forge/app.com/artisan queue:work sqs --sleep=3 --tries=3</span><br><span class="line">// 是否隨 supervisor 啟動一起啟動</span><br><span class="line">autostart=true</span><br><span class="line">// 程序異常退出後自動重啟</span><br><span class="line">autorestart=true</span><br><span class="line">user=forge</span><br><span class="line">numprocs=8</span><br><span class="line">// 是否教錯誤的 log 一併記錄到 stdout</span><br><span class="line">redirect_stderr=true</span><br><span class="line">// 一般輸出的記錄檔案位址</span><br><span class="line">stdout_logfile=/home/forge/app.com/worker.log</span><br><span class="line">// 刪除一個 job 的等待時間, 這邊需設定大於會執行最久的 job 的時間, 不然會在執行完畢前被砍掉</span><br><span class="line">stopwaitsecs=3600</span><br></pre></td></tr></table></figure>

</li>
</ul>
<br>

<h3 id="Starting-Supervisor"><a href="#Starting-Supervisor" class="headerlink" title="# Starting Supervisor"></a># Starting Supervisor</h3><h6 id="以下的-supervisor-example-command-的意思是？"><a href="#以下的-supervisor-example-command-的意思是？" class="headerlink" title="以下的 supervisor example command 的意思是？"></a><strong>以下的 supervisor example command 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">sudo supervisorctl reread</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>重新讀取 config 檔, 但不重啟 process</p>
</li>
</ul>
<h6 id="以下的-supervisor-example-command-的意思是？-1"><a href="#以下的-supervisor-example-command-的意思是？-1" class="headerlink" title="以下的 supervisor example command 的意思是？"></a><strong>以下的 supervisor example command 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">sudo supervisorctl update</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>重新讀取 config 檔, 並依照 config 檔案重啟 process</p>
</li>
</ul>
<h6 id="以下的-supervisor-example-command-的意思是？-2"><a href="#以下的-supervisor-example-command-的意思是？-2" class="headerlink" title="以下的 supervisor example command 的意思是？"></a><strong>以下的 supervisor example command 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">sudo supervisorctl start laravel-worker:*</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>啟動 supervisor</p>
</li>
</ul>
<h6 id="Supervisor-官方文件位址"><a href="#Supervisor-官方文件位址" class="headerlink" title="Supervisor 官方文件位址?"></a><strong>Supervisor 官方文件位址?</strong></h6><p><a href="http://supervisord.org/running.html#running-supervisord" target="_blank" rel="noopener">Supervisor 官方文件</a></p>
<br>
<br>

<h2 id="Dealing-With-Failed-Jobs"><a href="#Dealing-With-Failed-Jobs" class="headerlink" title="# Dealing With Failed Jobs"></a># Dealing With Failed Jobs</h2><h6 id="Laravel-queue-中-當一個-job-一直執行失敗-超出了指定的-tries-的限制-那這個-job-會跑到哪裡去？"><a href="#Laravel-queue-中-當一個-job-一直執行失敗-超出了指定的-tries-的限制-那這個-job-會跑到哪裡去？" class="headerlink" title="Laravel queue 中, 當一個 job 一直執行失敗, 超出了指定的 tries 的限制, 那這個 job 會跑到哪裡去？"></a><strong>Laravel queue 中, 當一個 job 一直執行失敗, 超出了指定的 tries 的限制, 那這個 job 會跑到哪裡去？</strong></h6><p>failed_jobs</p>
<h6 id="Laravel-queue-中-如何建立-failed-jobs-table"><a href="#Laravel-queue-中-如何建立-failed-jobs-table" class="headerlink" title="Laravel queue 中, 如何建立 failed_jobs table?"></a><strong>Laravel queue 中, 如何建立 failed_jobs table?</strong></h6><figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">php artisan queue:failed-table</span><br><span class="line">php artisan migrate</span><br></pre></td></tr></table></figure>

<h6 id="以下的-Laravel-example-code-的意思是？-20"><a href="#以下的-Laravel-example-code-的意思是？-20" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">php artisan queue:work redis --tries=3 --delay=3</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>如果失敗, 最多嘗試 3 次, 超過 3 次的會被歸類到 fail job 中, 每次嘗試的間隔最少 3 秒</p>
</li>
</ul>
<h6 id="以下位於-job-的-Laravel-example-code-的意思是？-1"><a href="#以下位於-job-的-Laravel-example-code-的意思是？-1" class="headerlink" title="以下位於 job 的 Laravel example code 的意思是？"></a><strong>以下位於 job 的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-keyword">public</span> $retryAfter = <span class="hljs-number">3</span>;</span><br><span class="line"><span class="hljs-keyword">public</span> $backOff = <span class="hljs-number">3</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>定義該 job 如果執行失敗了, 或被 release 回 queue 中, 要間隔多久時間才會再被 worker pick up 執行。 有時失敗是因為第三方服務短時間內故障, 若不定義間隔時間, 很可能會在短時間內將 tries 的次數全部耗光, 如此便失去了給第三方服務時間恢復正常的空間<br>$backOff 為 Laravel 8 的用法</p>
</li>
</ul>
<br>
<br>

<h2 id="Cleaning-Up-After-Failed-Jobs"><a href="#Cleaning-Up-After-Failed-Jobs" class="headerlink" title="# Cleaning Up After Failed Jobs"></a># Cleaning Up After Failed Jobs</h2><h6 id="以下的-Laravel-example-code-的意思是？-21"><a href="#以下的-Laravel-example-code-的意思是？-21" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Jobs</span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProcessPodcast</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ShouldQueue</span></span></span><br><span class="line"><span class="hljs-class"></span>&#123;</span><br><span class="line">    <span class="hljs-keyword">use</span> <span class="hljs-title">InteractsWithQueue</span>, <span class="hljs-title">Queueable</span>, <span class="hljs-title">SerializesModels</span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">protected</span> $podcast;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(Podcast $podcast)</span></span></span><br><span class="line"><span class="hljs-function">    </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;podcast = $podcast;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span><span class="hljs-params">(AudioProcessor $processor)</span></span></span><br><span class="line"><span class="hljs-function">    </span>&#123;</span><br><span class="line">        <span class="hljs-comment">// Process uploaded podcast...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">failed</span><span class="hljs-params">(Exception $exception)</span></span></span><br><span class="line"><span class="hljs-function">    </span>&#123;</span><br><span class="line">        <span class="hljs-comment">// Send user notification of failure, etc...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>handle() 內定義邏輯, failed() 內定義當 job failed 之後要做的事</p>
</li>
</ul>
<br>
<br>

<h2 id="Failed-Job-Events"><a href="#Failed-Job-Events" class="headerlink" title="# Failed Job Events"></a># Failed Job Events</h2><h6 id="以下的-Laravel-example-code-的意思是？-22"><a href="#以下的-Laravel-example-code-的意思是？-22" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Providers</span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Support</span>\<span class="hljs-title">Facades</span>\<span class="hljs-title">Queue</span>;</span><br><span class="line"><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Support</span>\<span class="hljs-title">ServiceProvider</span>;</span><br><span class="line"><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Queue</span>\<span class="hljs-title">Events</span>\<span class="hljs-title">JobFailed</span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AppServiceProvider</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ServiceProvider</span></span></span><br><span class="line"><span class="hljs-class"></span>&#123;</span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">register</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function">    </span>&#123;</span><br><span class="line">        <span class="hljs-comment">//</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">boot</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function">    </span>&#123;</span><br><span class="line">        Queue::failing(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(JobFailed $event)</span> </span>&#123;</span><br><span class="line">            <span class="hljs-comment">// $event-&gt;connectionName</span></span><br><span class="line">            <span class="hljs-comment">// $event-&gt;job</span></span><br><span class="line">            <span class="hljs-comment">// $event-&gt;exception</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>在 AppServiceProvider 的 boot method 中, 使用 Queue class 的 failing method, 定義了當 job 失敗時, 就會觸發這個事件, 並執行 closure 內的邏輯</p>
</li>
</ul>
<br>
<br>

<h2 id="Retrying-Failed-Jobs"><a href="#Retrying-Failed-Jobs" class="headerlink" title="# Retrying Failed Jobs"></a># Retrying Failed Jobs</h2><h6 id="以下的-Laravel-example-code-的意思是？-23"><a href="#以下的-Laravel-example-code-的意思是？-23" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">php artisan queue:failed</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>從 failed_jobs table 中檢視所有的 failed jobs</p>
</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-24"><a href="#以下的-Laravel-example-code-的意思是？-24" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">php artisan queue:failed</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>取得 failed job id</p>
</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-25"><a href="#以下的-Laravel-example-code-的意思是？-25" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">php artisan queue:retry 5</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>retry 特定 failed job, 5 為 failed job ID</p>
</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-26"><a href="#以下的-Laravel-example-code-的意思是？-26" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">php artisan queue:retry all</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>retry 所有的 failed jobs</p>
</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-27"><a href="#以下的-Laravel-example-code-的意思是？-27" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">php artisan queue:forget 5</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>刪除一個 failed job<br>5 為 failed job ID</p>
</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-28"><a href="#以下的-Laravel-example-code-的意思是？-28" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">php artisan queue:flush</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>刪除所有的 failed jobs</p>
</li>
</ul>
<br>
<br>

<h2 id="Ignoring-Missing-Models"><a href="#Ignoring-Missing-Models" class="headerlink" title="# Ignoring Missing Models"></a># Ignoring Missing Models</h2><h6 id="Laravel-Queue-中-我們注入一個-Eloquent-model-到一個-job-當中-而當執行該-job-時-該-model-已遭刪除-這時會發生什麼事？"><a href="#Laravel-Queue-中-我們注入一個-Eloquent-model-到一個-job-當中-而當執行該-job-時-該-model-已遭刪除-這時會發生什麼事？" class="headerlink" title="Laravel Queue 中, 我們注入一個 Eloquent model 到一個 job 當中, 而當執行該 job 時, 該 model 已遭刪除, 這時會發生什麼事？"></a><strong>Laravel Queue 中, 我們注入一個 Eloquent model 到一個 job 當中, 而當執行該 job 時, 該 model 已遭刪除, 這時會發生什麼事？</strong></h6><p>這個 job 會失敗, <code>ModelNotFoundException</code></p>
<h6 id="以下的-Laravel-example-code-的意思是？-29"><a href="#以下的-Laravel-example-code-的意思是？-29" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-keyword">public</span> $deleteWhenMissingModels = <span class="hljs-keyword">true</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>當注入一個 Eloquent model 到一個 job 當中, 而當執行該 job 時, 該 model 已遭刪除, 這時會報錯, <code>ModelNotFoundException</code>, 可以使用 job class 中的 $deleteWhenMissingModel property, 當出現此狀況時會自動餐除該 job</p>
</li>
</ul>
<br>
<br>

<h2 id="Job-Events"><a href="#Job-Events" class="headerlink" title="# Job Events"></a># Job Events</h2><h6 id="以下的-Laravel-example-code-的意思是？-30"><a href="#以下的-Laravel-example-code-的意思是？-30" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Providers</span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Support</span>\<span class="hljs-title">Facades</span>\<span class="hljs-title">Queue</span>;</span><br><span class="line"><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Support</span>\<span class="hljs-title">ServiceProvider</span>;</span><br><span class="line"><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Queue</span>\<span class="hljs-title">Events</span>\<span class="hljs-title">JobProcessed</span>;</span><br><span class="line"><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Queue</span>\<span class="hljs-title">Events</span>\<span class="hljs-title">JobProcessing</span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AppServiceProvider</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ServiceProvider</span></span></span><br><span class="line"><span class="hljs-class"></span>&#123;</span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">register</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function">    </span>&#123;</span><br><span class="line">        <span class="hljs-comment">//</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">boot</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function">    </span>&#123;</span><br><span class="line">        Queue::before(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(JobProcessing $event)</span> </span>&#123;</span><br><span class="line">            <span class="hljs-comment">// $event-&gt;connectionName</span></span><br><span class="line">            <span class="hljs-comment">// $event-&gt;job</span></span><br><span class="line">            <span class="hljs-comment">// $event-&gt;job-&gt;payload()</span></span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        Queue::after(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(JobProcessed $event)</span> </span>&#123;</span><br><span class="line">            <span class="hljs-comment">// $event-&gt;connectionName</span></span><br><span class="line">            <span class="hljs-comment">// $event-&gt;job</span></span><br><span class="line">            <span class="hljs-comment">// $event-&gt;job-&gt;payload()</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>如果想在 job 開始或結束後做一些事, 可在 AppServiceProvider 的 boot() 中註冊 before() 以及 after() event, 並在 closure 內做事<br>在 <code>AppServiceProvider</code> 中</p>
</li>
</ul>
<h6 id="Laravel-Queue-中-以下的程式碼通常可以應用在什麼情況？"><a href="#Laravel-Queue-中-以下的程式碼通常可以應用在什麼情況？" class="headerlink" title="Laravel Queue 中, 以下的程式碼通常可以應用在什麼情況？"></a><strong>Laravel Queue 中, 以下的程式碼通常可以應用在什麼情況？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Providers</span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Support</span>\<span class="hljs-title">Facades</span>\<span class="hljs-title">Queue</span>;</span><br><span class="line"><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Support</span>\<span class="hljs-title">ServiceProvider</span>;</span><br><span class="line"><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Queue</span>\<span class="hljs-title">Events</span>\<span class="hljs-title">JobProcessed</span>;</span><br><span class="line"><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Queue</span>\<span class="hljs-title">Events</span>\<span class="hljs-title">JobProcessing</span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AppServiceProvider</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ServiceProvider</span></span></span><br><span class="line"><span class="hljs-class"></span>&#123;</span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">register</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function">    </span>&#123;</span><br><span class="line">        <span class="hljs-comment">//</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">boot</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function">    </span>&#123;</span><br><span class="line">        Queue::before(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(JobProcessing $event)</span> </span>&#123;</span><br><span class="line">            <span class="hljs-comment">// $event-&gt;connectionName</span></span><br><span class="line">            <span class="hljs-comment">// $event-&gt;job</span></span><br><span class="line">            <span class="hljs-comment">// $event-&gt;job-&gt;payload()</span></span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        Queue::after(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(JobProcessed $event)</span> </span>&#123;</span><br><span class="line">            <span class="hljs-comment">// $event-&gt;connectionName</span></span><br><span class="line">            <span class="hljs-comment">// $event-&gt;job</span></span><br><span class="line">            <span class="hljs-comment">// $event-&gt;job-&gt;payload()</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Output</strong>:<br>記 log<br>統計特定 job 運行次數</p>
</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-31"><a href="#以下的-Laravel-example-code-的意思是？-31" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line">Queue::looping(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">    <span class="hljs-keyword">while</span> (DB::transactionLevel() &gt; <span class="hljs-number">0</span>) &#123;</span><br><span class="line">        DB::rollBack();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>在 AppServiceProvider boot() 中可以註冊 looping(), 在 worker fetch job 之前都會執行這個 closure, 將 active 的 transaction rollback</p>
</li>
</ul>
<br>

<h2 id="Additional"><a href="#Additional" class="headerlink" title="# Additional"></a># Additional</h2><h6 id="以下的-Laravel-example-code-的意思是？-32"><a href="#以下的-Laravel-example-code-的意思是？-32" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DeployProject</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ShouldQueue</span>, <span class="hljs-title">ShouldBeUniqueUntilProcessing</span></span></span><br><span class="line"><span class="hljs-class"></span>&#123;</span><br><span class="line">    <span class="hljs-keyword">public</span> $uniqueFor = <span class="hljs-number">60</span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">uniqueId</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function">    </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;project-&gt;id;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>若 implement ShouldBeUniqueUntilProcessing interface, 則當該 job 被 processing 時, 就允許相同 unique id 的 job 被 dispatch 到 queue 中, 適用場景為, 如果說這個 job 是用來 deploy 最新的 commit, 只要該 queue 中有這個 job, 那就不需要有額外的 job 存在於該 queue, 但一旦該 job starts be processed, 可能就會出現新的 commit, 因此這時就允許這個 job 再度被 dispatch 到 queue 來</p>
</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-33"><a href="#以下的-Laravel-example-code-的意思是？-33" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UpdateBalanceJob</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ShouldQueue</span>, <span class="hljs-title">ShouldBeUnique</span></span></span><br><span class="line"><span class="hljs-class"></span>&#123;</span><br><span class="line">    <span class="hljs-keyword">public</span> $uniqueId = <span class="hljs-string">'products'</span>;</span><br><span class="line">    <span class="hljs-keyword">public</span> $uniqueFor = <span class="hljs-number">60</span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">uniqueId</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function">    </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;category-&gt;id;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>Implement ShouldBeUnique, Laravel 會確保 queue 中, 該 $uniqueId 只會有這麼一個 job, 重複的都會被 ignore, ShouldBeUnique 跟 withoutOverlapping 的差異在於, 前者限制的是該 job 在 queue 中必須為 unique, 後者允許 multiple unique job 同時出現在 queue 中, 但只會一次執行一個<br>$uniqueFor 代表 atomic lock 鎖住的時間, 單位為秒</p>
</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-34"><a href="#以下的-Laravel-example-code-的意思是？-34" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">boot</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    RateLimiter::for(<span class="hljs-string">'reports'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">($job)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> $job-&gt;customer-&gt;onPremiumPlan()</span><br><span class="line">            ? Limit::perHour(<span class="hljs-number">100</span>)-&gt;by($job-&gt;customer-&gt;id) : Limit::perHour(<span class="hljs-number">10</span>)-&gt;by($job-&gt;customer-&gt;id);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">middleware</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    <span class="hljs-keyword">return</span> [</span><br><span class="line">        <span class="hljs-keyword">new</span> RateLimited(<span class="hljs-string">'reports'</span>)</span><br><span class="line">    ];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>先在 Service Provider 中定義 名為 report 的 RateLimiter middleware, 然後可以在 job 中使用該 middleware</p>
</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-35"><a href="#以下的-Laravel-example-code-的意思是？-35" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UpdateBalanceJob</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ShouldQueue</span></span></span><br><span class="line"><span class="hljs-class"></span>&#123;</span><br><span class="line">    <span class="hljs-comment">// The job handle method...</span></span><br><span class="line">    </span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">middleware</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function">    </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> [</span><br><span class="line">            <span class="hljs-keyword">new</span> WithoutOverlapping(<span class="hljs-keyword">$this</span>-&gt;customer-&gt;id)-&gt;expireAfter(<span class="hljs-number">10</span>)</span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>UpdateBalanceJob 將不會 run customer-&gt;id concurrently, 且在 10 秒後釋放 lock, 這樣即使該 job crashes 也不會讓該 lock 一直鎖住</p>
</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-36"><a href="#以下的-Laravel-example-code-的意思是？-36" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UpdateBalanceJob</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ShouldQueue</span></span></span><br><span class="line"><span class="hljs-class"></span>&#123;</span><br><span class="line">    <span class="hljs-comment">// The job handle method...</span></span><br><span class="line">    </span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">middleware</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function">    </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> [</span><br><span class="line">            <span class="hljs-keyword">new</span> WithoutOverlapping(<span class="hljs-keyword">$this</span>-&gt;customer-&gt;id)-&gt;dontRelease()</span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>UpdateBalanceJob 將不會 run customer-&gt;id concurrently, 且會刪除 concurrent job</p>
</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-37"><a href="#以下的-Laravel-example-code-的意思是？-37" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UpdateBalanceJob</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ShouldQueue</span></span></span><br><span class="line"><span class="hljs-class"></span>&#123;</span><br><span class="line">    <span class="hljs-comment">// The job handle method...</span></span><br><span class="line">    </span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">middleware</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function">    </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> [</span><br><span class="line">            <span class="hljs-keyword">new</span> WithoutOverlapping(<span class="hljs-keyword">$this</span>-&gt;customer-&gt;id)-&gt;releaseAfter(<span class="hljs-number">10</span>)</span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>UpdateBalanceJob 將不會 run customer-&gt;id concurrently, 且會 delay 10 秒後在 release 到 queue 當中讓 worker attempts picking up</p>
</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-38"><a href="#以下的-Laravel-example-code-的意思是？-38" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UpdateBalanceJob</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ShouldQueue</span></span></span><br><span class="line"><span class="hljs-class"></span>&#123;</span><br><span class="line">    <span class="hljs-comment">// The job handle method...</span></span><br><span class="line">    </span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">middleware</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function">    </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> [</span><br><span class="line">            <span class="hljs-keyword">new</span> WithoutOverlapping()</span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>UpdateBalanceJob 將不會 run concurrently</p>
</li>
</ul>
<h6 id="以下的-Laravel-Horizon-example-configuration-的意思是？"><a href="#以下的-Laravel-Horizon-example-configuration-的意思是？" class="headerlink" title="以下的 Laravel Horizon example configuration 的意思是？"></a><strong>以下的 Laravel Horizon example configuration 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">&apos;environments&apos; =&gt; [</span><br><span class="line">    &apos;environment&apos; =&gt; [</span><br><span class="line">        &apos;supervisor-1&apos; =&gt; [</span><br><span class="line">            &apos;nice&apos; =&gt; 5,</span><br><span class="line">        ],</span><br><span class="line">    ],</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>設定 worker 的 priority 不要高於其他的 server process</p>
</li>
</ul>
<h6 id="以下的-Laravel-Horizon-example-configuration-的意思是？-1"><a href="#以下的-Laravel-Horizon-example-configuration-的意思是？-1" class="headerlink" title="以下的 Laravel Horizon example configuration 的意思是？"></a><strong>以下的 Laravel Horizon example configuration 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">&apos;fast_termination&apos; =&gt; false,</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br><code>php artisan horizon</code> process 預設會等到所有的 worker 都退出, 自己才會退出, 即 Supervisor 會等到所有的 worker 結束才會啟動新的 Horizon process, 但如果此時正好有 long running worker 的話, 可能就會造成 delay, 如果設定 fast_termination = true, 那 Horizon 在送出 exit signal 給所有 worker 後自己就會退出並重啟, 所以會出現新舊 worker process 共存, old worder process 處理完後會退出</p>
</li>
</ul>
<h6 id="以下的-Laravel-Horizon-example-configuration-的意思是？-2"><a href="#以下的-Laravel-Horizon-example-configuration-的意思是？-2" class="headerlink" title="以下的 Laravel Horizon example configuration 的意思是？"></a><strong>以下的 Laravel Horizon example configuration 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">&apos;trim&apos; =&gt; [</span><br><span class="line">    &apos;recent&apos;        =&gt; 10080,</span><br><span class="line">    &apos;completed&apos;     =&gt; 10080,</span><br><span class="line">    &apos;pending&apos;       =&gt; 10080,</span><br><span class="line">    &apos;recent_failed&apos; =&gt; 10080,</span><br><span class="line">    &apos;failed&apos;        =&gt; 10080,</span><br><span class="line">    &apos;monitored&apos;     =&gt; 10080,</span><br><span class="line">];</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>Horizon 會將一些 metrics 存在 Redis 中, 即 server memory 中, 可定義多久之後的 metrics 該被釋放</p>
</li>
</ul>
<h6 id="以下的-Laravel-Horizon-example-configuration-的意思是？-3"><a href="#以下的-Laravel-Horizon-example-configuration-的意思是？-3" class="headerlink" title="以下的 Laravel Horizon example configuration 的意思是？"></a><strong>以下的 Laravel Horizon example configuration 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">&apos;memory_limit&apos; =&gt; 64,</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>定義 Horizon process 的 memory limit</p>
</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-39"><a href="#以下的-Laravel-example-code-的意思是？-39" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-keyword">public</span> $shouldBeEncrypted = <span class="hljs-keyword">true</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>在存到 store 之前, encrypt, 只有 worker 可以 decrypt 這些 job</p>
</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-40"><a href="#以下的-Laravel-example-code-的意思是？-40" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">uniqueVia</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    <span class="hljs-keyword">return</span> Cache::store(<span class="hljs-string">'redis'</span>); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>Laravel 預設會使用 default cache 來取得 atomic lock, 可指定其他的 cache instance</p>
</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-41"><a href="#以下的-Laravel-example-code-的意思是？-41" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line">php artisan queue:work --once</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>worker 只執行一次就重啟, 通常用於需要執行完後立即釋放 memory, 但會消耗較多的 CPU, 因為每次都要重啟一個 application process</p>
</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-42"><a href="#以下的-Laravel-example-code-的意思是？-42" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line">Worker::popUsing(<span class="hljs-string">'notifications'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">($pop)</span> </span>&#123;</span><br><span class="line">    $queues = time()-&gt;atNight()</span><br><span class="line">        ? [<span class="hljs-string">'mail'</span>, <span class="hljs-string">'webhooks'</span>]</span><br><span class="line">        : [<span class="hljs-string">'push-notifications'</span>, <span class="hljs-string">'sms'</span>, <span class="hljs-string">'mail'</span>, <span class="hljs-string">'webhooks'</span>];</span><br><span class="line">    <span class="hljs-keyword">foreach</span> ($queues <span class="hljs-keyword">as</span> $queue) &#123;</span><br><span class="line">        <span class="hljs-keyword">if</span> (!is_null($job = $pop($queue))) &#123;</span><br><span class="line">            <span class="hljs-keyword">return</span> $job;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>使用 Worker::popUsing(), customize 名為 notifications 的 worker, 如果時間是晚上, 就從 mail, webhooks queue 中 consume jobs, 反之則從其他的 queue 中 consume job</p>
</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-43"><a href="#以下的-Laravel-example-code-的意思是？-43" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">sudo supervisorctl stop group-name:* </span><br><span class="line"></span><br><span class="line">cd /home/forge/mysite.com</span><br><span class="line"># ...</span><br><span class="line">$FORGE_PHP artisan migrate --force </span><br><span class="line">sudo supervisorctl start group-name:*</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>當更新部署時, 若 database schema 更新了, 但 worker 的 code 沒有更新, 那會造成 worker 的 last job fails, 所以先關掉所有的 worker, 等到 migration 更新完畢, 在啟動新的 worker, 不過如果 database schema 沒有更動的話, 不建議每次都 stop workers</p>
</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-44"><a href="#以下的-Laravel-example-code-的意思是？-44" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line">php artisan queue:work --tries=<span class="hljs-number">3</span> --backoff=<span class="hljs-number">30</span>,<span class="hljs-number">90</span>,<span class="hljs-number">300</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SendInvoice</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ShouldQueue</span></span></span><br><span class="line"><span class="hljs-class"></span>&#123; </span><br><span class="line">    <span class="hljs-keyword">public</span> $backoff = [<span class="hljs-number">30</span>, <span class="hljs-number">90</span>, <span class="hljs-number">300</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">backoff</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function">    </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> [<span class="hljs-number">30</span>, <span class="hljs-number">90</span>, <span class="hljs-number">300</span>]; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>使用不同的方式來設定 backoff, 即 job fails 之後, 要經過多久時間才 retry, 第一次 30 秒, 第二次 90 秒, 第三次 300 秒</p>
</li>
</ul>
<h6 id="Laravel-Vapor-中-如果我有一些-job-需要-high-memory-而有些-job-只需要比較低的-memory-建議的做法是？"><a href="#Laravel-Vapor-中-如果我有一些-job-需要-high-memory-而有些-job-只需要比較低的-memory-建議的做法是？" class="headerlink" title="Laravel Vapor 中, 如果我有一些 job 需要 high memory, 而有些 job 只需要比較低的 memory, 建議的做法是？"></a><strong>Laravel Vapor 中, 如果我有一些 job 需要 high memory, 而有些 job 只需要比較低的 memory, 建議的做法是？</strong></h6><p>建立一個 environment configuration 來啟動 high memory worker, 並將 heavy memory job 放到一個特別的 queue, 這個 worker 就專門 pick up 這個 queue 中的 job</p>
<h6 id="Laravel-Vapor-中-以什麼計費？"><a href="#Laravel-Vapor-中-以什麼計費？" class="headerlink" title="Laravel Vapor 中, 以什麼計費？"></a><strong>Laravel Vapor 中, 以什麼計費？</strong></h6><p>container 啟動並執行 job 的時間</p>
<h6 id="Laravel-Vapor-中-什麼是-cold-start"><a href="#Laravel-Vapor-中-什麼是-cold-start" class="headerlink" title="Laravel Vapor 中, 什麼是 cold start?"></a><strong>Laravel Vapor 中, 什麼是 cold start?</strong></h6><p>當 Vapor 呼叫 AWS Lambda 啟動 container as worker, 會需要一些時間來啟動, 取決於 project size, 這個步驟又稱為 cold start</p>
<h6 id="SQS-可以設定哪個選項來避免-duplicated-job"><a href="#SQS-可以設定哪個選項來避免-duplicated-job" class="headerlink" title="SQS 可以設定哪個選項來避免 duplicated job?"></a><strong>SQS 可以設定哪個選項來避免 duplicated job?</strong></h6><p>VisibilityTimeout</p>
<h6 id="Laravel-Vapor-的最大-timeout-是多久？"><a href="#Laravel-Vapor-的最大-timeout-是多久？" class="headerlink" title="Laravel Vapor 的最大 timeout 是多久？"></a><strong>Laravel Vapor 的最大 timeout 是多久？</strong></h6><p>900 秒</p>
<h6 id="為避免-memory-leaking-Vapor-會在處理幾個-job-後重啟-worker-container"><a href="#為避免-memory-leaking-Vapor-會在處理幾個-job-後重啟-worker-container" class="headerlink" title="為避免 memory leaking, Vapor 會在處理幾個 job 後重啟 worker container?"></a><strong>為避免 memory leaking, Vapor 會在處理幾個 job 後重啟 worker container?</strong></h6><p>250 jobs</p>
<h6 id="AWS-的-default-concurrency-limit-是多少？"><a href="#AWS-的-default-concurrency-limit-是多少？" class="headerlink" title="AWS 的 default concurrency limit 是多少？"></a><strong>AWS 的 default concurrency limit 是多少？</strong></h6><p>1000 per region</p>
<h6 id="以下的-vapor-configuration-意思是？"><a href="#以下的-vapor-configuration-意思是？" class="headerlink" title="以下的 vapor configuration 意思是？"></a><strong>以下的 vapor configuration 意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line">id: <span class="hljs-number">1</span></span><br><span class="line">name: laravel-queues-in-action </span><br><span class="line">environments:</span><br><span class="line">    production: </span><br><span class="line">        queue-concurrency: <span class="hljs-number">10</span> </span><br><span class="line">        queue-memory: <span class="hljs-number">1024</span> </span><br><span class="line">        queue-timeout: <span class="hljs-number">300</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>使用 vapor 時, 可定義可同時執行的 queue job 的數量, 等同於啟動 10 個 workers<br>一個 job 最多使用 1024 mb<br>一個 job 最多執行 300 秒, 之後 worker container 會關閉</p>
</li>
</ul>
<h6 id="如果要使用-Redis-在不同的用途-假如是同一個-Redis-instance-那如果有一個應用的-traffic-特別高-會影響其他的應用嗎？"><a href="#如果要使用-Redis-在不同的用途-假如是同一個-Redis-instance-那如果有一個應用的-traffic-特別高-會影響其他的應用嗎？" class="headerlink" title="如果要使用 Redis 在不同的用途, 假如是同一個 Redis instance, 那如果有一個應用的 traffic 特別高, 會影響其他的應用嗎？"></a><strong>如果要使用 Redis 在不同的用途, 假如是同一個 Redis instance, 那如果有一個應用的 traffic 特別高, 會影響其他的應用嗎？</strong></h6><p>會, 因為 single thread nature</p>
<h6 id="如果要使用-Redis-在不同的用途-例如不同應用的-cache-以及-queue-建議-practice-是？"><a href="#如果要使用-Redis-在不同的用途-例如不同應用的-cache-以及-queue-建議-practice-是？" class="headerlink" title="如果要使用 Redis 在不同的用途, 例如不同應用的 cache 以及 queue, 建議 practice 是？"></a><strong>如果要使用 Redis 在不同的用途, 例如不同應用的 cache 以及 queue, 建議 practice 是？</strong></h6><p>分別使用不同的資料庫</p>
<h6 id="以下的-Laravel-example-code-的意思是？-45"><a href="#以下的-Laravel-example-code-的意思是？-45" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line">Queue::connection(<span class="hljs-string">'database'</span>)-&gt;size(<span class="hljs-string">'invoices'</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>取得 queue 中的 job 數量</p>
</li>
</ul>
<h6 id="Laravel-中-如果使用-sync-driver-是跑在-memory-還是-database"><a href="#Laravel-中-如果使用-sync-driver-是跑在-memory-還是-database" class="headerlink" title="Laravel 中, 如果使用 sync driver, 是跑在 memory 還是 database?"></a><strong>Laravel 中, 如果使用 sync driver, 是跑在 memory 還是 database?</strong></h6><p>memory</p>
<h6 id="Laravel-中-如果使用-SQS-當作-queue-driver-可以使用-retry-after-configuration-嗎？"><a href="#Laravel-中-如果使用-SQS-當作-queue-driver-可以使用-retry-after-configuration-嗎？" class="headerlink" title="Laravel 中, 如果使用 SQS 當作 queue driver, 可以使用 retry_after configuration 嗎？"></a><strong>Laravel 中, 如果使用 SQS 當作 queue driver, 可以使用 retry_after configuration 嗎？</strong></h6><p>不行, 需到 AWS console 設定 “Default Visibility Timeout”</p>
<h6 id="Laravel-中-如果使用-Sever-Redis-當作-queue-driver-可以確保-job-只被-dispatch-一次嗎？"><a href="#Laravel-中-如果使用-Sever-Redis-當作-queue-driver-可以確保-job-只被-dispatch-一次嗎？" class="headerlink" title="Laravel 中, 如果使用 Sever Redis 當作 queue driver, 可以確保 job 只被 dispatch 一次嗎？"></a><strong>Laravel 中, 如果使用 Sever Redis 當作 queue driver, 可以確保 job 只被 dispatch 一次嗎？</strong></h6><p>可以, 因為 single thread</p>
<h6 id="Laravel-中-如果使用-SQS-當作-queue-driver-可以確保-job-只被-dispatch-一次嗎？"><a href="#Laravel-中-如果使用-SQS-當作-queue-driver-可以確保-job-只被-dispatch-一次嗎？" class="headerlink" title="Laravel 中, 如果使用 SQS 當作 queue driver, 可以確保 job 只被 dispatch 一次嗎？"></a><strong>Laravel 中, 如果使用 SQS 當作 queue driver, 可以確保 job 只被 dispatch 一次嗎？</strong></h6><p>不可以</p>
<h6 id="Laravel-中-如果使用-SQS-當作-queue-driver-job-的最長生命週期多長？"><a href="#Laravel-中-如果使用-SQS-當作-queue-driver-job-的最長生命週期多長？" class="headerlink" title="Laravel 中, 如果使用 SQS 當作 queue driver, job 的最長生命週期多長？"></a><strong>Laravel 中, 如果使用 SQS 當作 queue driver, job 的最長生命週期多長？</strong></h6><p>12 小時</p>
<h6 id="以下的-Laravel-example-code-的意思是？-46"><a href="#以下的-Laravel-example-code-的意思是？-46" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-comment">// controller</span></span><br><span class="line">$job = <span class="hljs-keyword">new</span> SendOrderToSupplier($order);</span><br><span class="line"><span class="hljs-keyword">try</span> &#123;</span><br><span class="line">    retry(<span class="hljs-number">2</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> <span class="hljs-title">use</span> <span class="hljs-params">($job)</span> </span>&#123;</span><br><span class="line">        dispatch($job)-&gt;onQueue(<span class="hljs-string">'high'</span>); </span><br><span class="line">    &#125;, <span class="hljs-number">5000</span>);</span><br><span class="line">&#125; <span class="hljs-keyword">catch</span> (Throwable $e) &#123; </span><br><span class="line">    DB::table(<span class="hljs-string">'dead_letter_queue'</span>)-&gt;insert([</span><br><span class="line">        <span class="hljs-string">'message'</span> =&gt; serialize(<span class="hljs-keyword">clone</span> $job),</span><br><span class="line">        <span class="hljs-string">'failed_at'</span> =&gt; now() </span><br><span class="line">    ]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// failed handling</span></span><br><span class="line">DB::table(<span class="hljs-string">'dead_letter_queue'</span>)-&gt;take(<span class="hljs-number">50</span>)-&gt;each(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">($record)</span> </span>&#123; </span><br><span class="line">    <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">        dispatch( </span><br><span class="line">            unserialize($record-&gt;message)</span><br><span class="line">        );</span><br><span class="line">    &#125; <span class="hljs-keyword">catch</span> (Throwable $e) &#123;</span><br><span class="line">        <span class="hljs-keyword">return</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    DB::table(<span class="hljs-string">'dead_letter_queue'</span>)-&gt;where(<span class="hljs-string">'id'</span>, $record-&gt;id)-&gt;delete(); </span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>失敗時, 將 failed job serialize 並放到 table 中, 使用 cron 固定從該 table 中取出, 再次執行, 若執行成功則刪除該筆紀錄</p>
</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-47"><a href="#以下的-Laravel-example-code-的意思是？-47" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line">retry(<span class="hljs-number">2</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>&#123; </span><br><span class="line">    GenerateReport::dispatch();</span><br><span class="line">&#125;, <span class="hljs-number">5000</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>避免因為 network 的關係 dispatch 到 queue store 失敗, 所以使用 retry dispatch 兩次, 這邊要記得設定 unique</p>
</li>
</ul>
<h6 id="SQS-每個-message-的-size-限制是多少？"><a href="#SQS-每個-message-的-size-限制是多少？" class="headerlink" title="SQS 每個 message 的 size 限制是多少？"></a><strong>SQS 每個 message 的 size 限制是多少？</strong></h6><p>256 kb</p>
<h6 id="以下的-Laravel-example-code-的意思是？-48"><a href="#以下的-Laravel-example-code-的意思是？-48" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line">$queuedMessage = [</span><br><span class="line">    <span class="hljs-string">'job'</span> =&gt; serialize(<span class="hljs-keyword">clone</span> $job), <span class="hljs-string">'payload'</span> =&gt; [</span><br><span class="line">    <span class="hljs-comment">// attempts, timeout, backoff, retryUntil, ...</span></span><br><span class="line">    ] </span><br><span class="line">];</span><br><span class="line">   <span class="hljs-keyword">return</span> json_encode($queuedMessage);</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>Laravel 會先把 queued job serialized 並放到 array, 在發送到 queue store 之前, json encoded, 所以務必確保 job instance 以及所有的 dependency 都是 serializable</p>
</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-49"><a href="#以下的-Laravel-example-code-的意思是？-49" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-number">0</span> * * * * forge php /home/forge/laravel.com/artisan horizon:terminate</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>每小時關閉 horizon, 防止 memory leak</p>
</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-50"><a href="#以下的-Laravel-example-code-的意思是？-50" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-string">'environments'</span> =&gt; [ </span><br><span class="line">    <span class="hljs-string">'production'</span> =&gt; [</span><br><span class="line">        <span class="hljs-string">'supervisor-1'</span> =&gt; [</span><br><span class="line">        <span class="hljs-string">'queue'</span> =&gt; [<span class="hljs-string">'deployments'</span>, <span class="hljs-string">'notifications'</span>], </span><br><span class="line">        <span class="hljs-string">'balance'</span> =&gt; <span class="hljs-string">'auto'</span>,</span><br><span class="line">        <span class="hljs-string">'min_processes'</span> =&gt; <span class="hljs-number">1</span>,</span><br><span class="line">        <span class="hljs-string">'max_processes'</span> =&gt; <span class="hljs-number">10</span>,</span><br><span class="line">        <span class="hljs-string">'balanceMaxShift'</span> =&gt; <span class="hljs-number">3</span>,</span><br><span class="line">        <span class="hljs-string">'balanceCooldown'</span> =&gt; <span class="hljs-number">1</span></span><br><span class="line">        ], </span><br><span class="line">    ],</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>使用 Horizon 的 auto balance strategy, 自動依照 queue busy 的程度來啟動 worker, 最小 1 個 worker, 最多 10 個<br>每 1 秒 (balanceCooldown) 可以增加或減少 3 個 (balanceMaxShift) worker</p>
</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-51"><a href="#以下的-Laravel-example-code-的意思是？-51" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-string">'environments'</span> =&gt; [ </span><br><span class="line">    <span class="hljs-string">'production'</span> =&gt; [</span><br><span class="line">        <span class="hljs-string">'supervisor-1'</span> =&gt; [</span><br><span class="line">        <span class="hljs-string">'connection'</span> =&gt; <span class="hljs-string">'redis'</span>,</span><br><span class="line">        <span class="hljs-string">'queue'</span> =&gt; [<span class="hljs-string">'deployments'</span>, <span class="hljs-string">'notifications'</span>], </span><br><span class="line">        <span class="hljs-string">'balance'</span> =&gt; <span class="hljs-string">'simple'</span>,</span><br><span class="line">        <span class="hljs-string">'processes'</span> =&gt; <span class="hljs-number">10</span>,</span><br><span class="line">        <span class="hljs-string">'tries'</span> =&gt; <span class="hljs-number">1</span>,</span><br><span class="line">        ], </span><br><span class="line">    ],</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>使用 simple balance strategy, Horizon 會依照 queue priority 來分配 worker</p>
</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-52"><a href="#以下的-Laravel-example-code-的意思是？-52" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-string">'environments'</span> =&gt; [ </span><br><span class="line">    <span class="hljs-string">'production'</span> =&gt; [</span><br><span class="line">        <span class="hljs-string">'deployments'</span> =&gt; [ </span><br><span class="line">            <span class="hljs-comment">// ...</span></span><br><span class="line">            <span class="hljs-string">'timeout'</span> =&gt; <span class="hljs-number">300</span>, </span><br><span class="line">            <span class="hljs-string">'processes'</span> =&gt; <span class="hljs-number">7</span>, </span><br><span class="line">            <span class="hljs-string">'queue'</span> =&gt; <span class="hljs-string">'deployments'</span> </span><br><span class="line">            <span class="hljs-comment">// ...</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="hljs-string">'notifications'</span> =&gt; [ </span><br><span class="line">            <span class="hljs-comment">// ...</span></span><br><span class="line">            <span class="hljs-string">'timeout'</span> =&gt; <span class="hljs-number">60</span>, </span><br><span class="line">            <span class="hljs-string">'processes'</span> =&gt; <span class="hljs-number">3</span>,</span><br><span class="line">            <span class="hljs-string">'queue'</span> =&gt; <span class="hljs-string">'notifications'</span> </span><br><span class="line">            <span class="hljs-comment">// ...</span></span><br><span class="line">        ], </span><br><span class="line">    ],</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>使用 Horizon 在 production 下, 啟動 7 個 worker for queue deployments, 3 個 worker for notifications</p>
</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-53"><a href="#以下的-Laravel-example-code-的意思是？-53" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-string">'environments'</span> =&gt; [ </span><br><span class="line">    <span class="hljs-string">'production'</span> =&gt; [</span><br><span class="line">        <span class="hljs-string">'supervisor-1'</span> =&gt; [</span><br><span class="line">        <span class="hljs-string">'connection'</span> =&gt; <span class="hljs-string">'redis'</span>,</span><br><span class="line">        <span class="hljs-string">'queue'</span> =&gt; [<span class="hljs-string">'deployments'</span>, <span class="hljs-string">'notifications'</span>], </span><br><span class="line">        <span class="hljs-string">'balance'</span> =&gt; <span class="hljs-string">'off'</span>,</span><br><span class="line">        <span class="hljs-string">'processes'</span> =&gt; <span class="hljs-number">10</span>,</span><br><span class="line">        <span class="hljs-string">'tries'</span> =&gt; <span class="hljs-number">1</span>,</span><br><span class="line">        ], </span><br><span class="line">    ],</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>Horizon 會執行如下指令, 並確保有 10 個 worker, 如果其中有的掛了, 會自動啟動, 若有其他要設定的, 例如 backoff, 也可以加到 config 檔中</p>
<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">artisan horizon:work redis --name=default </span><br><span class="line">--supervisor=host-tdjk:supervisor-1</span><br><span class="line">--backoff=0</span><br><span class="line">--memory=128 --queue=deployments,notifications --sleep=3</span><br><span class="line">--timeout=60</span><br><span class="line">--tries=1</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-54"><a href="#以下的-Laravel-example-code-的意思是？-54" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">// command</span><br><span class="line">php artisan horizon</span><br><span class="line"></span><br><span class="line">// configuration</span><br><span class="line">[program:horizon] command=php artisan horizon</span><br><span class="line">process_name=%(program_name)s </span><br><span class="line">autostart=true </span><br><span class="line">autorestart=true </span><br><span class="line">stopasgroup=true</span><br><span class="line">user=forge </span><br><span class="line">stdout_logfile=/home/forge/.forge/notifications-workers.log </span><br><span class="line">stopwaitsecs=3600</span><br><span class="line"></span><br><span class="line">// 位置</span><br><span class="line">/etc/supervisor/conf.d/horizon.conf</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>將 configuration 置於 <code>.../conf.d/horizon.conf</code>, 由 horizon 來統一控管所有的 worker, 不需要指定 numprocess, 這些參數將設定在 Horizon 的 config file, 由 Horizon 統一控管</p>
</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-55"><a href="#以下的-Laravel-example-code-的意思是？-55" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">*/5 * * * * forge php /home/forge/laravel.com/artisan queue:work --stop-when-empty --max-time=240</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>每 5 分鐘起動一個 worker, 結束工作後即自動退出, 若 server 的記憶體有限, 為避免 worker 越起越多 (如果 queue 非常 busy 的話), 可定義最長多少時間要退出</p>
</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-56"><a href="#以下的-Laravel-example-code-的意思是？-56" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">*/5 * * * * forge php /home/forge/laravel.com/artisan queue:work --stop-when-empty</span><br><span class="line">*/5 * * * * forge php /home/forge/laravel.com/artisan queue:work --stop-when-empty</span><br><span class="line">*/5 * * * * forge php /home/forge/laravel.com/artisan queue:work --stop-when-empty</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>每 5 分鐘啟動三個 worker, 工作結束後自動關閉</p>
</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-57"><a href="#以下的-Laravel-example-code-的意思是？-57" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-comment">// on schedule</span></span><br><span class="line">$schedule-&gt;call(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">    <span class="hljs-keyword">if</span> (Queue::size(<span class="hljs-string">'orders'</span>) &lt; <span class="hljs-number">30</span>) &#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;scaleDown();</span><br><span class="line">    &#125;</span><br><span class="line">    Cache::increment(<span class="hljs-string">'timer'</span>);</span><br><span class="line">    <span class="hljs-keyword">if</span> (Cache::get(<span class="hljs-string">'timer'</span>) == <span class="hljs-number">4</span>) &#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;scaleUp();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)-&gt;everyMinute();</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">scaleDown</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    Cache::forget(<span class="hljs-string">'timer'</span>);</span><br><span class="line">    Process::fromShellCommandline(</span><br><span class="line">        <span class="hljs-string">'sudo supervisorctl stop extra-workers:*'</span></span><br><span class="line">    )-&gt;run();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">scaleUp</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    Cache::forget(<span class="hljs-string">'timer'</span>);</span><br><span class="line">    Process::fromShellCommandline(</span><br><span class="line">        <span class="hljs-string">'sudo supervisorctl start extra-workers:*'</span></span><br><span class="line">    )-&gt;run();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>如果連續四次, 即四分鐘檢測, 如果 queue orders 中的 job 數量都保持在 30 個以上的話, 即啟動 extra worker, 如果 job 數量低於 30, 則關閉 extra workers</p>
</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-58"><a href="#以下的-Laravel-example-code-的意思是？-58" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">// supervisor</span><br><span class="line">[program:extra-workers]</span><br><span class="line">command=php artisan queue:work notifications -- queue=orders,notifications</span><br><span class="line">process_name=%(program_name)s_%(process_num)02d autostart=false</span><br><span class="line">autorestart=true</span><br><span class="line">stopasgroup=true</span><br><span class="line">user=forge</span><br><span class="line">numprocs=3 stdout_logfile=/home/forge/.forge/extra-workers.log stopwaitsecs=3600</span><br><span class="line"></span><br><span class="line">// suvisor command</span><br><span class="line">supervisorctl reread</span><br><span class="line">supervisorctl update</span><br><span class="line"></span><br><span class="line">// cron</span><br><span class="line">0 7 * * * root supervisorctl start extra-workers:* </span><br><span class="line">0 11 * * * root supervisorctl stop extra-workers:*</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>rush hour scaling, 少了 autostart, 所以當 restart supervisor 時, 不會自動啟動這個 group<br>reread 並 update, 將這個 group 更新到 supervisor memory<br>使用 cron 來管理 start and stop</p>
</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-59"><a href="#以下的-Laravel-example-code-的意思是？-59" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">php artisan queue:work --max-jobs=1000 --max-time=3600</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>定義  worker 最多執行 1000 個 job, 以及最長的執行一小時, 達到任一時, 會自動重啟, 以避免 memory leak<br>worker 會在每次完成一個 job 後, 檢查是否達到條件來決定退出或繼續 pick up job</p>
</li>
</ul>
<h6 id="以下的-cron-example-的意思是？"><a href="#以下的-cron-example-的意思是？" class="headerlink" title="以下的 cron example 的意思是？"></a><strong>以下的 cron example 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">0 * * * * forge php /home/forge/laravel.com/artisan queue:restart</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>每小時 restart worker 來避免 memory leak</p>
</li>
</ul>
<h6 id="以下的-supervisor-的意思是？"><a href="#以下的-supervisor-的意思是？" class="headerlink" title="以下的 supervisor 的意思是？"></a><strong>以下的 supervisor 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">supervisorctl restart notification-workers:* </span><br><span class="line">supervisorctl restart reports-workers:*</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>當 code 更新時, worker 的 code 並未更新, 所以必須 restart</p>
</li>
</ul>
<h6 id="當使用-supervisor-stop-時-會中斷執行到一半的-task-嗎？"><a href="#當使用-supervisor-stop-時-會中斷執行到一半的-task-嗎？" class="headerlink" title="當使用 supervisor stop 時, 會中斷執行到一半的 task 嗎？"></a><strong>當使用 supervisor stop 時, 會中斷執行到一半的 task 嗎？</strong></h6><p>不會, 會送出 stop signal, 讓 worker 先完成手邊的工作, 並停止 pick up new task, 然後退出</p>
<h6 id="以下的-supervisor-example-的意思是？"><a href="#以下的-supervisor-example-的意思是？" class="headerlink" title="以下的 supervisor example 的意思是？"></a><strong>以下的 supervisor example 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">[program:notification-workers]</span><br><span class="line">command=php artisan queue:work notifications --tries=3 --memory=256</span><br><span class="line">process_name=%(program_name)s_%(process_num)02d autostart=true</span><br><span class="line">autorestart=true</span><br><span class="line">stopasgroup=true</span><br><span class="line">user=forge</span><br><span class="line">numprocs=4 stdout_logfile=/home/forge/.forge/notifications-workers.log stopwaitsecs=3600</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>stopasgroup=true, 如果這個選項開啟, 當要求 supervisor stop this group 時, signal 會被發送到 every process in this group</p>
</li>
</ul>
<h6 id="Laravel-中-如果一個-worker-吃光了-PHP-可用的所有-memory-那會發生什麼事？"><a href="#Laravel-中-如果一個-worker-吃光了-PHP-可用的所有-memory-那會發生什麼事？" class="headerlink" title="Laravel 中, 如果一個 worker 吃光了 PHP 可用的所有 memory, 那會發生什麼事？"></a><strong>Laravel 中, 如果一個 worker 吃光了 PHP 可用的所有 memory, 那會發生什麼事？</strong></h6><p>該 worker 會 exit with a fetal error</p>
<h6 id="以下的-Laravel-Testing-example-code-的意思是？"><a href="#以下的-Laravel-Testing-example-code-的意思是？" class="headerlink" title="以下的 Laravel Testing example code 的意思是？"></a><strong>以下的 Laravel Testing example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line">php artisan queue:work --memory=<span class="hljs-number">256</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>指定每個 worker 可以使用的最大 memory size, worker-level 使用的 memory 不可超過定義在 php.ini 中, 分配給 PHP 的 memory limit</p>
</li>
</ul>
<h6 id="以下的-Laravel-Queue-example-code-的意思是？"><a href="#以下的-Laravel-Queue-example-code-的意思是？" class="headerlink" title="以下的 Laravel Queue example code 的意思是？"></a><strong>以下的 Laravel Queue example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line">SomeClass::$property[] = $item;</span><br><span class="line">SomeClass::$property = [];</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>當使用 singleton 方法 cache value 時, 在 job 結束時別忘了 clean resource</p>
</li>
</ul>
<h6 id="Laravel-中-如果-server-是一台-single-CPU-server-and-jobs-involve-a-lot-of-waiting-那建議啟動幾個-worker"><a href="#Laravel-中-如果-server-是一台-single-CPU-server-and-jobs-involve-a-lot-of-waiting-那建議啟動幾個-worker" class="headerlink" title="Laravel 中, 如果 server 是一台 single CPU server, and jobs involve a lot of waiting, 那建議啟動幾個 worker?"></a><strong>Laravel 中, 如果 server 是一台 single CPU server, and jobs involve a lot of waiting, 那建議啟動幾個 worker?</strong></h6><p>可以啟用多個, 因為當一個 worker waiting 時, 其他 worker 可以使用 CPU</p>
<h6 id="Laravel-中-如果-server-是一台-single-CPU-server-而-job-是-CPU-intensive-job-那建議啟動幾個-worker"><a href="#Laravel-中-如果-server-是一台-single-CPU-server-而-job-是-CPU-intensive-job-那建議啟動幾個-worker" class="headerlink" title="Laravel 中, 如果 server 是一台 single CPU server, 而 job 是 CPU intensive job, 那建議啟動幾個 worker?"></a><strong>Laravel 中, 如果 server 是一台 single CPU server, 而 job 是 CPU intensive job, 那建議啟動幾個 worker?</strong></h6><p>一個, 因為該 worker 將會使用掉大部分的 CPU</p>
<h6 id="以下的-Laravel-example-code-的意思是？-60"><a href="#以下的-Laravel-example-code-的意思是？-60" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) &#123;</span><br><span class="line">    $job = <span class="hljs-keyword">$this</span>-&gt;getNextJob();</span><br><span class="line">    <span class="hljs-keyword">if</span> ($job) &#123;</span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;process($job);</span><br><span class="line">    &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">        sleep(<span class="hljs-number">3</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>worker 實際的運作模式</p>
</li>
</ul>
<h6 id="以下的-Laravel-Testing-example-code-的意思是？-1"><a href="#以下的-Laravel-Testing-example-code-的意思是？-1" class="headerlink" title="以下的 Laravel Testing example code 的意思是？"></a><strong>以下的 Laravel Testing example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-comment">// Event listener</span></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EventServiceProvider</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ServiceProvider</span></span></span><br><span class="line"><span class="hljs-class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">protected</span> $listen = [</span><br><span class="line">        NewOrderSubmitted::class =&gt; [</span><br><span class="line">            UpdateCustomerMetrics::class, SendInvoice::class, SendGiftCoupon::class,</span><br><span class="line">        ],</span><br><span class="line">    ];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// Controller</span></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OrderController</span></span></span><br><span class="line"><span class="hljs-class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">store</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function">    </span>&#123;</span><br><span class="line"><span class="hljs-comment">// ...</span></span><br><span class="line">        event(<span class="hljs-keyword">new</span> NewOrderSubmitted($order));</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">return</span> redirect(<span class="hljs-string">'/thanks'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// Job</span></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SendGiftCoupon</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ShouldQueue</span></span></span><br><span class="line"><span class="hljs-class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span><span class="hljs-params">(NewOrderSubmitted $event)</span></span></span><br><span class="line"><span class="hljs-function">    </span>&#123;</span><br><span class="line">        $customer = $event-&gt;customer;</span><br><span class="line">        $coupon = Coupon::createForCustomer($customer);</span><br><span class="line">        Mail::to($customer)-&gt;send(<span class="hljs-keyword">new</span> CouponGift($coupon)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">shouldQueue</span><span class="hljs-params">(NewOrderSubmitted $event)</span></span></span><br><span class="line"><span class="hljs-function">    </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> $event-&gt;customer-&gt;eligibleForRewards();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>使用 shouldQueue 來判斷 customer 是否 eligibleForRewards, 如果 return false, 則該 job 不會被放到 queue 中<br>如果不使用 shouldQueue 而在 handle() 中寫 if 判斷, 一是無法掌握判斷的時機點, 因為 job 何時會被 pick up 是無法掌握的, 二是萬一是 false 的話, 會浪費資源執行一個沒有動作的 job</p>
</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-61"><a href="#以下的-Laravel-example-code-的意思是？-61" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line">nice -n <span class="hljs-number">10</span> php artisan queue:work</span><br><span class="line">php artisan queue:work --rest=<span class="hljs-number">0.5</span> --sleep=<span class="hljs-number">5</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>給 worker 指派較低的 priority, 這樣 CPU 會讓 request 優先的被處理, 像是 php-fpm, nginx<br>可指定 0 到 19, 越高則 priority 越低<br>rest 0.5 秒, 可讓 worker 在處理完 job 後, 停頓 0.5s, 讓 OS 有機會分配更多的 CPU 給 high priority 的 process</p>
</li>
</ul>
<h6 id="Laravel-queue-中-使用-queue-的要點是什麼？"><a href="#Laravel-queue-中-使用-queue-的要點是什麼？" class="headerlink" title="Laravel queue 中, 使用 queue 的要點是什麼？"></a><strong>Laravel queue 中, 使用 queue 的要點是什麼？</strong></h6><p>job payload 越小越好</p>
<h6 id="Laravel-queue-中-當使用-Redis-為-queue-driver-時-務必要讓-job-越可能得越快被執行越好-為什麼？"><a href="#Laravel-queue-中-當使用-Redis-為-queue-driver-時-務必要讓-job-越可能得越快被執行越好-為什麼？" class="headerlink" title="Laravel queue 中, 當使用 Redis 為 queue driver 時, 務必要讓 job 越可能得越快被執行越好, 為什麼？"></a><strong>Laravel queue 中, 當使用 Redis 為 queue driver 時, 務必要讓 job 越可能得越快被執行越好, 為什麼？</strong></h6><p>因為未處理的 job 會堆積在 redis 中</p>
<h6 id="以下的-Laravel-queue-example-code-的意思是？"><a href="#以下的-Laravel-queue-example-code-的意思是？" class="headerlink" title="以下的 Laravel queue example code 的意思是？"></a><strong>以下的 Laravel queue example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    app(<span class="hljs-string">'queue.worker'</span>)-&gt;shouldQuit  = <span class="hljs-number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>如果有某些 job 會耗費大量的 memory, 那麼極有可能在該 worker 完成該 job 後, 會累積大量 PHP garbage collector 無法偵測到的 reference 在 server memory 中, 可在 handle method 的結尾, 指定該 worker restart</p>
</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-62"><a href="#以下的-Laravel-example-code-的意思是？-62" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line">php artisan queue:work --max-jobs=<span class="hljs-number">1000</span> --max-time=<span class="hljs-number">3600</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>隨著 worker 處理 job, 會慢慢地堆積一些 reference, 這些 reference 不會被 PHP garbage collector 偵測並回收, 會累積在 server memory, 直到累積到某個點, 造成 server crash, 因此可定義讓 worker 執行到達某個量的 job 或時間便自動釋放重啟</p>
</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-63"><a href="#以下的-Laravel-example-code-的意思是？-63" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-comment">// In controller</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">store</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    Messenger::dispatch($customer);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// In Messenger Job</span></span><br><span class="line"><span class="hljs-keyword">public</span> $tries = <span class="hljs-number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">$this</span>-&gt;customer-&gt;is_active) &#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;fail(</span><br><span class="line">            <span class="hljs-keyword">new</span> \<span class="hljs-keyword">Exception</span>(<span class="hljs-string">'Customer account is not active!'</span>)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $messages = Messages::where(<span class="hljs-string">'customer'</span>, <span class="hljs-keyword">$this</span>-&gt;customer-&gt;id)-&gt;where(<span class="hljs-string">'status'</span>, <span class="hljs-string">'pending'</span>)</span><br><span class="line">        -&gt;orderBy(<span class="hljs-string">'timestamp'</span>)-&gt;limit(<span class="hljs-number">10</span>)-&gt;get();</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">if</span> (!$messages-&gt;count()) &#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;release(<span class="hljs-number">5</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">foreach</span> ($messages <span class="hljs-keyword">as</span> $message) &#123;</span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;chained[] = <span class="hljs-keyword">$this</span>-&gt;serializeJob(<span class="hljs-keyword">new</span> ProcessMessage($message));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">$this</span>-&gt;chained[] = <span class="hljs-keyword">$this</span>-&gt;serializeJob(<span class="hljs-keyword">new</span> <span class="hljs-keyword">self</span>(<span class="hljs-keyword">$this</span>-&gt;customer));</span><br><span class="line"></span><br><span class="line">    Bus::chain(<span class="hljs-keyword">$this</span>-&gt;chained)-&gt;dispatch();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// In ProcessMessage Job</span></span><br><span class="line"><span class="hljs-keyword">public</span> $tries = <span class="hljs-number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">$this</span>-&gt;attemps() &gt; <span class="hljs-number">5</span>) &#123;</span><br><span class="line">        Log::error(...);</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Intercom::send(<span class="hljs-keyword">$this</span>-&gt;message);</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">$this</span>-&gt;message-&gt;update([</span><br><span class="line">        <span class="hljs-string">'status'</span> =&gt; <span class="hljs-string">'sent'</span></span><br><span class="line">    ]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-comment">// In controller</span></span><br><span class="line"><span class="hljs-comment">// 當建立新的 customer 時, 啟動該 job</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">store</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    Messenger::dispatch($customer);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// In Messenger Job</span></span><br><span class="line"><span class="hljs-comment">// $treis 設為 0, 因為這個 job 將會無限制次數的一直跑在背景, 監聽著 database</span></span><br><span class="line"><span class="hljs-keyword">public</span> $tries = <span class="hljs-number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    <span class="hljs-comment">// 如果該 customer 帳號為啟動, 則 return 該 job, 啟動時需 dispatch messenger job</span></span><br><span class="line">    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">$this</span>-&gt;customer-&gt;is_active) &#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;fail(</span><br><span class="line">            <span class="hljs-keyword">new</span> \<span class="hljs-keyword">Exception</span>(<span class="hljs-string">'Customer account is not active!'</span>)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// Laravel 會將 chain's jobs payloads 存在第一個 the payload of the first job in the chain</span></span><br><span class="line">    <span class="hljs-comment">// 所以使用 limit() 以避免 payload size 過大</span></span><br><span class="line">    $messages = Messages::where(<span class="hljs-string">'customer'</span>, <span class="hljs-keyword">$this</span>-&gt;customer-&gt;id)-&gt;where(<span class="hljs-string">'status'</span>, <span class="hljs-string">'pending'</span>)</span><br><span class="line">        -&gt;orderBy(<span class="hljs-string">'timestamp'</span>)-&gt;limit(<span class="hljs-number">10</span>)-&gt;get();</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// 如果目前資料庫中沒有未處理的 message, 則 5 秒後再看一次</span></span><br><span class="line">    <span class="hljs-keyword">if</span> (!$messages-&gt;count()) &#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;release(<span class="hljs-number">5</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// 取得將會用到的 job</span></span><br><span class="line">    <span class="hljs-keyword">foreach</span> ($messages <span class="hljs-keyword">as</span> $message) &#123;</span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;chained[] = <span class="hljs-keyword">$this</span>-&gt;serializeJob(<span class="hljs-keyword">new</span> ProcessMessage($message));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// 最後, 將 messenger 這個 job 放在最後, 這樣當所有的 message 都處理完成</span></span><br><span class="line">    <span class="hljs-comment">// 會再次執行 messenger job, 再檢查一次資料庫</span></span><br><span class="line">    <span class="hljs-keyword">$this</span>-&gt;chained[] = <span class="hljs-keyword">$this</span>-&gt;serializeJob(<span class="hljs-keyword">new</span> <span class="hljs-keyword">self</span>(<span class="hljs-keyword">$this</span>-&gt;customer));</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// dispatch chained jobs</span></span><br><span class="line">    Bus::chain(<span class="hljs-keyword">$this</span>-&gt;chained)-&gt;dispatch();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// In ProcessMessage Job</span></span><br><span class="line"><span class="hljs-comment">// $tries 需設為 0, 這樣才不會因為失敗被 mark as failed</span></span><br><span class="line"><span class="hljs-comment">// 才不會讓後面的 job 都無法被執行</span></span><br><span class="line"><span class="hljs-keyword">public</span> $tries = <span class="hljs-number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    <span class="hljs-comment">// 因為 $tries 設為 0, 所以這邊要手動的處理 failure</span></span><br><span class="line">    <span class="hljs-comment">// 如果嘗試超過 5 次, 就 log 並 return, 執行下一個 message job</span></span><br><span class="line">    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">$this</span>-&gt;attemps() &gt; <span class="hljs-number">5</span>) &#123;</span><br><span class="line">        Log::error(...);</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Intercom::send(<span class="hljs-keyword">$this</span>-&gt;message);</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">$this</span>-&gt;message-&gt;update([</span><br><span class="line">        <span class="hljs-string">'status'</span> =&gt; <span class="hljs-string">'sent'</span></span><br><span class="line">    ]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-64"><a href="#以下的-Laravel-example-code-的意思是？-64" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RefundAttendee</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ShouldQueue</span>, <span class="hljs-title">ShouldBeUnique</span></span></span><br><span class="line"><span class="hljs-class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> $uniqueFor = <span class="hljs-number">10</span>; <span class="hljs-comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">($attendee)</span></span></span><br><span class="line"><span class="hljs-function">    </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;attendee = $attendee;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function">    </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">$this</span>-&gt;attendee-&gt;invoice-&gt;wasRefunded()) &#123;</span><br><span class="line">            <span class="hljs-keyword">$this</span>-&gt;attendee-&gt;invoice-&gt;refund();</span><br><span class="line">        &#125;</span><br><span class="line">        Mail::to(<span class="hljs-keyword">$this</span>-&gt;attendee)-&gt;send(...);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">uniqueId</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function">    </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;attendee-&gt;invoice-&gt;id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>Laravel 8 的新功能, 如果擔心一個 job 會被 dispatch 多次, 那可以 implement ShouldBeUnique interface, 當 queue 內已有該 instance, 後面 dispatch 的都會被忽略<br>如果需要 dispatch 多個相同的 job class, 但根據帶入的 parameter 而不同的話, 可使用 uniqueId() 來作為 unique key<br>Laravel 在底層會嘗試取得該 job 該 unique key 的 lock, 只要該 lock 存在, 後面 dispatch 的 job 都會被忽略<br>通常 lock 會在該 job fails 或 finish 之後 release, 若要自定義釋放時間, 可使用 $uniqueFor property</p>
</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-65"><a href="#以下的-Laravel-example-code-的意思是？-65" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ReportGenerationPlan</span></span></span><br><span class="line"><span class="hljs-class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">start</span><span class="hljs-params">($report)</span></span></span><br><span class="line"><span class="hljs-function">    </span>&#123;</span><br><span class="line">        Bus::chain([</span><br><span class="line">            <span class="hljs-keyword">new</span> ExtractData($report), </span><br><span class="line">            <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> <span class="hljs-title">use</span> <span class="hljs-params">($report)</span> </span>&#123;</span><br><span class="line">                <span class="hljs-keyword">static</span>::step2($report);</span><br><span class="line">            &#125;</span><br><span class="line">        ])-&gt;catch(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> <span class="hljs-title">use</span> <span class="hljs-params">($report)</span> </span>&#123;</span><br><span class="line">            <span class="hljs-keyword">static</span>::failed($report);</span><br><span class="line">        &#125;)-&gt;dispatch();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">step2</span><span class="hljs-params">($report)</span></span></span><br><span class="line"><span class="hljs-function">    </span>&#123;</span><br><span class="line">        $jobs = $report-&gt;chunks-&gt;mapInto(TransformChunk::class);</span><br><span class="line">        Bus::batch($jobs)</span><br><span class="line">        -&gt;then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> <span class="hljs-title">use</span> <span class="hljs-params">($report)</span> </span>&#123;</span><br><span class="line">            <span class="hljs-keyword">static</span>::step3($report);</span><br><span class="line">        &#125;)-&gt;dispatch();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">step3</span><span class="hljs-params">($report)</span></span></span><br><span class="line"><span class="hljs-function">    </span>&#123;</span><br><span class="line">        Bus::chain([</span><br><span class="line">            <span class="hljs-keyword">new</span> StoreData($report),</span><br><span class="line">            <span class="hljs-keyword">new</span> GenerateSummary($report)</span><br><span class="line">        ])-&gt;dispatch();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">failed</span><span class="hljs-params">($report)</span></span></span><br><span class="line"><span class="hljs-function">    </span>&#123;</span><br><span class="line">        <span class="hljs-comment">// Run any cleaning work ...</span></span><br><span class="line">        $report-&gt;update([</span><br><span class="line">            <span class="hljs-string">'status'</span> =&gt; <span class="hljs-string">'failed'</span></span><br><span class="line">        ]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// in controller</span></span><br><span class="line">$report = Report::create([...]);</span><br><span class="line">   ReportGenerationPlan:::start($report);</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:</p>
<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">START</span><br><span class="line">-&gt; RUN ExtractData THEN</span><br><span class="line">-&gt; DISPATCH multiple TransformChunk jobs THEN</span><br><span class="line">-&gt; RUN all TransformChunk jobs from the batch THEN</span><br><span class="line">-&gt; DISPATCH a chain THEN</span><br><span class="line">-&gt; RUN StoreData THEN</span><br><span class="line">-&gt; RUN GenerateSummary END</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-66"><a href="#以下的-Laravel-example-code-的意思是？-66" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">store</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    $database = Database::create([</span><br><span class="line">        <span class="hljs-string">'status'</span> =&gt; <span class="hljs-string">'provisioning'</span></span><br><span class="line">    ]);</span><br><span class="line"></span><br><span class="line">    Bus::chain(</span><br><span class="line">        <span class="hljs-keyword">new</span> EnsureANetworkExists(),</span><br><span class="line">        <span class="hljs-keyword">new</span> EnsureNetworkHasInternetAccess(),</span><br><span class="line">        <span class="hljs-keyword">new</span> CreateDatabase($database)</span><br><span class="line">    )-&gt;catch(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        $network = Network::first();</span><br><span class="line">        <span class="hljs-keyword">if</span> (!$network-&gt;usedByOtherResources()) &#123;</span><br><span class="line">            $network-&gt;delete();</span><br><span class="line"></span><br><span class="line">            <span class="hljs-keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-keyword">if</span> (!$network-&gt;activeDatabases()-&gt;count()) &#123;</span><br><span class="line">            $network-&gt;removeInternetAccess();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)-&gt;dispatch();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>多個 job 會按照 chain() 內的順序執行, 當第一個成功了才會執行下一個, 如果第一個一直 retry 直到 attempt 好耗盡而失敗, 那便會 invoke cache() 內的 closure<br>先確定 network 存在, 否則則建立, 在確認 network 有 internet access, 否則則建立, 最後確認 database 是否有被 attached, 若無, 則 attach 到 network<br>若失敗, 先確認 network 是否有被其他 resource 使用, 若無, 則直接刪除該 network, 若有被其他資源使用, 但無連接 active database, 則移除 internet access</p>
</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-67"><a href="#以下的-Laravel-example-code-的意思是？-67" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-comment">// in controller</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">store</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    $temporaryFilePath = request()-&gt;file(<span class="hljs-string">'video'</span>)</span><br><span class="line">        -&gt;store(<span class="hljs-string">'uploaded-videos'</span>);</span><br><span class="line">    CompressAndStoreVideo::dispatch($temporaryFilePath);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// in job</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    <span class="hljs-keyword">if</span> (!app(<span class="hljs-string">'files'</span>)-&gt;exists(<span class="hljs-keyword">$this</span>-&gt;temporaryFilePath)) &#123;</span><br><span class="line">        report(<span class="hljs-keyword">new</span> \<span class="hljs-keyword">Exception</span>(<span class="hljs-string">'Temporary file not found!'</span>));</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;delete();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $newFile = VideoProcessesor::compress(<span class="hljs-keyword">$this</span>-&gt;temporaryFilePath);</span><br><span class="line"></span><br><span class="line">    app(<span class="hljs-string">'files'</span>)-&gt;delete(<span class="hljs-keyword">$this</span>-&gt;temporaryFilePath);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">failed</span><span class="hljs-params">(Exception $e)</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    <span class="hljs-comment">// 如果之後不重試, 也可立即刪掉</span></span><br><span class="line">    DeleteFile::dispatch(<span class="hljs-keyword">$this</span>-&gt;temporaryFilePath)-&gt;delay(now()-&gt;addHours(<span class="hljs-number">24</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>在 controller 中, 將 file 先存到 default disk, 並取得 path, dispatch path 到 job<br>job handle method 中, 檢查該 path file 是否依然存在, 如果不存在則 report 並刪掉該 job<br>如果存在, 則 compress 該 file, 完成後刪掉該 file<br>如果失敗了, 延遲 24 小時後刪除, 在這期間可以手動嘗試</p>
</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-68"><a href="#以下的-Laravel-example-code-的意思是？-68" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ModelIdentifier</span></span></span><br><span class="line"><span class="hljs-class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">        $class,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">        $id,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">        $relations,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">        $connection</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">    )</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;id = $id;</span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;class = $class;</span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;relations = $relations;</span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;connection = $connection;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>Laravel 為了減少 job payload size, 當 queued job 如果其中有 model, 只會記住該 model identifier, 待真正執行該 job 時才會依照 identifier 取出 model</p>
</li>
</ul>
<h6 id="以下的-Laravel-job-middleware-example-code-的意思是？"><a href="#以下的-Laravel-job-middleware-example-code-的意思是？" class="headerlink" title="以下的 Laravel job middleware example code 的意思是？"></a><strong>以下的 Laravel job middleware example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span><span class="hljs-params">($job, $next)</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    <span class="hljs-keyword">$this</span>-&gt;lastFailureTimestamp = Cache::get(<span class="hljs-string">'circuit:open'</span>);</span><br><span class="line">    <span class="hljs-comment">// Check if the circuit is open and release the job.</span></span><br><span class="line">    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">$this</span>-&gt;shouldRun()) &#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> $job-&gt;release(</span><br><span class="line">            <span class="hljs-keyword">$this</span>-&gt;lastFailureTimestamp + <span class="hljs-keyword">$this</span>-&gt;secondsToCloseCircuit + rand(<span class="hljs-number">1</span>, <span class="hljs-number">120</span>)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-comment">// If the circuit is closed or half-open, we will try // running the job and catch exceptions.</span></span><br><span class="line">    <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">        $next($job);</span><br><span class="line">        <span class="hljs-comment">// If the job passes, we'll close the circuit if it's // open and reset the failures counter. $this-&gt;closeCircuit();</span></span><br><span class="line">    &#125; <span class="hljs-keyword">catch</span> (RequestException $e) &#123;</span><br><span class="line">        <span class="hljs-keyword">if</span> ($e-&gt;response-&gt;serverError()) &#123;</span><br><span class="line">            <span class="hljs-keyword">$this</span>-&gt;handleFailure($job);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="hljs-keyword">catch</span> (ConnectionException $e) &#123;</span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;handleFailure($job);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>將 circuit pattern 的概念寫成一個 job middleware, 當 error 達到一定程度時打開 circuit breaker, 打開一段時間後啟動 half open 狀態, 放一個 job 過去, 要是該 job 成功, 則關掉 circuit breaker, 要是失敗則重新計算 circuit breaker 時間, 同時根據 exception 的不同使用不同的方式來 handle failure, request exception 或 connection exception</p>
</li>
</ul>
<h6 id="以下的-Laravel-job-example-code-的意思是？"><a href="#以下的-Laravel-job-example-code-的意思是？" class="headerlink" title="以下的 Laravel job example code 的意思是？"></a><strong>以下的 Laravel job example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RateLimitingJobMiddleware</span></span></span><br><span class="line"><span class="hljs-class"></span>&#123;</span><br><span class="line">    <span class="hljs-keyword">public</span> $key;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">($key)</span></span></span><br><span class="line"><span class="hljs-function">    </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;key = $key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span><span class="hljs-params">($job, $next)</span></span></span><br><span class="line"><span class="hljs-function">    </span>&#123;</span><br><span class="line">        Redis::throttle(</span><br><span class="line">            <span class="hljs-keyword">$this</span>-&gt;key</span><br><span class="line">        )</span><br><span class="line">        <span class="hljs-comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// job class</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">middleware</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    <span class="hljs-keyword">return</span> [</span><br><span class="line">        <span class="hljs-keyword">new</span> BulkHeadingJobMiddleware(<span class="hljs-string">'slow_service'</span>),</span><br><span class="line">        <span class="hljs-keyword">new</span> CircuitBreakerJobMiddleware(<span class="hljs-string">'unstable_service'</span>)</span><br><span class="line">    ];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>可 pass parameter 到 job middleware, 以 limit 特定的 job</p>
</li>
</ul>
<h6 id="以下位於-job-中的-Laravel-example-code-的意思是？"><a href="#以下位於-job-中的-Laravel-example-code-的意思是？" class="headerlink" title="以下位於 job 中的 Laravel example code 的意思是？"></a><strong>以下位於 job 中的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">middleware</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    <span class="hljs-keyword">return</span> [</span><br><span class="line">        <span class="hljs-keyword">new</span> RateLimitingJobMiddleware(<span class="hljs-keyword">$this</span>-&gt;customer-&gt;id)</span><br><span class="line">    ];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>在 job class 中的 middleware method 中可定義該 job 會經過哪一些 middleware, 並且可 pass parameter 到 middleware</p>
</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-69"><a href="#以下的-Laravel-example-code-的意思是？-69" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RateLimitingJobMiddleware</span></span></span><br><span class="line"><span class="hljs-class"></span>&#123;</span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span><span class="hljs-params">($job, $next)</span></span></span><br><span class="line"><span class="hljs-function">    </span>&#123;</span><br><span class="line">        Redis::throttle(<span class="hljs-string">'job-limiter'</span>)</span><br><span class="line">            -&gt;allow(<span class="hljs-number">5</span>)</span><br><span class="line">            -&gt;every(<span class="hljs-number">60</span>)</span><br><span class="line">            -&gt;then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> <span class="hljs-title">use</span> <span class="hljs-params">($job, $next)</span> </span>&#123;</span><br><span class="line">                $next($job);</span><br><span class="line">            &#125;, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> <span class="hljs-title">use</span> <span class="hljs-params">($job)</span> </span>&#123;</span><br><span class="line">                $job-&gt;release(<span class="hljs-number">60</span>);</span><br><span class="line">            &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>使用 job middleware 來限制最多可以 concurrent 執行的 job 數量, Redis 的 throttle method 會鎖住 <code>job-limiter</code> 字段, 使該字段只能最多 5 個 current job 被 worker pick up, <code>$next($job)</code> 代表執行該 job 的 handle(), 也可透過 property 來取代字段, 這樣就可以限制同類型的 job</p>
</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-70"><a href="#以下的-Laravel-example-code-的意思是？-70" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    <span class="hljs-keyword">if</span> ($lastFailureTimestamp = Cache::get(<span class="hljs-string">'circuit:open'</span>)) &#123;</span><br><span class="line">        <span class="hljs-keyword">if</span> (time() - $lastFailureTimestamp &lt; <span class="hljs-number">8</span> * <span class="hljs-number">60</span>) &#123;</span><br><span class="line">            <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;release(</span><br><span class="line">                $lastFailureTimestamp + <span class="hljs-number">600</span> + rand(<span class="hljs-number">1</span>, <span class="hljs-number">120</span>)</span><br><span class="line">            );</span><br><span class="line">        &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">            $halfOpen = <span class="hljs-keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    $response = Http::acceptJson()-&gt;timeout(<span class="hljs-number">10</span>)</span><br><span class="line">        -&gt;get(<span class="hljs-string">'...'</span>);</span><br><span class="line">    <span class="hljs-keyword">if</span> ($response-&gt;serverError()) &#123;</span><br><span class="line">        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>($halfOpen)) &#123;</span><br><span class="line">            Cache::put(<span class="hljs-string">'circuit:open'</span>, time(), <span class="hljs-number">600</span>);</span><br><span class="line"></span><br><span class="line">            <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;release(<span class="hljs-number">600</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-keyword">if</span> (!$failures = Cache::get(<span class="hljs-string">'failures'</span>)) &#123;</span><br><span class="line">            Cache::put(<span class="hljs-string">'failures'</span>, <span class="hljs-number">1</span>, <span class="hljs-number">60</span>);</span><br><span class="line">        &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">            Cache::increment(<span class="hljs-string">'failures'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-keyword">if</span> (Cache::get(<span class="hljs-string">'failures'</span>) &gt; <span class="hljs-number">10</span>) &#123;</span><br><span class="line">            Cache::put(<span class="hljs-string">'circuit:open'</span>, time(), <span class="hljs-number">600</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;release(<span class="hljs-number">600</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    Cache::forget(<span class="hljs-string">'failures'</span>);</span><br><span class="line">    Cache::forget(<span class="hljs-string">'circuit:open'</span>);</span><br><span class="line">    <span class="hljs-comment">// Use the response to run the business logic.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>circuit pattern<br>如果第三方服務失敗超過 10 次, 則開啟斷路器, 10 分鐘後再嘗試<br>若斷路器已開啟超過 8 分鐘, 先放一個 job 過去試試看, 若成功則關閉斷路器, 失敗則更新斷路器開啟時間, 重新計算 10 分鐘</p>
</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-71"><a href="#以下的-Laravel-example-code-的意思是？-71" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    Redis::throttle(<span class="hljs-keyword">$this</span>-&gt;report-&gt;customer_id)-&gt;allow(<span class="hljs-number">5</span>)</span><br><span class="line">        -&gt;every(<span class="hljs-number">60</span> * <span class="hljs-number">60</span>)</span><br><span class="line">        -&gt;then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">            $results = ReportGenerator::generate(<span class="hljs-keyword">$this</span>-&gt;report);</span><br><span class="line">            <span class="hljs-keyword">$this</span>-&gt;report-&gt;update([</span><br><span class="line">                <span class="hljs-string">'status'</span> =&gt; <span class="hljs-string">'done'</span>, <span class="hljs-string">'results'</span> =&gt; $results</span><br><span class="line">            ]);</span><br><span class="line">        &#125;, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">            <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;release(<span class="hljs-number">60</span> * <span class="hljs-number">10</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>每 1 個小時只允許每個 customer_id 可以最多產生 5 份 report, 如果 5 個 slots 都滿了, 則 acquire lock 失敗的 job 會被在 10 分鐘後 release, 60 分鐘從第一個 slot 被佔據之後開始計算時間</p>
</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-72"><a href="#以下的-Laravel-example-code-的意思是？-72" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line">Redis::funnel(<span class="hljs-keyword">$this</span>-&gt;report-&gt;customer_id)-&gt;releaseAfter(<span class="hljs-number">5</span> * <span class="hljs-number">60</span>)</span><br><span class="line">-&gt;block(...)</span><br><span class="line">-&gt;limit(...)</span><br><span class="line">-&gt;then(...)</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>funnel limiter 預設會在 60 秒後清掉 slot, 若該 job 執行時間超過 60 秒, limiter 會清掉該 slot, 但原本的 job 還在執行中, 這樣會變成又有一個新的 job 可被執行, 這樣就超出了我們預期 limiter 的最大限制, 可使用 releaseAfter 定義 timeout 時間</p>
</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-73"><a href="#以下的-Laravel-example-code-的意思是？-73" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line">Redis::funnel(<span class="hljs-keyword">$this</span>-&gt;report-&gt;customer_id)-&gt;block(<span class="hljs-number">5</span>)</span><br><span class="line">    -&gt;limit(...)-&gt;then(...);</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>funnel 預設會嘗試 acquire lock 3 秒, 可使用 block() 指定嘗試時間</p>
</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-74"><a href="#以下的-Laravel-example-code-的意思是？-74" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    <span class="hljs-keyword">public</span> $tries = <span class="hljs-number">10</span>;</span><br><span class="line">    <span class="hljs-keyword">public</span> $maxExceptions = <span class="hljs-number">2</span>;</span><br><span class="line">    Redis::funnel(<span class="hljs-keyword">$this</span>-&gt;report-&gt;customer_id)-&gt;limit(<span class="hljs-number">5</span>)</span><br><span class="line">        -&gt;then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">            $results = ReportGenerator::generate(<span class="hljs-keyword">$this</span>-&gt;report);</span><br><span class="line">            <span class="hljs-keyword">$this</span>-&gt;report-&gt;update([</span><br><span class="line">                <span class="hljs-string">'status'</span> =&gt; <span class="hljs-string">'done'</span>, <span class="hljs-string">'results'</span> =&gt; $results</span><br><span class="line">            ]);</span><br><span class="line">        &#125;, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">            <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;release(<span class="hljs-number">10</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>限制同一個 customer_id 最多只能同時有 5 筆 job 被執行, 若成功取得 lock 則會執行 closure, 若無法取得 lock (預設 3 秒), 則執行 second closure, 10 秒後可重新被 worker pick up</p>
</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-75"><a href="#以下的-Laravel-example-code-的意思是？-75" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    <span class="hljs-keyword">if</span> ($timestamp = Cache::get(<span class="hljs-string">'api-limit'</span>)) &#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;release(</span><br><span class="line">            $timestamp - time());</span><br><span class="line">    &#125;</span><br><span class="line">    $response = Http::acceptJson()-&gt;timeout(<span class="hljs-number">10</span>)</span><br><span class="line">        -&gt;withToken(<span class="hljs-string">'...'</span>)-&gt;get(<span class="hljs-string">'https://...'</span>);</span><br><span class="line">    <span class="hljs-keyword">if</span> ($response-&gt;failed() &amp;&amp; $response-&gt;status() == <span class="hljs-number">429</span>) &#123;</span><br><span class="line">        $secondsRemaining = $response-&gt;header(<span class="hljs-string">'Retry-After'</span>);</span><br><span class="line">        Cache::put(<span class="hljs-string">'api-limit'</span>,</span><br><span class="line">            now()-&gt;addSeconds($secondsRemaining)-&gt;timestamp,</span><br><span class="line">            $secondsRemaining</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;release($secondsRemaining</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    <span class="hljs-comment">// 所有會呼叫此外部服務的 job 會在第一個判斷重新被 release, 如果該外部服務</span></span><br><span class="line">    <span class="hljs-comment">// 目前處於 429 的狀態的話</span></span><br><span class="line">    <span class="hljs-comment">// 如果 cache 中存在 api-limit 這個 key, 代表還處於 429 狀態</span></span><br><span class="line">    <span class="hljs-comment">// api-limit 的 value 為實際上允許再被存取的時間, 所以這個時間扣掉當前</span></span><br><span class="line">    <span class="hljs-comment">// 的時間就會是距離可再被存取還需經過的秒數</span></span><br><span class="line">    <span class="hljs-keyword">if</span> ($timestamp = Cache::get(<span class="hljs-string">'api-limit'</span>)) &#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;release(</span><br><span class="line">            $timestamp - time());</span><br><span class="line">    &#125;</span><br><span class="line">    $response = Http::acceptJson()-&gt;timeout(<span class="hljs-number">10</span>)</span><br><span class="line">        -&gt;withToken(<span class="hljs-string">'...'</span>)-&gt;get(<span class="hljs-string">'https://...'</span>);</span><br><span class="line">        </span><br><span class="line">    <span class="hljs-comment">// 如果 response failed, 且 status 為 429, 代表 too many attempt</span></span><br><span class="line">    <span class="hljs-comment">// 得出可再被存取的時間點, 並將這個時間點存去 cache</span></span><br><span class="line">    <span class="hljs-keyword">if</span> ($response-&gt;failed() &amp;&amp; $response-&gt;status() == <span class="hljs-number">429</span>) &#123;</span><br><span class="line">        $secondsRemaining = $response-&gt;header(<span class="hljs-string">'Retry-After'</span>);</span><br><span class="line">        Cache::put(<span class="hljs-string">'api-limit'</span>,</span><br><span class="line">            now()-&gt;addSeconds($secondsRemaining)-&gt;timestamp,</span><br><span class="line">            $secondsRemaining</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;release($secondsRemaining</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-76"><a href="#以下的-Laravel-example-code-的意思是？-76" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-comment">// Controller</span></span><br><span class="line"><span class="hljs-keyword">foreach</span> (User::all() <span class="hljs-keyword">as</span> $user) &#123;</span><br><span class="line">    $exchangeRate = Currency::exchangeRateFor($user-&gt;currency);</span><br><span class="line">    GenerateInvoice::dispatch($user, $month, $exchangeRate);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// Currency Class</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> $rates = [];</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">exchangeRateFor</span><span class="hljs-params">($currency)</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>(<span class="hljs-keyword">static</span>::$rates[$currency])) &#123;</span><br><span class="line">        <span class="hljs-keyword">static</span>::$rates[$currency] = ExchangeRateApi::get(<span class="hljs-string">'USD'</span>, $currency);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-keyword">static</span>::$rates[$currency];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// Job handle method</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    $amountInLocalCurrency = $amount * <span class="hljs-keyword">$this</span>-&gt;exchangeRate;</span><br><span class="line">    $taxInLocalCurrency = ($amount * <span class="hljs-number">14</span> / <span class="hljs-number">100</span>) * <span class="hljs-keyword">$this</span>-&gt;exchangeRate;</span><br><span class="line"></span><br><span class="line">    $total = $amountInLocalCurrency + $taxInLocalCurrency;</span><br><span class="line">    Mail::to(<span class="hljs-keyword">$this</span>-&gt;user)-&gt;send(<span class="hljs-string">"Your usage last month was &#123;$total&#125;&#123;$this-&gt;user-&gt;currency&#125;"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>發送月帳單給客戶<br>使用 memorization tech 取得 exchange rate, 避免重複呼叫 API<br>取得 exchange rate 之後在 pass 到 job, 因為 job 運行在 memory 中的 single instance, 若是在 job 中使用 memorization tech, 那將會一直使用該 instance 中的初始得到的 exchange rate</p>
</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-77"><a href="#以下的-Laravel-example-code-的意思是？-77" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-comment">// controller</span></span><br><span class="line"><span class="hljs-keyword">foreach</span> (Site::all() <span class="hljs-keyword">as</span> $site) &#123;</span><br><span class="line">    <span class="hljs-keyword">if</span> ($site-&gt;current_visitors &gt;= $site-&gt;threshold) &#123;</span><br><span class="line">        SendSpikeDetectionNotification::dispatch(</span><br><span class="line">            $site, $site-&gt;current_visitors);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// job class</span></span><br><span class="line"><span class="hljs-keyword">private</span> $site;</span><br><span class="line"><span class="hljs-keyword">private</span> $visitors;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(Conference $site, $visitors)</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    <span class="hljs-keyword">$this</span>-&gt;site = $site;</span><br><span class="line">    <span class="hljs-keyword">$this</span>-&gt;visitors = $visitors;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    SMS::send(</span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;site-&gt;owner,</span><br><span class="line">        <span class="hljs-string">"Spike detected on &#123;$this-&gt;site-&gt;name&#125;! Current visitors: &#123;$this-&gt;visitors&#125;"</span></span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>當偵測到某個 site 的 visitor 已達 threshold, 發送 notification, 且 pass 當時的 value<br>因為 job execute 可能會有 delay, 若是在 job 中使用 model, serialization 會讓 job 取得最新的 model 狀態, 因此可能會出現 notification 中的資訊並非當時觸發 threshold 的數字, 而是 delay 之後可能降下來的數字</p>
</li>
</ul>
<h6 id="以下兩個-job-class-example-差異處在於？"><a href="#以下兩個-job-class-example-差異處在於？" class="headerlink" title="以下兩個 job class example, 差異處在於？"></a><strong>以下兩個 job class example, 差異處在於？</strong></h6><ul>
<li><p><strong>Job Example 1</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-keyword">private</span> $site;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(Conference $site)</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    <span class="hljs-keyword">$this</span>-&gt;site = $site;</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    SMS::send(</span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;site-&gt;owner,</span><br><span class="line">        <span class="hljs-string">"Spike detected on &#123;$this-&gt;site-&gt;name&#125;! Current visitors: &#123;$this-&gt;site-&gt;current_visitors&#125;"</span></span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Job Example 2</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-keyword">private</span> $site;</span><br><span class="line"><span class="hljs-keyword">private</span> $visitors;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(Conference $site, $visitors)</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    <span class="hljs-keyword">$this</span>-&gt;site = $site;</span><br><span class="line">    <span class="hljs-keyword">$this</span>-&gt;visitors = $visitors;</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    SMS::send(</span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;site-&gt;owner,</span><br><span class="line">        <span class="hljs-string">"Spike detected on &#123;$this-&gt;site-&gt;name&#125;! Current visitors: &#123;$this-&gt;visitors&#125;"</span></span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>當 job 被 queue 時, serialization 會記下 model identifier 而非 model instance, 因此<br>example 1 中, 因為是在 job 中 fetch model attribute, 會取得 model attribute 最新的狀態, 值可能會跟 dispatch 時不同<br>example 2 中, 因為是在 job 中取得 job class property, 因此值會跟 dispatch 時一樣</p>
</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-78"><a href="#以下的-Laravel-example-code-的意思是？-78" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">store</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    DB::transaction(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> <span class="hljs-title">use</span> <span class="hljs-params">($conference)</span> </span>&#123;</span><br><span class="line">        $attendee = Attendee::create([</span><br><span class="line">            <span class="hljs-string">'conference_id'</span> =&gt; $conference-&gt;id, <span class="hljs-string">'name'</span> =&gt; request(<span class="hljs-string">'name'</span>),</span><br><span class="line">            <span class="hljs-string">'reference'</span>     =&gt; $reference = Str::uuid() <span class="hljs-comment">// ...</span></span><br><span class="line">        ]);</span><br><span class="line">        $invoice = BillingProvider::invoice([</span><br><span class="line">            <span class="hljs-string">'customer_reference'</span> =&gt; $reference, <span class="hljs-string">'card_token'</span> =&gt; request(<span class="hljs-string">'card_token'</span>), <span class="hljs-comment">// ...</span></span><br><span class="line">        ]);</span><br><span class="line">    &#125;);</span><br><span class="line">    SendTicketInformation::dispatch($attendee);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>在 transaction 內, 建立 attendee 並 bill, 如果失敗則回滾並 throw exception, 如果都成功, 則 dispatch SendTicketInformation job, 若要在 transaction 內 dispatch 也可, 只要設定 delay 就可, 確保 transaction commit 完成之後 worker 才去 pick up job</p>
</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-79"><a href="#以下的-Laravel-example-code-的意思是？-79" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line">Bus::batch($jobs)-&gt;allowFailures()</span><br><span class="line">    -&gt;then(...)</span><br><span class="line">    -&gt;catch(...)-&gt;finally(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">($batch)</span> </span>&#123;</span><br><span class="line">        $conference = Conference::firstWhere(<span class="hljs-string">'refunds_batch'</span>, <span class="hljs-string">'='</span>, $batch-&gt;id);</span><br><span class="line">        Mail::to($conference-&gt;organizer)-&gt;send(</span><br><span class="line">            <span class="hljs-string">'Refunding attendees completed!'</span></span><br><span class="line">        );</span><br><span class="line">    &#125;)-&gt;dispatch();</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>當所有 job 都執行完畢, 儘管有些 fail, 有些 succeed, 那便會觸發 finally(), 通知 organizer</p>
</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-80"><a href="#以下的-Laravel-example-code-的意思是？-80" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line">Bus::batch($jobs)</span><br><span class="line">    -&gt;allowFailures()</span><br><span class="line">    -&gt;then(...)</span><br><span class="line">    -&gt;catch(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">($batch, $e)</span> </span>&#123;</span><br><span class="line">        $conference = Conference::firstWhere(<span class="hljs-string">'refunds_batch'</span>, <span class="hljs-string">'='</span>, $batch-&gt;id);</span><br><span class="line">        Mail::to($conference-&gt;organizer)-&gt;send(</span><br><span class="line">            <span class="hljs-string">'We failed to refund some of the attendees!'</span></span><br><span class="line">        );</span><br><span class="line">    &#125;)</span><br><span class="line">    -&gt;dispatch();</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>當首次有 job fails 時, 會執行 cache() 內的 closure, 通知 organizer, 如果有 job fails 就不會觸發 then()</p>
</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-81"><a href="#以下的-Laravel-example-code-的意思是？-81" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line">Bus::batch($jobs)-&gt;allowFailures()-&gt;then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">($batch)</span> </span>&#123;</span><br><span class="line">    $conference = Conference::firstWhere(<span class="hljs-string">'refunds_batch'</span>, <span class="hljs-string">'='</span>, $batch-&gt;id);</span><br><span class="line">    Mail::to($conference-&gt;organizer)-&gt;send(</span><br><span class="line">        <span class="hljs-string">'All attendees were refunded successfully!'</span></span><br><span class="line">    );</span><br><span class="line">&#125;)-&gt;dispatch();</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>當 batch 內所有的 job 都 successfully executed, 會執行 then() 內的 closure, 發 mail 通知 organizer</p>
</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-82"><a href="#以下的-Laravel-example-code-的意思是？-82" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line">$batch = Bus::findBatch($conference-&gt;refunds_batch);</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">return</span> [</span><br><span class="line">    <span class="hljs-string">'progress'</span>     =&gt; $batch-&gt;progress().<span class="hljs-string">'%'</span>, </span><br><span class="line">    <span class="hljs-string">'remaining_refunds'</span> =&gt; $batch-&gt;pendingJobs,</span><br><span class="line">    <span class="hljs-string">'has_failures'</span> =&gt; $batch-&gt;hasFailures(), </span><br><span class="line">    <span class="hljs-string">'is_cancelled'</span> =&gt; $batch-&gt;canceled()</span><br><span class="line">];</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>取得 batch 目前的整體進度 (1-100, int)<br>取得目前 pending jobs 的數量 (int)<br>取得是否有 failed job (boolean)<br>取得該 batch 是否 cancelled (boolean)</p>
</li>
</ul>
<h6 id="以下的-Laravel-example-command-的意思是？-1"><a href="#以下的-Laravel-example-command-的意思是？-1" class="headerlink" title="以下的 Laravel example command 的意思是？"></a><strong>以下的 Laravel example command 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">php artisan queue:retry-batch &#123;batch_id&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>使用 CLI retry 指定 batch 中的 failed jobs</p>
</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-83"><a href="#以下的-Laravel-example-code-的意思是？-83" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line">$batch = Bus::batch($jobs)-&gt;allowFailures()-&gt;dispatch();</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>當使用 batch dispatch jobs, 預設如果其中一個 job fails, 那該 batch 就會終止, 使用 allowFailures(), 即使有 job fails 該 batch 也會 dispatch 其他 job</p>
</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-84"><a href="#以下的-Laravel-example-code-的意思是？-84" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line">$batch = Bus::findBatch($conference-&gt;refunds_batch);</span><br><span class="line">$batch-&gt;cancel();</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// in job class</span></span><br><span class="line"><span class="hljs-keyword">use</span> <span class="hljs-title">Batchable</span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">$this</span>-&gt;batch()-&gt;canceled()) &#123;</span><br><span class="line">        <span class="hljs-keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-comment">// Actual refunding code here ...</span></span><br><span class="line">    <span class="hljs-keyword">$this</span>-&gt;attendee-&gt;update([</span><br><span class="line">        <span class="hljs-string">'refunded'</span> =&gt; <span class="hljs-keyword">true</span></span><br><span class="line">    ]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>從存在資料庫的 batch_id 取得該 batch, 並執行 cancel(), 該 batch 會被 marked as cancelled<br>在 job handle() 中, 判斷如果該 job 的 batch 已經被 marked as cancelled, 那立即 return 該 job, 若否則繼續執行<br>藉此當我們 mark batch as cancelled 之後, 所以在 queue 中尚未執行的 job 都會被 cancelled</p>
</li>
</ul>
<h6 id="以下的-Laravel-example-command-的意思是？-2"><a href="#以下的-Laravel-example-command-的意思是？-2" class="headerlink" title="以下的 Laravel example command 的意思是？"></a><strong>以下的 Laravel example command 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">php artisan queue:batches-table</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>Laravel 會將 batch 資料存在 table, 因此需要建立該 table</p>
</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-85"><a href="#以下的-Laravel-example-code-的意思是？-85" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Bus</span>\<span class="hljs-title">Batchable</span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RefundAttendee</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ShouldQueue</span></span></span><br><span class="line"><span class="hljs-class"></span>&#123;</span><br><span class="line">    <span class="hljs-keyword">use</span> <span class="hljs-title">Batchable</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>若要 job 可被 batch dispatch, 需 use <code>Batchable</code> trait</p>
</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-86"><a href="#以下的-Laravel-example-code-的意思是？-86" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line">$jobs = <span class="hljs-keyword">$this</span>-&gt;conference-&gt;attendees-&gt;map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">($attendee)</span> </span>&#123;</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> RefundAttendee($attendee);</span><br><span class="line">   &#125;);</span><br><span class="line">$batch = Bus::batch($jobs)-&gt;dispatch();</span><br><span class="line"><span class="hljs-keyword">$this</span>-&gt;conference-&gt;update([</span><br><span class="line">    <span class="hljs-string">'refunds_batch'</span> =&gt; $batch-&gt;id</span><br><span class="line">]);</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>使用 batch(), 一次性的 queue 複數的 jobs, 相當於用一句 command 將複數的 job push 到 queue, 而不是分成多句 command<br>並將 batch id 儲存在資料庫</p>
</li>
</ul>
<h6 id="以下的-Laravel-job-example-中-要是-worker-在取得-lock-之後-crash-了-那會發生什麼事？"><a href="#以下的-Laravel-job-example-中-要是-worker-在取得-lock-之後-crash-了-那會發生什麼事？" class="headerlink" title="以下的 Laravel job example 中, 要是 worker 在取得 lock 之後 crash 了, 那會發生什麼事？"></a><strong>以下的 Laravel job example 中, 要是 worker 在取得 lock 之後 crash 了, 那會發生什麼事？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    $invoice = <span class="hljs-keyword">$this</span>-&gt;attendee-&gt;invoice;</span><br><span class="line"></span><br><span class="line">    Cache::lock(<span class="hljs-string">'refund.'</span>.$invoice-&gt;id)</span><br><span class="line">        -&gt;get(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">            <span class="hljs-keyword">if</span> (! $invoice-&gt;wasRefunded()) &#123;</span><br><span class="line">                $invoice-&gt;refund();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Mail::to(<span class="hljs-keyword">$this</span>-&gt;attendee)-&gt;send(...);</span><br><span class="line">        &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>因為 lock 並沒有設定持有秒數, 所以會永遠持有, 那當該 job reserved tag 被移除後, 其他 worker 會嘗試 pick up 該 job, 但會卡在 lock 處, 直到 $timeout, 最後耗盡 $tries 次數</p>
</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-87"><a href="#以下的-Laravel-example-code-的意思是？-87" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RefundAttendee</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ShouldQueue</span></span></span><br><span class="line"><span class="hljs-class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> $tries = <span class="hljs-number">3</span>;</span><br><span class="line">    <span class="hljs-keyword">public</span> $timeout = <span class="hljs-number">60</span>;</span><br><span class="line">    <span class="hljs-keyword">public</span> $backoff = <span class="hljs-number">11</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="hljs-keyword">private</span> $attendee;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(Attendee $attendee)</span></span></span><br><span class="line"><span class="hljs-function">    </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;attendee = $attendee;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function">    </span>&#123;</span><br><span class="line">        $invoice = <span class="hljs-keyword">$this</span>-&gt;attendee-&gt;invoice;</span><br><span class="line"></span><br><span class="line">        Cache::lock(<span class="hljs-string">'refund.'</span>.$invoice-&gt;id, <span class="hljs-number">10</span>)</span><br><span class="line">            -&gt;get(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">                <span class="hljs-keyword">if</span> (! $invoice-&gt;wasRefunded()) &#123;</span><br><span class="line">                    $invoice-&gt;refund();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                Mail::to(<span class="hljs-keyword">$this</span>-&gt;attendee)-&gt;send(...);</span><br><span class="line">            &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// wasRefunded </span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">wasRefunded</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    $response = HTTP::timeout(<span class="hljs-number">5</span>)-&gt;get(<span class="hljs-string">'../invoice/'</span>.$id)-&gt;throw()</span><br><span class="line">        -&gt;json();</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">return</span> $response[<span class="hljs-string">'invoice'</span>][<span class="hljs-string">'status'</span>] == <span class="hljs-string">'refunded'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>使用 lock, 這樣當不小心 dispatch 同一個 job 兩次時, 也不用擔心 worker 會執行兩次<br>設定 lock 秒數, 如果沒設定, 假如 worker obtain lock 之後 crash, 那該 job 將永遠不會被執行, 直到 $tries 耗盡, 因為 lock 並沒有釋放<br>$backoff 設定 11 秒, 以避免 lock 10 秒期間 worker 不停的嘗試 obtain lock<br>在真正 refund 之前, 都呼叫 billing provider 以確定該 invoice 是否已經 refunded, 以避免 refund 兩次</p>
</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-88"><a href="#以下的-Laravel-example-code-的意思是？-88" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-comment">// on controller</span></span><br><span class="line"><span class="hljs-keyword">$this</span>-&gt;conference-&gt;attendees-&gt;each(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">($attendee)</span> </span>&#123;</span><br><span class="line">    RefundAttendee::dispatch($attendee);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// on job class</span></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RefundAttendee</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ShouldQueue</span></span></span><br><span class="line"><span class="hljs-class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> $tries = <span class="hljs-number">3</span>;</span><br><span class="line">    <span class="hljs-keyword">public</span> $timeout = <span class="hljs-number">60</span>;</span><br><span class="line">    <span class="hljs-keyword">private</span> $attendee;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(Attendee $attendee)</span></span></span><br><span class="line"><span class="hljs-function">    </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;attendee = $attendee;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function">    </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;attendee-&gt;invoice-&gt;refund();</span><br><span class="line">        Mail::to(<span class="hljs-keyword">$this</span>-&gt;attendee)-&gt;send(...);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// worker</span></span><br><span class="line">php artisan queue:work --queue=cancelations,<span class="hljs-keyword">default</span> </span><br><span class="line">php artisan queue:work --queue=<span class="hljs-keyword">default</span>,cancelations</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>假如一場 conference 忽然要取消, 我取消 refund 這場 conference 中的每一個 attendee, 可將 refund 作業分拆成多個 small job<br>使用兩個 worker, 定義不同的 priority 以避免 starvation 的狀況</p>
</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-89"><a href="#以下的-Laravel-example-code-的意思是？-89" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-string">'connections'</span> =&gt; [</span><br><span class="line">    <span class="hljs-string">'database'</span> =&gt; [</span><br><span class="line">        <span class="hljs-string">'driver'</span> =&gt; <span class="hljs-string">'database'</span>,</span><br><span class="line">        <span class="hljs-string">'retry_after'</span> =&gt; <span class="hljs-number">60</span>,</span><br><span class="line">    ],</span><br><span class="line">    <span class="hljs-string">'database_long_running'</span> =&gt; [</span><br><span class="line">        <span class="hljs-string">'driver'</span> =&gt; <span class="hljs-string">'database'</span>,</span><br><span class="line">        <span class="hljs-string">'retry_after'</span> =&gt; <span class="hljs-number">18060</span>,</span><br><span class="line">    ],</span><br><span class="line">],</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>retry_after 會將 job 的 <strong>reserved</strong> tag 移除, 以避免 worker crash 後該 job 始終保持 <strong>reserved</strong> 狀態而永遠不被執行<br>但一個 connection 只能設定一個 retry_after, 所以如果有 <code>job 運行時間會比較久</code> 的需求時, 很可能需要第二個 connection<br>或是盡可能地避免這種狀況, 將需要運行比較久的 job 分拆成多個 job</p>
</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-90"><a href="#以下的-Laravel-example-code-的意思是？-90" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-comment">// job</span></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CancelConference</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ShouldQueue</span></span></span><br><span class="line"><span class="hljs-class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> $timeout = <span class="hljs-number">18000</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// config/queue.php</span></span><br><span class="line"><span class="hljs-string">'connections'</span> =&gt; [</span><br><span class="line">    <span class="hljs-string">'database'</span> =&gt; [</span><br><span class="line">        <span class="hljs-string">'driver'</span> =&gt; <span class="hljs-string">'database'</span>,</span><br><span class="line">        <span class="hljs-string">'table'</span> =&gt; <span class="hljs-string">'jobs'</span>,</span><br><span class="line">        <span class="hljs-string">'queue'</span> =&gt; <span class="hljs-string">'default'</span>,</span><br><span class="line">        <span class="hljs-string">'retry_after'</span> =&gt; <span class="hljs-number">18060</span>,</span><br><span class="line">    ],</span><br><span class="line">],</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>假如該 job timeout, 給 worker 60 秒的時間完成清理工作, 不管如何, 18060 秒之後, 該 job 都會被移除 <code>reserved</code> tag</p>
</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-91"><a href="#以下的-Laravel-example-code-的意思是？-91" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProvisionServer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ShouldQueue</span></span></span><br><span class="line"><span class="hljs-class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">private</span> $server;</span><br><span class="line">    <span class="hljs-keyword">private</span> $payload;</span><br><span class="line">    </span><br><span class="line">    <span class="hljs-keyword">public</span> $tries = <span class="hljs-number">20</span>;</span><br><span class="line">    <span class="hljs-keyword">public</span> $maxExceptions = <span class="hljs-number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(Server $server, $payload)</span></span></span><br><span class="line"><span class="hljs-function">    </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;server = $server;</span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;payload = $payload;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function">    </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">$this</span>-&gt;server-&gt;forge_server_id) &#123;</span><br><span class="line">            $response = Http::timeout(<span class="hljs-number">5</span>)-&gt;post(</span><br><span class="line">                <span class="hljs-string">'.../servers'</span>, <span class="hljs-keyword">$this</span>-&gt;payload)-&gt;throw()-&gt;json();</span><br><span class="line">            <span class="hljs-keyword">$this</span>-&gt;server-&gt;update([</span><br><span class="line">                <span class="hljs-string">'forge_server_id'</span> =&gt; $response[<span class="hljs-string">'id'</span>]</span><br><span class="line">            ]);</span><br><span class="line"></span><br><span class="line">            <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;release(<span class="hljs-number">120</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">$this</span>-&gt;server-&gt;stillProvisioning(<span class="hljs-keyword">$this</span>-&gt;server)) &#123;</span><br><span class="line">            <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;release(<span class="hljs-number">60</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;server-&gt;update([</span><br><span class="line">            <span class="hljs-string">'is_ready'</span> =&gt; <span class="hljs-keyword">true</span></span><br><span class="line">        ]);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">failed</span><span class="hljs-params">(Exception $e)</span></span></span><br><span class="line"><span class="hljs-function">    </span>&#123;</span><br><span class="line">        Alert::create([</span><br><span class="line">            <span class="hljs-comment">// ...</span></span><br><span class="line">            <span class="hljs-string">'message'</span> =&gt; <span class="hljs-string">"Provisioning failed!"</span></span><br><span class="line">        ]);</span><br><span class="line">        </span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;server-&gt;delete();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>如果沒有 forge_server_id, 代表 Forge server 尚未建立, 所以呼叫 Forge API, 建立 server 並取得 server id, 將 job 丟回 queue, 指定 120 秒後再執行一次<br>如果 server 處於 provisioning 狀態, 丟回 queue, 60 秒後再執行一次<br>建立完成後, 更新 Server model 中的 id_ready 為 true<br>該 job 可被執行最多達 20 次, 但如果是 exception, 最多 3 次<br>如果失敗, 建立 Alert 並刪除此筆 server record</p>
</li>
</ul>
<h6 id="以下位於-config-queue-php-的-Laravel-example-code-的意思是？"><a href="#以下位於-config-queue-php-的-Laravel-example-code-的意思是？" class="headerlink" title="以下位於 config/queue.php 的 Laravel example code 的意思是？"></a><strong>以下位於 config/queue.php 的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-string">'connections'</span> =&gt; [</span><br><span class="line">    <span class="hljs-string">'database'</span> =&gt; [</span><br><span class="line">        <span class="hljs-string">'driver'</span> =&gt; <span class="hljs-string">'database'</span>,</span><br><span class="line">        <span class="hljs-comment">// ...</span></span><br><span class="line">        <span class="hljs-string">'retry_after'</span> =&gt; <span class="hljs-number">90</span>,</span><br><span class="line">    ],</span><br><span class="line">],</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>當一個 worker pick up 一個 job 時, 會在這個 job mark <code>reserved</code>, 這樣其他 worker 就不會嘗試 pick up 這個 job, 但當一個 worker 在執行這個 job 時 crash 了, 會導致這個 job 的 <code>reserved</code> mark 不會被清除, 導致這個 job 永遠不會被執行。 Laravel 為了預防這一點, 定義了一個 job 最長可以處於 <code>reserved</code> state 多久, 就是 retry_after</p>
</li>
</ul>
<h6 id="Laravel-Queue-中-當一個-worker-執行一個-job-時-為何其他-worker-不會執行同一個-job"><a href="#Laravel-Queue-中-當一個-worker-執行一個-job-時-為何其他-worker-不會執行同一個-job" class="headerlink" title="Laravel Queue 中, 當一個 worker 執行一個 job 時, 為何其他 worker 不會執行同一個 job?"></a><strong>Laravel Queue 中, 當一個 worker 執行一個 job 時, 為何其他 worker 不會執行同一個 job?</strong></h6><p>因為當一個 worker pick up 一個 job 時, 會 mark job as <code>reserved</code></p>
<h6 id="Laravel-Queue-中-當使用-job-的-retry-until-120-代表該-job-在-120-秒後就會立即被執行嗎？"><a href="#Laravel-Queue-中-當使用-job-的-retry-until-120-代表該-job-在-120-秒後就會立即被執行嗎？" class="headerlink" title="Laravel Queue 中, 當使用 job 的 retry_until = 120, 代表該 job 在 120 秒後就會立即被執行嗎？"></a><strong>Laravel Queue 中, 當使用 job 的 retry_until = 120, 代表該 job 在 120 秒後就會立即被執行嗎？</strong></h6><p>不是哦, 這只代表該 job 在 release 或 dispatch 後的 120 秒內不會被執行, 如果 worker 都很忙, 10 分鐘後才被執行也是有可能的</p>
<h6 id="以下的-Laravel-example-code-的意思是？-92"><a href="#以下的-Laravel-example-code-的意思是？-92" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-keyword">public</span> $tries = <span class="hljs-number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    $response = Http::timeout(...)-&gt;post(...);</span><br><span class="line">    </span><br><span class="line">    <span class="hljs-keyword">if</span> ($response-&gt;failed()) &#123;</span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;release(</span><br><span class="line">            now()-&gt;addMinutes(<span class="hljs-number">15</span> * <span class="hljs-keyword">$this</span>-&gt;attempts()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">retryUntil</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    <span class="hljs-keyword">return</span> now()-&gt;addDay();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">failed</span><span class="hljs-params">(Exception $e)</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    Mail::to(<span class="hljs-keyword">$this</span>-&gt;integration-&gt;developer_email</span><br><span class="line">    )-&gt;send(...);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>如果 request 失敗的話, 逐次的遞增再次執行該 job 的時間間隔, 最多嘗試一天(會從第一次 dispatch 時開始計算時間), 在一天內可以無限次數嘗試(依照定義的時間間隔頻率), 若超過一天則視為 failed job<br>失敗的話, 採取相對應動作</p>
</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-93"><a href="#以下的-Laravel-example-code-的意思是？-93" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CheckoutController</span></span></span><br><span class="line"><span class="hljs-class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">store</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function">    </span>&#123;</span><br><span class="line">        $order = Order::create([</span><br><span class="line">            <span class="hljs-string">'status'</span> =&gt; Order::PENDING, <span class="hljs-comment">// ...</span></span><br><span class="line">        ]);</span><br><span class="line">        MonitorPendingOrder::dispatch($order)-&gt;delay(<span class="hljs-number">900</span>);</span><br><span class="line">        <span class="hljs-comment">// also ... delay(now()-&gt;addMinutes(15))</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// MonitorPendingOrder class</span></span><br><span class="line">    <span class="hljs-keyword">public</span> $tries = <span class="hljs-number">4</span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function">    </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">$this</span>-&gt;order-&gt;status == Order::CONFIRMED || <span class="hljs-keyword">$this</span>-&gt;order-&gt;status == Order::CANCELED) &#123;</span><br><span class="line">            <span class="hljs-keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">$this</span>-&gt;order-&gt;olderThan(<span class="hljs-number">59</span>, <span class="hljs-string">'minutes'</span>)) &#123;</span><br><span class="line">            <span class="hljs-keyword">$this</span>-&gt;order-&gt;markAsCanceled();</span><br><span class="line"></span><br><span class="line">            <span class="hljs-keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        SMS::send(...);</span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;release(now()-&gt;addMinutes(<span class="hljs-number">15</span>)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>常常使用者建立訂單後, 忽然決定不買了, 但也不會手動取消這張訂單<br>如上 example 邏輯<br>訂單建立後每 15 分鐘提醒使用者有這張訂單存在<br>若過了 59 分鐘後, 訂單並未被 confirmed, 也未 cancelled, 這時 job 就取消這張訂單<br>public $tries 確保這個 job 能被執行 4 次, 這邊 4 次還是有點太少了, 可以在設大一點</p>
</li>
</ul>
<h6 id="以下的-Laravel-example-command-的意思是？-3"><a href="#以下的-Laravel-example-command-的意思是？-3" class="headerlink" title="以下的 Laravel example command 的意思是？"></a><strong>以下的 Laravel example command 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">php artisan queue:work --backoff=60,120</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>定義該 worker 在嘗試 job 的時間間隔, 比如說嘗試執行 job A 失敗了, 第一次要間隔 60 秒之後才可嘗試再次執行, 第二次之後都要間隔至少 120 秒<br>Laravel 8 之前又叫做 <strong>–delay</strong></p>
</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-94"><a href="#以下的-Laravel-example-code-的意思是？-94" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Jobs</span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SendVerificationMessage</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ShouldQueue</span></span></span><br><span class="line"><span class="hljs-class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> $tries = <span class="hljs-number">3</span>;</span><br><span class="line">    <span class="hljs-keyword">public</span> $backoff = [<span class="hljs-number">60</span>, <span class="hljs-number">120</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>$tries 定義該 job 最多會被執行 3 次, release() 也算一次, 如果 3 次過了還在 queue 當中, 那就會被放到 failed_job 當中<br>$backoff 定義每次嘗試執行 job 的時間間隔, 第一次為 60 秒, 之後都間隔 120 秒, Laravel 8.0 之前叫做 <strong>retryAfter</strong></p>
</li>
</ul>
<h6 id="以下的-Laravel-example-code-的意思是？-95"><a href="#以下的-Laravel-example-code-的意思是？-95" class="headerlink" title="以下的 Laravel example code 的意思是？"></a><strong>以下的 Laravel example code 的意思是？</strong></h6><ul>
<li><p><strong>Example</strong>:</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">php artisan queue:work --queue=payments,default </span><br><span class="line">php artisan queue:work --queue=default,payments</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:<br>讓兩個 worker 分別執行兩個 queue, 以避免一個執行完就處於 idle 狀態</p>
</li>
</ul>

    
    </div>
    
    <div class="columns is-variable is-1 is-multiline is-mobile">
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/zh-tw/tags/Laravel/">#Laravel</a></span>
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/zh-tw/tags/Laravel-Documentation/">#Laravel Documentation</a></span>
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/zh-tw/tags/Laravel-Queues/">#Laravel Queues</a></span>
    
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop  article-nav-prev">
            
            <a href="/zh-tw/GKEMigratingToContainers/">GKE Migrating to Containers</a>
            
        </span>
        <span class="column is-12-mobile is-half-desktop  article-nav-next">
            
            <a href="/zh-tw/introductionToDocker/">Docker 實戰入門</a>
            
        </span>
    </div>
    
</article>


<div class="sharebox">
    
<div class="sharethis-inline-share-buttons"></div>
<script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5c72643b9ea706001139fd89&amp;product=inline-share-buttons" async="async"></script>

</div>



<div class="comments">
    <h3 class="title is-4">留言</h3>
    
<script>
    var disqus_config = function () {
        this.page.url = 'https://tn710617.github.io/zh-tw/laravelDiggingDeeperQueues/';
        this.page.identifier = 'zh-tw/laravelDiggingDeeperQueues/';
        
        this.language = 'zh';
        
    };
    (function() {
        var d = document, s = d.createElement('script');  
        s.src = '//' + 'rayscodingjourney' + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>

<div id="disqus_thread">
    
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</div>

    </div>
</section>
    <footer class="footer">
    <div class="container">
        <div class="columns content">
            <div class="column is-narrow has-text-centered">
                &copy; 2021 Ray&nbsp;
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a href="http://github.com/ppoffice/hexo-theme-minos">Minos</a>
            </div>
            <div class="column is-hidden-mobile"></div>

            
                <script src="https://unpkg.com/mermaid@7.1.2/dist/mermaid.min.js"></script>
                <script>
                    if (window.mermaid) {
                        mermaid.initialize({theme: 'default'});
                    }
                </script>
            

            
            
            <a class="navbar-item" title="GitHub" href="https://github.com/tn710617">
                
                    <i class="fab fa-github"></i>
                
            </a>
            
            <a class="navbar-item" title="Medium" href="https://medium.com/@raycodingjourney">
                
                    <i class="fab fa-medium"></i>
                
            </a>
            
            <a class="navbar-item" title="Linkedin" href="https://www.linkedin.com/in/ray-lee-99315315a">
                
                    <i class="fab fa-linkedin"></i>
                
            </a>
            
            <a class="navbar-item" title="Facebook" href="https://www.facebook.com/profile.php?id=100001626039430">
                
                    <i class="fab fa-facebook"></i>
                
            </a>
            
            <a class="navbar-item" title="CakeResume" href="https://www.cakeresume.com/resumes/ray-6edaef/edit">
                
                    <i class="far fa-address-card"></i>
                
            </a>
            
            <a class="navbar-item" title="E-Mail" href="mailto:tn710617@gmail.com">
                
                    <i class="far fa-envelope"></i>
                
            </a>
            
            <a class="navbar-item" title="Skype" href="skype:adad0310?call|chat">
                
                    <i class="fab fa-skype"></i>
                
            </a>
            
            

        </div>
    </div>
</footer>

    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script>

<!-- test if the browser is outdated -->
<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/">Update my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.js"></script>
<script>
    $(document).ready(function () {
        // plugin function, place inside DOM ready function
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        })
    });
</script>

<script>
    window.FontAwesomeConfig = {
        searchPseudoElements: true
    }
    moment.locale("zh-CN");
</script>


    
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<script>
    MathJax.Hub.Config({
        "HTML-CSS": {matchFontHeight: false},
        SVG: {matchFontHeight: false},
        CommonHTML: {matchFontHeight: false}
    });
</script>

    
    
    
    
<script src="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/js/lightgallery-all.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/justifiedGallery/3.6.5/js/jquery.justifiedGallery.min.js"></script>
<script>
    (function ($) {
        $(document).ready(function () {
            if (typeof($.fn.lightGallery) === 'function') {
                $('.article.gallery').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof($.fn.justifiedGallery) === 'function') {
                $('.justified-gallery').justifiedGallery();
            }
        });
    })(jQuery);
</script>

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <style>
        .hljs {
            position: relative;
        }

        .hljs .clipboard-btn {
            float: right;
            color: #9a9a9a;
            background: none;
            border: none;
            cursor: pointer;
        }

        .hljs .clipboard-btn:hover {
          color: #8a8a8a;
        }

        .hljs > .clipboard-btn {
            display: none;
            position: absolute;
            right: 4px;
            top: 4px;
        }

        .hljs:hover > .clipboard-btn {
            display: inline;
        }

        .hljs > figcaption > .clipboard-btn {
            margin-right: 4px;
        }
    </style>
    <script>
      $(document).ready(function () {
        $('figure.hljs').each(function(i, figure) {
          var codeId = 'code-' + i;
          var code = figure.querySelector('.code');
          var copyButton = $('<button>Copy <i class="far fa-clipboard"></i></button>');
          code.id = codeId;
          copyButton.addClass('clipboard-btn');
          copyButton.attr('data-clipboard-target-id', codeId);

          var figcaption = figure.querySelector('figcaption');

          if (figcaption) {
            figcaption.append(copyButton[0]);
          } else {
            figure.prepend(copyButton[0]);
          }
        })

        var clipboard = new ClipboardJS('.clipboard-btn', {
          target: function(trigger) {
            return document.getElementById(trigger.getAttribute('data-clipboard-target-id'));
          }
        });
        clipboard.on('success', function(e) {
          e.clearSelection();
        })
      })
    </script>

    
    

    


<script src="/js/script.js"></script>

    
    <div class="searchbox ins-search">
    <div class="searchbox-mask"></div>
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="站內搜尋">
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: '文章',
                PAGES: '頁面',
                CATEGORIES: '分類',
                TAGS: '標籤',
                UNTITLED: '(無標題)',
            },
            CONTENT_URL: '/content.zh-tw.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script src="/js/insight.js"></script>
    
</body>
</html>