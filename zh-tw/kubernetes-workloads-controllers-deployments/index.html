<!DOCTYPE html>
<html class="has-navbar-fixed-top">
<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
<title>Kubernetes - Deployments - Ray&#39;s Coding Journey</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="description" content="概述Deployment 提供宣告式的方法來更新 Pods 以及 ReplicaSets透過 Deployment 描述希望的狀態, 然後 Deployment Controller 會將目前的狀態改變成希望的狀態, 你可以定義 Deployments 來建立一個新的 ReplicaSets, 或是移除已存在的 Deployments, 然後重新建一個。">
<meta name="keywords" content="Kubernetes,Kubernetes Deployments">
<meta property="og:type" content="article">
<meta property="og:title" content="Kubernetes - Deployments">
<meta property="og:url" content="https://tn710617.github.io/zh-tw/kubernetes-workloads-controllers-deployments/index.html">
<meta property="og:site_name" content="Ray&#39;s Coding Journey">
<meta property="og:description" content="概述Deployment 提供宣告式的方法來更新 Pods 以及 ReplicaSets透過 Deployment 描述希望的狀態, 然後 Deployment Controller 會將目前的狀態改變成希望的狀態, 你可以定義 Deployments 來建立一個新的 ReplicaSets, 或是移除已存在的 Deployments, 然後重新建一個。">
<meta property="og:locale" content="zh-tw">
<meta property="og:updated_time" content="2020-02-14T14:58:56.437Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Kubernetes - Deployments">
<meta name="twitter:description" content="概述Deployment 提供宣告式的方法來更新 Pods 以及 ReplicaSets透過 Deployment 描述希望的狀態, 然後 Deployment Controller 會將目前的狀態改變成希望的狀態, 你可以定義 Deployments 來建立一個新的 ReplicaSets, 或是移除已存在的 Deployments, 然後重新建一個。">


<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.css">


    <link href="/kubernetes-workloads-controllers-deployments/" rel="alternate" hreflang="en">








    <meta name="description" content="概述Deployment 提供宣告式的方法來更新 Pods 以及 ReplicaSets透過 Deployment 描述希望的狀態, 然後 Deployment Controller 會將目前的狀態改變成希望的狀態, 你可以定義 Deployments 來建立一個新的 ReplicaSets, 或是移除已存在的 Deployments, 然後重新建一個。">
<meta name="keywords" content="Kubernetes,Kubernetes Deployments">
<meta property="og:type" content="article">
<meta property="og:title" content="Kubernetes - Deployments">
<meta property="og:url" content="https://tn710617.github.io/zh-tw/kubernetes-workloads-controllers-deployments/index.html">
<meta property="og:site_name" content="Ray&#39;s Coding Journey">
<meta property="og:description" content="概述Deployment 提供宣告式的方法來更新 Pods 以及 ReplicaSets透過 Deployment 描述希望的狀態, 然後 Deployment Controller 會將目前的狀態改變成希望的狀態, 你可以定義 Deployments 來建立一個新的 ReplicaSets, 或是移除已存在的 Deployments, 然後重新建一個。">
<meta property="og:locale" content="zh-tw">
<meta property="og:updated_time" content="2020-02-14T14:58:56.437Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Kubernetes - Deployments">
<meta name="twitter:description" content="概述Deployment 提供宣告式的方法來更新 Pods 以及 ReplicaSets透過 Deployment 描述希望的狀態, 然後 Deployment Controller 會將目前的狀態改變成希望的狀態, 你可以定義 Deployments 來建立一個新的 ReplicaSets, 或是移除已存在的 Deployments, 然後重新建一個。">





    <link rel="icon" href="/images/favicon.png">


<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bulma/0.6.2/css/bulma.min.css">


    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/justifiedGallery/3.6.5/css/justifiedGallery.min.css">


<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/sunburst.min.css">

<link rel="stylesheet" href="/css/style.css">

<script defer src="//use.fontawesome.com/releases/v5.0.8/js/all.js"></script>


    
        
    
        
    
        
    
        
    
        
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-135063928-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-135063928-1');
</script>


    


</head>
<body>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="/zh-tw">
                
                    
                    不學會死
                    
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item " href="/zh-tw/archives">歸檔</a>
            
            <a class="navbar-item " href="/zh-tw/categories">分類</a>
            
            <a class="navbar-item " href="/zh-tw/tags">標籤</a>
            
            <a class="navbar-item " href="/zh-tw/schedule">行程</a>
            
            <a class="navbar-item " href="/zh-tw/about">關於</a>
            
            <a class="navbar-item " href="/zh-tw/japanese">日語</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            <a class="navbar-item search" title="搜尋" href="javascript:;">
                <i class="fas fa-search"></i>
            </a>
            
            
            <div class="navbar-item is-hoverable has-dropdown is-hidden-mobile is-hidden-tablet-only toc">
                <a class="navbar-item" title="目錄">
                    <i class="fa fa-list"></i>
                </a>
                <div class="navbar-dropdown is-right">
                    
                    
                    
                    
                    <a class="navbar-item" href="#概述">1&nbsp;&nbsp;<b>概述</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#建立一個-Deployment">2&nbsp;&nbsp;<b>建立一個 Deployment</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#Pod-template-hash-label">2.1&nbsp;&nbsp;Pod-template-hash label</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#Updating-a-Deployment">3&nbsp;&nbsp;<b>Updating a Deployment</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#Rollover-aka-multiple-updates-in-flight">3.1&nbsp;&nbsp;Rollover (aka multiple updates in-flight)</a>
                    
                    
                    
                    <a class="navbar-item" href="#Label-selector-更新">3.2&nbsp;&nbsp;Label selector 更新</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#回滾-Deployment">4&nbsp;&nbsp;<b>回滾 Deployment</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#確認-Deployment-的-Rollout-歷史">4.1&nbsp;&nbsp;確認 Deployment 的 Rollout 歷史</a>
                    
                    
                    
                    <a class="navbar-item" href="#版本回滾">4.2&nbsp;&nbsp;版本回滾</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#擴縮-Deployment">5&nbsp;&nbsp;<b>擴縮 Deployment</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#比例擴縮">5.1&nbsp;&nbsp;比例擴縮</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#暫停以及恢復一個-Deployment">6&nbsp;&nbsp;<b>暫停以及恢復一個 Deployment</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#Deployment-狀態">7&nbsp;&nbsp;<b>Deployment 狀態</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#進行中的-Deployment">7.1&nbsp;&nbsp;進行中的 Deployment</a>
                    
                    
                    
                    <a class="navbar-item" href="#完成-Deployment">7.2&nbsp;&nbsp;完成 Deployment</a>
                    
                    
                    
                    <a class="navbar-item" href="#失敗的-Deployment">7.3&nbsp;&nbsp;失敗的 Deployment</a>
                    
                    
                    
                    <a class="navbar-item" href="#在失敗的-Deployment-上的操作">7.4&nbsp;&nbsp;在失敗的 Deployment 上的操作</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#Clean-up-Policy">8&nbsp;&nbsp;<b>Clean up Policy</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#Canary-Deployment">9&nbsp;&nbsp;<b>Canary Deployment</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#撰寫-Deployment-Spec">10&nbsp;&nbsp;<b>撰寫 Deployment Spec</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#Pod-Template">10.1&nbsp;&nbsp;Pod Template</a>
                    
                    
                    
                    <a class="navbar-item" href="#Replicas">10.2&nbsp;&nbsp;Replicas</a>
                    
                    
                    
                    <a class="navbar-item" href="#Selector">10.3&nbsp;&nbsp;Selector</a>
                    
                    
                    
                    <a class="navbar-item" href="#Strategy">10.4&nbsp;&nbsp;Strategy</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#Q-amp-A">11&nbsp;&nbsp;<b>Q&amp;amp;amp;A</b></a>
                    
                </div>
            </div>
            

            
<div class="column is-narrow has-text-centered">
    <div class="dropdown is-up is-right is-hoverable" style="margin-top: -0.2em;">
        <div class="dropdown-trigger">
            <button class="button is-small" aria-haspopup="true" aria-controls="dropdown-menu7">
                <span class="icon">
                    <i class="fas fa-globe"></i>
                </span>
                <span>繁體中文</span>
                <span class="icon is-small">
            <i class="fas fa-angle-down" aria-hidden="true"></i>
          </span>
            </button>
        </div>
        <div class="dropdown-menu has-text-left" role="menu" style="top:100%">
            <div class="dropdown-content">
            
                <a href="/kubernetes-workloads-controllers-deployments/" class="dropdown-item">
                    English
                </a>
            
                <a href="/zh-tw/kubernetes-workloads-controllers-deployments/" class="dropdown-item">
                    繁體中文
                </a>
            
            </div>
        </div>
    </div>
</div>

        </div>
    </div>
</nav>

    <section class="section">
    <div class="container">
    <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            Kubernetes - Deployments
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            <time datetime="2020-02-07T12:34:33.000Z" itemprop="datePublished">2月 7 2020</time>
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="/zh-tw/categories/Ops/">Ops</a>
        </span>
        
        
        <span class="column is-narrow">
            
            
            1 小时 讀完 (大概 8219 字)
        </span>
        
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>Deployment 提供宣告式的方法來更新 Pods 以及 ReplicaSets<br>透過 Deployment 描述希望的狀態, 然後 Deployment Controller 會將目前的狀態改變成希望的狀態, 你可以定義 Deployments 來建立一個新的 ReplicaSets, 或是移除已存在的 Deployments, 然後重新建一個。</p>
<a id="more"></a>
<p><br><br><br></p>
<h2 id="建立一個-Deployment"><a href="#建立一個-Deployment" class="headerlink" title="建立一個 Deployment"></a>建立一個 Deployment</h2><p>以下是 Deployment 的範例, 它建立了一個 ReplicaSet 來啟動三個 <code>nginx</code> Pods:<br><figure class="highlight yaml hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span></span><br><span class="line"><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span></span><br><span class="line"><span class="hljs-attr">metadata:</span></span><br><span class="line"><span class="hljs-attr">  name:</span> <span class="hljs-string">nginx-deployment</span></span><br><span class="line"><span class="hljs-attr">  labels:</span></span><br><span class="line"><span class="hljs-attr">    app:</span> <span class="hljs-string">nginx</span></span><br><span class="line"><span class="hljs-attr">spec:</span></span><br><span class="line"><span class="hljs-attr">  replicas:</span> <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-attr">  selector:</span></span><br><span class="line"><span class="hljs-attr">    matchLabels:</span></span><br><span class="line"><span class="hljs-attr">      app:</span> <span class="hljs-string">nginx</span></span><br><span class="line"><span class="hljs-attr">  template:</span></span><br><span class="line"><span class="hljs-attr">    metadata:</span></span><br><span class="line"><span class="hljs-attr">      labels:</span></span><br><span class="line"><span class="hljs-attr">        app:</span> <span class="hljs-string">nginx</span></span><br><span class="line"><span class="hljs-attr">    spec:</span></span><br><span class="line"><span class="hljs-attr">      containers:</span></span><br><span class="line"><span class="hljs-attr">      - name:</span> <span class="hljs-string">nginx</span></span><br><span class="line"><span class="hljs-attr">        image:</span> <span class="hljs-attr">nginx:1.7.9</span></span><br><span class="line"><span class="hljs-attr">        ports:</span></span><br><span class="line"><span class="hljs-attr">        - containerPort:</span> <span class="hljs-number">80</span></span><br></pre></td></tr></table></figure></p>
<p>這邊針對上面的範例做解說:</p>
<ul>
<li>一個叫做 <code>nginx-deployment</code> 的 Deployment 被建立了, 可從 <code>.metadata.name</code> 這裡看到</li>
<li>這個 Deployment 建立了三個 replicated Pods, 可從 <code>replicas</code> 欄位得知</li>
<li><code>selector</code> field 用於定義 Deployment 管理的 Pods 對象, 本範例中的對象為 template 中定義的 <code>app: nginx</code></li>
<li><code>template</code> 欄位中又含有以下子欄位：<ul>
<li>經由 <code>labels</code> 欄位, 我們給 Pods 貼上標籤 <code>app: nginx</code></li>
<li>從 <code>.template.spec</code> 欄位, 可以看到 Pods 運行一個容器, <code>nignx</code>, 使用 <code>nginx</code> <a href="https://hub.docker.com/" target="_blank" rel="noopener">Docker Hub</a> 鏡像, 版本 1.7.9</li>
<li>建立一個容器, 並透過 <code>name</code> 欄位來命名為 <code>nginx</code></li>
</ul>
</li>
</ul>
<p>現在讓我們來建立一個 Deployment 吧：</p>
<ul>
<li><p>使用以下指令建立一個 Deployment, 你可以給指定最後加上 <code>--record</code>, 它會將執行的指令寫入資源的 annotation 欄位中 <code>kubernetes.io/change-cause</code>, 這對之後的追蹤十分有用, 比如說, 可用來檢視每個 Deployment 版本執行的指令</p>
<figure class="highlight yaml hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-string">kubectl</span> <span class="hljs-string">apply</span> <span class="hljs-bullet">-f</span> <span class="hljs-attr">https://k8s.io/examples/controllers/nginx-deployment.yaml</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>執行 <code>kubectl get deployments</code> 來確認 Deployment 是不是已經建立了。 如果還在建立中, 輸出應如下：</p>
<ul>
<li><p>輸出</p>
<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">NAME               READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">nginx-deployment   0/3     0            0           1s</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果是在叢集中檢視 Deployments, 會顯示以下欄位</p>
<ul>
<li><code>NAME</code> 列出在這個叢集中 Deployments 的名稱</li>
<li><code>DESIRED</code> 列出宣告的 <em>replicas</em> 的數量, 建立 Deployment 時定義的</li>
<li><code>CURRENT</code> 顯示目前共有幾個 replicas 在運行</li>
<li><code>UP-TO-DATE</code> 顯示已被更新來達成期望狀態的 replicas 數量</li>
<li><code>AVAILABLE</code> 顯示可用的 replicas 數量</li>
<li><code>AGE</code> 顯示 replica 已運行的時間</li>
</ul>
</li>
<li>replicas 數量的宣告值是根據 <code>.spec.replicas</code> 欄位</li>
</ul>
</li>
<li><p>執行以下指令來檢視 Deployment rollout status</p>
<ul>
<li><p>指令</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectl rollout status deployment.v1.apps/nginx-deployment</span><br></pre></td></tr></table></figure>
</li>
<li><p>預計輸出</p>
<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">Waiting for rollout to finish: 2 out of 3 new replicas have been updated...</span><br><span class="line">deployment.apps/nginx-deployment successfully rolled out</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<ul>
<li><p>幾秒後, 在執行以下指令一次</p>
<ul>
<li><p>指令</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectl get deployments</span><br></pre></td></tr></table></figure>
</li>
<li><p>預計輸出</p>
<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">NAME               READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">nginx-deployment   3/3     3            3           18s</span><br></pre></td></tr></table></figure>
<p>可以看到 Deployment 已經建立了三個 replicas, 且所有的 replicas 都是最新狀態以及可用</p>
</li>
</ul>
</li>
<li><p>檢視被 Deployment 建立的 ReplicaSet (<code>rs</code>)</p>
<ul>
<li><p>執行以下指令</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectl get rs</span><br></pre></td></tr></table></figure>
</li>
<li><p>預計輸出</p>
<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">NAME                          DESIRED   CURRENT   READY   AGE</span><br><span class="line">nginx-deployment-75675f5897   3         3         3       18s</span><br></pre></td></tr></table></figure>
<p>ReplicaSet 的格式為 <code>[DEPLOYMENT-NAME]-[RANDOM-STRING]</code>, <em>random string</em> 為隨機產生, 且使用 pod-template-hash 為來源之一</p>
</li>
</ul>
</li>
<li><p>檢視每個 Pod 自動產生的 labels</p>
<ul>
<li><p>執行指令</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectl get pods --show-labels</span><br></pre></td></tr></table></figure>
</li>
<li><p>預計輸出</p>
<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">NAME                                READY     STATUS    RESTARTS   AGE       LABELS</span><br><span class="line">nginx-deployment-75675f5897-7ci7o   1/1       Running   0          18s       app=nginx,pod-template-hash=3123191453</span><br><span class="line">nginx-deployment-75675f5897-kzszj   1/1       Running   0          18s       app=nginx,pod-template-hash=3123191453</span><br><span class="line">nginx-deployment-75675f5897-qqcnn   1/1       Running   0          18s       app=nginx,pod-template-hash=3123191453</span><br></pre></td></tr></table></figure>
<p>已建立完成的 ReplicaSet 會確保有三個 <code>nginx</code> Pods</p>
</li>
</ul>
</li>
</ul>
<p>這邊要注意的是, 務必要正確的在 Deployment 中指定適當的 selector 以及 Pod template labels (在本範例中, <code>app:nginx</code>), 不要讓 labels 或 selectors 跟其他的 controllers 有重疊 (包含其他的 Deployments 以及 StatefulSets), Kubernetes 不會阻止這件事, 且如果上述情形發生的話, 可能會產生衝突以及一些預期外的行為</p>
<p><br></p>
<h3 id="Pod-template-hash-label"><a href="#Pod-template-hash-label" class="headerlink" title="Pod-template-hash label"></a>Pod-template-hash label</h3><p><strong>注意</strong>: 不可改變這個 label<br><code>pod-template-hash</code> label 由 Deployment controller 加到每一個它所建立的 ReplicaSet 當中。</p>
<p><br><br><br></p>
<h2 id="Updating-a-Deployment"><a href="#Updating-a-Deployment" class="headerlink" title="Updating a Deployment"></a>Updating a Deployment</h2><p><strong>注意</strong>: Deployment 的 rollout 唯有當 Deployment 的 Pod template (也就是 <code>.spec.template</code>) 變更了, 舉例來說, 像是 template 當中的 labels 或是容器鏡像更新了。<br>其他的更新, 例如 Deployment 的擴縮, 不會觸發 rollout</p>
<p>遵循以下步驟來更新你的 Deployment:</p>
<ul>
<li><p>將 nginx Pods 從鏡像版本 <code>nginx:1.7.9</code> 更新成 <code>nginx:1.9.1</code></p>
<ul>
<li><p>執行以下指令</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectl --record deployment.apps/nginx-deployment <span class="hljs-built_in">set</span> image deployment.v1.apps/nginx-deployment nginx=nginx:1.9.1</span><br></pre></td></tr></table></figure>
</li>
<li><p>或是簡化版本的</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectl <span class="hljs-built_in">set</span> image deployment/nginx-deployment nginx=nginx:1.9.1 --record</span><br></pre></td></tr></table></figure>
</li>
<li><p>輸出應如下：</p>
<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">deployment.apps/nginx-deployment image updated</span><br></pre></td></tr></table></figure>
</li>
<li><p>又或者, 你也可以使用 <code>edit</code> 指令, 到編輯器中將 <code>.spac.template.spec.container[0].image</code> 的版本從 <code>nginx.1.7.9</code> 變更為 <code>nginx:1.9.1</code></p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectl edit deployment.v1.apps/nginx-deployment</span><br></pre></td></tr></table></figure>
</li>
<li><p>輸出應如下：</p>
<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">deployment.apps/nginx-deployment edited</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>檢視 rollout status    </p>
<ul>
<li><p>執行指令</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectl rollout status deployment.v1.apps/nginx-deployment</span><br></pre></td></tr></table></figure>
</li>
<li><p>或是簡化版</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectll rollout status deployment nginx-deployment</span><br></pre></td></tr></table></figure>
</li>
<li><p>輸出應如下:</p>
<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">Waiting for rollout to finish: 2 out of 3 new replicas have been updated...</span><br></pre></td></tr></table></figure>
<p>或</p>
<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">deployment.apps/nginx-deployment successfully rolled out</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<p>從更新後的 Deployment 取得更多細節：</p>
<ul>
<li><p>檢視 rollout 成功的 Deployment</p>
<ul>
<li><p>執行</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectl get deployments</span><br></pre></td></tr></table></figure>
</li>
<li><p>輸出</p>
<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">NAME               READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">nginx-deployment   3/3     3            3           36s</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>檢視 ReplicaSets</p>
<ul>
<li><p>執行</p>
<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">kubectl get rs</span><br></pre></td></tr></table></figure>
</li>
<li><p>輸出</p>
<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">NAME                          DESIRED   CURRENT   READY   AGE</span><br><span class="line">nginx-deployment-1564180365   3         3         3       6s</span><br><span class="line">nginx-deployment-2035384211   0         0         0       36s</span><br></pre></td></tr></table></figure>
<p>下一次你想要更新這些 Pod 的話, 你只需要再次更新 Deployment 的 Pod template 就行了<br>Deployment 確保更新過程中只會有一定數量的 Pods 是不可用的。<br>預設, 最少要有 75% 的 Pod 要處於運行中, 最多 25% 的 Pod 可容許不可用<br>Deployment 同時確保在升級過程中同時只有一定數量的 Pod 會被建立, 預設最多 Pod 的 125% 期望數量可被運行 (最多 25% 增加)<br>舉例來說, 如果你仔細的檢視 rollout 的過程, 你會發現, 首先 Deployment 會先建立一個新的 Pod, 然後殺掉某個舊的 Pod, 然後建立一個新的。 它不會等到新的 Pod 都已經足夠了才殺掉舊的 Pod, 也不會等到舊的 Pod 已經被砍到一個足夠的數量才去建立新的 Pod, 它確保至少有兩個 Pods 可用, 而最多四個 Pods 可用</p>
</li>
</ul>
</li>
<li><p>檢視 Deployment 的細節資訊:</p>
<ul>
<li><p>執行</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectl describe deployments</span><br></pre></td></tr></table></figure>
</li>
<li><p>輸出</p>
<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">Name:                   nginx-deployment</span><br><span class="line">Namespace:              default</span><br><span class="line">CreationTimestamp:      Thu, 30 Nov 2017 10:56:25 +0000</span><br><span class="line">Labels:                 app=nginx</span><br><span class="line">Annotations:            deployment.kubernetes.io/revision=2</span><br><span class="line">Selector:               app=nginx</span><br><span class="line">Replicas:               3 desired | 3 updated | 3 total | 3 available | 0 unavailable</span><br><span class="line">StrategyType:           RollingUpdate</span><br><span class="line">MinReadySeconds:        0</span><br><span class="line">RollingUpdateStrategy:  25% max unavailable, 25% max surge</span><br><span class="line">Pod Template:</span><br><span class="line">Labels:  app=nginx</span><br><span class="line"> Containers:</span><br><span class="line">  nginx:</span><br><span class="line">    Image:        nginx:1.9.1</span><br><span class="line">    Port:         80/TCP</span><br><span class="line">    Environment:  &lt;none&gt;</span><br><span class="line">    Mounts:       &lt;none&gt;</span><br><span class="line">  Volumes:        &lt;none&gt;</span><br><span class="line">Conditions:</span><br><span class="line">  Type           Status  Reason</span><br><span class="line">  ----           ------  ------</span><br><span class="line">  Available      True    MinimumReplicasAvailable</span><br><span class="line">  Progressing    True    NewReplicaSetAvailable</span><br><span class="line">OldReplicaSets:  &lt;none&gt;</span><br><span class="line">NewReplicaSet:   nginx-deployment-1564180365 (3/3 replicas created)</span><br><span class="line">Events:</span><br><span class="line">  Type    Reason             Age   From                   Message</span><br><span class="line">  ----    ------             ----  ----                   -------</span><br><span class="line">  Normal  ScalingReplicaSet  2m    deployment-controller  Scaled up replica set nginx-deployment-2035384211 to 3</span><br><span class="line">  Normal  ScalingReplicaSet  24s   deployment-controller  Scaled up replica set nginx-deployment-1564180365 to 1</span><br><span class="line">  Normal  ScalingReplicaSet  22s   deployment-controller  Scaled down replica set nginx-deployment-2035384211 to 2</span><br><span class="line">  Normal  ScalingReplicaSet  22s   deployment-controller  Scaled up replica set nginx-deployment-1564180365 to 2</span><br><span class="line">  Normal  ScalingReplicaSet  19s   deployment-controller  Scaled down replica set nginx-deployment-2035384211 to 1</span><br><span class="line">  Normal  ScalingReplicaSet  19s   deployment-controller  Scaled up replica set nginx-deployment-1564180365 to 3</span><br><span class="line">  Normal  ScalingReplicaSet  14s   deployment-controller  Scaled down replica set nginx-deployment-2035384211 to 0</span><br></pre></td></tr></table></figure>
<p>這邊可以看到, 一開始當你建立了 Deployment, 它建立了一個 ReplicaSet (nginx-deployment-2035384211), 然後直接擴增到 3 個 replicas, 而當你更新 Deployment, 它建立了一個新的 ReplicaSet (nginx-deployment-1564180365) 並且擴增到 1 個然後將舊的 ReplicaSet 縮為 2, 所以最少有 2 個 Pods 是可用的, 最多可以有 4 個 Pods 是啟動的。 之後, 遵循著相同的滾動升級策略, 它持續的擴縮, 最後, 你會有三個新的 replicas, 然後 0 個舊的 Replicas</p>
</li>
</ul>
</li>
</ul>
<p><br></p>
<h3 id="Rollover-aka-multiple-updates-in-flight"><a href="#Rollover-aka-multiple-updates-in-flight" class="headerlink" title="Rollover (aka multiple updates in-flight)"></a>Rollover (aka multiple updates in-flight)</h3><p>每次 Deployment controller 觀察到有新的 Deployment 時, 一個新的 ReplicaSet 會被建立來提供期望數量的 Pods。 如果說 Deployment 被更新了, 那 label 有符合 <code>.spec.selector</code> 但 template 不符合 <code>.spec.replicas</code> 的已存在 ReplicaSet 會開始縮減數量。 最後, 新的 ReplicaSet 會擴增到符合 <code>.spec.replicas</code> 的數量, 然後所有舊的 ReplicaSets 都縮減為 0<br>如果你在滾動升級途中更新一個 Deployment, Deployment 會建立一個新的 ReplicaSet 並開始擴容, 同時縮減原本擴容到一半的 ReplicaSet, 它會被加到舊的 ReplicaSets 清單, 並且開始縮減<br>舉例來說, 假如你建立了一個 Deployment 來建立 5 個 <code>nginx:1.7.9</code> replicas, 但是當只有 3 個 replicas 的 <code>nginx:1.7.9</code> 被建立完成時, 你將這個 Deployment 更新成 5 個 <code>nginx:1.9.1</code> 的 replicas。 在這個範例中, Deployment 會立即的開始砍掉這三個 <code>nginx:1.7.9</code> 的 Pods, 並開始建立 <code>nginx:1.9.1</code> 的 Pods。 他不會等到 5 個 <code>nginx:1.7.9</code> 的 replicas 都建好之後, 再改變狀態</p>
<p><br></p>
<h3 id="Label-selector-更新"><a href="#Label-selector-更新" class="headerlink" title="Label selector 更新"></a>Label selector 更新</h3><p>通常不建議修改 label selector, 且 selector 建議在一開始就規劃好。 不管怎樣, 如果你需要更新 label selector, 那請一定要很小心, 並且確保你已經掌握任何它可能會造成的影響。<br><strong>注意</strong>: 在 API 版本 <code>apps/v1</code>, Deployment 的 label selector 在建立之後就無法變更了。</p>
<ul>
<li>Selector 的增加需要也更新 Deployment spec 中的 Pod template labels, 否則會回傳 validation error。 這個變更是不可覆蓋的, 這表示說, 新的 selector 不會去選擇舊的 selector 建立的 ReplicasSet 以及 Pods, 所以結果會是, 建立了新的 ReplicaSet, 然後所有舊的 ReplicaSets 都成了孤兒。</li>
<li>Selector 的更新改變了 selector key 的現存 value - 造成的結果跟增加 selector 相同</li>
<li>Selector 的刪除會從 Deployment selector 中移除已經存在的 key - 這不需要 Pod template labels 有任何改變。 已經存在的 ReplicaSets 也不會變成孤兒, 也不會有新的 ReplicaSets 會被建立。 但被移除的 label 還是存在於現存的 Pods 以及 ReplicaSets 之中。</li>
</ul>
<p><br><br><br></p>
<h2 id="回滾-Deployment"><a href="#回滾-Deployment" class="headerlink" title="回滾 Deployment"></a>回滾 Deployment</h2><p>有時, 你可能會想要回滾 Deployment; 例如說, 當一個 Deployment 並不穩定, 一直的 crash looping。 預設, 所有的 Deployment rollout 歷史都會被記錄下來, 所以任何時候你都可以回滾 (你可以修改版本歷史限制來改變這一個特性)<br><strong>Note</strong>: 當 Deployment 的 rollout 被觸發時, 會建立一個 Deployment revision。 這表示唯有當 Deployment 的 Pod template (<code>.spec.template</code>) 改變了, 例如你更新了 template 的 labels 或 container images, 這樣 revision 才會被建立。 其他更新, 像是擴容 Deployment 並不會建立 Deployment revision, 所以你可以無礙的手動或自動的擴縮 Deployment。 這表示說, 當你回滾到一個早些的版本, 只有 Deployment 的 Pod template 部分會被回滾。</p>
<ul>
<li><p>假如你在更新 Deployment 時打錯字, 把 <code>nginx:1.9.1</code> 打成 <code>nginx:1.91</code>:</p>
<ul>
<li><p>執行指令</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectl <span class="hljs-built_in">set</span> image deployment.v1.apps/nginx-deployment nginx=nginx:1.91 --record=<span class="hljs-literal">true</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>輸出</p>
<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">deployment.apps/nginx-deployment image updated</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<ul>
<li><p>這時 rollout 卡住了, 確認一下：</p>
<ul>
<li><p>執行</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectl rollout status deployment.v1.apps/nginx-deployment</span><br></pre></td></tr></table></figure>
</li>
<li><p>輸出</p>
<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">Waiting for rollout to finish: 1 out of 3 new replicas have been updated...</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<ul>
<li><p>按下 Ctrl-C 來停止 rollout status 輸出, 可以參考<a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#deployment-status" target="_blank" rel="noopener">這裏</a>, 有更多 rollout 卡住的資訊</p>
</li>
<li><p>可以看到舊的 replicas <code>nginx-deployment-1564180365</code> 跟 <code>nginx-deployment-2035384211</code> 的數量是 2, 然後新的 replicas (nginx-deployment-3066724191) 是 1</p>
<ul>
<li><p>執行</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectl get rs</span><br></pre></td></tr></table></figure>
</li>
<li><p>輸出</p>
<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">NAME                          DESIRED   CURRENT   READY   AGE</span><br><span class="line">nginx-deployment-1564180365   3         3         3       25s</span><br><span class="line">nginx-deployment-2035384211   0         0         0       36s</span><br><span class="line">nginx-deployment-3066724191   1         1         0       6s</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<ul>
<li><p>從建立的 Pods 可以看到這個由新的 ReplicaSet 建立的 Pod 卡在 image pull loop</p>
<ul>
<li><p>執行</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectl get pods</span><br></pre></td></tr></table></figure>
</li>
<li><p>輸出</p>
<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">NAME                                READY     STATUS             RESTARTS   AGE</span><br><span class="line">nginx-deployment-1564180365-70iae   1/1       Running            0          25s</span><br><span class="line">nginx-deployment-1564180365-jbqqo   1/1       Running            0          25s</span><br><span class="line">nginx-deployment-1564180365-hysrc   1/1       Running            0          25s</span><br><span class="line">nginx-deployment-3066724191-08mng   0/1       ImagePullBackOff   0          6s</span><br></pre></td></tr></table></figure>
<p><strong>注意</strong>: Deployment controller 自動停止了錯誤的 rollout, 並且停止擴容新的 ReplicaSet。 這取決於你定義的 rollingUpdate 的參數 (更準確的說, <code>maxUnavailable</code>), Kubernetes 的預設值為 25%</p>
</li>
</ul>
</li>
<li><p>取得 Deployment 描述</p>
<ul>
<li><p>執行</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectl describe deployment</span><br></pre></td></tr></table></figure>
</li>
<li><p>輸出</p>
<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">Name:           nginx-deployment</span><br><span class="line">Namespace:      default</span><br><span class="line">CreationTimestamp:  Tue, 15 Mar 2016 14:48:04 -0700</span><br><span class="line">Labels:         app=nginx</span><br><span class="line">Selector:       app=nginx</span><br><span class="line">Replicas:       3 desired | 1 updated | 4 total | 3 available | 1 unavailable</span><br><span class="line">StrategyType:       RollingUpdate</span><br><span class="line">MinReadySeconds:    0</span><br><span class="line">RollingUpdateStrategy:  25% max unavailable, 25% max surge</span><br><span class="line">Pod Template:</span><br><span class="line">  Labels:  app=nginx</span><br><span class="line">  Containers:</span><br><span class="line">   nginx:</span><br><span class="line">    Image:        nginx:1.91</span><br><span class="line">    Port:         80/TCP</span><br><span class="line">    Host Port:    0/TCP</span><br><span class="line">    Environment:  &lt;none&gt;</span><br><span class="line">    Mounts:       &lt;none&gt;</span><br><span class="line">  Volumes:        &lt;none&gt;</span><br><span class="line">Conditions:</span><br><span class="line">  Type           Status  Reason</span><br><span class="line">  ----           ------  ------</span><br><span class="line">  Available      True    MinimumReplicasAvailable</span><br><span class="line">  Progressing    True    ReplicaSetUpdated</span><br><span class="line">OldReplicaSets:     nginx-deployment-1564180365 (3/3 replicas created)</span><br><span class="line">NewReplicaSet:      nginx-deployment-3066724191 (1/1 replicas created)</span><br><span class="line">Events:</span><br><span class="line">  FirstSeen LastSeen    Count   From                    SubObjectPath   Type        Reason              Message</span><br><span class="line">  --------- --------    -----   ----                    -------------   --------    ------              -------</span><br><span class="line">  1m        1m          1       &#123;deployment-controller &#125;                Normal      ScalingReplicaSet   Scaled up replica set nginx-deployment-2035384211 to 3</span><br><span class="line">  22s       22s         1       &#123;deployment-controller &#125;                Normal      ScalingReplicaSet   Scaled up replica set nginx-deployment-1564180365 to 1</span><br><span class="line">  22s       22s         1       &#123;deployment-controller &#125;                Normal      ScalingReplicaSet   Scaled down replica set nginx-deployment-2035384211 to 2</span><br><span class="line">  22s       22s         1       &#123;deployment-controller &#125;                Normal      ScalingReplicaSet   Scaled up replica set nginx-deployment-1564180365 to 2</span><br><span class="line">  21s       21s         1       &#123;deployment-controller &#125;                Normal      ScalingReplicaSet   Scaled down replica set nginx-deployment-2035384211 to 1</span><br><span class="line">  21s       21s         1       &#123;deployment-controller &#125;                Normal      ScalingReplicaSet   Scaled up replica set nginx-deployment-1564180365 to 3</span><br><span class="line">  13s       13s         1       &#123;deployment-controller &#125;                Normal      ScalingReplicaSet   Scaled down replica set nginx-deployment-2035384211 to 0</span><br><span class="line">  13s       13s         1       &#123;deployment-controller &#125;                Normal      ScalingReplicaSet   Scaled up replica set nginx-deployment-3066724191 to 1</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<p>要解決這個問題, 你需要回滾到前一個穩定的 Deployment reversion</p>
<p><br></p>
<h3 id="確認-Deployment-的-Rollout-歷史"><a href="#確認-Deployment-的-Rollout-歷史" class="headerlink" title="確認 Deployment 的 Rollout 歷史"></a>確認 Deployment 的 Rollout 歷史</h3><p>照著以下步驟來確認 rollout 歷史:</p>
<ul>
<li><p>確認 Deployment reversion</p>
<ul>
<li><p>執行</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectl rollout <span class="hljs-built_in">history</span> deployment.v1.apps/nginx-deployment</span><br></pre></td></tr></table></figure>
</li>
<li><p>輸出</p>
<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">deployments &quot;nginx-deployment&quot;</span><br><span class="line">REVISION    CHANGE-CAUSE</span><br><span class="line">1           kubectl apply --filename=https://k8s.io/examples/controllers/nginx-deployment.yaml --record=true</span><br><span class="line">2           kubectl set image deployment.v1.apps/nginx-deployment nginx=nginx:1.9.1 --record=true</span><br><span class="line">3           kubectl set image deployment.v1.apps/nginx-deployment nginx=nginx:1.91 --record=true</span><br></pre></td></tr></table></figure>
<p><code>CHANGE-CAUSE</code> 是當 revisions 建立時, 從 Deployment 的 annotation <code>kubernetes.io/change-cause</code> 複製到你的 revisions, 你也可以藉由以下方法指定 <code>CHANGE-CAUSE</code> 的 message:</p>
<ul>
<li><p>輸入指令</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectl annotate deployment.v1.apps/nginx-deployment kubernetes.io/change-cause=<span class="hljs-string">"image updated to 1.9.1"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>當我們在做資源變更時, 最後加入 <code>--record</code> 的 flag</p>
</li>
<li>手動編輯資源的 manifest 檔案, 就是 yaml 檔</li>
</ul>
</li>
</ul>
</li>
<li><p>若要檢視每個 revision 的細節資訊：</p>
<ul>
<li><p>執行</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectl rollout <span class="hljs-built_in">history</span> deployment.v1.apps/nginx-deployment --revision=2</span><br></pre></td></tr></table></figure>
</li>
<li><p>輸出</p>
<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">deployments &quot;nginx-deployment&quot; revision 2</span><br><span class="line">  Labels:       app=nginx</span><br><span class="line">          pod-template-hash=1159050644</span><br><span class="line">  Annotations:  kubernetes.io/change-cause=kubectl set image deployment.v1.apps/nginx-deployment nginx=nginx:1.9.1 --record=true</span><br><span class="line">  Containers:</span><br><span class="line">   nginx:</span><br><span class="line">    Image:      nginx:1.9.1</span><br><span class="line">    Port:       80/TCP</span><br><span class="line">     QoS Tier:</span><br><span class="line">        cpu:      BestEffort</span><br><span class="line">        memory:   BestEffort</span><br><span class="line">    Environment Variables:      &lt;none&gt;</span><br><span class="line">  No volumes.</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h3 id="版本回滾"><a href="#版本回滾" class="headerlink" title="版本回滾"></a>版本回滾</h3><p>照著以下步驟將 Deployment 從目前的版本回滾到之前的版本, 之前的版本為版本2</p>
<ul>
<li><p>取消當前版本並回滾到之前版本</p>
<ul>
<li><p>執行</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectl rollout undo deployment.v1.apps/nginx-deployment</span><br></pre></td></tr></table></figure>
</li>
<li><p>輸出</p>
<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">deployment.apps/nginx-deployment</span><br></pre></td></tr></table></figure>
</li>
<li><p>或使用 <code>--to-revision</code> 指定要回滾至的版本</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectl rollout undo deployment.v1.apps/nginx-deployment --to-revision=2</span><br></pre></td></tr></table></figure>
</li>
<li><p>輸出</p>
<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">deployment.apps/nginx-deployment</span><br></pre></td></tr></table></figure>
<p>更多關於 rollout 的指令可以參考<a href="https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#rollout" target="_blank" rel="noopener">kubectl rollout</a><br>Deployment 目前已經回滾到之前的穩定版本, 所以你可以看到, Deployment 產生了一個 <code>DeploymentRollback</code> 的事件, 代表回滾到版本 2</p>
</li>
</ul>
</li>
<li><p>要確定 rollback 有成功並且 Deployment 如預期般的正常運行:</p>
<ul>
<li><p>執行</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectl get deployment nginx-deployment</span><br></pre></td></tr></table></figure>
</li>
<li><p>輸出</p>
<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">NAME               READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">nginx-deployment   3/3     3            3           30m</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<ul>
<li><p>取得 Deployment 的細節描述</p>
<ul>
<li><p>執行</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectl describe deployment nginx-deployment</span><br></pre></td></tr></table></figure>
</li>
<li><p>輸出</p>
<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">Name:                   nginx-deployment</span><br><span class="line">Namespace:              default</span><br><span class="line">CreationTimestamp:      Sun, 02 Sep 2018 18:17:55 -0500</span><br><span class="line">Labels:                 app=nginx</span><br><span class="line">Annotations:            deployment.kubernetes.io/revision=4</span><br><span class="line">                        kubernetes.io/change-cause=kubectl set image deployment.v1.apps/nginx-deployment nginx=nginx:1.9.1 --record=true</span><br><span class="line">Selector:               app=nginx</span><br><span class="line">Replicas:               3 desired | 3 updated | 3 total | 3 available | 0 unavailable</span><br><span class="line">StrategyType:           RollingUpdate</span><br><span class="line">MinReadySeconds:        0</span><br><span class="line">RollingUpdateStrategy:  25% max unavailable, 25% max surge</span><br><span class="line">Pod Template:</span><br><span class="line">  Labels:  app=nginx</span><br><span class="line">  Containers:</span><br><span class="line">   nginx:</span><br><span class="line">    Image:        nginx:1.9.1</span><br><span class="line">    Port:         80/TCP</span><br><span class="line">    Host Port:    0/TCP</span><br><span class="line">    Environment:  &lt;none&gt;</span><br><span class="line">    Mounts:       &lt;none&gt;</span><br><span class="line">  Volumes:        &lt;none&gt;</span><br><span class="line">Conditions:</span><br><span class="line">  Type           Status  Reason</span><br><span class="line">  ----           ------  ------</span><br><span class="line">  Available      True    MinimumReplicasAvailable</span><br><span class="line">  Progressing    True    NewReplicaSetAvailable</span><br><span class="line">OldReplicaSets:  &lt;none&gt;</span><br><span class="line">NewReplicaSet:   nginx-deployment-c4747d96c (3/3 replicas created)</span><br><span class="line">Events:</span><br><span class="line">  Type    Reason              Age   From                   Message</span><br><span class="line">  ----    ------              ----  ----                   -------</span><br><span class="line">  Normal  ScalingReplicaSet   12m   deployment-controller  Scaled up replica set nginx-deployment-75675f5897 to 3</span><br><span class="line">  Normal  ScalingReplicaSet   11m   deployment-controller  Scaled up replica set nginx-deployment-c4747d96c to 1</span><br><span class="line">  Normal  ScalingReplicaSet   11m   deployment-controller  Scaled down replica set nginx-deployment-75675f5897 to 2</span><br><span class="line">  Normal  ScalingReplicaSet   11m   deployment-controller  Scaled up replica set nginx-deployment-c4747d96c to 2</span><br><span class="line">  Normal  ScalingReplicaSet   11m   deployment-controller  Scaled down replica set nginx-deployment-75675f5897 to 1</span><br><span class="line">  Normal  ScalingReplicaSet   11m   deployment-controller  Scaled up replica set nginx-deployment-c4747d96c to 3</span><br><span class="line">  Normal  ScalingReplicaSet   11m   deployment-controller  Scaled down replica set nginx-deployment-75675f5897 to 0</span><br><span class="line">  Normal  ScalingReplicaSet   11m   deployment-controller  Scaled up replica set nginx-deployment-595696685f to 1</span><br><span class="line">  Normal  DeploymentRollback  15s   deployment-controller  Rolled back deployment &quot;nginx-deployment&quot; to revision 2</span><br><span class="line">  Normal  ScalingReplicaSet   15s   deployment-controller  Scaled down replica set nginx-deployment-595696685f to 0</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<p><br><br><br></p>
<h2 id="擴縮-Deployment"><a href="#擴縮-Deployment" class="headerlink" title="擴縮 Deployment"></a>擴縮 Deployment</h2><p>使用以下指令擴縮 Deployment:</p>
<ul>
<li><p>執行</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectl scale deployment.v1.apps/nginx-deployment --replicas=10</span><br></pre></td></tr></table></figure>
</li>
<li><p>輸出</p>
<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">deployment.apps/nginx-deployment scaled</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>假設 <a href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough/" target="_blank" rel="noopener">水平 Pod 自動擴縮</a> 在你的叢集中是有打開的, 可以設定擴縮你的 Deployment 依據給予的 Pods 最大及最小數量, 以及 CPU 的使用率</p>
<ul>
<li><p>執行</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectl autoscale deployment.v1.apps/nginx-deployment --min=10 --max=15 --cpu-percent=80</span><br></pre></td></tr></table></figure>
</li>
<li><p>輸出</p>
<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">deployment.apps/nginx-deployment scaled</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="比例擴縮"><a href="#比例擴縮" class="headerlink" title="比例擴縮"></a>比例擴縮</h3><p>滾動升級 Deployment 支援同時運行不同版本的應用。 當一個 Deployment 正處於 rollout 狀態 (在途中或暫停狀態), 此時你或者是自動調節器又發出一個擴縮請求, Deployment controller 會將額外增加的 replicas 成比例的分配到目前運作中的 ReplicaSets (有啟動 Pods 的 ReplicaSets) 以降低風險。 這樣的行為稱為比例擴縮 (proportional scaling), 例如說, 你正運行著有 10 個 replicas 的 Deployment, maxSurge=3, maxUnavailable=2</p>
<ul>
<li><p>確保 Deployment 下的 10 個 replicas 都有在運行</p>
<ul>
<li><p>執行</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectl get deploy</span><br></pre></td></tr></table></figure>
</li>
<li><p>輸出</p>
<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">NAME                 DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">nginx-deployment     10        10        10           10          50s</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>將鏡像版本更新成無法被解析的版本</p>
<ul>
<li><p>執行</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectl <span class="hljs-built_in">set</span> image deployment.v1.apps/nginx-deployment nginx=nginx:sometag</span><br></pre></td></tr></table></figure>
</li>
<li><p>輸出</p>
<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">deployment.apps/nginx-deployment image updated</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<ul>
<li><p>這個鏡像的更新會啟動一個新的 rollout 以及 ReplicaSet nginx-deployment-1989198191, 但它會因為上面提到的 <code>maxUnavailable</code> 而被阻塞住</p>
<ul>
<li><p>執行</p>
<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">kubectl get rs</span><br></pre></td></tr></table></figure>
</li>
<li><p>輸出</p>
<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">NAME                          DESIRED   CURRENT   READY     AGE</span><br><span class="line">nginx-deployment-1989198191   5         5         0         9s</span><br><span class="line">nginx-deployment-618515232    8         8         8         1m</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<ul>
<li><p>這時再將數量提升到 15 個</p>
<ul>
<li><p>執行</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectl scale deployment nginx-deployment --replicas=15</span><br></pre></td></tr></table></figure>
</li>
<li><p>此時, Deployment controller 需要決定要把這新的 5 個 replicas 使用哪一個 replicaSet 來啟動。 如果你沒有使用比例擴縮的話, 所有 5 個都會使用新的 ReplicaSet。 使用比例擴縮, 你將額外的 replicas 散佈到所有的 ReplicaSets, 比較多的 replicas 會被分配給擁有比較多 replica 的 replicaSet, 而比較少的 replicas 會被分配給擁有比較少 replica 的 replicaSet, 而擁有 0 個 replica 的 replicaSet 將不會被分配任何 replica</p>
</li>
<li><p>執行以下指令確認目前狀態</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectl get deploy</span><br></pre></td></tr></table></figure>
</li>
<li><p>輸出</p>
<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">NAME                 DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">nginx-deployment     15        18        7            8           7m</span><br></pre></td></tr></table></figure>
</li>
<li><p>執行指令確認 rs 狀態</p>
<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">kubectl get rs</span><br></pre></td></tr></table></figure>
</li>
<li><p>輸出</p>
<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">NAME                          DESIRED   CURRENT   READY     AGE</span><br><span class="line">nginx-deployment-1989198191   7         7         0         7m</span><br><span class="line">nginx-deployment-618515232    11        11        11        7m</span><br></pre></td></tr></table></figure>
<p>如果最後 rollout 恢復正常, replica 恢復健康的話, 所有的 replica 都會被移動到新的 ReplicaSet</p>
</li>
</ul>
</li>
</ul>
<h2 id="暫停以及恢復一個-Deployment"><a href="#暫停以及恢復一個-Deployment" class="headerlink" title="暫停以及恢復一個 Deployment"></a>暫停以及恢復一個 Deployment</h2><p>你可以在觸發一個或多個更新之前先暫停 Deployment, 然後再恢復。 這讓你可以進行多個更新, 並避免掉不必要的 rollout</p>
<ul>
<li><p>比如說, 取得剛建立的 Deployment 資訊：</p>
<ul>
<li><p>執行</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectl get deploly</span><br></pre></td></tr></table></figure>
</li>
<li><p>輸出</p>
<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">NAME      DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">nginx     3         3         3            3           1m</span><br></pre></td></tr></table></figure>
</li>
<li><p>取得 rollout 狀態</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectl get rs</span><br></pre></td></tr></table></figure>
</li>
<li><p>輸出</p>
<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">NAME               DESIRED   CURRENT   READY     AGE</span><br><span class="line">nginx-2142116321   3         3         3         1m</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>使用以下指令停止</p>
<ul>
<li><p>執行</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectl rollout pause deployment.v1.apps/nginx-deployment</span><br></pre></td></tr></table></figure>
</li>
<li><p>輸出</p>
<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">deployment.apps/nginx-deployment paused</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<ul>
<li><p>更新鏡像</p>
<ul>
<li><p>執行</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectl <span class="hljs-built_in">set</span> image deployment.v1.apps/nginx-deployment nginx=nginx:1.9.1</span><br></pre></td></tr></table></figure>
</li>
<li><p>輸出</p>
<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">deployment.apps/nginx-deployment image updated</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>可以看到 rollout 完全沒有開始</p>
<ul>
<li><p>執行</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectl rollout <span class="hljs-built_in">history</span> deployment.v1.apps/nginx-deployment</span><br></pre></td></tr></table></figure>
</li>
<li><p>輸出</p>
<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">deployments &quot;nginx&quot;</span><br><span class="line">REVISION  CHANGE-CAUSE</span><br><span class="line">1   &lt;none&gt;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<ul>
<li><p>取得 rollout status 確保 Deployment 已經有成功更新</p>
<ul>
<li><p>執行</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectl get rs</span><br></pre></td></tr></table></figure>
</li>
<li><p>輸出</p>
<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">NAME               DESIRED   CURRENT   READY     AGE</span><br><span class="line">nginx-2142116321   3         3         3         2m</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>你可以盡可能地建立你需要的更新, 例如說, 更新資源:</p>
<ul>
<li><p>執行</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectl <span class="hljs-built_in">set</span> resources deployment.v1.apps/nginx-deployment -c=nginx --limits=cpu=200m,memory=512Mi</span><br></pre></td></tr></table></figure>
</li>
<li><p>輸出</p>
<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">deployment.apps/nginx-deployment resource requirements updated</span><br></pre></td></tr></table></figure>
<p>在暫停前的 Deployment 狀態將會保持運作, 只要 Deployment 是處於暫停的狀態, 那你所建立的更新都不會對目前狀態有任何影響。</p>
</li>
</ul>
</li>
</ul>
<ul>
<li><p>最後, 恢復 Deployment 並且觀察新的 ReplicaSet 進行所有新的更新</p>
<ul>
<li><p>執行</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectl rollout resume deployment.v1.apps/nginx-deployment</span><br></pre></td></tr></table></figure>
</li>
<li><p>輸出</p>
<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">deployment.apps/nginx-deployment resumed</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<ul>
<li><p>觀察 rollout 的狀態直到結束</p>
<ul>
<li><p>執行</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectl get rs -w</span><br></pre></td></tr></table></figure>
</li>
<li><p>輸出</p>
<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">NAME               DESIRED   CURRENT   READY     AGE</span><br><span class="line">nginx-2142116321   2         2         2         2m</span><br><span class="line">nginx-3926361531   2         2         0         6s</span><br><span class="line">nginx-3926361531   2         2         1         18s</span><br><span class="line">nginx-2142116321   1         2         2         2m</span><br><span class="line">nginx-2142116321   1         2         2         2m</span><br><span class="line">nginx-3926361531   3         2         1         18s</span><br><span class="line">nginx-3926361531   3         2         1         18s</span><br><span class="line">nginx-2142116321   1         1         1         2m</span><br><span class="line">nginx-3926361531   3         3         1         18s</span><br><span class="line">nginx-3926361531   3         3         2         19s</span><br><span class="line">nginx-2142116321   0         1         1         2m</span><br><span class="line">nginx-2142116321   0         1         1         2m</span><br><span class="line">nginx-2142116321   0         0         0         2m</span><br><span class="line">nginx-3926361531   3         3         3         20s</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<ul>
<li><p>取得最新 rollout 狀態</p>
<ul>
<li><p>執行</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectl get rs</span><br></pre></td></tr></table></figure>
</li>
<li><p>輸出</p>
<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">NAME               DESIRED   CURRENT   READY     AGE</span><br><span class="line">nginx-2142116321   0         0         0         2m</span><br><span class="line">nginx-3926361531   3         3         3         28s</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<p><br><br><br></p>
<h2 id="Deployment-狀態"><a href="#Deployment-狀態" class="headerlink" title="Deployment 狀態"></a>Deployment 狀態</h2><p>Deployment 的生命週期中有很多種狀態, <a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#progressing-deployment" target="_blank" rel="noopener">progressing</a> 當建立一個新的 ReplicaSet, 又或者是 <a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#complete-deployment" target="_blank" rel="noopener">complete</a> 或 <a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#failed-deployment" target="_blank" rel="noopener">fail to progress</a></p>
<p><br></p>
<h3 id="進行中的-Deployment"><a href="#進行中的-Deployment" class="headerlink" title="進行中的 Deployment"></a>進行中的 Deployment</h3><p>當以下任務在進行中時, Kubernetes 會將 Deployment 標註為 <em>progressing</em></p>
<ul>
<li>當 Deployment 建立新的 ReplicaSet</li>
<li>當 Deployment 正在擴容 ReplicaSet</li>
<li>當 Deployment 正在縮減 ReplicaSet</li>
<li>有新的 Pod 可用, 至少 (就緒時間打 <a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#min-ready-seconds" target="_blank" rel="noopener">MinReadySeconds</a> 定義)</li>
</ul>
<p>你可以使用 <code>kubectl rollout status</code> 來監控 Deployment 狀態</p>
<p><br></p>
<h3 id="完成-Deployment"><a href="#完成-Deployment" class="headerlink" title="完成 Deployment"></a>完成 Deployment</h3><p>有以下特點時, Kubernetes 會將 Deployment 標註為 complete</p>
<ul>
<li>所有此 Deployment 的 replicas 都已更新到指定的最新版本, 代表說任何要求的更新都已經完成。</li>
<li>所有與此 Deployment 相關的 replicas 都可用</li>
<li>此 Deployment 下沒有舊的 replicas 在運行中</li>
</ul>
<p>若要確認 Deployment 狀態是否為 completed, 可使用 <code>kubectl rollout status</code>。 如果 rollout 成功完成, <code>kubectl rollout status</code> 回應一個值為 0 的 exit code<br>執行<br><figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectl rollout status deployment.v1.apps/nginx-deployment</span><br></pre></td></tr></table></figure></p>
<p>輸出<br><figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">Waiting for rollout to finish: 2 of 3 updated replicas are available...</span><br><span class="line">deployment.apps/nginx-deployment successfully rolled out</span><br><span class="line">$ echo $?</span><br><span class="line">0</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h3 id="失敗的-Deployment"><a href="#失敗的-Deployment" class="headerlink" title="失敗的 Deployment"></a>失敗的 Deployment</h3><p>以下原因可能造成 rollout 卡住：</p>
<ul>
<li>資源配額不足</li>
<li>Readiness 探測結果失敗</li>
<li>拉取鏡像錯誤</li>
<li>權限不足</li>
<li>資源限制</li>
<li>應用 runtime 配置錯誤</li>
</ul>
<p>偵測這個情況的一個方法就是在 Deployment 的 spec (<a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#progress-deadline-seconds" target="_blank" rel="noopener"><code>.spec.progressDeadlineSeconds</code></a>), 這是個時間, 表示 Deployment controller 會在 Deployment 卡住多久之後回報這個異常</p>
<p>使用 <code>kubectl</code> 指令來設定 <code>progressDeadlineSeconds</code> 讓 controller 會在卡住 10 分鐘之後回報異常</p>
<ul>
<li><p>執行</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectl patch deployment.v1.apps/nginx-deployment -p <span class="hljs-string">'&#123;"spec":&#123;"progressDeadlineSeconds":600&#125;&#125;'</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>輸出</p>
<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">deployment.apps/nginx-deployment patched</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>一旦超過設定的 deadline, Deployment controller 在 Deployment 的 <code>.status.confitions</code> 增加一個具有下面內容的 DeploymentCondition 屬性</p>
<ul>
<li>Type=Progressing</li>
<li>Status=False</li>
<li>Reason=ProgressDeadlineExceeded</li>
</ul>
<p>更多有關 [status conditions] 的資訊可以參考 <a href="https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#typical-status-properties" target="_blank" rel="noopener">Kubernetes API conventions</a></p>
<p><strong>注意</strong>: Kubernetes 對異常的 Deployment 除了回報 <code>Reason=ProgressDeadlineExceeded</code> 之外, 不會有其他動作。 更高階層的調節器可以利用這個訊息做相對應的動作, 比方說, 將 Deployment 回滾到之前的版本</p>
<p><strong>注意</strong>: 如果你暫停 Deployment, Kubernetes 就不會確認你指定的 deadline, 你可以放心的暫停以及恢復 rollout, 不用擔心會因此而觸發 deadline</p>
<p>有時你可能會遇到暫時性的 Deployment 錯誤, 可能是因為你設了過短的 timeout 或是其他被認為是短暫的。 例如說, 你沒有足夠的資源。 如果你 describe Deployment, 你會看到以下：</p>
<ul>
<li><p>執行</p>
<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">kubectl describe deployment nignx-deployment</span><br></pre></td></tr></table></figure>
</li>
<li><p>輸出</p>
<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">&lt;...&gt;</span><br><span class="line">Conditions:</span><br><span class="line">  Type            Status  Reason</span><br><span class="line">  ----            ------  ------</span><br><span class="line">  Available       True    MinimumReplicasAvailable</span><br><span class="line">  Progressing     True    ReplicaSetUpdated</span><br><span class="line">  ReplicaFailure  True    FailedCreate</span><br><span class="line">&lt;...&gt;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>如果你執行 <code>kubectl get deployment nginx-deployment -o yaml</code>, Deployment status 如下：<br><figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">status:</span><br><span class="line">  availableReplicas: 2</span><br><span class="line">  conditions:</span><br><span class="line">  - lastTransitionTime: 2016-10-04T12:25:39Z</span><br><span class="line">    lastUpdateTime: 2016-10-04T12:25:39Z</span><br><span class="line">    message: Replica set &quot;nginx-deployment-4262182780&quot; is progressing.</span><br><span class="line">    reason: ReplicaSetUpdated</span><br><span class="line">    status: &quot;True&quot;</span><br><span class="line">    type: Progressing</span><br><span class="line">  - lastTransitionTime: 2016-10-04T12:25:42Z</span><br><span class="line">    lastUpdateTime: 2016-10-04T12:25:42Z</span><br><span class="line">    message: Deployment has minimum availability.</span><br><span class="line">    reason: MinimumReplicasAvailable</span><br><span class="line">    status: &quot;True&quot;</span><br><span class="line">    type: Available</span><br><span class="line">  - lastTransitionTime: 2016-10-04T12:25:39Z</span><br><span class="line">    lastUpdateTime: 2016-10-04T12:25:39Z</span><br><span class="line">    message: &apos;Error creating: pods &quot;nginx-deployment-4262182780-&quot; is forbidden: exceeded quota:</span><br><span class="line">      object-counts, requested: pods=1, used: pods=3, limited: pods=2&apos;</span><br><span class="line">    reason: FailedCreate</span><br><span class="line">    status: &quot;True&quot;</span><br><span class="line">    type: ReplicaFailure</span><br><span class="line">  observedGeneration: 3</span><br><span class="line">  replicas: 2</span><br><span class="line">  unavailableReplicas: 2</span><br></pre></td></tr></table></figure></p>
<p>最後, 一旦 Deployment progress deadline 超過, Kubernetes 會將 status 以及 reason 更新:<br><figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">Conditions:</span><br><span class="line">  Type            Status  Reason</span><br><span class="line">  ----            ------  ------</span><br><span class="line">  Available       True    MinimumReplicasAvailable</span><br><span class="line">  Progressing     False   ProgressDeadlineExceeded</span><br><span class="line">  ReplicaFailure  True    FailedCreate</span><br></pre></td></tr></table></figure></p>
<p>你可以藉由擴縮 Deployment 或是增加資源配額到你的命名空間來解決資源配額不足的問題。 只要你滿足了資源配額, Deployment controller 會自動完成 Deployment rollout, 你將會看到 Deployment 的 status 會更新為 <code>Status=True</code> 以及 <code>Reason=NewReplicaSetAvailable</code><br><figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">Conditions:</span><br><span class="line">  Type          Status  Reason</span><br><span class="line">  ----          ------  ------</span><br><span class="line">  Available     True    MinimumReplicasAvailable</span><br><span class="line">  Progressing   True    NewReplicaSetAvailable</span><br></pre></td></tr></table></figure></p>
<p><code>Type=Available</code> 配上 <code>Status=True</code> 表示你的 Deployment 已具有最小可用性。 最小可用性是由 Deployment strategy 的設定來決定。 <code>Type=Progressing</code> 配上 <code>Status=true</code> 表示你的 Deployment 正在 rollout 途中, 或者是 process 已完成, 且心 replicas 的最低需求已滿足 (詳細資料可以查看 condition 的 reason - 在我們的案例中, <code>Reason=NewReplicaSetAvailable</code>, 這代表這個 Deployment 已經完成)<br>你可以使用 <code>kubectl rollout status</code> 確認 Deployment 是否有 process 失敗, 如果 Deployment 以及超出 procession deadline 的話, 會回傳一個值為非 0 的 exit code</p>
<ul>
<li><p>執行 </p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectl rollout status deployment.v1.apps/nginx-deployment</span><br></pre></td></tr></table></figure>
</li>
<li><p>輸出</p>
<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">Waiting for rollout to finish: 2 out of 3 new replicas have been updated...</span><br><span class="line">error: deployment &quot;nginx&quot; exceeded its progress deadline</span><br><span class="line">$ echo $?</span><br><span class="line">1</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><br></p>
<h3 id="在失敗的-Deployment-上的操作"><a href="#在失敗的-Deployment-上的操作" class="headerlink" title="在失敗的 Deployment 上的操作"></a>在失敗的 Deployment 上的操作</h3><p>所有你可以在完成的 Deployment 上做的操作也可以使用在失敗的 Deployment 上。 你可以對它擴縮容, 回滾到之前的版本, 或是暫停, 如果你需要對這個 Deployment 的 Pod template 做多次的調整的話</p>
<p><br><br><br></p>
<h2 id="Clean-up-Policy"><a href="#Clean-up-Policy" class="headerlink" title="Clean up Policy"></a>Clean up Policy</h2><p>你可以在 Deployment 中的欄位 <code>.spec.revisionHistoryLimit</code> 指定你想要保留的舊的 ReplicaSets 的數量, 超出這個數量的會在背景被垃圾回收掉, 預設值為 10</p>
<p><strong>注意</strong>: 如果你特別將這個欄位設為 0, 所有的 history 都會被清理掉, 因此你將會無法回滾你的 Deployment</p>
<p><br><br><br></p>
<h2 id="Canary-Deployment"><a href="#Canary-Deployment" class="headerlink" title="Canary Deployment"></a>Canary Deployment</h2><p>如果你想要使用 Deployment 發佈 release 到不同的使用者群或伺服器群, 你可以建立多個 Deployment, 每個發佈都有各自的 Deployment, 更多有關金絲雀 (Canary) 部署的描述, 請參考<a href="https://kubernetes.io/docs/concepts/cluster-administration/manage-deployment/#canary-deployments" target="_blank" rel="noopener">managing resources</a></p>
<p><br><br><br></p>
<h2 id="撰寫-Deployment-Spec"><a href="#撰寫-Deployment-Spec" class="headerlink" title="撰寫 Deployment Spec"></a>撰寫 Deployment Spec</h2><p>跟所有其他的 Kubernetes 配置檔一樣, Deployment 也需要 <code>apiVersion</code>, <code>kind</code>, 以及 <code>metadata</code> 欄位。 一些通用的資訊可以參考 <a href="https://kubernetes.io/docs/tutorials/stateless-application/run-stateless-application-deployment/" target="_blank" rel="noopener">應用部署</a>, 設置容器, 以及 <a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/object-management/" target="_blank" rel="noopener">使用 kubectl 管理資源</a> 文件<br>Deployment 也需要 <a href="https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#spec-and-status" target="_blank" rel="noopener"><code>.spec</code> 區塊</a></p>
<p><br></p>
<h3 id="Pod-Template"><a href="#Pod-Template" class="headerlink" title="Pod Template"></a>Pod Template</h3><p><code>.spec.template</code> 以及 <code>.spec.selector</code> 是 <code>.spec</code> 中唯一要求的欄位<br><code>.spec.template</code> 為 <a href="https://kubernetes.io/docs/concepts/workloads/pods/pod-overview/#pod-templates" target="_blank" rel="noopener">Pod template</a>。 它跟 Pod 有完全相同的配置, 唯一的不同處是它不需要 <code>apiVersion</code> 以及 <code>kind</code>, 以及它被包在另外一個一個物件內<br>除了 Pod 中要求的欄位之外, 在 Deployment 中的 Pod template 必須指定合適的 labels 以及 restart policy。 不可與其他 controller 重疊 labels, 可參考 <a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#selector" target="_blank" rel="noopener">selector</a></p>
<p><code>.spec.template.spec.restartPolicy</code> 只被允許設為 <code>Always</code>, 這也是默認值</p>
<p><br></p>
<h3 id="Replicas"><a href="#Replicas" class="headerlink" title="Replicas"></a>Replicas</h3><p><code>.spec.replicas</code> 可填可不填, 用來指定想要啟動的 Pod 的數量, 預設為 1</p>
<p><br></p>
<h3 id="Selector"><a href="#Selector" class="headerlink" title="Selector"></a>Selector</h3><p><code>.spec.selector</code> 是一個必要的欄位, 它指定了一個 <a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/" target="_blank" rel="noopener">label selector</a>, 定義這個 Deployment 的目標 Pods</p>
<p><code>.spec.selector</code> 必須符合 <code>.spec.template.metadata.labels</code>, 否則將被 API 拒絕。</p>
<p>在 API 版本 <code>apps/v1</code>, <code>.spec.selector</code> 以及 <code>.metadata.labels</code> 預設並非 <code>.spec.template.metadata.labels</code>, 所以他們必須被明確的設定。 再者, <code>.spec.selector</code> 在 <code>app/v1</code> 中, 建立後就不可再更改</p>
<p>如果 Pods 的 template 跟 Deployment 的 <code>.spec.template</code> 不同, 又或者 Pods 的總數量超過了 <code>.spec.replicas</code> 定義的數量, Deployment 可能會將 label 符合該 Deployment selector 的 Pods 結束掉。 如果 Pods 的數量小於 Deployment 定義期望的數量, Deployment controller 會依照 <code>.spec.template</code> 開啟新的 Pods</p>
<p><strong>注意</strong>: 不可直接建立 label 符合這個 selector 的 Pod, 或透過 Deployment 建立, 又或者透過其他的 controller, 像是 ReplicaSet 或 ReplicationController。 如果你這麼做了, 第一個 Deployment 依然會認為是她建立了這些其他的 Pods, 且 Kubernetes 也不會阻止你這麼做。</p>
<p>如果你有多個 controller, 彼此的 selector 都有重疊, 那這些 controller 將會互相打架而無法正確運作。</p>
<p><br></p>
<h3 id="Strategy"><a href="#Strategy" class="headerlink" title="Strategy"></a>Strategy</h3><p><br><br><br></p>
<h2 id="Q-amp-A"><a href="#Q-amp-A" class="headerlink" title="Q&amp;A"></a>Q&amp;A</h2><ul>
<li><strong>Kubernetes Deployment 中, <code>.spec.replicas</code> 預設值為多少?</strong><br>1</li>
</ul>
<ul>
<li><strong>Kubernetes Deployment 中, <code>.spec.template.spec.restartPolicy</code> 預設值為?</strong><br>Always</li>
</ul>
<ul>
<li><strong>Kubernetes Deployment 中, <code>.spec.template.spec.restartPolicy</code> 只可設為什麼?</strong><br>Always</li>
</ul>
<ul>
<li><strong>Kubernetes deployment 中, <code>.spec</code> 中唯一要求哪兩個欄位？</strong><ul>
<li><code>.spec.template</code></li>
<li><code>.spec.selector</code></li>
</ul>
</li>
</ul>
<ul>
<li><strong>Kubernetes 中, 如果我將 <code>.spec.revisionHistoryLimit</code> 的值設為 0, 會發生什麼事？</strong><br>所有 revision history 都會被回收掉, Deployment 會無法回滾</li>
</ul>
<ul>
<li><strong>Kubernetes 中, <code>.spec.revisionHistoryLimit</code> 預設的值為多少？</strong><br>10 個</li>
</ul>
<ul>
<li><strong>Kubernetes 中, 可使用哪一個欄位來設定要保留的舊的 revision 數量？</strong><br><code>.spec.revisionHistoryLimit</code></li>
</ul>
<ul>
<li><strong>Kubernetes 中, 當我在 progress 途中使用 pause, 會計算 deadline 的時間嗎？</strong><br>不會</li>
</ul>
<ul>
<li><strong>Kubernetes 中, 當 ProgressDeadlineExceeded 被觸發, Deployment 除了回報狀況以外, 還會做什麼事情嗎？</strong><br>不會</li>
</ul>
<ul>
<li><strong>Kubernetes 中, 如果 Deployment progress 卡住超過指定的 deadline, Deployment controller 會在 DeploymentCondition 屬性中增加什麼內容？</strong><ul>
<li>Type=Progressing</li>
<li>Status=False</li>
<li>Reason=ProgressDeadlineExceeded</li>
</ul>
</li>
</ul>
<ul>
<li><strong>Kubernetes 中, 如果 Deployment progress 卡住超過指定的 deadline, Deployment controller 會在什麼地方增加一個 DeploymentCondition 屬性？</strong><br><code>.status.conditions</code></li>
</ul>
<ul>
<li><strong>Kubernetes 中, 哪一個屬性可以決定 process 卡住之後多久會回報異常？</strong><br><code>.spec.progressDeadlineSeconds</code></li>
</ul>
<ul>
<li><p><strong>Kubernetes 中, 如何使用 CLI 來設定資源限制</strong></p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectl <span class="hljs-built_in">set</span> resources deployment/deploymentName -c=nginx --limits=cpu=200m,memory=512Mi</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Kubernetes 中, 如何 resume 一個 deployment?</strong></p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectl rollout resume deployment/deploymentName</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Kubernetes 中, 如何 pause 一個 deployment?</strong></p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectl rollout pause deployment/deploymentName</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Kubernetes 中, 如果我 pause 一個 Deployment, 那它還會保持運作嗎？</strong><br>會哦, 只是會鎖住目前的版本而已</p>
</li>
</ul>
<ul>
<li><strong>Kubernetes 中, 當我暫停一個 Deployment 時, 我可以回滾它嗎？</strong><br>不行哦</li>
</ul>
<ul>
<li><strong>Kubernetes 中, pause 跟 resume 可以帶來什麼好處？</strong><br>有時要進行多個修正時, 可以避免不必要的 rollout</li>
</ul>
<ul>
<li><strong>Kubernetes 當中, 假如現在正 rollout 到一半, 這時有新的擴容需求被呼叫, 那如果我有使用 proportional scaling 的話, 新的 replica 會被加到新的 replicaSet 還是舊的 replicaSet?</strong><br>會照比例分配, 擁有多個 replica 的 replicaSet 會被分配多組, 反之亦然</li>
</ul>
<ul>
<li><strong>Kubernetes 當中, 假如現在正 rollout 到一半, 這時有新的擴容需求被呼叫, 那如果我沒有使用 proportional scaling 的話, 新的 replica 會被加到新的 replicaSet 還是舊的 replicaSet?</strong><br>新的</li>
</ul>
<ul>
<li><p><strong>以下的 Kubernetes CLI 的意思是？</strong></p>
<ul>
<li><p><strong>CLI</strong></p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectl autoscale deployment.v1.apps/nginx-deployment --min=10 --max=15 --cpu-percent=80</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Answer</strong>:</p>
<ul>
<li>最少 10 個 pod</li>
<li>最多 15 個 pod</li>
<li>當 CPU 使用超過 80% 時, 多開一個 Pod</li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li><p><strong>Kubernetes 中, 假如我要指定自動擴縮 Deployment 的範圍以及 CPU 使用率, 我可以怎麼做？</strong></p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectl autoscale deployment/deploymentName --min=10 --max=15 --cpu-percent=80</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Kubernetes 中, 假如我現在要擴縮指定 Deployment 到 10 個 replica, 我可以怎麼做？</strong></p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectl scale deployment/deploymentName --replicas=replicasNumber</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Kubernetes 中, 如果我要放棄目前的版本回滾到一個指定的版本, 我可以怎麼做？</strong></p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectl rollout undo deployment/deploymentName --to-revision=revisionName</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Kubernetes 中, 如果我要放棄目前的版本回滾到前一個版本, 我可以怎麼做？</strong></p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectl rollout undo deployment/deploymentName</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Kubernetes 中, 如果我要檢視指定 revision 的細節資訊, 我可以怎麼做？</strong></p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectl rollout <span class="hljs-built_in">history</span> deployment/deploymentName --revision=revisionName</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Kubernetes 中, 有哪三種方法可以指定 <code>CHANGE-CAUSE</code> message?</strong></p>
<ul>
<li>藉由 <code>kubectl annotate</code> 指令</li>
<li>變更資源時, 加入 <code>--record</code> flag</li>
<li>手動變更</li>
</ul>
</li>
</ul>
<ul>
<li><strong>Kubernetes 中, 當我回滾到之前的版本, 會否對 replica 的期望數量有影響？</strong><br>不會, rolling back 只會影響到 <code>spec.template</code> 中的內容</li>
</ul>
<ul>
<li><strong>Kubernetes 中, Deployment revision 唯有當什麼情況之下才會被建立？</strong><br>當 <code>spec.template</code> 中的內容有變更時</li>
</ul>
<ul>
<li><strong>Kubernetes 中, 自 <code>apps/v1</code> 的版本後, Deployment 的 label selector 在建立後可以再變更嗎？</strong><br>不行</li>
</ul>
<ul>
<li><strong>Kubernetes 中, 在滾動升級的過程中, 如果新的 Deployment 還沒完成擴容我就更新了這個 Deployment, 那 Deployment controller 會等到原本的擴容任務完成之後再開始新的任務嗎？</strong><br>不會, 會立即縮減舊的, 擴容新的</li>
</ul>
<ul>
<li><strong>Kubernetes 中, 當 Deployment 被更新了, 新的 ReplicaSet 會被建立來提供期望的 Pods 數量, 那 Kubernetes 是如何判斷舊的 ReplicaSet?</strong><br>label 符合 <code>.spec.selector</code> 但 <code>.spec.template</code> 不符合</li>
</ul>
<ul>
<li><strong>Kubernetes 中, 在滾動升級的過程中, Deployment 建立新的 Pod 以及刪除舊的 Pod 的模式是？</strong><br>確保不可用以及可用的 Pod 都處於指定的範圍之內, 它不會等到新的 Pod 都建好才去砍舊的, 也不會等到舊的 Pod 都砍完才去建新的</li>
</ul>
<ul>
<li><strong>Kubernetes 中, 預設最多幾 % 的期望 Pod 數量可以處於運行中？</strong><br>125%</li>
</ul>
<ul>
<li><strong>Kubernetes 中, 當實施滾動升級時, 預設最多可以有幾% 的 Pod 不可用？</strong><br>25%</li>
</ul>
<ul>
<li><strong>Kubernetes 中, 當實施滾動升級時, 預設至少會保持幾 % 的 Pods 運行？</strong><br>75%</li>
</ul>
<ul>
<li><strong>Kubernetes 中, 當 rollout 被觸發, Deployment 是透過建立一個新的什麼資源來建立新的 Pod?</strong><br>ReplicaSet</li>
</ul>
<ul>
<li><p><strong>Kubernetes 中, 如果我要利用 kubectl CLI 來更新指定鏡像的版本, 我可以使用哪一個指令？</strong></p>
  <figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectl <span class="hljs-built_in">set</span> image deployment/deploymentName containerName=imageName:tagName --record</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Kubernetes 中, Deployment 的 rollout 唯有在什麼情況下會被觸發？</strong><br>當 <code>.spec.template</code> 的內容變了</p>
</li>
</ul>
<ul>
<li><strong>Kubernetes 中, <code>pod-template-hash</code> 是由 hash 哪一個 field 得來的？</strong><br><code>PodTemplate</code></li>
</ul>
<ul>
<li><strong>Kubernetes 中, <code>pod-template-hash</code> 的用途是？</strong><br>確保一個 Deployment 建立的 ReplicaSet 不會重疊</li>
</ul>
<ul>
<li><strong>Kubernetes 中, <code>pod-template-hash</code> 是由誰加到 ReplicaSet 上的？</strong><br>Deployment Controller</li>
</ul>
<ul>
<li><strong>Kubernetes 中, <code>pod-template-hash</code> 可以被變更嗎？</strong><br>不可</li>
</ul>
<ul>
<li><strong>Kubernetes 中, 當我們在定義 labels 以及 selectors 時, 務必要注意什麼？ 否則會造成衝突以及預期外的行為</strong><br>不可讓 labels 或 selectors 在多個 controller 之間互相重疊</li>
</ul>
<ul>
<li><p><strong>Kubernetes 中, 如果要檢視每個 pod 自動產生的 labels, 可以使用哪一個 kubectl 指令？</strong></p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectl get pods --show-labels</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Kubernetes 中, ReplicaSet 的命名格式為？</strong><br><code>[DEPLOYMENT-NAME]-[RANDOM-STRING]</code></p>
</li>
</ul>
<ul>
<li><p><strong>Kubernetes 中, 如果要透過 CLI 取得 ReplicaSet, 可以使用哪一個 kubectl command?</strong></p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectl get rs</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Kubernetes 中, <code>rs</code> 是哪一個資源的縮寫？</strong><br>ReplicaSet</p>
</li>
</ul>
<ul>
<li><p><strong>Kubernetes 中, 要如何查看 rollout status?</strong></p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectl rollout status deployment deploymentName</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Kubernetes 中, 當我在建立資源時加上了 <code>--record</code> flag, 我要怎樣才可以看到運行的 command 的紀錄？</strong></p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectl describe resource resourceName</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Kubernetes 中, 如果我想要之後使用 <code>kubectl describe</code> 時都可以看到該 resource 之前執行過什麼執行, 那我可以在建立該 resource 時加上哪一個 flag?</strong><br><code>--record</code></p>
</li>
<li><p><strong>Kubernetes 中, <code>matchExpressions</code> field 的 operator <code>Lt</code> 代表的意思是？</strong><br>該 label 的 value 需<code>小於</code>指定值</p>
</li>
<li><p><strong>Kubernetes 中, <code>matchExpressions</code> field 的 operator <code>Gt</code> 代表的意思是？</strong><br>該 label 的 value 需<code>大於</code>指定值</p>
</li>
<li><p><strong>Kubernetes 中, <code>matchExpressions</code> field 的 operator <code>DoesNotExist</code> 代表的意思是？</strong><br>該 label <code>key</code> 有存在的都算</p>
</li>
<li><p><strong>Kubernetes 中, <code>matchExpressions</code> field 的 operator <code>Exist</code> 代表的意思是？</strong><br>該 label <code>key</code> 有存在的都算</p>
</li>
<li><p><strong>Kubernetes 中, <code>matchExpressions</code> field 的 operator <code>NotIn</code> 代表的意思是？</strong><br>該 label 的 value 需<code>不存在</code>於指定的 array list 當中</p>
</li>
<li><p><strong>Kubernetes 中, <code>matchExpressions</code> field 的 operator <code>In</code> 代表的意思是？</strong><br>該 label 的 value 需<code>存在</code>於指定的 array list 當中</p>
</li>
<li><p><strong>Kubernetes 中, <code>matchLabels</code> field 代表？</strong><br>一對 key/value pair</p>
</li>
<li><p><strong>Kubernetes 中, <code>matchExpressions</code> field 有哪幾個 operator？</strong></p>
<ul>
<li>In</li>
<li>NotIn</li>
<li>Exists</li>
<li>DoesNotExist</li>
<li>Lt</li>
<li>Gt</li>
</ul>
</li>
</ul>

    
    </div>
    
    <div class="columns is-variable is-1 is-multiline is-mobile">
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/zh-tw/tags/Kubernetes/">#Kubernetes</a></span>
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/zh-tw/tags/Kubernetes-Deployments/">#Kubernetes Deployments</a></span>
    
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop  article-nav-prev">
            
            <a href="/zh-tw/managingDeploymentsUsingKubernetesEngine/">使用 GCP Kubernetes Engine 來管理部署</a>
            
        </span>
        <span class="column is-12-mobile is-half-desktop  article-nav-next">
            
            <a href="/zh-tw/kubernetes-container-lifecycle-hooks/">Kubernetes - Container Lifecycle Hooks</a>
            
        </span>
    </div>
    
</article>


<div class="sharebox">
    
<div class="sharethis-inline-share-buttons"></div>
<script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5c72643b9ea706001139fd89&amp;product=inline-share-buttons" async="async"></script>

</div>



<div class="comments">
    <h3 class="title is-4">留言</h3>
    
<script>
    var disqus_config = function () {
        this.page.url = 'https://tn710617.github.io/zh-tw/kubernetes-workloads-controllers-deployments/';
        this.page.identifier = 'zh-tw/kubernetes-workloads-controllers-deployments/';
        
        this.language = 'zh';
        
    };
    (function() {
        var d = document, s = d.createElement('script');  
        s.src = '//' + 'rayscodingjourney' + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>

<div id="disqus_thread">
    
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</div>

    </div>
</section>
    <footer class="footer">
    <div class="container">
        <div class="columns content">
            <div class="column is-narrow has-text-centered">
                &copy; 2020 Ray&nbsp;
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a href="http://github.com/ppoffice/hexo-theme-minos">Minos</a>
            </div>
            <div class="column is-hidden-mobile"></div>

            
            
                       <a class="navbar-item" title="GitHub" href="https://github.com/tn710617">
                           
                           <i class="fab fa-github"></i>
                           
                       </a>
                          
                       <a class="navbar-item" title="Medium" href="https://medium.com/@raycodingjourney">
                           
                           <i class="fab fa-medium"></i>
                           
                       </a>
                          
                       <a class="navbar-item" title="Linkedin" href="https://www.linkedin.com/in/ray-lee-99315315a">
                           
                           <i class="fab fa-linkedin"></i>
                           
                       </a>
                          
                       <a class="navbar-item" title="Facebook" href="https://www.facebook.com/profile.php?id=100001626039430">
                           
                           <i class="fab fa-facebook"></i>
                           
                       </a>
                          
                       <a class="navbar-item" title="CakeResume" href="https://www.cakeresume.com/resumes/ray-6edaef/edit">
                           
                           <i class="far fa-address-card"></i>
                           
                       </a>
                          
                       <a class="navbar-item" title="E-Mail" href="mailto:tn710617@gmail.com">
                           
                           <i class="far fa-envelope"></i>
                           
                       </a>
                          
                       <a class="navbar-item" title="Skype" href="skype:adad0310?call|chat">
                           
                           <i class="fab fa-skype"></i>
                           
                       </a>
                          
                       
        </div>
    </div>
</footer>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script>

<!-- test if the browser is outdated -->
<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/">Update my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.js"></script>
<script>
    $(document).ready(function () {
        // plugin function, place inside DOM ready function
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        })
    });
</script>

<script>
    window.FontAwesomeConfig = {
        searchPseudoElements: true
    }
    moment.locale("zh-CN");
</script>


    
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<script>
    MathJax.Hub.Config({
        "HTML-CSS": {matchFontHeight: false},
        SVG: {matchFontHeight: false},
        CommonHTML: {matchFontHeight: false}
    });
</script>

    
    
    
    
<script src="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/js/lightgallery-all.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/justifiedGallery/3.6.5/js/jquery.justifiedGallery.min.js"></script>
<script>
    (function ($) {
        $(document).ready(function () {
            if (typeof($.fn.lightGallery) === 'function') {
                $('.article.gallery').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof($.fn.justifiedGallery) === 'function') {
                $('.justified-gallery').justifiedGallery();
            }
        });
    })(jQuery);
</script>

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <style>
        .hljs {
            position: relative;
        }

        .hljs .clipboard-btn {
            float: right;
            color: #9a9a9a;
            background: none;
            border: none;
            cursor: pointer;
        }

        .hljs .clipboard-btn:hover {
          color: #8a8a8a;
        }

        .hljs > .clipboard-btn {
            display: none;
            position: absolute;
            right: 4px;
            top: 4px;
        }

        .hljs:hover > .clipboard-btn {
            display: inline;
        }

        .hljs > figcaption > .clipboard-btn {
            margin-right: 4px;
        }
    </style>
    <script>
      $(document).ready(function () {
        $('figure.hljs').each(function(i, figure) {
          var codeId = 'code-' + i;
          var code = figure.querySelector('.code');
          var copyButton = $('<button>Copy <i class="far fa-clipboard"></i></button>');
          code.id = codeId;
          copyButton.addClass('clipboard-btn');
          copyButton.attr('data-clipboard-target-id', codeId);

          var figcaption = figure.querySelector('figcaption');

          if (figcaption) {
            figcaption.append(copyButton[0]);
          } else {
            figure.prepend(copyButton[0]);
          }
        })

        var clipboard = new ClipboardJS('.clipboard-btn', {
          target: function(trigger) {
            return document.getElementById(trigger.getAttribute('data-clipboard-target-id'));
          }
        });
        clipboard.on('success', function(e) {
          e.clearSelection();
        })
      })
    </script>

    
    

    


<script src="/js/script.js"></script>

    
    <div class="searchbox ins-search">
    <div class="searchbox-mask"></div>
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="站內搜尋">
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: '文章',
                PAGES: '頁面',
                CATEGORIES: '分類',
                TAGS: '標籤',
                UNTITLED: '(無標題)',
            },
            CONTENT_URL: '/content.zh-tw.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script src="/js/insight.js"></script>
    
</body>
</html>