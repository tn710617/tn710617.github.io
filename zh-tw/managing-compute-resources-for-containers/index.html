<!DOCTYPE html>
<html class="has-navbar-fixed-top">
<head>
    <meta charset="utf-8">
<title>Kubernetes - Resources Limit - Learn or Die</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="description" content="# 概述哈囉！ 本篇來介紹 Kubernetes 中的 Compute Resource。 接下來要介紹的可不是一般的 Resource, 像是元件那些, 而是可計算資源。簡單來說, 我們在定義 Pod 的時候, 可以定義啟動這個 Pod 需要多少資源, 以及這個 Pod 最多可以使用多少資源, 這樣夠淺顯易懂吧！ 下面就是詳細介紹了。">
<meta property="og:type" content="article">
<meta property="og:title" content="Kubernetes - Resources Limit">
<meta property="og:url" content="https://tn710617.github.io/zh-tw/managing-compute-resources-for-containers/index.html">
<meta property="og:site_name" content="Learn or Die">
<meta property="og:description" content="# 概述哈囉！ 本篇來介紹 Kubernetes 中的 Compute Resource。 接下來要介紹的可不是一般的 Resource, 像是元件那些, 而是可計算資源。簡單來說, 我們在定義 Pod 的時候, 可以定義啟動這個 Pod 需要多少資源, 以及這個 Pod 最多可以使用多少資源, 這樣夠淺顯易懂吧！ 下面就是詳細介紹了。">
<meta property="og:locale" content="zh_TW">
<meta property="article:published_time" content="2020-01-30T10:35:30.000Z">
<meta property="article:modified_time" content="2020-12-21T08:57:40.107Z">
<meta property="article:author" content="Ray">
<meta property="article:tag" content="Kubernetes">
<meta property="article:tag" content="Kubernetes Resources">
<meta name="twitter:card" content="summary">


<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.css">


    <link href="/managing-compute-resources-for-containers/" rel="alternate"
          hreflang="en"/>








    <meta name="description" content="# 概述哈囉！ 本篇來介紹 Kubernetes 中的 Compute Resource。 接下來要介紹的可不是一般的 Resource, 像是元件那些, 而是可計算資源。簡單來說, 我們在定義 Pod 的時候, 可以定義啟動這個 Pod 需要多少資源, 以及這個 Pod 最多可以使用多少資源, 這樣夠淺顯易懂吧！ 下面就是詳細介紹了。">
<meta property="og:type" content="article">
<meta property="og:title" content="Kubernetes - Resources Limit">
<meta property="og:url" content="https://tn710617.github.io/zh-tw/managing-compute-resources-for-containers/index.html">
<meta property="og:site_name" content="Learn or Die">
<meta property="og:description" content="# 概述哈囉！ 本篇來介紹 Kubernetes 中的 Compute Resource。 接下來要介紹的可不是一般的 Resource, 像是元件那些, 而是可計算資源。簡單來說, 我們在定義 Pod 的時候, 可以定義啟動這個 Pod 需要多少資源, 以及這個 Pod 最多可以使用多少資源, 這樣夠淺顯易懂吧！ 下面就是詳細介紹了。">
<meta property="og:locale" content="zh_TW">
<meta property="article:published_time" content="2020-01-30T10:35:30.000Z">
<meta property="article:modified_time" content="2020-12-21T08:57:40.107Z">
<meta property="article:author" content="Ray">
<meta property="article:tag" content="Kubernetes">
<meta property="article:tag" content="Kubernetes Resources">
<meta name="twitter:card" content="summary">





    <link rel="icon" href="/images/favicon.png">


<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bulma/0.6.2/css/bulma.min.css">


    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/justifiedGallery/3.6.5/css/justifiedGallery.min.css">


<link rel="stylesheet"
      href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/sunburst.min.css">


<link rel="stylesheet" href="/css/style.css">


<script defer src="//use.fontawesome.com/releases/v5.0.8/js/all.js"></script>


    
        
    
        
    
        
    
        
    
        
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-135063928-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-135063928-1');
</script>


    


<meta name="generator" content="Hexo 6.2.0"></head>
<body>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="/zh-tw">
                
                    
                    不學會死
                    
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item "
               href="/zh-tw/archives">歸檔</a>
            
            <a class="navbar-item "
               href="/zh-tw/categories">分類</a>
            
            <a class="navbar-item "
               href="/zh-tw/tags">標籤</a>
            
            <a class="navbar-item "
               href="/zh-tw/schedule">行程</a>
            
            <a class="navbar-item "
               href="/zh-tw/about">關於</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            <a class="navbar-item search" title="搜尋" href="javascript:;">
                <i class="fas fa-search"></i>
            </a>
            
            
            <div class="navbar-item is-hoverable has-dropdown is-hidden-mobile is-hidden-tablet-only toc">
                <a class="navbar-item" title="目錄">
                    <i class="fa fa-list"></i>
                </a>
                <div class="navbar-dropdown is-right">
                    
                    
                    
                    
                    <a class="navbar-item" href="#概述">1&nbsp;&nbsp;<b># 概述</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#資源類型">2&nbsp;&nbsp;<b># 資源類型</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#Pod-以及-Container-的資源要求以及資源限制">3&nbsp;&nbsp;<b># Pod 以及 Container 的資源要求以及資源限制</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#CPU-解釋">4&nbsp;&nbsp;<b># CPU 解釋</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#Memory-解釋">5&nbsp;&nbsp;<b># Memory 解釋</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#有-resource-requests-的-Pod-是被如何調度的？">6&nbsp;&nbsp;<b># 有 resource requests 的 Pod 是被如何調度的？</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#有-resource-limits-的-Pod-是如何被調度？">7&nbsp;&nbsp;<b># 有 resource limits 的 Pod 是如何被調度？</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#監控資源使用量">8&nbsp;&nbsp;<b># 監控資源使用量</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#Troubleshooting">9&nbsp;&nbsp;<b># Troubleshooting</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#容器顯示-pending-以及事件訊息-failedScheduling">9.1&nbsp;&nbsp;# 容器顯示 pending 以及事件訊息 failedScheduling</a>
                    
                    
                    
                    <a class="navbar-item" href="#容器被終止">9.2&nbsp;&nbsp;# 容器被終止</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#Local-ephemeral-storage">10&nbsp;&nbsp;<b># Local ephemeral storage</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#本地臨時儲存區的-Requests-以及-Limits-資源限制設定">10.1&nbsp;&nbsp;# 本地臨時儲存區的 Requests 以及 Limits 資源限制設定</a>
                    
                    
                    
                    <a class="navbar-item" href="#有-ephemeral-storage-request-限制的-Pod-是如何被分配的？">10.2&nbsp;&nbsp;# 有 ephemeral-storage request 限制的 Pod 是如何被分配的？</a>
                    
                    
                    
                    <a class="navbar-item" href="#有-ephemeral-storage-limit-限制的-Pod-是如何被分配的？">10.3&nbsp;&nbsp;# 有 ephemeral-storage limit 限制的 Pod 是如何被分配的？</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#頗析-Memory">11&nbsp;&nbsp;<b># 頗析 (Memory)</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#建立一個沒有資源限制的-pod">11.1&nbsp;&nbsp;# 建立一個沒有資源限制的 pod</a>
                    
                    
                    
                    <a class="navbar-item" href="#使用-Kubectl-來驗證看看-Kubernetes-是否建立沒有資源限制的-pod">11.2&nbsp;&nbsp;# 使用 Kubectl 來驗證看看 Kubernetes 是否建立沒有資源限制的 pod</a>
                    
                    
                    
                    <a class="navbar-item" href="#現在我們-ssh-到該-node-然後使用以下指令看看-docker-是如何運行這個容器">11.3&nbsp;&nbsp;# 現在我們 ssh 到該 node, 然後使用以下指令看看 docker 是如何運行這個容器</a>
                    
                    
                    
                    <a class="navbar-item" href="#讓我們繼續往下追-追到最終的-cgroup">11.4&nbsp;&nbsp;# 讓我們繼續往下追, 追到最終的 cgroup</a>
                    
                    
                    
                    <a class="navbar-item" href="#先來看-memory-limit-in-bytes-這是設定-memory-limit-的-cgroup-他等同於-docker-裡頭的-memory-以及-Kubernetes-限制的-memory-limit">11.5&nbsp;&nbsp;# 先來看 memory.limit_in_bytes, 這是設定 memory limit 的 cgroup, 他等同於 docker 裡頭的 --memory, 以及 Kubernetes 限制的 memory limit</a>
                    
                    
                    
                    <a class="navbar-item" href="#現在讓我們來建立另外一個-pod-限制-memory-limit-為-100Mi">11.6&nbsp;&nbsp;# 現在讓我們來建立另外一個 pod, 限制 memory limit 為 100Mi</a>
                    
                    
                    
                    <a class="navbar-item" href="#驗證這個-pod-有被設置特定的-limit">11.7&nbsp;&nbsp;# 驗證這個 pod 有被設置特定的 limit</a>
                    
                    
                    
                    <a class="navbar-item" href="#取得容器-id">11.8&nbsp;&nbsp;# 取得容器 id</a>
                    
                    
                    
                    <a class="navbar-item" href="#取得容器-pid">11.9&nbsp;&nbsp;# 取得容器 pid</a>
                    
                    
                    
                    <a class="navbar-item" href="#取得該容器的-memory-cgroup">11.10&nbsp;&nbsp;# 取得該容器的 memory cgroup</a>
                    
                    
                    
                    <a class="navbar-item" href="#印出-memory-cgroup-中的-memory-limit-in-bytes-數值">11.11&nbsp;&nbsp;# 印出 memory cgroup 中的 memory.limit_in_bytes 數值</a>
                    
                    
                    
                    <a class="navbar-item" href="#最後-讓我們來看看前面跳過的-位於-memory-cgroup-當中的-momery-soft-limit-in-bytes">11.12&nbsp;&nbsp;# 最後, 讓我們來看看前面跳過的, 位於 memory cgroup 當中的 momery.soft_limit_in_bytes</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#頗析-CPU">12&nbsp;&nbsp;<b># 頗析 (CPU)</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#建立一個有-request-CPU-限制的-pod">12.1&nbsp;&nbsp;# 建立一個有 request CPU 限制的 pod</a>
                    
                    
                    
                    <a class="navbar-item" href="#使用-kubectl-來檢視-pod-的資源限制資訊">12.2&nbsp;&nbsp;# 使用 kubectl 來檢視 pod 的資源限制資訊</a>
                    
                    
                    
                    <a class="navbar-item" href="#取得容器-id-1">12.3&nbsp;&nbsp;# 取得容器 id</a>
                    
                    
                    
                    <a class="navbar-item" href="#查看-Docker-是否確實設定資源限制">12.4&nbsp;&nbsp;# 查看 Docker 是否確實設定資源限制</a>
                    
                    
                    
                    <a class="navbar-item" href="#取得容器-pid-1">12.5&nbsp;&nbsp;# 取得容器 pid</a>
                    
                    
                    
                    <a class="navbar-item" href="#取得容器的-CPU-cgroup">12.6&nbsp;&nbsp;# 取得容器的 CPU cgroup</a>
                    
                    
                    
                    <a class="navbar-item" href="#取得-cgroup-屬性">12.7&nbsp;&nbsp;# 取得 cgroup 屬性</a>
                    
                    
                    
                    <a class="navbar-item" href="#取得-cpu-shares-的值">12.8&nbsp;&nbsp;# 取得 cpu.shares 的值</a>
                    
                    
                    
                    <a class="navbar-item" href="#接下來-建立一個有著-limit-resource-的-pod">12.9&nbsp;&nbsp;# 接下來, 建立一個有著 limit resource 的 pod</a>
                    
                    
                    
                    <a class="navbar-item" href="#使用-kubectl-來檢視第二個-pod-的資源限制資訊">12.10&nbsp;&nbsp;# 使用 kubectl 來檢視第二個 pod 的資源限制資訊</a>
                    
                    
                    
                    <a class="navbar-item" href="#取得第二個容器-id">12.11&nbsp;&nbsp;# 取得第二個容器 id</a>
                    
                    
                    
                    <a class="navbar-item" href="#查看-Docker-是否確實設定資源限制-1">12.12&nbsp;&nbsp;# 查看 Docker 是否確實設定資源限制</a>
                    
                    
                    
                    <a class="navbar-item" href="#取得-cpu-cfs-period-us-跟-cpu-cfs-quota-us-的值">12.13&nbsp;&nbsp;# 取得 cpu.cfs_period_us 跟 cpu.cfs_quota_us 的值</a>
                    
                    
                    
                    <a class="navbar-item" href="#CPU-頗析的總結">12.14&nbsp;&nbsp;# CPU 頗析的總結</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#以下是幫助釐清觀念的-Q-amp-A">13&nbsp;&nbsp;<b># 以下是幫助釐清觀念的 Q&amp;amp;amp;A</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Kubernetes-範例輸出中-為什麼-node-的可用資源比-node-的-capacity-少？">13.1.1&nbsp;&nbsp;以下的 Kubernetes 範例輸出中, 為什麼 node 的可用資源比 node 的 capacity 少？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Kubernetes-範例輸出中-requests-CPU-Request-限制還有多少-quota-可分配？">13.1.2&nbsp;&nbsp;以下的 Kubernetes 範例輸出中, requests CPU Request 限制還有多少 quota 可分配？</a>
                    
                    
                    
                    <a class="navbar-item" href="#Kubernetes-中-每次當-Scheduler-無法在-node-上找到足夠的資源來置放-Pod-時-都會產生一個什麼事件？">13.1.3&nbsp;&nbsp;Kubernetes 中, 每次當 Scheduler 無法在 node 上找到足夠的資源來置放 Pod 時, 都會產生一個什麼事件？</a>
                    
                    
                    
                    <a class="navbar-item" href="#Kubernetes-的可計算資源管理中-所指定的資源配額是絕對數字還是相對數字？">13.1.4&nbsp;&nbsp;Kubernetes 的可計算資源管理中, 所指定的資源配額是絕對數字還是相對數字？</a>
                    
                    
                    
                    <a class="navbar-item" href="#Kubernetes-compute-resource-management-中-如果我-CPU-設為-0-1-在單核-雙核-甚至-48核的機器中-代表的量會有所不同嗎？">13.1.5&nbsp;&nbsp;Kubernetes compute resource management 中, 如果我 CPU 設為 0.1, 在單核, 雙核, 甚至 48核的機器中, 代表的量會有所不同嗎？</a>
                    
                    
                    
                    <a class="navbar-item" href="#什麼是-TLB">13.1.6&nbsp;&nbsp;什麼是 TLB?</a>
                    
                    
                    
                    <a class="navbar-item" href="#在-Linux-系統中-虛擬記憶體管理系統中-最小的-memory-單位是什麼？">13.1.7&nbsp;&nbsp;在 Linux 系統中, 虛擬記憶體管理系統中, 最小的 memory 單位是什麼？</a>
                    
                    
                    
                    <a class="navbar-item" href="#Kubernetes-resource-limit-management-中-huge-page-是什麼">13.1.8&nbsp;&nbsp;Kubernetes resource limit management 中, huge page 是什麼?</a>
                    
                    
                    
                    <a class="navbar-item" href="#Kubernetes-中-如果一個-Pod-卡在-pending-status-那很有可能是甚麼原因？">13.1.9&nbsp;&nbsp;Kubernetes 中, 如果一個 Pod 卡在 pending status, 那很有可能是甚麼原因？</a>
                    
                    
                    
                    <a class="navbar-item" href="#Kubernetes-中-Resource-的限制可分為-CPU-以及-Memory-限制類型主要分成哪兩種？">13.1.10&nbsp;&nbsp;Kubernetes 中, Resource 的限制可分為 CPU 以及 Memory, 限制類型主要分成哪兩種？</a>
                    
                    
                    
                    <a class="navbar-item" href="#Kubernetes-Resource-的限制又可分為-requests-以及-limits-兩大類-request-主要代表的是？">13.1.11&nbsp;&nbsp;Kubernetes Resource 的限制又可分為 requests 以及 limits 兩大類, request 主要代表的是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#Kubernetes-Resource-的限制又可分為-requests-以及-limits-兩大類-在-Kubernetes-各元件當中-request-resource-對哪一個元件格外重要？">13.1.12&nbsp;&nbsp;Kubernetes Resource 的限制又可分為 requests 以及 limits 兩大類, 在 Kubernetes 各元件當中, request resource 對哪一個元件格外重要？</a>
                    
                    
                    
                    <a class="navbar-item" href="#Kubernetes-Resource-的限制又可分為-requests-以及-limits-兩大類-在-Kubernetes-各元件當中-limit-resource-對哪一個元件格外重要？">13.1.13&nbsp;&nbsp;Kubernetes Resource 的限制又可分為 requests 以及 limits 兩大類, 在 Kubernetes 各元件當中, limit resource 對哪一個元件格外重要？</a>
                    
                    
                    
                    <a class="navbar-item" href="#Kubernetes-Resource-的限制又可分為-requests-以及-limits-兩大類-當-Scheduler-在選擇要在哪一個-Node-上面運行-Pod-時-主要會考量哪一種類？">13.1.14&nbsp;&nbsp;Kubernetes Resource 的限制又可分為 requests 以及 limits 兩大類, 當 Scheduler 在選擇要在哪一個 Node 上面運行 Pod 時, 主要會考量哪一種類？</a>
                    
                    
                    
                    <a class="navbar-item" href="#Kubernetes-Resource-的限制又可分為-requests-以及-limits-兩大類-當-Scheduler-跟-request-的關係是？">13.1.15&nbsp;&nbsp;Kubernetes Resource 的限制又可分為 requests 以及 limits 兩大類, 當 Scheduler 跟 request 的關係是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Kubernetes-yaml-檔所代表的意思是">13.1.16&nbsp;&nbsp;以下的 Kubernetes yaml 檔所代表的意思是?</a>
                    
                    
                    
                    <a class="navbar-item" href="#Kubernetes-中-1-MiB-等於多少？">13.1.17&nbsp;&nbsp;Kubernetes 中, 1 MiB 等於多少？</a>
                    
                    
                    
                    <a class="navbar-item" href="#Kubernetes-中-1-MB-等於多少？">13.1.18&nbsp;&nbsp;Kubernetes 中, 1 MB 等於多少？</a>
                    
                    
                    
                    <a class="navbar-item" href="#Kubernetes-中-一個-Pod-的資源總限制是-什麼-的總和？">13.1.19&nbsp;&nbsp;Kubernetes 中, 一個 Pod 的資源總限制是 什麼 的總和？</a>
                    
                    
                    
                    <a class="navbar-item" href="#Cgroup-的全寫是？">13.1.20&nbsp;&nbsp;Cgroup 的全寫是？</a>
                    
                    
                    
                    <a class="navbar-item" href="#Cgroup-簡單解釋">13.1.21&nbsp;&nbsp;Cgroup 簡單解釋?</a>
                    
                    
                    
                    <a class="navbar-item" href="#Kubernetes-resource-limit-中-當我們只設置-limits-但沒設置-requests-時-會發生什麼事？">13.1.22&nbsp;&nbsp;Kubernetes resource limit 中, 當我們只設置 limits, 但沒設置 requests 時, 會發生什麼事？</a>
                    
                    
                    
                    <a class="navbar-item" href="#當宿主機面臨記憶體壓力時-會做什麼事？">13.1.23&nbsp;&nbsp;當宿主機面臨記憶體壓力時, 會做什麼事？</a>
                    
                    
                    
                    <a class="navbar-item" href="#當一個程序使用了超過在-cgroup-中規定的-memory-時-會發生什麼事？">13.1.24&nbsp;&nbsp;當一個程序使用了超過在 cgroup 中規定的 memory 時, 會發生什麼事？</a>
                    
                    
                    
                    <a class="navbar-item" href="#Server-中的-OOM-的全寫是">13.1.25&nbsp;&nbsp;Server 中的 OOM 的全寫是??</a>
                    
                    
                    
                    <a class="navbar-item" href="#Kubernetes-resource-limit-當中-當我設定了-requests-的限制-Kubernetes-會否要求-docker-去設定-memory-cgroup-中的-soft-limit">13.1.26&nbsp;&nbsp;Kubernetes resource limit 當中, 當我設定了 requests 的限制, Kubernetes 會否要求 docker 去設定 memory cgroup 中的 soft_limit?</a>
                    
                    
                    
                    <a class="navbar-item" href="#Kubernetes-resource-limit-當中-requests-若設得太高會發生什麼事？">13.1.27&nbsp;&nbsp;Kubernetes resource limit 當中, requests 若設得太高會發生什麼事？</a>
                    
                    
                    
                    <a class="navbar-item" href="#Kubernetes-resource-limit-當中-requests-若設得太低會發生什麼事？">13.1.28&nbsp;&nbsp;Kubernetes resource limit 當中, requests 若設得太低會發生什麼事？</a>
                    
                    
                    
                    <a class="navbar-item" href="#Kubernetes-中-一個-core-為幾-m">13.1.29&nbsp;&nbsp;Kubernetes 中, 一個 core 為幾 m?</a>
                    
                    
                    
                    <a class="navbar-item" href="#Kubernetes-將一個-core-分成幾份？">13.1.30&nbsp;&nbsp;Kubernetes 將一個 core 分成幾份？</a>
                    
                    
                    
                    <a class="navbar-item" href="#Docker-將一個-core-分成幾份？">13.1.31&nbsp;&nbsp;Docker 將一個 core 分成幾份？</a>
                    
                    
                    
                    <a class="navbar-item" href="#CGroup-將一個-core-分成幾份？">13.1.32&nbsp;&nbsp;CGroup 將一個 core 分成幾份？</a>
                    
                    
                    
                    <a class="navbar-item" href="#Kubernetes-中-當設定-memory-的-request-limit-後-會作用到-cgroup-嗎？">13.1.33&nbsp;&nbsp;Kubernetes 中, 當設定 memory 的 request limit 後, 會作用到 cgroup 嗎？</a>
                    
                    
                    
                    <a class="navbar-item" href="#Kubernetes-中-當設定-CPU-的-request-limit-後-會作用到-cgroup-嗎？">13.1.34&nbsp;&nbsp;Kubernetes 中, 當設定 CPU 的 request limit 後, 會作用到 cgroup 嗎？</a>
                    
                    
                    
                    <a class="navbar-item" href="#Kubernetes-resource-limit-中-request-resource-是由哪一個-cgroup-系統所管理的">13.1.35&nbsp;&nbsp;Kubernetes resource limit 中, request resource 是由哪一個 cgroup 系統所管理的?</a>
                    
                    
                    
                    <a class="navbar-item" href="#cgroup-cpu-cfs-period-us-中的-period-代表幾秒？">13.1.36&nbsp;&nbsp;cgroup cpu.cfs_period_us 中的 period 代表幾秒？</a>
                    
                    
                    
                    <a class="navbar-item" href="#cgroup-cpu-cfs-quota-us-中的-quota-代表什麼？">13.1.37&nbsp;&nbsp;cgroup cpu.cfs_quota_us 中的 quota 代表什麼？</a>
                    
                    
                    
                    <a class="navbar-item" href="#假如我的-CPU-request-limit-是-200m-那我的-cpu-cfs-period-us-以及-cpu-cfs-quota-us-分別是多少？">13.1.38&nbsp;&nbsp;假如我的 CPU request limit 是 200m, 那我的 cpu.cfs_period_us 以及 cpu.cfs_quota_us 分別是多少？</a>
                    
                    
                    
                    <a class="navbar-item" href="#cpu-cfs-period-us-跟-cpu-cfs-quota-us-是屬於哪一個-cgroup">13.1.39&nbsp;&nbsp;cpu.cfs_period_us 跟 cpu.cfs_quota_us 是屬於哪一個 cgroup?</a>
                    
                    
                    
                    <a class="navbar-item" href="#cpu-cfs-period-us-跟-cpu-cfs-quota-us-中的-cfs-的意思是">13.1.40&nbsp;&nbsp;cpu.cfs_period_us 跟 cpu.cfs_quota_us 中的 cfs 的意思是?</a>
                    
                    
                    
                    <a class="navbar-item" href="#Linux-的預設-CPU-scheduler-是哪一個">13.1.41&nbsp;&nbsp;Linux 的預設 CPU scheduler 是哪一個?</a>
                    
                    
                    
                    <a class="navbar-item" href="#Kubernetes-中-當設定-CPU-的-request-resource-限制-會作用到-cgroup-嗎？">13.1.42&nbsp;&nbsp;Kubernetes 中, 當設定 CPU 的 request resource 限制, 會作用到 cgroup 嗎？</a>
                    
                    
                    
                    <a class="navbar-item" href="#Kubernetes-中-程序可以超出-CPU-request-resource-限制-規定的用量嗎？">13.1.43&nbsp;&nbsp;Kubernetes 中, 程序可以超出 CPU request resource 限制 規定的用量嗎？</a>
                    
                    
                    
                    <a class="navbar-item" href="#Kubernetes-中-當程序使用了超過-CPU-request-resource-限制-規定的用量的話-會發生什麼事？">13.1.44&nbsp;&nbsp;Kubernetes 中, 當程序使用了超過 CPU request resource 限制 規定的用量的話, 會發生什麼事？</a>
                    
                    
                    
                    <a class="navbar-item" href="#Kubernetes-resource-limit-中-如果我只設定了-limits-但沒設定-requests-會發生什麼事？">13.1.45&nbsp;&nbsp;Kubernetes resource limit 中, 如果我只設定了 limits, 但沒設定 requests, 會發生什麼事？</a>
                    
                    
                    
                    <a class="navbar-item" href="#Kubernetes-resource-limit-中-如果我只設定了-requests-但沒設定-limits-會發生什麼事？">13.1.46&nbsp;&nbsp;Kubernetes resource limit 中, 如果我只設定了 requests, 但沒設定 limits, 會發生什麼事？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Kubernetes-yaml-設定檔的意思是">13.1.47&nbsp;&nbsp;以下的 Kubernetes yaml 設定檔的意思是?</a>
                    
                    
                    
                    <a class="navbar-item" href="#Kubernetes-request-resource-限制中-1-core-1000-m-那允許的最小設定值是多少？">13.1.48&nbsp;&nbsp;Kubernetes request resource 限制中, 1 core = 1000 m, 那允許的最小設定值是多少？</a>
                    
                    
                    
                    <a class="navbar-item" href="#Kubernetes-中-要如何查看-node-有多少可用資源？">13.1.49&nbsp;&nbsp;Kubernetes 中, 要如何查看 node 有多少可用資源？</a>
                    
                    
                    
                    <a class="navbar-item" href="#Kubernetes-中-如何知道容器有沒有因為資源達到限制而被砍掉？">13.1.50&nbsp;&nbsp;Kubernetes 中, 如何知道容器有沒有因為資源達到限制而被砍掉？</a>
                    
                    
                    
                    <a class="navbar-item" href="#Kubernetes-中-local-ephemeral-storage-指的是什麼地方？">13.1.51&nbsp;&nbsp;Kubernetes 中, local ephemeral storage 指的是什麼地方？</a>
                    
                    
                    
                    <a class="navbar-item" href="#Kubernetes-中-emptyDir-volumes-container-logs-image-layers-container-writable-layers-這些都是使用哪一塊空間？">13.1.52&nbsp;&nbsp;Kubernetes 中, emptyDir volumes, container logs, image layers, container writable layers, 這些都是使用哪一塊空間？</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下的-Kubernetes-yaml-檔是什麼意思呢？">13.1.53&nbsp;&nbsp;以下的 Kubernetes yaml 檔是什麼意思呢？</a>
                    
                    
                    
                    <a class="navbar-item" href="#Kubernetes-哪一個元件依據-ephemeral-storage-資源分配-pod-到適當的-node">13.1.54&nbsp;&nbsp;Kubernetes, 哪一個元件依據 ephemeral-storage 資源分配 pod 到適當的 node?</a>
                    
                    
                    
                    <a class="navbar-item" href="#Kubernetes-如果一個-pod-裡頭的某個容器的-writable-layer-以及-logs-使用量超過的-ephemeral-storage-的資源限制-會發生什麼事？">13.1.55&nbsp;&nbsp;Kubernetes, 如果一個 pod 裡頭的某個容器的 writable layer 以及 logs 使用量超過的 ephemeral-storage 的資源限制, 會發生什麼事？</a>
                    
                    
                    
                    <a class="navbar-item" href="#Kubernetes-如果一個-pod-裡頭的所有容器使用的-ephemeral-storage-用量以及-emptyDir-volumes-超過了資院限制-會發生什麼事？">13.1.56&nbsp;&nbsp;Kubernetes, 如果一個 pod 裡頭的所有容器使用的 ephemeral-storage 用量以及 emptyDir volumes 超過了資院限制, 會發生什麼事？</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#參考資源">14&nbsp;&nbsp;<b># 參考資源</b></a>
                    
                </div>
            </div>
            

            
<div class="column is-narrow has-text-centered">
    <div class="dropdown is-up is-right is-hoverable" style="margin-top: -0.2em;">
        <div class="dropdown-trigger">
            <button class="button is-small" aria-haspopup="true" aria-controls="dropdown-menu7">
                <span class="icon">
                    <i class="fas fa-globe"></i>
                </span>
                <span>繁體中文</span>
                <span class="icon is-small">
            <i class="fas fa-angle-down" aria-hidden="true"></i>
          </span>
            </button>
        </div>
        <div class="dropdown-menu has-text-left" role="menu" style="top:100%">
            <div class="dropdown-content">
            
                <a href="/managing-compute-resources-for-containers/" class="dropdown-item">
                    English
                </a>
            
                <a href="/zh-tw/managing-compute-resources-for-containers/" class="dropdown-item">
                    繁體中文
                </a>
            
            </div>
        </div>
    </div>
</div>

        </div>
    </div>
</nav>

    <section class="section">
    <div class="container">
    <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            Kubernetes - Resources Limit
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            <time datetime="2020-01-30T10:35:30.000Z" itemprop="datePublished">1月 30 2020</time>
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="/zh-tw/categories/Ops/">Ops</a>
        </span>
        
        
        <span class="column is-narrow">
            
            
            1 小时 讀完 (大概 7640 字)
        </span>
        
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <h2 id="概述"><a href="#概述" class="headerlink" title="# 概述"></a># 概述</h2><p>哈囉！ 本篇來介紹 Kubernetes 中的 Compute Resource。 接下來要介紹的可不是一般的 Resource, 像是元件那些, 而是可計算資源。<br>簡單來說, 我們在定義 Pod 的時候, 可以定義啟動這個 Pod 需要多少資源, 以及這個 Pod 最多可以使用多少資源, 這樣夠淺顯易懂吧！ 下面就是詳細介紹了。</p>
<span id="more"></span>

<p>當你指定一個 Pod, 你可以選擇性的指定每個容器需要多少 CPU 以及 memory (RAM), 當你有指定 <em>資源要求</em> (resource request) 給容器, scheduler 可以更加的分配 Pods 到 nodes 上。 而當你有指定容器的 <em>資源限制</em> (resource limits), 在 node 上的資源競爭將以指定的方式來處理。 更多 requests 以及 limits 的不同之處可以參考 <a target="_blank" rel="noopener" href="https://git.k8s.io/community/contributors/design-proposals/node/resource-qos.md">Resource QoS</a></p>
<br>
<br>

<h2 id="資源類型"><a href="#資源類型" class="headerlink" title="# 資源類型"></a># 資源類型</h2><p>CPU 以及 memory 為 <em>資源類型</em> (resource type), 資源類型有其基本單位。 CPU 以 cores 為單位, 而 memory 以 bytes 為單位。 如果你使用的是 Kubernetes v1.14 或更新的版本, 你可以指定 <em>巨頁</em> (huge page) 資源。 Huge pages 是 Linux 上特定的功能, node 的 kernel 可以分配比預設 page 更大的 memory。</p>
<p>比如說, 在預設 page 大小為 4KiB 的系統, 你可以指定一個限制, <code>hugepages-2Mi: 80Mi</code>。 如果容器試圖分配超過 40 2MiB huge pages (總共 80MiB), 則分配將失敗。<br>Ray 第一次聽到 Huge Page 的概念時也是 <em>一臉矇逼</em>, 不過本著學習者的心態 Google 了幾下之後, 就不再那麼矇了。 </p>
<p>簡單來說, memory 有過被管理的單位叫做 <strong>頁 (page)</strong>, 在很多系統中預設是 4Ki, 所以 1Mi 的 memory 就有 256 pages, 沒問題吧？ </p>
<p>而有個硬體叫做 TLB (Translation Lookaside Buffer), 它是個大小固定的緩存硬體, 而虛擬記憶體對應實體記憶體的 mapping 會緩存 TLB 上。簡單來說, 如果是使用 4Ki 為 page 為單位的話, 那就要有很多 page, 而越多 page 記憶體的位置就需要越大的緩存去管理, 偏偏 TLB 這東西又是固定大小, 所以能怎麼做？ 那自然就是加大 page 的大小, 讓總 page 的數量下降, 這樣緩存就不需要那麼大的空間來記住那麼多的記憶體位置了。 這便是 huge page 的簡單概念。</p>
<p><strong>注意</strong>: 跟 <code>memory</code> 以及 <code>cpu</code> 資源不同, 你無法過量使用 <code>hugepages-*</code> 資源</p>
<p>CPU 以及 memory 都被歸類在 <em>compute resources</em>, 或 <em>resources</em>。 Compute resources 為可被要求, 分配, 以及消耗的可量測數量。 他們與 [API resources] 不同。 API resources, 像是 Pod 以及 Services 為可通過 Kubernetes API server 讀取以及修改的物件。</p>
<br>
<br>

<h2 id="Pod-以及-Container-的資源要求以及資源限制"><a href="#Pod-以及-Container-的資源要求以及資源限制" class="headerlink" title="# Pod 以及 Container 的資源要求以及資源限制"></a># Pod 以及 Container 的資源要求以及資源限制</h2><p>每個 Container 或 Pod 可被指定下列一個或多個條件：</p>
<ul>
<li><code>spec.containers[].resources.limits.cpu</code></li>
<li><code>spec.containers[].resources.limits.memory</code></li>
<li><code>spec.containers[].resources.limits.hugepages-&lt;size&gt;</code></li>
<li><code>spec.containers[].resources.requests.cpu</code></li>
<li><code>spec.containers[].resources.requests.memory</code></li>
<li><code>spec.containers[].resources.requests.hugepages-&lt;size&gt;</code></li>
</ul>
<p>儘管 requests 以及 limits 只可被指定再單獨的 Container 上, 但要計算出 Pod 的 request 以及 limits 也很方便。 Pod 對某項特定資源的 <em>request/limit</em> 就等於該 Pod 裡的所有容器的 <em>request/limit</em> 總和。</p>
<br>
<br>

<h2 id="CPU-解釋"><a href="#CPU-解釋" class="headerlink" title="# CPU 解釋"></a># CPU 解釋</h2><p>CPU 資源的 limits 以及 requests 都以 <em>cpu</em> 為單位衡量。 1 cpu, 在 Kubernetes 中, 相當於以下單位:</p>
<ul>
<li>1 AWS vCPU</li>
<li>1 GCP Core</li>
<li>1 Azure vCore</li>
<li>1 IBM vCPU</li>
<li>1 Hyperthread, Hyperthreading 的 Intel bare-metal 處理器</li>
</ul>
<p>小數的資源請求是容許的。 <code>spec.container[].resources.requests.cpu</code> 如果設為 <code>0.5</code>, 那相當於要求 1 CPU 的一半。 <code>0.1</code> 相等於 <code>100m</code>, 100m 也可讀為 “100 millicpu”。 有些人說 “100 millicores”, 都可理解為同樣的東西。 有小數點的請求, 像是 <code>0.1</code>, 會被 API 轉換到 <code>100m</code>, 而精度最小為 <code>1m</code>, 所以設定 <code>100m</code> 會是比較理想的</p>
<p>CPU 都是絕對數字, 不會是相對數字; 舉例來說, 0.1 在 1-core, 2-core, 或 48-core 的機器中代表的量都是一樣的。</p>
<br>
<br>

<h2 id="Memory-解釋"><a href="#Memory-解釋" class="headerlink" title="# Memory 解釋"></a># Memory 解釋</h2><p>Memory 中的 limits 以及 requests 資源管理以 bytes 為單位。 記憶體可被表示為簡單的 integer, 或固定位數的 integer, 可使用以下後綴： E, P, T, G, M, K 。 你也可以使用: Ei, Pi, Ti, Gi, Mi, Ki, 舉例來說, 下面都代表大約相同的值：</p>
<figure class="highlight plaintext hljs"><table><tr><td class="code"><pre><span class="line">128974848, 129e6, 129M, 123Mi</span><br></pre></td></tr></table></figure>

<p>這邊有個範例, 下面的 Pod 含有兩個容器。 每個容器都有 resource requests, 0.25 cpu 以及 64MiB 記憶體。 每個容器都有 resource limits 0.5 cpu 以及 128 MiB 記憶體。 可以說, 這個 Pod 有 resource requests 0.5 cpu 以及 128 MiB 記憶體, resource limits 1 cpu 以及 256 MiB 記憶體</p>
<figure class="highlight yaml hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span></span><br><span class="line"><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span></span><br><span class="line"><span class="hljs-attr">metadata:</span></span><br><span class="line">  <span class="hljs-attr">name:</span> <span class="hljs-string">frontend</span></span><br><span class="line"><span class="hljs-attr">spec:</span></span><br><span class="line">  <span class="hljs-attr">containers:</span></span><br><span class="line">  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">db</span></span><br><span class="line">    <span class="hljs-attr">image:</span> <span class="hljs-string">mysql</span></span><br><span class="line">    <span class="hljs-attr">env:</span></span><br><span class="line">    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">MYSQL_ROOT_PASSWORD</span></span><br><span class="line">      <span class="hljs-attr">value:</span> <span class="hljs-string">&quot;password&quot;</span></span><br><span class="line">    <span class="hljs-attr">resources:</span></span><br><span class="line">      <span class="hljs-attr">requests:</span></span><br><span class="line">        <span class="hljs-attr">memory:</span> <span class="hljs-string">&quot;64Mi&quot;</span></span><br><span class="line">        <span class="hljs-attr">cpu:</span> <span class="hljs-string">&quot;250m&quot;</span></span><br><span class="line">      <span class="hljs-attr">limits:</span></span><br><span class="line">        <span class="hljs-attr">memory:</span> <span class="hljs-string">&quot;128Mi&quot;</span></span><br><span class="line">        <span class="hljs-attr">cpu:</span> <span class="hljs-string">&quot;500m&quot;</span></span><br><span class="line">  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">wp</span></span><br><span class="line">    <span class="hljs-attr">image:</span> <span class="hljs-string">wordpress</span></span><br><span class="line">    <span class="hljs-attr">resources:</span></span><br><span class="line">      <span class="hljs-attr">requests:</span></span><br><span class="line">        <span class="hljs-attr">memory:</span> <span class="hljs-string">&quot;64Mi&quot;</span></span><br><span class="line">        <span class="hljs-attr">cpu:</span> <span class="hljs-string">&quot;250m&quot;</span></span><br><span class="line">      <span class="hljs-attr">limits:</span></span><br><span class="line">        <span class="hljs-attr">memory:</span> <span class="hljs-string">&quot;128Mi&quot;</span></span><br><span class="line">        <span class="hljs-attr">cpu:</span> <span class="hljs-string">&quot;500m&quot;</span></span><br></pre></td></tr></table></figure>

<br>
<br>

<h2 id="有-resource-requests-的-Pod-是被如何調度的？"><a href="#有-resource-requests-的-Pod-是被如何調度的？" class="headerlink" title="# 有 resource requests 的 Pod 是被如何調度的？"></a># 有 resource requests 的 Pod 是被如何調度的？</h2><p>當你建立 Pod, Kubernetes scheduler 會挑選一個 node 來運行該 Pod。 每個 node 針對每種資源類型都有最大容量: 也就是說, 有多少 CPU 以及 memory 可以分配給 Pods。 Scheduler 會確保被調度的容器的各類型資源總和會小於該 Node 的資源總量。 注意到, 就算 node 上的資源使用量非常低, 如果容量確認沒過的話, Scheduler 還是不會分配 Pod 到這個 node 上。 這確保在 node 上資源短缺, 比如說, 在每日的資源用量高峰。</p>
<br>
<br>

<h2 id="有-resource-limits-的-Pod-是如何被調度？"><a href="#有-resource-limits-的-Pod-是如何被調度？" class="headerlink" title="# 有 resource limits 的 Pod 是如何被調度？"></a># 有 resource limits 的 Pod 是如何被調度？</h2><p>當 Kubelet 啟動 Pod 中的一個 Container, 它會將 CPU 以及 memory limits 帶入到該 container runtime。<br>當使用 Docker:</p>
<ul>
<li><code>spec.containers[].resources.requests.cpu</code> 會被轉換成 core 值, 它可能會是有小數點的, 以及會被乘以 1024。 在 <code>docker run</code> 指令中使用 <a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/run/#cpu-share-constraint"><code>--cpu-shares</code></a>, 可以設定比這更高的數字或 2 </li>
<li><code>spec.containers[].resources.limits.cpu</code> 會被轉換成 millicore 值以及乘以 100。 結果值為容器在每 100ms (也就是十分之一秒)的 CPU time 中可使用的總量, 容器無法使用超過被分到的 CPU 配額, 這個部分如果看不是很懂, 有興趣的話最下面會有補充說明。</li>
</ul>
<p><strong>注意</strong>: 預設的 quota period 為 100ms, 最小為 1ms</p>
<ul>
<li><code>spec.containers[].resources.limits.memory</code> 會被轉換成 integer, 如同 <code>docker run</code> 指令的 [<code>--memory</code>] flag 的效果</li>
</ul>
<p>如果容器超出了其 memory limits 限制, 它會被終止。 如果它設置為可重啟, 跟其他的 runtime failure 一樣, kubelet 將會重啟它。<br>如果容器超出了其 memory request 限制, 當 node memory 耗光了之後, 就會把該 Pod 砍了, Ray 看到這一段的時候也有點矇逼, 下面會再補充解釋！<br>容器可能會或者可能不會被允許超出其 CPU limit 限制, 然而, 超出了也不會被砍了。<br>要得知容器是否無法被分配, 或者因為資源限制被殺掉了, 可以參考 <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/configuration/manage-compute-resources-container/#troubleshooting">Troubleshooting</a> 區塊</p>
<br>
<br>

<h2 id="監控資源使用量"><a href="#監控資源使用量" class="headerlink" title="# 監控資源使用量"></a># 監控資源使用量</h2><p>資源使用率會以 Pod 狀態的部分回報</p>
<br>
<br>

<h2 id="Troubleshooting"><a href="#Troubleshooting" class="headerlink" title="# Troubleshooting"></a># Troubleshooting</h2><h3 id="容器顯示-pending-以及事件訊息-failedScheduling"><a href="#容器顯示-pending-以及事件訊息-failedScheduling" class="headerlink" title="# 容器顯示 pending 以及事件訊息 failedScheduling"></a># 容器顯示 pending 以及事件訊息 failedScheduling</h3><p>如果 Scheduler 在 node 上無法找到足夠的資源來置放 Pod, 這個 Pod 將會持續處於未分配的狀態, 直到 Scheduler 找到足夠的資源。 每次 Scheduler 找不到足夠資源而分配失敗的話, 都會產生一個事件, 就像這樣：</p>
<ul>
<li>取得事件：<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectl describe pod frontend | grep -A 3 Events</span><br></pre></td></tr></table></figure></li>
<li>輸出：<figure class="highlight plaintext hljs"><table><tr><td class="code"><pre><span class="line">Events:</span><br><span class="line">  FirstSeen LastSeen   Count  From          Subobject   PathReason      Message</span><br><span class="line">  36s   5s     6      &#123;scheduler &#125;              FailedScheduling  Failed for reason PodExceedsFreeCPU and possibly others</span><br></pre></td></tr></table></figure></li>
</ul>
<p>在上面的例子中, 因為 node 的 CPU 資源不足, 所以 Scheduler 無法分配名為 “frontend” 的 Pod。 類似的錯誤訊息也會出現在 memory 不足時 (PodExceedsFreeMemory)。 另外, 如果 Pod 顯示這類型的錯誤訊息, 並卡住, 你可以試試下面的操作:</p>
<ul>
<li>增加更多的 nodes 到叢集</li>
<li>終止不必要的 Pods, 騰出空間給 pending Pods</li>
<li>確認 Pod 沒有比所有的 nodes 大, 比方說, 如果所有的 Nodes 都有 <code>cpu: 1</code> 的容量, 然後 Pod 的 requests 限制為 <code>cpu: 1.1</code>, 那這個 pod 將無法被分配</li>
</ul>
<p>可以使用 <code>kubectl describe nodes</code> 指令來確認可用容量以及已經分配出去的容量, 比如說：</p>
<ul>
<li>執行指令<figure class="highlight plaintext hljs"><table><tr><td class="code"><pre><span class="line">kubectl describe nodes e2e-test-node-pool-4lw4</span><br></pre></td></tr></table></figure></li>
<li>輸出:<figure class="highlight plaintext hljs"><table><tr><td class="code"><pre><span class="line">Name:            e2e-test-node-pool-4lw4</span><br><span class="line">[ ... lines removed for clarity ...]</span><br><span class="line">Capacity:</span><br><span class="line"> cpu:                               2</span><br><span class="line"> memory:                            7679792Ki</span><br><span class="line"> pods:                              110</span><br><span class="line">Allocatable:</span><br><span class="line"> cpu:                               1800m</span><br><span class="line"> memory:                            7474992Ki</span><br><span class="line"> pods:                              110</span><br><span class="line">[ ... lines removed for clarity ...]</span><br><span class="line">Non-terminated Pods:        (5 in total)</span><br><span class="line">  Namespace    Name                                  CPU Requests  CPU Limits  Memory Requests  Memory Limits</span><br><span class="line">  ---------    ----                                  ------------  ----------  ---------------  -------------</span><br><span class="line">  kube-system  fluentd-gcp-v1.38-28bv1               100m (5%)     0 (0%)      200Mi (2%)       200Mi (2%)</span><br><span class="line">  kube-system  kube-dns-3297075139-61lj3             260m (13%)    0 (0%)      100Mi (1%)       170Mi (2%)</span><br><span class="line">  kube-system  kube-proxy-e2e-test-...               100m (5%)     0 (0%)      0 (0%)           0 (0%)</span><br><span class="line">  kube-system  monitoring-influxdb-grafana-v4-z1m12  200m (10%)    200m (10%)  600Mi (8%)       600Mi (8%)</span><br><span class="line">  kube-system  node-problem-detector-v0.1-fj7m3      20m (1%)      200m (10%)  20Mi (0%)        100Mi (1%)</span><br><span class="line">Allocated resources:</span><br><span class="line">  (Total limits may be over 100 percent, i.e., overcommitted.)</span><br><span class="line">  CPU Requests    CPU Limits    Memory Requests    Memory Limits</span><br><span class="line">  ------------    ----------    ---------------    -------------</span><br><span class="line">  680m (34%)      400m (20%)    920Mi (12%)        1070Mi (14%)</span><br></pre></td></tr></table></figure></li>
</ul>
<p>從上面的輸出可以看到, Allocatable 就是可分配的資源, 而 Allocated resources 就是已經分配出去的資源, 所以如果 Pod 被定義 requests 限制超過 1120m CPUs, 或 6.23Gi memory, 那這個 Pod 將無法被分配在這個 node, 因為資源不足啊！</p>
<p>從 <code>Pods</code> 區塊中可以看到每個 Pod 各使用了這個 node 多少的資源。</p>
<p>Pod 可用的資源總量小於該 node 的 capacity, 因為系統 daemons 使用了一部分的可用資源。 <code>allocatable</code> 欄位 <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.17/#nodestatus-v1-core">NodeStatus</a> 提供了可分配給 Pods 的資源。 更多資訊, 可參考 <a target="_blank" rel="noopener" href="https://git.k8s.io/community/contributors/design-proposals/node/node-allocatable.md">Node Allocatable Resources</a></p>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/policy/resource-quotas/">resource quota</a> 功能可用來設置資源可被消耗的最大限制。 如果使用在 namespaces 上, 那可以有效防止一個團隊佔據了所有的資源。</p>
<br>

<h3 id="容器被終止"><a href="#容器被終止" class="headerlink" title="# 容器被終止"></a># 容器被終止</h3><p>容器可能會因為資源耗盡而被終止。 若要確認容器是否有因為達到資源限制而被殺掉, 使用 <code>kubectl describe pod PodName</code></p>
<ul>
<li>執行指令<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectl describe pod simmemleak-hra99</span><br></pre></td></tr></table></figure></li>
<li>範例輸出<figure class="highlight plaintext hljs"><table><tr><td class="code"><pre><span class="line">Name:                           simmemleak-hra99</span><br><span class="line">Namespace:                      default</span><br><span class="line">Image(s):                       saadali/simmemleak</span><br><span class="line">Node:                           kubernetes-node-tf0f/10.240.216.66</span><br><span class="line">Labels:                         name=simmemleak</span><br><span class="line">Status:                         Running</span><br><span class="line">Reason:</span><br><span class="line">Message:</span><br><span class="line">IP:                             10.244.2.75</span><br><span class="line">Replication Controllers:        simmemleak (1/1 replicas created)</span><br><span class="line">Containers:</span><br><span class="line">  simmemleak:</span><br><span class="line">    Image:  saadali/simmemleak</span><br><span class="line">    Limits:</span><br><span class="line">      cpu:                      100m</span><br><span class="line">      memory:                   50Mi</span><br><span class="line">    State:                      Running</span><br><span class="line">      Started:                  Tue, 07 Jul 2015 12:54:41 -0700</span><br><span class="line">    Last Termination State:     Terminated</span><br><span class="line">      Exit Code:                1</span><br><span class="line">      Started:                  Fri, 07 Jul 2015 12:54:30 -0700</span><br><span class="line">      Finished:                 Fri, 07 Jul 2015 12:54:33 -0700</span><br><span class="line">    Ready:                      False</span><br><span class="line">    Restart Count:              5</span><br><span class="line">Conditions:</span><br><span class="line">  Type      Status</span><br><span class="line">  Ready     False</span><br><span class="line">Events:</span><br><span class="line">  FirstSeen                         LastSeen                         Count  From                              SubobjectPath                       Reason      Message</span><br><span class="line">  Tue, 07 Jul 2015 12:53:51 -0700   Tue, 07 Jul 2015 12:53:51 -0700  1      &#123;scheduler &#125;                                                          scheduled   Successfully assigned simmemleak-hra99 to kubernetes-node-tf0f</span><br><span class="line">  Tue, 07 Jul 2015 12:53:51 -0700   Tue, 07 Jul 2015 12:53:51 -0700  1      &#123;kubelet kubernetes-node-tf0f&#125;    implicitly required container POD   pulled      Pod container image &quot;k8s.gcr.io/pause:0.8.0&quot; already present on machine</span><br><span class="line">  Tue, 07 Jul 2015 12:53:51 -0700   Tue, 07 Jul 2015 12:53:51 -0700  1      &#123;kubelet kubernetes-node-tf0f&#125;    implicitly required container POD   created     Created with docker id 6a41280f516d</span><br><span class="line">  Tue, 07 Jul 2015 12:53:51 -0700   Tue, 07 Jul 2015 12:53:51 -0700  1      &#123;kubelet kubernetes-node-tf0f&#125;    implicitly required container POD   started     Started with docker id 6a41280f516d</span><br><span class="line">  Tue, 07 Jul 2015 12:53:51 -0700   Tue, 07 Jul 2015 12:53:51 -0700  1      &#123;kubelet kubernetes-node-tf0f&#125;    spec.containers&#123;simmemleak&#125;         created     Created with docker id 87348f12526a</span><br></pre></td></tr></table></figure></li>
</ul>
<p>上面的 example 中, <code>Restart Count: 5</code> 顯示容器 <code>simmemleak</code> 容器已被終止並重啟五次</p>
<p>你可以呼叫 <code>kubectl get pod</code> 以及 option <code>-o go-template=...</code> 來取得之前中止的容器狀態</p>
<ul>
<li>執行指令<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectl get pod -o go-template=<span class="hljs-string">&#x27;&#123;&#123;range.status.containerStatuses&#125;&#125;&#123;&#123;&quot;Container Name: &quot;&#125;&#125;&#123;&#123;.name&#125;&#125;&#123;&#123;&quot;\r\nLastState: &quot;&#125;&#125;&#123;&#123;.lastState&#125;&#125;&#123;&#123;end&#125;&#125;&#x27;</span>  simmemleak-hra99</span><br></pre></td></tr></table></figure></li>
<li>範例輸出<figure class="highlight plaintext hljs"><table><tr><td class="code"><pre><span class="line">Container Name: simmemleak</span><br><span class="line">LastState: map[terminated:map[exitCode:137 reason:OOM Killed startedAt:2015-07-07T20:58:43Z finishedAt:2015-07-07T20:58:43Z containerID:docker://0e4095bba1feccdfe7ef9fb6ebffe972b4b14285d5acdec6f0d3ae8a22fad8b2]]</span><br></pre></td></tr></table></figure></li>
</ul>
<p>可以看到, 容器因為 <code>reason:OOM killed</code> 而被殺掉, <code>OOM</code> 表示 Out Of Memory</p>
<br>
<br>

<h2 id="Local-ephemeral-storage"><a href="#Local-ephemeral-storage" class="headerlink" title="# Local ephemeral storage"></a># Local ephemeral storage</h2><p><strong>FEATURE STATE: <code>kubernetes v1.17</code></strong><br>kubernetes 版本 1.8 介紹了一個新的資源, 用來管理本地臨時儲存空間的 <em>ephemeral-storage</em>。 在每一個 node 中, kubelet 的 root 資料夾 (預設 /var/lib/kubelet) 以及 log 資料夾 (預設 /var/log) 都被儲存在 root 分區。 這個分區同時也經由 emptyDir volumes, container logs, image layers 以及 container writable layers 被 Pods 共享</p>
<h3 id="本地臨時儲存區的-Requests-以及-Limits-資源限制設定"><a href="#本地臨時儲存區的-Requests-以及-Limits-資源限制設定" class="headerlink" title="# 本地臨時儲存區的 Requests 以及 Limits 資源限制設定"></a># 本地臨時儲存區的 Requests 以及 Limits 資源限制設定</h3><p>每個 Pod 中的容器都可以指定一個或多個以下的限制：</p>
<ul>
<li><code>spec.containers[].resources.limits.ephemeral-storage</code></li>
<li><code>spec.containers[].resources.requests.ephemeral-storage</code></li>
</ul>
<p><code>ephemeral-storage</code> 的 limits 以及 requests 資源管理以 bytes 為單位。 儲存區可被表示為簡單的 integer, 或固定位數的 integer, 可使用以下後綴： E, P, T, G, M, K 。 你也可以使用: Ei, Pi, Ti, Gi, Mi, Ki, 舉例來說, 下面都代表大約相同的值：</p>
<figure class="highlight plaintext hljs"><table><tr><td class="code"><pre><span class="line">128974848, 129e6, 129M, 123Mi</span><br></pre></td></tr></table></figure>

<p>舉例來說, 以下的 Pod 有兩個容器。 每個容器都有 2 GiB 的 本地臨時儲存區 request 限制, 而每個容器都有 4GiB 的本地臨時儲存區 limit 限制。 因此, 這個 Pod 有 4GiB 的本地臨時儲存 request 限制以及 8GiB 的 limit 限制</p>
<figure class="highlight yaml hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span></span><br><span class="line"><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span></span><br><span class="line"><span class="hljs-attr">metadata:</span></span><br><span class="line">  <span class="hljs-attr">name:</span> <span class="hljs-string">frontend</span></span><br><span class="line"><span class="hljs-attr">spec:</span></span><br><span class="line">  <span class="hljs-attr">containers:</span></span><br><span class="line">  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">db</span></span><br><span class="line">    <span class="hljs-attr">image:</span> <span class="hljs-string">mysql</span></span><br><span class="line">    <span class="hljs-attr">env:</span></span><br><span class="line">    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">MYSQL_ROOT_PASSWORD</span></span><br><span class="line">      <span class="hljs-attr">value:</span> <span class="hljs-string">&quot;password&quot;</span></span><br><span class="line">    <span class="hljs-attr">resources:</span></span><br><span class="line">      <span class="hljs-attr">requests:</span></span><br><span class="line">        <span class="hljs-attr">ephemeral-storage:</span> <span class="hljs-string">&quot;2Gi&quot;</span></span><br><span class="line">      <span class="hljs-attr">limits:</span></span><br><span class="line">        <span class="hljs-attr">ephemeral-storage:</span> <span class="hljs-string">&quot;4Gi&quot;</span></span><br><span class="line">  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">wp</span></span><br><span class="line">    <span class="hljs-attr">image:</span> <span class="hljs-string">wordpress</span></span><br><span class="line">    <span class="hljs-attr">resources:</span></span><br><span class="line">      <span class="hljs-attr">requests:</span></span><br><span class="line">        <span class="hljs-attr">ephemeral-storage:</span> <span class="hljs-string">&quot;2Gi&quot;</span></span><br><span class="line">      <span class="hljs-attr">limits:</span></span><br><span class="line">        <span class="hljs-attr">ephemeral-storage:</span> <span class="hljs-string">&quot;4Gi&quot;</span></span><br></pre></td></tr></table></figure>

<br>

<h3 id="有-ephemeral-storage-request-限制的-Pod-是如何被分配的？"><a href="#有-ephemeral-storage-request-限制的-Pod-是如何被分配的？" class="headerlink" title="# 有 ephemeral-storage request 限制的 Pod 是如何被分配的？"></a># 有 ephemeral-storage request 限制的 Pod 是如何被分配的？</h3><p>當建立一個 Pod 時, Kubernetes scheduler 會挑選 node 來運行該 Pod。 每個 node 都有 local ephemeral storage 可提供給 Pods 的最大值。 更多資訊可參考 <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/administer-cluster/reserve-compute-resources/#node-allocatable">Node Allocatable</a></p>
<p>Scheduler 會確保被分配的容器的 request 限制小於 node 的容量</p>
<br>

<h3 id="有-ephemeral-storage-limit-限制的-Pod-是如何被分配的？"><a href="#有-ephemeral-storage-limit-限制的-Pod-是如何被分配的？" class="headerlink" title="# 有 ephemeral-storage limit 限制的 Pod 是如何被分配的？"></a># 有 ephemeral-storage limit 限制的 Pod 是如何被分配的？</h3><p>從容器等級隔離層面來說, 如果容器的可寫層 (writable layer) 以及 logs 使用量超過了儲存限制, 那們 Pod 會被殺掉。 從 Pod 等級隔離層面來說, 如果該 Pod 內的容器 ephemeral storage 使用量超過了限制, 以及該 Pods 的 emptyDir volumes 超過了限制, 該 Pod 也會被殺掉。</p>
<p>官方文件就先到這裡, 以下為針對 Memory 以及 CPU 的進一步分析</p>
<br>
<br>


<h2 id="頗析-Memory"><a href="#頗析-Memory" class="headerlink" title="# 頗析 (Memory)"></a># 頗析 (Memory)</h2><p>首先, 先針對 memory 的部分來頗析 limits 跟 requests 的詳細運作</p>
<h3 id="建立一個沒有資源限制的-pod"><a href="#建立一個沒有資源限制的-pod" class="headerlink" title="# 建立一個沒有資源限制的 pod"></a># 建立一個沒有資源限制的 pod</h3><ul>
<li>輸入<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectl run limit-test --image=busybox --<span class="hljs-built_in">command</span> -- /bin/sh -c <span class="hljs-string">&quot;while true; do sleep 2; done&quot;</span></span><br></pre></td></tr></table></figure></li>
<li>輸出<figure class="highlight plaintext hljs"><table><tr><td class="code"><pre><span class="line">deployment.apps &quot;limit-test&quot; created</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="使用-Kubectl-來驗證看看-Kubernetes-是否建立沒有資源限制的-pod"><a href="#使用-Kubectl-來驗證看看-Kubernetes-是否建立沒有資源限制的-pod" class="headerlink" title="# 使用 Kubectl 來驗證看看 Kubernetes 是否建立沒有資源限制的 pod"></a># 使用 Kubectl 來驗證看看 Kubernetes 是否建立沒有資源限制的 pod</h3><ul>
<li>輸入<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectl get pods limit-test-7cff9996fc-zpjps -o=jsonpath=<span class="hljs-string">&#x27;&#123;.spec.containers[0].resources&#125;&#x27;</span></span><br></pre></td></tr></table></figure></li>
<li>輸出<figure class="highlight plaintext hljs"><table><tr><td class="code"><pre><span class="line">map[]</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="現在我們-ssh-到該-node-然後使用以下指令看看-docker-是如何運行這個容器"><a href="#現在我們-ssh-到該-node-然後使用以下指令看看-docker-是如何運行這個容器" class="headerlink" title="# 現在我們 ssh 到該 node, 然後使用以下指令看看 docker 是如何運行這個容器"></a># 現在我們 ssh 到該 node, 然後使用以下指令看看 docker 是如何運行這個容器</h3><ul>
<li>輸入以下指令取得容器名稱<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">docker ps | grep busy | <span class="hljs-built_in">cut</span> -d<span class="hljs-string">&#x27; &#x27;</span> -f1</span><br></pre></td></tr></table></figure></li>
<li>得到容器名稱<figure class="highlight plaintext hljs"><table><tr><td class="code"><pre><span class="line">5c3af3101afb</span><br></pre></td></tr></table></figure></li>
<li>輸入指令取得容器限制的 memory value<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">docker inspect 5c3af3101afb -f <span class="hljs-string">&quot;&#123;&#123;.HostConfig.Memory&#125;&#125;&quot;</span></span><br></pre></td></tr></table></figure></li>
<li>得到輸出<figure class="highlight plaintext hljs"><table><tr><td class="code"><pre><span class="line">0</span><br></pre></td></tr></table></figure></li>
<li><strong><code>.HostConfig.Memory</code></strong> 代表的意思是？<br>對應到 <code>docker run</code> 的 <a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/run/#user-memory-constraints">–memory 參數</a></li>
</ul>
<h3 id="讓我們繼續往下追-追到最終的-cgroup"><a href="#讓我們繼續往下追-追到最終的-cgroup" class="headerlink" title="# 讓我們繼續往下追, 追到最終的 cgroup"></a># 讓我們繼續往下追, 追到最終的 cgroup</h3><ul>
<li><p>取得容器 pid</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">ps ax | grep /bin/sh</span><br></pre></td></tr></table></figure></li>
<li><p>輸出</p>
<figure class="highlight plaintext hljs"><table><tr><td class="code"><pre><span class="line">9513 ?        Ss     0:00 /bin/sh -c while true; do sleep 2; done</span><br></pre></td></tr></table></figure></li>
<li><p>取得該 pid cgroup</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">sudo <span class="hljs-built_in">cat</span> /proc/9513/cgroup</span><br></pre></td></tr></table></figure></li>
<li><p>輸出</p>
<figure class="highlight plaintext hljs"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line">6:memory:/kubepods/burstable/podfbc202d3-da21-11e8-ab5e-42010a80014b/0a1b22ec1361a97c3511db37a4bae932d41b22264e5b97611748f8b662312574</span><br></pre></td></tr></table></figure></li>
</ul>
<p>(1)<strong>kubepods</strong>: 程序將會繼承所有這個 group 中的屬性<br>(2)<strong>burstable</strong>: 可參考<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/configure-pod-container/quality-service-pod/#qos-classes">burstable QOS class</a></p>
<ul>
<li>取得細節, 將上面的路徑 append 到 <code>/sys/fs/cgroups/memory</code><figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-built_in">ls</span> -l /sys/fs/cgroup/memory/kubepods/burstable/podfbc202d3-da21-11e8-ab5e-42010a80014b/0a1b22ec1361a97c3511db37a4bae932d41b22264e5b97611748f8b662312574</span><br></pre></td></tr></table></figure></li>
<li>輸出<figure class="highlight plaintext hljs"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line">-rw-r--r-- 1 root root 0 Oct 27 19:53 memory.limit_in_bytes</span><br><span class="line">-rw-r--r-- 1 root root 0 Oct 27 19:53 memory.soft_limit_in_bytes</span><br></pre></td></tr></table></figure></li>
</ul>
<br>
    
<h3 id="先來看-memory-limit-in-bytes-這是設定-memory-limit-的-cgroup-他等同於-docker-裡頭的-memory-以及-Kubernetes-限制的-memory-limit"><a href="#先來看-memory-limit-in-bytes-這是設定-memory-limit-的-cgroup-他等同於-docker-裡頭的-memory-以及-Kubernetes-限制的-memory-limit" class="headerlink" title="# 先來看 memory.limit_in_bytes, 這是設定 memory limit 的 cgroup, 他等同於 docker 裡頭的 --memory, 以及 Kubernetes 限制的 memory limit"></a># 先來看 <code>memory.limit_in_bytes</code>, 這是設定 memory limit 的 cgroup, 他等同於 docker 裡頭的 <code>--memory</code>, 以及 Kubernetes 限制的 memory limit</h3><ul>
<li><p>輸入以下指令取得數值</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">sudo <span class="hljs-built_in">cat</span> /sys/fs/cgroup/memory/kubepods/burstable/podfbc202d3-da21-11e8-ab5e-42010a80014b/0a1b22ec1361a97c3511db37a4bae932d41b22264e5b97611748f8b662312574/memory.limit_in_bytes</span><br></pre></td></tr></table></figure></li>
<li><p>輸出</p>
<figure class="highlight plaintext hljs"><table><tr><td class="code"><pre><span class="line">9223372036854771712</span><br></pre></td></tr></table></figure></li>
</ul>
<p>這個數據代表沒有限制 memory, 可參考 <a target="_blank" rel="noopener" href="https://unix.stackexchange.com/questions/420906/what-is-the-value-for-the-cgroups-limit-in-bytes-if-the-memory-is-not-restricte">Stackoverflow</a><br>我們一開始在 Kubernetes 沒有設定 memory 限制, 導致 docker 建立一個 <code>HostConfig.Memory</code> 設定為 0 的容器, 最終導致這個容器的程序被放到 <code>memory.limit_in_bytes</code> 屬性設為 “no limit” 的 memory cgroup </p>
<br>
    
<h3 id="現在讓我們來建立另外一個-pod-限制-memory-limit-為-100Mi"><a href="#現在讓我們來建立另外一個-pod-限制-memory-limit-為-100Mi" class="headerlink" title="# 現在讓我們來建立另外一個 pod, 限制 memory limit 為 100Mi"></a># 現在讓我們來建立另外一個 pod, 限制 memory limit 為 100Mi</h3><ul>
<li>執行以下指令<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectl run limit-test --image=busybox --limits <span class="hljs-string">&quot;memory=100Mi&quot;</span> --<span class="hljs-built_in">command</span> -- /bin/sh -c <span class="hljs-string">&quot;while true; do sleep 2; done&quot;</span></span><br></pre></td></tr></table></figure></li>
<li>輸出<figure class="highlight plaintext hljs"><table><tr><td class="code"><pre><span class="line">deployment.apps &quot;limit-test&quot; created</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="驗證這個-pod-有被設置特定的-limit"><a href="#驗證這個-pod-有被設置特定的-limit" class="headerlink" title="# 驗證這個 pod 有被設置特定的 limit"></a># 驗證這個 pod 有被設置特定的 limit</h3><ul>
<li><p>執行以下指令</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectl get pods limit-test-5f5c7dc87d-8qtdx -o=jsonpath=<span class="hljs-string">&#x27;&#123;.spec.containers[0].resources&#125;&#x27;</span></span><br></pre></td></tr></table></figure></li>
<li><p>輸出</p>
<figure class="highlight plaintext hljs"><table><tr><td class="code"><pre><span class="line">map[limits:map[memory:100Mi] requests:map[memory:100Mi]]</span><br></pre></td></tr></table></figure></li>
</ul>
<p>這邊可以看到, 如果我們有設置 limits resource, 但是沒設置 requests resource 的時候, Kubernetes 預設將 requests 設為 limits</p>
<br>

<h3 id="取得容器-id"><a href="#取得容器-id" class="headerlink" title="# 取得容器 id"></a># 取得容器 id</h3><ul>
<li><p>執行以下指令</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">docker ps | grep busy | <span class="hljs-built_in">cut</span> -d<span class="hljs-string">&#x27; &#x27;</span> -f1</span><br></pre></td></tr></table></figure></li>
<li><p>輸出</p>
<figure class="highlight plaintext hljs"><table><tr><td class="code"><pre><span class="line">8fec6c7b6119</span><br></pre></td></tr></table></figure></li>
</ul>
<br>
    
<h3 id="取得容器-pid"><a href="#取得容器-pid" class="headerlink" title="# 取得容器 pid"></a># 取得容器 pid</h3><ul>
<li>輸入以下指令<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">ps ax | grep /bin/sh</span><br></pre></td></tr></table></figure></li>
<li>輸出<figure class="highlight plaintext hljs"><table><tr><td class="code"><pre><span class="line">29532 ?      Ss     0:00 /bin/sh -c while true; do sleep 2; done</span><br></pre></td></tr></table></figure></li>
</ul>
<br>
    
<h3 id="取得該容器的-memory-cgroup"><a href="#取得該容器的-memory-cgroup" class="headerlink" title="# 取得該容器的 memory cgroup"></a># 取得該容器的 memory cgroup</h3><ul>
<li>輸入以下指令<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">sudo <span class="hljs-built_in">cat</span> /proc/29532/cgroup</span><br></pre></td></tr></table></figure></li>
<li>輸出<figure class="highlight plaintext hljs"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line">6:memory:/kubepods/burstable/pod88f89108-daf7-11e8-b1e1-42010a800070/8fec6c7b61190e74cd9f88286181dd5fa3bbf9cf33c947574eb61462bc254d11</span><br></pre></td></tr></table></figure></li>
</ul>
<br>
    
<h3 id="印出-memory-cgroup-中的-memory-limit-in-bytes-數值"><a href="#印出-memory-cgroup-中的-memory-limit-in-bytes-數值" class="headerlink" title="# 印出 memory cgroup 中的 memory.limit_in_bytes 數值"></a># 印出 memory cgroup 中的 <code>memory.limit_in_bytes</code> 數值</h3><ul>
<li>輸入以下指令<figure class="highlight plaintext hljs"><table><tr><td class="code"><pre><span class="line">sudo cat /sys/fs/cgroup/memory/kubepods/burstable/pod88f89108-daf7-11e8-b1e1-42010a800070/8fec6c7b61190e74cd9f88286181dd5fa3bbf9cf33c947574eb61462bc254d11/memory.limit_in_bytes</span><br></pre></td></tr></table></figure></li>
<li>輸出<figure class="highlight plaintext hljs"><table><tr><td class="code"><pre><span class="line">104857600</span><br></pre></td></tr></table></figure></li>
</ul>
<br>

<h3 id="最後-讓我們來看看前面跳過的-位於-memory-cgroup-當中的-momery-soft-limit-in-bytes"><a href="#最後-讓我們來看看前面跳過的-位於-memory-cgroup-當中的-momery-soft-limit-in-bytes" class="headerlink" title="# 最後, 讓我們來看看前面跳過的, 位於 memory cgroup 當中的 momery.soft_limit_in_bytes"></a># 最後, 讓我們來看看前面跳過的, 位於 memory cgroup 當中的 <code>momery.soft_limit_in_bytes</code></h3><ul>
<li>輸入以下指令<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">sudo <span class="hljs-built_in">cat</span> /sys/fs/cgroup/memory/kubepods/burstable/pod88f89108-daf7-11e8-b1e1-42010a800070/8fec6c7b61190e74cd9f88286181dd5fa3bbf9cf33c947574eb61462bc254d11/memory.soft_limit_in_bytes</span><br></pre></td></tr></table></figure></li>
<li>輸出<figure class="highlight plaintext hljs"><table><tr><td class="code"><pre><span class="line">9223372036854771712</span><br></pre></td></tr></table></figure>
從上面的值可以得知, 就算我們有設定 requests 的限制, kubernetes 也不會命令 docker 去做這件事, 儘管 docker run 的參數 <code>--memory-reservation</code> 是可以做到這件事的</li>
</ul>
<br>
<br>
    
<h2 id="頗析-CPU"><a href="#頗析-CPU" class="headerlink" title="# 頗析 (CPU)"></a># 頗析 (CPU)</h2><p>CPU 的頗析模式大致上與 memory 相同, 但還是有不一樣的地方, 讓我們繼續看下去。</p>
<h3 id="建立一個有-request-CPU-限制的-pod"><a href="#建立一個有-request-CPU-限制的-pod" class="headerlink" title="# 建立一個有 request CPU 限制的 pod"></a># 建立一個有 <code>request CPU</code> 限制的 pod</h3><ul>
<li>輸入以下指令建立 pod<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectl run limit-test --image=busybox --requests <span class="hljs-string">&quot;cpu=50m&quot;</span> --<span class="hljs-built_in">command</span> -- /bin/sh -c <span class="hljs-string">&quot;while true; do sleep 2; done&quot;</span></span><br></pre></td></tr></table></figure></li>
<li>輸出<figure class="highlight plaintext hljs"><table><tr><td class="code"><pre><span class="line">deployment.apps &quot;limit-test&quot; created</span><br></pre></td></tr></table></figure></li>
</ul>
<br>
    
<h3 id="使用-kubectl-來檢視-pod-的資源限制資訊"><a href="#使用-kubectl-來檢視-pod-的資源限制資訊" class="headerlink" title="# 使用 kubectl 來檢視 pod 的資源限制資訊"></a># 使用 kubectl 來檢視 pod 的資源限制資訊</h3><ul>
<li>輸入以下指令<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectl get pods limit-test-5b4c495556-p2xkr -o=jsonpath=<span class="hljs-string">&#x27;&#123;.spec.containers[0].resources&#125;&#x27;</span></span><br></pre></td></tr></table></figure></li>
<li>輸出<figure class="highlight plaintext hljs"><table><tr><td class="code"><pre><span class="line">map[requests:map[cpu:50m]]</span><br></pre></td></tr></table></figure>
從輸出可看到 kubernetes 有確實的設定 request 資源限制</li>
</ul>
<br>
    
<h3 id="取得容器-id-1"><a href="#取得容器-id-1" class="headerlink" title="# 取得容器 id"></a># 取得容器 id</h3><ul>
<li>輸入以下指令<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">docker ps | grep busy | <span class="hljs-built_in">cut</span> -d<span class="hljs-string">&#x27; &#x27;</span> -f1</span><br></pre></td></tr></table></figure></li>
<li>輸出<figure class="highlight plaintext hljs"><table><tr><td class="code"><pre><span class="line">f2321226620e</span><br></pre></td></tr></table></figure></li>
</ul>
<br>
    
<h3 id="查看-Docker-是否確實設定資源限制"><a href="#查看-Docker-是否確實設定資源限制" class="headerlink" title="# 查看 Docker 是否確實設定資源限制"></a># 查看 Docker 是否確實設定資源限制</h3><ul>
<li>輸入以下指令<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">docker inspect f2321226620e --format <span class="hljs-string">&#x27;&#123;&#123;.HostConfig.CpuShares&#125;&#125;&#x27;</span></span><br></pre></td></tr></table></figure></li>
<li>輸出<figure class="highlight plaintext hljs"><table><tr><td class="code"><pre><span class="line">51</span><br></pre></td></tr></table></figure>
為什麼不是 50? 那是因為 Docker 以及 cgroup 都將 core 分成 1024 份, 而 Kubernetes 則是分成 1000 份</li>
</ul>
<br>
    
<h3 id="取得容器-pid-1"><a href="#取得容器-pid-1" class="headerlink" title="# 取得容器 pid"></a># 取得容器 pid</h3><ul>
<li>輸入以下指令<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">ps ax | grep /bin/sh</span><br></pre></td></tr></table></figure></li>
<li>輸出<figure class="highlight plaintext hljs"><table><tr><td class="code"><pre><span class="line">60554 ?      Ss     0:00 /bin/sh -c while true; do sleep 2; done</span><br></pre></td></tr></table></figure></li>
</ul>
<br>
    
<h3 id="取得容器的-CPU-cgroup"><a href="#取得容器的-CPU-cgroup" class="headerlink" title="# 取得容器的 CPU cgroup"></a># 取得容器的 CPU cgroup</h3><ul>
<li>輸入以下指令<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">sudo <span class="hljs-built_in">cat</span> /proc/60554/cgroup</span><br></pre></td></tr></table></figure></li>
<li>輸出<figure class="highlight plaintext hljs"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line">4:cpu,cpuacct:/kubepods/burstable/pode12b33b1-db07-11e8-b1e1-42010a800070/3be263e7a8372b12d2f8f8f9b4251f110b79c2a3bb9e6857b2f1473e640e8e75</span><br></pre></td></tr></table></figure></li>
</ul>
<br>
    
<h3 id="取得-cgroup-屬性"><a href="#取得-cgroup-屬性" class="headerlink" title="# 取得 cgroup 屬性"></a># 取得 cgroup 屬性</h3><ul>
<li>輸入以下指令<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-built_in">ls</span> -l /sys/fs/cgroup/cpu,cpuacct/kubepods/burstable/pode12b33b1-db07-11e8-b1e1-42010a800070/3be263e7a8372b12d2f8f8f9b4251f110b79c2a3bb9e6857b2f1473e640e8e75</span><br></pre></td></tr></table></figure></li>
<li>輸出<figure class="highlight plaintext hljs"><table><tr><td class="code"><pre><span class="line">total 0</span><br><span class="line">drwxr-xr-x 2 root root 0 Oct 28 23:19 .</span><br><span class="line">drwxr-xr-x 4 root root 0 Oct 28 23:19 ..</span><br><span class="line">...</span><br><span class="line">-rw-r--r-- 1 root root 0 Oct 28 23:19 cpu.shares</span><br></pre></td></tr></table></figure>
以上輸出可知, Docker 的 <code>HostConfig.CpuShares</code> 屬性映射到 cgroup 的 <code>cpu.shares</code> 屬性</li>
</ul>
<br>
    
<h3 id="取得-cpu-shares-的值"><a href="#取得-cpu-shares-的值" class="headerlink" title="# 取得 cpu.shares 的值"></a># 取得 <code>cpu.shares</code> 的值</h3><ul>
<li>輸入以下指令<figure class="highlight plaintext hljs"><table><tr><td class="code"><pre><span class="line">/sys/fs/cgroup/cpu,cpuacct/kubepods/burstable/podb5c03ddf-db10-11e8-b1e1-42010a800070/64b5f1b636dafe6635ddd321c5b36854a8add51931c7117025a694281fb11444/cpu.shares</span><br></pre></td></tr></table></figure></li>
<li>輸出<figure class="highlight plaintext hljs"><table><tr><td class="code"><pre><span class="line">51</span><br></pre></td></tr></table></figure>
咦, 以上的行為跟 memory 不太一樣對吧? 限制 memory 的 resource limit 是不會作用到 cgroup 的 soft limits 的</li>
</ul>
<br>

<h3 id="接下來-建立一個有著-limit-resource-的-pod"><a href="#接下來-建立一個有著-limit-resource-的-pod" class="headerlink" title="# 接下來, 建立一個有著 limit resource 的 pod"></a># 接下來, 建立一個有著 <code>limit resource</code> 的 pod</h3><ul>
<li>輸入以下指令<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectl run limit-test --image=busybox --requests <span class="hljs-string">&quot;cpu=50m&quot;</span> --limits <span class="hljs-string">&quot;cpu=100m&quot;</span> --<span class="hljs-built_in">command</span> -- /bin/sh -c <span class="hljs-string">&quot;while true; do</span></span><br><span class="line"><span class="hljs-string">sleep 2; done&quot;</span></span><br></pre></td></tr></table></figure></li>
<li>輸出<figure class="highlight plaintext hljs"><table><tr><td class="code"><pre><span class="line">deployment.apps &quot;limit-test&quot; created</span><br></pre></td></tr></table></figure></li>
</ul>
<br>
    
<h3 id="使用-kubectl-來檢視第二個-pod-的資源限制資訊"><a href="#使用-kubectl-來檢視第二個-pod-的資源限制資訊" class="headerlink" title="# 使用 kubectl 來檢視第二個 pod 的資源限制資訊"></a># 使用 kubectl 來檢視第二個 pod 的資源限制資訊</h3><ul>
<li>輸入以下指令<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectl get pods limit-test-5b4fb64549-qpd4n -o=jsonpath=<span class="hljs-string">&#x27;&#123;.spec.containers[0].resources&#125;&#x27;</span></span><br></pre></td></tr></table></figure></li>
<li>輸出<figure class="highlight plaintext hljs"><table><tr><td class="code"><pre><span class="line">map[limits:map[cpu:100m] requests:map[cpu:50m]]</span><br></pre></td></tr></table></figure>
從輸出可看到 kubernetes 有確實的設定 request 資源限制</li>
</ul>
<br>
    
<h3 id="取得第二個容器-id"><a href="#取得第二個容器-id" class="headerlink" title="# 取得第二個容器 id"></a># 取得第二個容器 id</h3><ul>
<li>輸入以下指令<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">docker ps | grep busy | <span class="hljs-built_in">cut</span> -d<span class="hljs-string">&#x27; &#x27;</span> -f1</span><br></pre></td></tr></table></figure></li>
<li>輸出<figure class="highlight plaintext hljs"><table><tr><td class="code"><pre><span class="line">f2321226620e</span><br></pre></td></tr></table></figure></li>
</ul>
<br>
    
<h3 id="查看-Docker-是否確實設定資源限制-1"><a href="#查看-Docker-是否確實設定資源限制-1" class="headerlink" title="# 查看 Docker 是否確實設定資源限制"></a># 查看 Docker 是否確實設定資源限制</h3><ul>
<li>輸入以下指令<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">docker inspect 472abbce32a5 --format <span class="hljs-string">&#x27;&#123;&#123;.HostConfig.CpuShares&#125;&#125; &#123;&#123;.HostConfig.CpuQuota&#125;&#125; &#123;&#123;.HostConfig.CpuPeriod&#125;&#125;&#x27;</span></span><br></pre></td></tr></table></figure></li>
<li>輸出<figure class="highlight plaintext hljs"><table><tr><td class="code"><pre><span class="line">51 10000 100000</span><br></pre></td></tr></table></figure></li>
</ul>
<p>Dokcer 使用了兩個值來代表 memory resource limit, <code>HostConfig.CpuPeriod</code> 跟 <code>HostConfig.CpuQuota</code>, 而這兩個值又分別映射到 cgroup 的兩個屬性 <code>cpu.cfs_period_us</code> 跟 <code>cpu.cfs_quota_us</code></p>
<br>
    
<h3 id="取得-cpu-cfs-period-us-跟-cpu-cfs-quota-us-的值"><a href="#取得-cpu-cfs-period-us-跟-cpu-cfs-quota-us-的值" class="headerlink" title="# 取得 cpu.cfs_period_us 跟 cpu.cfs_quota_us 的值"></a># 取得 <code>cpu.cfs_period_us</code> 跟 <code>cpu.cfs_quota_us</code> 的值</h3><ul>
<li>輸入以下指令<figure class="highlight plaintext hljs"><table><tr><td class="code"><pre><span class="line">sudo cat /sys/fs/cgroup/cpu,cpuacct/kubepods/burstable/pod2f1b50b6-db13-11e8-b1e1-42010a800070/f0845c65c3073e0b7b0b95ce0c1eb27f69d12b1fe2382b50096c4b59e78cdf71/cpu.cfs_period_us</span><br></pre></td></tr></table></figure></li>
<li>輸出<figure class="highlight plaintext hljs"><table><tr><td class="code"><pre><span class="line">100000</span><br></pre></td></tr></table></figure></li>
<li>輸入以下指令<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">sudo <span class="hljs-built_in">cat</span> /sys/fs/cgroup/cpu,cpuacct/kubepods/burstable/pod2f1b50b6-db13-11e8-b1e1-42010a800070/f0845c65c3073e0b7b0b95ce0c1eb27f69d12b1fe2382b50096c4b59e78cdf71/cpu.cfs_quota_us</span><br></pre></td></tr></table></figure></li>
<li>輸出<figure class="highlight plaintext hljs"><table><tr><td class="code"><pre><span class="line">10000</span><br></pre></td></tr></table></figure></li>
</ul>
<br>
    
<h3 id="CPU-頗析的總結"><a href="#CPU-頗析的總結" class="headerlink" title="# CPU 頗析的總結"></a># CPU 頗析的總結</h3><ul>
<li>period 為百萬分之一秒</li>
<li>quota 為程序容許在 period 中可調動的 CPU</li>
<li>100 m 就剛好是 1/10 core, 也是 10000/100000 百萬分之一秒</li>
<li>CPU 的資源限制中, request 是會作用到 cgroup 的, 該種類在 memory 是不會作用到 cgroup 的</li>
</ul>
<br>
<br>

<h2 id="以下是幫助釐清觀念的-Q-amp-A"><a href="#以下是幫助釐清觀念的-Q-amp-A" class="headerlink" title="# 以下是幫助釐清觀念的 Q&amp;A"></a># 以下是幫助釐清觀念的 Q&amp;A</h2><h6 id="以下的-Kubernetes-範例輸出中-為什麼-node-的可用資源比-node-的-capacity-少？"><a href="#以下的-Kubernetes-範例輸出中-為什麼-node-的可用資源比-node-的-capacity-少？" class="headerlink" title="以下的 Kubernetes 範例輸出中, 為什麼 node 的可用資源比 node 的 capacity 少？"></a><strong>以下的 Kubernetes 範例輸出中, 為什麼 node 的可用資源比 node 的 capacity 少？</strong></h6><ul>
<li><strong>Example</strong>:<figure class="highlight plaintext hljs"><table><tr><td class="code"><pre><span class="line">Name:            e2e-test-node-pool-4lw4</span><br><span class="line">[ ... lines removed for clarity ...]</span><br><span class="line">Capacity:</span><br><span class="line"> cpu:                               2</span><br><span class="line"> memory:                            7679792Ki</span><br><span class="line"> pods:                              110</span><br><span class="line">Allocatable:</span><br><span class="line"> cpu:                               1800m</span><br><span class="line"> memory:                            7474992Ki</span><br><span class="line"> pods:                              110</span><br><span class="line">[ ... lines removed for clarity ...]</span><br><span class="line">Non-terminated Pods:        (5 in total)</span><br><span class="line">  Namespace    Name                                  CPU Requests  CPU Limits  Memory Requests  Memory Limits</span><br><span class="line">  ---------    ----                                  ------------  ----------  ---------------  -------------</span><br><span class="line">  kube-system  fluentd-gcp-v1.38-28bv1               100m (5%)     0 (0%)      200Mi (2%)       200Mi (2%)</span><br><span class="line">  kube-system  kube-dns-3297075139-61lj3             260m (13%)    0 (0%)      100Mi (1%)       170Mi (2%)</span><br><span class="line">  kube-system  kube-proxy-e2e-test-...               100m (5%)     0 (0%)      0 (0%)           0 (0%)</span><br><span class="line">  kube-system  monitoring-influxdb-grafana-v4-z1m12  200m (10%)    200m (10%)  600Mi (8%)       600Mi (8%)</span><br><span class="line">  kube-system  node-problem-detector-v0.1-fj7m3      20m (1%)      200m (10%)  20Mi (0%)        100Mi (1%)</span><br><span class="line">Allocated resources:</span><br><span class="line">  (Total limits may be over 100 percent, i.e., overcommitted.)</span><br><span class="line">  CPU Requests    CPU Limits    Memory Requests    Memory Limits</span><br><span class="line">  ------------    ----------    ---------------    -------------</span><br><span class="line">  680m (34%)      400m (20%)    920Mi (12%)        1070Mi (14%)</span><br></pre></td></tr></table></figure></li>
<li><strong>Answer</strong>:<br>因為系統 daemons 使用了一部分的資源</li>
</ul>
<h6 id="以下的-Kubernetes-範例輸出中-requests-CPU-Request-限制還有多少-quota-可分配？"><a href="#以下的-Kubernetes-範例輸出中-requests-CPU-Request-限制還有多少-quota-可分配？" class="headerlink" title="以下的 Kubernetes 範例輸出中, requests CPU Request 限制還有多少 quota 可分配？"></a><strong>以下的 Kubernetes 範例輸出中, requests CPU Request 限制還有多少 quota 可分配？</strong></h6><ul>
<li><strong>Example</strong>:<figure class="highlight plaintext hljs"><table><tr><td class="code"><pre><span class="line">Name:            e2e-test-node-pool-4lw4</span><br><span class="line">[ ... lines removed for clarity ...]</span><br><span class="line">Capacity:</span><br><span class="line"> cpu:                               2</span><br><span class="line"> memory:                            7679792Ki</span><br><span class="line"> pods:                              110</span><br><span class="line">Allocatable:</span><br><span class="line"> cpu:                               1800m</span><br><span class="line"> memory:                            7474992Ki</span><br><span class="line"> pods:                              110</span><br><span class="line">[ ... lines removed for clarity ...]</span><br><span class="line">Non-terminated Pods:        (5 in total)</span><br><span class="line">  Namespace    Name                                  CPU Requests  CPU Limits  Memory Requests  Memory Limits</span><br><span class="line">  ---------    ----                                  ------------  ----------  ---------------  -------------</span><br><span class="line">  kube-system  fluentd-gcp-v1.38-28bv1               100m (5%)     0 (0%)      200Mi (2%)       200Mi (2%)</span><br><span class="line">  kube-system  kube-dns-3297075139-61lj3             260m (13%)    0 (0%)      100Mi (1%)       170Mi (2%)</span><br><span class="line">  kube-system  kube-proxy-e2e-test-...               100m (5%)     0 (0%)      0 (0%)           0 (0%)</span><br><span class="line">  kube-system  monitoring-influxdb-grafana-v4-z1m12  200m (10%)    200m (10%)  600Mi (8%)       600Mi (8%)</span><br><span class="line">  kube-system  node-problem-detector-v0.1-fj7m3      20m (1%)      200m (10%)  20Mi (0%)        100Mi (1%)</span><br><span class="line">Allocated resources:</span><br><span class="line">  (Total limits may be over 100 percent, i.e., overcommitted.)</span><br><span class="line">  CPU Requests    CPU Limits    Memory Requests    Memory Limits</span><br><span class="line">  ------------    ----------    ---------------    -------------</span><br><span class="line">  680m (34%)      400m (20%)    920Mi (12%)        1070Mi (14%)</span><br></pre></td></tr></table></figure></li>
<li><strong>Answer</strong>:<br>1800m - 680m = 1120m</li>
</ul>
<h6 id="Kubernetes-中-每次當-Scheduler-無法在-node-上找到足夠的資源來置放-Pod-時-都會產生一個什麼事件？"><a href="#Kubernetes-中-每次當-Scheduler-無法在-node-上找到足夠的資源來置放-Pod-時-都會產生一個什麼事件？" class="headerlink" title="Kubernetes 中, 每次當 Scheduler 無法在 node 上找到足夠的資源來置放 Pod 時, 都會產生一個什麼事件？"></a><strong>Kubernetes 中, 每次當 Scheduler 無法在 node 上找到足夠的資源來置放 Pod 時, 都會產生一個什麼事件？</strong></h6><figure class="highlight plaintext hljs"><table><tr><td class="code"><pre><span class="line">Events:</span><br><span class="line">  FirstSeen LastSeen   Count  From          Subobject   PathReason      Message</span><br><span class="line">  36s   5s     6      &#123;scheduler &#125;              FailedScheduling  Failed for reason PodExceedsFreeCPU and possibly others</span><br></pre></td></tr></table></figure>

<h6 id="Kubernetes-的可計算資源管理中-所指定的資源配額是絕對數字還是相對數字？"><a href="#Kubernetes-的可計算資源管理中-所指定的資源配額是絕對數字還是相對數字？" class="headerlink" title="Kubernetes 的可計算資源管理中, 所指定的資源配額是絕對數字還是相對數字？"></a><strong>Kubernetes 的可計算資源管理中, 所指定的資源配額是絕對數字還是相對數字？</strong></h6><p>絕對數字</p>
<h6 id="Kubernetes-compute-resource-management-中-如果我-CPU-設為-0-1-在單核-雙核-甚至-48核的機器中-代表的量會有所不同嗎？"><a href="#Kubernetes-compute-resource-management-中-如果我-CPU-設為-0-1-在單核-雙核-甚至-48核的機器中-代表的量會有所不同嗎？" class="headerlink" title="Kubernetes compute resource management 中, 如果我 CPU 設為 0.1, 在單核, 雙核, 甚至 48核的機器中, 代表的量會有所不同嗎？"></a><strong>Kubernetes compute resource management 中, 如果我 CPU 設為 <code>0.1</code>, 在單核, 雙核, 甚至 48核的機器中, 代表的量會有所不同嗎？</strong></h6><p>不會哦</p>
<h6 id="什麼是-TLB"><a href="#什麼是-TLB" class="headerlink" title="什麼是 TLB?"></a><strong>什麼是 TLB?</strong></h6><p>Translation lookaside buffer, 緩存虛擬記憶體到實體記憶體的 mapping</p>
<h6 id="在-Linux-系統中-虛擬記憶體管理系統中-最小的-memory-單位是什麼？"><a href="#在-Linux-系統中-虛擬記憶體管理系統中-最小的-memory-單位是什麼？" class="headerlink" title="在 Linux 系統中, 虛擬記憶體管理系統中, 最小的 memory 單位是什麼？"></a><strong>在 Linux 系統中, 虛擬記憶體管理系統中, 最小的 memory 單位是什麼？</strong></h6><p>page</p>
<h6 id="Kubernetes-resource-limit-management-中-huge-page-是什麼"><a href="#Kubernetes-resource-limit-management-中-huge-page-是什麼" class="headerlink" title="Kubernetes resource limit management 中, huge page 是什麼?"></a><strong>Kubernetes resource limit management 中, huge page 是什麼?</strong></h6><p>size 較大的 page</p>
<h6 id="Kubernetes-中-如果一個-Pod-卡在-pending-status-那很有可能是甚麼原因？"><a href="#Kubernetes-中-如果一個-Pod-卡在-pending-status-那很有可能是甚麼原因？" class="headerlink" title="Kubernetes 中, 如果一個 Pod 卡在 pending status, 那很有可能是甚麼原因？"></a><strong>Kubernetes 中, 如果一個 Pod 卡在 pending status, 那很有可能是甚麼原因？</strong></h6><p>沒有 Node 有足夠的資源來運行這個 Pod</p>
<h6 id="Kubernetes-中-Resource-的限制可分為-CPU-以及-Memory-限制類型主要分成哪兩種？"><a href="#Kubernetes-中-Resource-的限制可分為-CPU-以及-Memory-限制類型主要分成哪兩種？" class="headerlink" title="Kubernetes 中, Resource 的限制可分為 CPU 以及 Memory, 限制類型主要分成哪兩種？"></a><strong>Kubernetes 中, Resource 的限制可分為 CPU 以及 Memory, 限制類型主要分成哪兩種？</strong></h6><ul>
<li>Request</li>
<li>Limit</li>
</ul>
<h6 id="Kubernetes-Resource-的限制又可分為-requests-以及-limits-兩大類-request-主要代表的是？"><a href="#Kubernetes-Resource-的限制又可分為-requests-以及-limits-兩大類-request-主要代表的是？" class="headerlink" title="Kubernetes Resource 的限制又可分為 requests 以及 limits 兩大類, request 主要代表的是？"></a><strong>Kubernetes Resource 的限制又可分為 requests 以及 limits 兩大類, request 主要代表的是？</strong></h6><p>這個 Pod 正常需要多少的資源可以正常運行</p>
<h6 id="Kubernetes-Resource-的限制又可分為-requests-以及-limits-兩大類-在-Kubernetes-各元件當中-request-resource-對哪一個元件格外重要？"><a href="#Kubernetes-Resource-的限制又可分為-requests-以及-limits-兩大類-在-Kubernetes-各元件當中-request-resource-對哪一個元件格外重要？" class="headerlink" title="Kubernetes Resource 的限制又可分為 requests 以及 limits 兩大類, 在 Kubernetes 各元件當中, request resource 對哪一個元件格外重要？"></a><strong>Kubernetes Resource 的限制又可分為 requests 以及 limits 兩大類, 在 Kubernetes 各元件當中, request resource 對哪一個元件格外重要？</strong></h6><p>scheduler</p>
<h6 id="Kubernetes-Resource-的限制又可分為-requests-以及-limits-兩大類-在-Kubernetes-各元件當中-limit-resource-對哪一個元件格外重要？"><a href="#Kubernetes-Resource-的限制又可分為-requests-以及-limits-兩大類-在-Kubernetes-各元件當中-limit-resource-對哪一個元件格外重要？" class="headerlink" title="Kubernetes Resource 的限制又可分為 requests 以及 limits 兩大類, 在 Kubernetes 各元件當中, limit resource 對哪一個元件格外重要？"></a><strong>Kubernetes Resource 的限制又可分為 requests 以及 limits 兩大類, 在 Kubernetes 各元件當中, limit resource 對哪一個元件格外重要？</strong></h6><p>kubelet</p>
<h6 id="Kubernetes-Resource-的限制又可分為-requests-以及-limits-兩大類-當-Scheduler-在選擇要在哪一個-Node-上面運行-Pod-時-主要會考量哪一種類？"><a href="#Kubernetes-Resource-的限制又可分為-requests-以及-limits-兩大類-當-Scheduler-在選擇要在哪一個-Node-上面運行-Pod-時-主要會考量哪一種類？" class="headerlink" title="Kubernetes Resource 的限制又可分為 requests 以及 limits 兩大類, 當 Scheduler 在選擇要在哪一個 Node 上面運行 Pod 時, 主要會考量哪一種類？"></a><strong>Kubernetes Resource 的限制又可分為 requests 以及 limits 兩大類, 當 Scheduler 在選擇要在哪一個 Node 上面運行 Pod 時, 主要會考量哪一種類？</strong></h6><p>request</p>
<h6 id="Kubernetes-Resource-的限制又可分為-requests-以及-limits-兩大類-當-Scheduler-跟-request-的關係是？"><a href="#Kubernetes-Resource-的限制又可分為-requests-以及-limits-兩大類-當-Scheduler-跟-request-的關係是？" class="headerlink" title="Kubernetes Resource 的限制又可分為 requests 以及 limits 兩大類, 當 Scheduler 跟 request 的關係是？"></a><strong>Kubernetes Resource 的限制又可分為 requests 以及 limits 兩大類, 當 Scheduler 跟 request 的關係是？</strong></h6><p>Scheduler 會選擇有足夠資源 (request 要求的資源) 的 node 來運行該 pod</p>
<h6 id="以下的-Kubernetes-yaml-檔所代表的意思是"><a href="#以下的-Kubernetes-yaml-檔所代表的意思是" class="headerlink" title="以下的 Kubernetes yaml 檔所代表的意思是?"></a><strong>以下的 Kubernetes yaml 檔所代表的意思是?</strong></h6><ul>
<li><strong>yaml 檔</strong>:<figure class="highlight yaml hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-attr">resources:</span></span><br><span class="line">  <span class="hljs-attr">requests:</span></span><br><span class="line">    <span class="hljs-attr">cpu:</span> <span class="hljs-string">50m</span></span><br><span class="line">    <span class="hljs-attr">memory:</span> <span class="hljs-string">50Mi</span></span><br><span class="line">  <span class="hljs-attr">limits:</span></span><br><span class="line">    <span class="hljs-attr">cpu:</span> <span class="hljs-string">100m</span></span><br><span class="line">    <span class="hljs-attr">memory:</span> <span class="hljs-string">100Mi</span></span><br></pre></td></tr></table></figure></li>
<li><strong>Answer</strong>:<figure class="highlight yaml hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-comment"># 定義資源限制</span></span><br><span class="line"><span class="hljs-attr">resources:</span></span><br><span class="line">  <span class="hljs-comment"># 定義 requests 種類限制, scheduler 會選擇有足夠 request 資源的 Node 來運行該 Pod</span></span><br><span class="line">  <span class="hljs-attr">requests:</span></span><br><span class="line">    <span class="hljs-attr">cpu:</span> <span class="hljs-string">50m</span></span><br><span class="line">    <span class="hljs-attr">memory:</span> <span class="hljs-string">50Mi</span></span><br><span class="line">  <span class="hljs-comment"># 定義 limits 種類限制, Kubelet 會根據 limits 資源來決定是否重啟該 Pod</span></span><br><span class="line">  <span class="hljs-attr">limits:</span></span><br><span class="line">    <span class="hljs-attr">cpu:</span> <span class="hljs-string">100m</span></span><br><span class="line">    <span class="hljs-attr">memory:</span> <span class="hljs-string">100Mi</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h6 id="Kubernetes-中-1-MiB-等於多少？"><a href="#Kubernetes-中-1-MiB-等於多少？" class="headerlink" title="Kubernetes 中, 1 MiB 等於多少？"></a><strong>Kubernetes 中, 1 MiB 等於多少？</strong></h6><p>1 MiB = 1024 KiB = 1024 * 1024 = 1048576 Bytes</p>
<h6 id="Kubernetes-中-1-MB-等於多少？"><a href="#Kubernetes-中-1-MB-等於多少？" class="headerlink" title="Kubernetes 中, 1 MB 等於多少？"></a><strong>Kubernetes 中, 1 MB 等於多少？</strong></h6><p>1 MB = 1000 KB = 1000 * 1000 = 1000000 Bytes</p>
<h6 id="Kubernetes-中-一個-Pod-的資源總限制是-什麼-的總和？"><a href="#Kubernetes-中-一個-Pod-的資源總限制是-什麼-的總和？" class="headerlink" title="Kubernetes 中, 一個 Pod 的資源總限制是 什麼 的總和？"></a><strong>Kubernetes 中, 一個 Pod 的資源總限制是 <code>什麼</code> 的總和？</strong></h6><p>該 Pod 內所有容器的資源限制加總</p>
<h6 id="Cgroup-的全寫是？"><a href="#Cgroup-的全寫是？" class="headerlink" title="Cgroup 的全寫是？"></a><strong>Cgroup 的全寫是？</strong></h6><p>Control Group</p>
<h6 id="Cgroup-簡單解釋"><a href="#Cgroup-簡單解釋" class="headerlink" title="Cgroup 簡單解釋?"></a><strong>Cgroup 簡單解釋?</strong></h6><p>有著一系列相關屬性的容器, 控制 kernel 如何運行程序</p>
<h6 id="Kubernetes-resource-limit-中-當我們只設置-limits-但沒設置-requests-時-會發生什麼事？"><a href="#Kubernetes-resource-limit-中-當我們只設置-limits-但沒設置-requests-時-會發生什麼事？" class="headerlink" title="Kubernetes resource limit 中, 當我們只設置 limits, 但沒設置 requests 時, 會發生什麼事？"></a><strong>Kubernetes resource limit 中, 當我們只設置 limits, 但沒設置 requests 時, 會發生什麼事？</strong></h6><p>Kubernetes 會將 requests 設為 limits 的值</p>
<h6 id="當宿主機面臨記憶體壓力時-會做什麼事？"><a href="#當宿主機面臨記憶體壓力時-會做什麼事？" class="headerlink" title="當宿主機面臨記憶體壓力時, 會做什麼事？"></a><strong>當宿主機面臨記憶體壓力時, 會做什麼事？</strong></h6><p>會殺掉程序</p>
<h6 id="當一個程序使用了超過在-cgroup-中規定的-memory-時-會發生什麼事？"><a href="#當一個程序使用了超過在-cgroup-中規定的-memory-時-會發生什麼事？" class="headerlink" title="當一個程序使用了超過在 cgroup 中規定的 memory 時, 會發生什麼事？"></a><strong>當一個程序使用了超過在 cgroup 中規定的 memory 時, 會發生什麼事？</strong></h6><p>該程序會被列入要殺掉的優先名單中</p>
<h6 id="Server-中的-OOM-的全寫是"><a href="#Server-中的-OOM-的全寫是" class="headerlink" title="Server 中的 OOM 的全寫是??"></a><strong>Server 中的 OOM 的全寫是??</strong></h6><p>Out Of Memory</p>
<h6 id="Kubernetes-resource-limit-當中-當我設定了-requests-的限制-Kubernetes-會否要求-docker-去設定-memory-cgroup-中的-soft-limit"><a href="#Kubernetes-resource-limit-當中-當我設定了-requests-的限制-Kubernetes-會否要求-docker-去設定-memory-cgroup-中的-soft-limit" class="headerlink" title="Kubernetes resource limit 當中, 當我設定了 requests 的限制, Kubernetes 會否要求 docker 去設定 memory cgroup 中的 soft_limit?"></a><strong>Kubernetes resource limit 當中, 當我設定了 requests 的限制, Kubernetes 會否要求 docker 去設定 memory cgroup 中的 soft_limit?</strong></h6><p>不會</p>
<h6 id="Kubernetes-resource-limit-當中-requests-若設得太高會發生什麼事？"><a href="#Kubernetes-resource-limit-當中-requests-若設得太高會發生什麼事？" class="headerlink" title="Kubernetes resource limit 當中, requests 若設得太高會發生什麼事？"></a><strong>Kubernetes resource limit 當中, requests 若設得太高會發生什麼事？</strong></h6><p>可能會出現沒有 node 可以運行這個 pod, 明明這個 pod 正常不會需要這麼高的 memory</p>
<h6 id="Kubernetes-resource-limit-當中-requests-若設得太低會發生什麼事？"><a href="#Kubernetes-resource-limit-當中-requests-若設得太低會發生什麼事？" class="headerlink" title="Kubernetes resource limit 當中, requests 若設得太低會發生什麼事？"></a><strong>Kubernetes resource limit 當中, requests 若設得太低會發生什麼事？</strong></h6><p>如果一個 node 的剩餘空間已經沒有很多了, 因為 request 設得低, 所以依然會被分派到這個 node, 但該 pod 實際需要的資源遠高於 request 值, 所以該 node 面臨記憶體壓力時就會優先砍掉這個 pod</p>
<h6 id="Kubernetes-中-一個-core-為幾-m"><a href="#Kubernetes-中-一個-core-為幾-m" class="headerlink" title="Kubernetes 中, 一個 core 為幾 m?"></a><strong>Kubernetes 中, 一個 core 為幾 m?</strong></h6><p>1000 m</p>
<h6 id="Kubernetes-將一個-core-分成幾份？"><a href="#Kubernetes-將一個-core-分成幾份？" class="headerlink" title="Kubernetes 將一個 core 分成幾份？"></a><strong>Kubernetes 將一個 core 分成幾份？</strong></h6><p>1000</p>
<h6 id="Docker-將一個-core-分成幾份？"><a href="#Docker-將一個-core-分成幾份？" class="headerlink" title="Docker 將一個 core 分成幾份？"></a><strong>Docker 將一個 core 分成幾份？</strong></h6><p>1024</p>
<h6 id="CGroup-將一個-core-分成幾份？"><a href="#CGroup-將一個-core-分成幾份？" class="headerlink" title="CGroup 將一個 core 分成幾份？"></a><strong>CGroup 將一個 core 分成幾份？</strong></h6><p>1024</p>
<h6 id="Kubernetes-中-當設定-memory-的-request-limit-後-會作用到-cgroup-嗎？"><a href="#Kubernetes-中-當設定-memory-的-request-limit-後-會作用到-cgroup-嗎？" class="headerlink" title="Kubernetes 中, 當設定 memory 的 request limit 後, 會作用到 cgroup 嗎？"></a><strong>Kubernetes 中, 當設定 memory 的 request limit 後, 會作用到 cgroup 嗎？</strong></h6><p>不會</p>
<h6 id="Kubernetes-中-當設定-CPU-的-request-limit-後-會作用到-cgroup-嗎？"><a href="#Kubernetes-中-當設定-CPU-的-request-limit-後-會作用到-cgroup-嗎？" class="headerlink" title="Kubernetes 中, 當設定 CPU 的 request limit 後, 會作用到 cgroup 嗎？"></a><strong>Kubernetes 中, 當設定 CPU 的 request limit 後, 會作用到 cgroup 嗎？</strong></h6><p>會</p>
<h6 id="Kubernetes-resource-limit-中-request-resource-是由哪一個-cgroup-系統所管理的"><a href="#Kubernetes-resource-limit-中-request-resource-是由哪一個-cgroup-系統所管理的" class="headerlink" title="Kubernetes resource limit 中, request resource 是由哪一個 cgroup 系統所管理的?"></a><strong>Kubernetes resource limit 中, request resource 是由哪一個 cgroup 系統所管理的?</strong></h6><p><code>cpu shares system</code></p>
<h6 id="cgroup-cpu-cfs-period-us-中的-period-代表幾秒？"><a href="#cgroup-cpu-cfs-period-us-中的-period-代表幾秒？" class="headerlink" title="cgroup cpu.cfs_period_us 中的 period 代表幾秒？"></a><strong>cgroup <code>cpu.cfs_period_us</code> 中的 period 代表幾秒？</strong></h6><p>1/10 秒 或 100000 microseconds (百萬分之一秒)</p>
<h6 id="cgroup-cpu-cfs-quota-us-中的-quota-代表什麼？"><a href="#cgroup-cpu-cfs-quota-us-中的-quota-代表什麼？" class="headerlink" title="cgroup cpu.cfs_quota_us 中的 quota 代表什麼？"></a><strong>cgroup <code>cpu.cfs_quota_us</code> 中的 quota 代表什麼？</strong></h6><p>一個程序在 period 中容許可調用的最大值</p>
<h6 id="假如我的-CPU-request-limit-是-200m-那我的-cpu-cfs-period-us-以及-cpu-cfs-quota-us-分別是多少？"><a href="#假如我的-CPU-request-limit-是-200m-那我的-cpu-cfs-period-us-以及-cpu-cfs-quota-us-分別是多少？" class="headerlink" title="假如我的 CPU request limit 是 200m, 那我的 cpu.cfs_period_us 以及 cpu.cfs_quota_us 分別是多少？"></a><strong>假如我的 CPU request limit 是 200m, 那我的 <code>cpu.cfs_period_us</code> 以及 <code>cpu.cfs_quota_us</code> 分別是多少？</strong></h6><ul>
<li><code>cpu.cfs_period_us</code>: 100000</li>
<li><code>cpu.cfs_quota_us</code>: 20000</li>
</ul>
<h6 id="cpu-cfs-period-us-跟-cpu-cfs-quota-us-是屬於哪一個-cgroup"><a href="#cpu-cfs-period-us-跟-cpu-cfs-quota-us-是屬於哪一個-cgroup" class="headerlink" title="cpu.cfs_period_us 跟 cpu.cfs_quota_us 是屬於哪一個 cgroup?"></a><strong><code>cpu.cfs_period_us</code> 跟 <code>cpu.cfs_quota_us</code> 是屬於哪一個 cgroup?</strong></h6><p>cpu,cpuacct</p>
<h6 id="cpu-cfs-period-us-跟-cpu-cfs-quota-us-中的-cfs-的意思是"><a href="#cpu-cfs-period-us-跟-cpu-cfs-quota-us-中的-cfs-的意思是" class="headerlink" title="cpu.cfs_period_us 跟 cpu.cfs_quota_us 中的 cfs 的意思是?"></a><strong><code>cpu.cfs_period_us</code> 跟 <code>cpu.cfs_quota_us</code> 中的 cfs 的意思是?</strong></h6><p>Completely Fair Scheduler</p>
<h6 id="Linux-的預設-CPU-scheduler-是哪一個"><a href="#Linux-的預設-CPU-scheduler-是哪一個" class="headerlink" title="Linux 的預設 CPU scheduler 是哪一個?"></a><strong>Linux 的預設 CPU scheduler 是哪一個?</strong></h6><p>CFS (Completely Fair Scheduler)</p>
<h6 id="Kubernetes-中-當設定-CPU-的-request-resource-限制-會作用到-cgroup-嗎？"><a href="#Kubernetes-中-當設定-CPU-的-request-resource-限制-會作用到-cgroup-嗎？" class="headerlink" title="Kubernetes 中, 當設定 CPU 的 request resource 限制, 會作用到 cgroup 嗎？"></a><strong>Kubernetes 中, 當設定 CPU 的 request resource 限制, 會作用到 cgroup 嗎？</strong></h6><p>會哦</p>
<h6 id="Kubernetes-中-程序可以超出-CPU-request-resource-限制-規定的用量嗎？"><a href="#Kubernetes-中-程序可以超出-CPU-request-resource-限制-規定的用量嗎？" class="headerlink" title="Kubernetes 中, 程序可以超出 CPU request resource 限制 規定的用量嗎？"></a><strong>Kubernetes 中, 程序可以超出 <code>CPU request resource 限制</code> 規定的用量嗎？</strong></h6><p>不行</p>
<h6 id="Kubernetes-中-當程序使用了超過-CPU-request-resource-限制-規定的用量的話-會發生什麼事？"><a href="#Kubernetes-中-當程序使用了超過-CPU-request-resource-限制-規定的用量的話-會發生什麼事？" class="headerlink" title="Kubernetes 中, 當程序使用了超過 CPU request resource 限制 規定的用量的話, 會發生什麼事？"></a><strong>Kubernetes 中, 當程序使用了超過 <code>CPU request resource 限制</code> 規定的用量的話, 會發生什麼事？</strong></h6><p>不會有這種情況, 因為 <code>CPU request resource 限制</code> 規定的用量不允許超出</p>
<h6 id="Kubernetes-resource-limit-中-如果我只設定了-limits-但沒設定-requests-會發生什麼事？"><a href="#Kubernetes-resource-limit-中-如果我只設定了-limits-但沒設定-requests-會發生什麼事？" class="headerlink" title="Kubernetes resource limit 中, 如果我只設定了 limits, 但沒設定 requests, 會發生什麼事？"></a><strong>Kubernetes resource limit 中, 如果我只設定了 limits, 但沒設定 requests, 會發生什麼事？</strong></h6><p>requests 的預設值會被設為跟 limits 一樣</p>
<h6 id="Kubernetes-resource-limit-中-如果我只設定了-requests-但沒設定-limits-會發生什麼事？"><a href="#Kubernetes-resource-limit-中-如果我只設定了-requests-但沒設定-limits-會發生什麼事？" class="headerlink" title="Kubernetes resource limit 中, 如果我只設定了 requests, 但沒設定 limits, 會發生什麼事？"></a><strong>Kubernetes resource limit 中, 如果我只設定了 requests, 但沒設定 limits, 會發生什麼事？</strong></h6><p>scheduler 會正常根據 requests 的資源數據啟動 pod, 但該 process 的資源使用量將無法被限制</p>
<h6 id="以下的-Kubernetes-yaml-設定檔的意思是"><a href="#以下的-Kubernetes-yaml-設定檔的意思是" class="headerlink" title="以下的 Kubernetes yaml 設定檔的意思是?"></a><strong>以下的 Kubernetes yaml 設定檔的意思是?</strong></h6><ul>
<li><strong>yaml 檔</strong>:<figure class="highlight yaml hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span></span><br><span class="line"><span class="hljs-attr">kind:</span> <span class="hljs-string">LimitRange</span></span><br><span class="line"><span class="hljs-attr">metadata:</span></span><br><span class="line">  <span class="hljs-attr">name:</span> <span class="hljs-string">default-limit</span></span><br><span class="line"><span class="hljs-attr">spec:</span></span><br><span class="line">  <span class="hljs-attr">limits:</span></span><br><span class="line">  <span class="hljs-bullet">-</span> <span class="hljs-attr">default:</span></span><br><span class="line">      <span class="hljs-attr">memory:</span> <span class="hljs-string">100Mi</span></span><br><span class="line">      <span class="hljs-attr">cpu:</span> <span class="hljs-string">100m</span></span><br><span class="line">    <span class="hljs-attr">defaultRequest:</span></span><br><span class="line">      <span class="hljs-attr">memory:</span> <span class="hljs-string">50Mi</span></span><br><span class="line">      <span class="hljs-attr">cpu:</span> <span class="hljs-string">50m</span></span><br><span class="line">  <span class="hljs-bullet">-</span> <span class="hljs-attr">max:</span></span><br><span class="line">      <span class="hljs-attr">memory:</span> <span class="hljs-string">512Mi</span></span><br><span class="line">      <span class="hljs-attr">cpu:</span> <span class="hljs-string">500m</span></span><br><span class="line">  <span class="hljs-bullet">-</span> <span class="hljs-attr">min:</span></span><br><span class="line">      <span class="hljs-attr">memory:</span> <span class="hljs-string">50Mi</span></span><br><span class="line">      <span class="hljs-attr">cpu:</span> <span class="hljs-string">50m</span></span><br><span class="line">    <span class="hljs-attr">type:</span> <span class="hljs-string">Container</span></span><br></pre></td></tr></table></figure></li>
<li><strong>Answer</strong>:<figure class="highlight yaml hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-comment"># API 版本</span></span><br><span class="line"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span></span><br><span class="line"><span class="hljs-comment"># 種類為 LimitRange</span></span><br><span class="line"><span class="hljs-attr">kind:</span> <span class="hljs-string">LimitRange</span></span><br><span class="line"><span class="hljs-comment"># 該 LimitRange 的 metadata</span></span><br><span class="line"><span class="hljs-attr">metadata:</span></span><br><span class="line">  <span class="hljs-comment"># 該 LimitRange 的 name</span></span><br><span class="line">  <span class="hljs-attr">name:</span> <span class="hljs-string">default-limit</span></span><br><span class="line"><span class="hljs-comment"># 該 LimitRange 運行的規格</span></span><br><span class="line"><span class="hljs-attr">spec:</span></span><br><span class="line">  <span class="hljs-comment"># 定義 limits</span></span><br><span class="line">  <span class="hljs-attr">limits:</span></span><br><span class="line">    <span class="hljs-comment"># 預設的 resource limits, 若該 namespace 下的 pod 在建立時沒有指定資源限制, 將套用此預設設定</span></span><br><span class="line">  <span class="hljs-bullet">-</span> <span class="hljs-attr">default:</span></span><br><span class="line">      <span class="hljs-attr">memory:</span> <span class="hljs-string">100Mi</span></span><br><span class="line">      <span class="hljs-attr">cpu:</span> <span class="hljs-string">100m</span></span><br><span class="line">    <span class="hljs-comment"># 預設的 resource requested, 若該 namespace 下的 pod 在建立時沒有指定資源限制, 將套用此預設設定</span></span><br><span class="line">    <span class="hljs-attr">defaultRequest:</span></span><br><span class="line">      <span class="hljs-attr">memory:</span> <span class="hljs-string">50Mi</span></span><br><span class="line">      <span class="hljs-attr">cpu:</span> <span class="hljs-string">50m</span></span><br><span class="line">    <span class="hljs-comment"># 若欲在此 namespace 下建立 pod, 而該 pod 若指定資源限制高於此設定, 將不允許建立</span></span><br><span class="line">  <span class="hljs-bullet">-</span> <span class="hljs-attr">max:</span></span><br><span class="line">      <span class="hljs-attr">memory:</span> <span class="hljs-string">512Mi</span></span><br><span class="line">      <span class="hljs-attr">cpu:</span> <span class="hljs-string">500m</span></span><br><span class="line">    <span class="hljs-comment"># 若欲在此 namespace 下建立 pod, 而該 pod 若指定資源限制低於此設定, 將不允許建立</span></span><br><span class="line">  <span class="hljs-bullet">-</span> <span class="hljs-attr">min:</span></span><br><span class="line">      <span class="hljs-attr">memory:</span> <span class="hljs-string">50Mi</span></span><br><span class="line">      <span class="hljs-attr">cpu:</span> <span class="hljs-string">50m</span></span><br><span class="line">    <span class="hljs-comment"># 限制的類型為 container</span></span><br><span class="line">    <span class="hljs-attr">type:</span> <span class="hljs-string">Container</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h6 id="Kubernetes-request-resource-限制中-1-core-1000-m-那允許的最小設定值是多少？"><a href="#Kubernetes-request-resource-限制中-1-core-1000-m-那允許的最小設定值是多少？" class="headerlink" title="Kubernetes request resource 限制中, 1 core = 1000 m, 那允許的最小設定值是多少？"></a><strong>Kubernetes request resource 限制中, 1 core = 1000 m, 那允許的最小設定值是多少？</strong></h6><p>1m</p>
<h6 id="Kubernetes-中-要如何查看-node-有多少可用資源？"><a href="#Kubernetes-中-要如何查看-node-有多少可用資源？" class="headerlink" title="Kubernetes 中, 要如何查看 node 有多少可用資源？"></a><strong>Kubernetes 中, 要如何查看 node 有多少可用資源？</strong></h6><figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectl describe nodes nodeName</span><br></pre></td></tr></table></figure>


<h6 id="Kubernetes-中-如何知道容器有沒有因為資源達到限制而被砍掉？"><a href="#Kubernetes-中-如何知道容器有沒有因為資源達到限制而被砍掉？" class="headerlink" title="Kubernetes 中, 如何知道容器有沒有因為資源達到限制而被砍掉？"></a><strong>Kubernetes 中, 如何知道容器有沒有因為資源達到限制而被砍掉？</strong></h6><ul>
<li>取得 pod 資訊<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kube describe pod podName</span><br></pre></td></tr></table></figure></li>
<li>取得前一個 pod 被砍掉的原因<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">kubectl get pod -o go-template=<span class="hljs-string">&#x27;&#123;&#123;range.status.containerStatuses&#125;&#125;&#123;&#123;&quot;Container Name: &quot;&#125;&#125;&#123;&#123;.name&#125;&#125;&#123;&#123;&quot;\r\nLastState: &quot;&#125;&#125;&#123;&#123;.lastState&#125;&#125;&#123;&#123;end&#125;&#125;&#x27;</span>  simmemleak-hra99</span><br></pre></td></tr></table></figure></li>
</ul>
<h6 id="Kubernetes-中-local-ephemeral-storage-指的是什麼地方？"><a href="#Kubernetes-中-local-ephemeral-storage-指的是什麼地方？" class="headerlink" title="Kubernetes 中, local ephemeral storage 指的是什麼地方？"></a><strong>Kubernetes 中, local ephemeral storage 指的是什麼地方？</strong></h6><p>root partition</p>
<h6 id="Kubernetes-中-emptyDir-volumes-container-logs-image-layers-container-writable-layers-這些都是使用哪一塊空間？"><a href="#Kubernetes-中-emptyDir-volumes-container-logs-image-layers-container-writable-layers-這些都是使用哪一塊空間？" class="headerlink" title="Kubernetes 中, emptyDir volumes, container logs, image layers, container writable layers, 這些都是使用哪一塊空間？"></a><strong>Kubernetes 中, emptyDir volumes, container logs, image layers, container writable layers, 這些都是使用哪一塊空間？</strong></h6><p>root partition</p>
<h6 id="以下的-Kubernetes-yaml-檔是什麼意思呢？"><a href="#以下的-Kubernetes-yaml-檔是什麼意思呢？" class="headerlink" title="以下的 Kubernetes yaml 檔是什麼意思呢？"></a><strong>以下的 Kubernetes yaml 檔是什麼意思呢？</strong></h6><ul>
<li><strong>yaml 檔</strong><figure class="highlight yaml hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span></span><br><span class="line"><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span></span><br><span class="line"><span class="hljs-attr">metadata:</span></span><br><span class="line">  <span class="hljs-attr">name:</span> <span class="hljs-string">frontend</span></span><br><span class="line"><span class="hljs-attr">spec:</span></span><br><span class="line">  <span class="hljs-attr">containers:</span></span><br><span class="line">  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">db</span></span><br><span class="line">    <span class="hljs-attr">image:</span> <span class="hljs-string">mysql</span></span><br><span class="line">    <span class="hljs-attr">env:</span></span><br><span class="line">    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">MYSQL_ROOT_PASSWORD</span></span><br><span class="line">      <span class="hljs-attr">value:</span> <span class="hljs-string">&quot;password&quot;</span></span><br><span class="line">    <span class="hljs-attr">resources:</span></span><br><span class="line">      <span class="hljs-attr">requests:</span></span><br><span class="line">        <span class="hljs-attr">ephemeral-storage:</span> <span class="hljs-string">&quot;2Gi&quot;</span></span><br><span class="line">      <span class="hljs-attr">limits:</span></span><br><span class="line">        <span class="hljs-attr">ephemeral-storage:</span> <span class="hljs-string">&quot;4Gi&quot;</span></span><br><span class="line">  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">wp</span></span><br><span class="line">    <span class="hljs-attr">image:</span> <span class="hljs-string">wordpress</span></span><br><span class="line">    <span class="hljs-attr">resources:</span></span><br><span class="line">      <span class="hljs-attr">requests:</span></span><br><span class="line">        <span class="hljs-attr">ephemeral-storage:</span> <span class="hljs-string">&quot;2Gi&quot;</span></span><br><span class="line">      <span class="hljs-attr">limits:</span></span><br><span class="line">        <span class="hljs-attr">ephemeral-storage:</span> <span class="hljs-string">&quot;4Gi&quot;</span></span><br></pre></td></tr></table></figure></li>
<li><strong>Answer</strong>:<figure class="highlight yaml hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-comment"># API 版本</span></span><br><span class="line"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span></span><br><span class="line"><span class="hljs-comment"># 種類為 Pod</span></span><br><span class="line"><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span></span><br><span class="line"><span class="hljs-comment"># 該 Pod 的 metadata</span></span><br><span class="line"><span class="hljs-attr">metadata:</span></span><br><span class="line">  <span class="hljs-comment"># 該 Pod 的 name</span></span><br><span class="line">  <span class="hljs-attr">name:</span> <span class="hljs-string">frontend</span></span><br><span class="line"><span class="hljs-comment"># 該 pod 運行的規格</span></span><br><span class="line"><span class="hljs-attr">spec:</span></span><br><span class="line">  <span class="hljs-comment"># 定義容器規格</span></span><br><span class="line">  <span class="hljs-attr">containers:</span></span><br><span class="line">    <span class="hljs-comment"># 容器名稱</span></span><br><span class="line">  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">db</span></span><br><span class="line">    <span class="hljs-comment"># 鏡像名稱</span></span><br><span class="line">    <span class="hljs-attr">image:</span> <span class="hljs-string">mysql</span></span><br><span class="line">    <span class="hljs-comment"># 定義變數</span></span><br><span class="line">    <span class="hljs-attr">env:</span></span><br><span class="line">      <span class="hljs-comment"># 變數名稱</span></span><br><span class="line">    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">MYSQL_ROOT_PASSWORD</span></span><br><span class="line">      <span class="hljs-comment"># 變數值</span></span><br><span class="line">      <span class="hljs-attr">value:</span> <span class="hljs-string">&quot;password&quot;</span></span><br><span class="line">    <span class="hljs-comment"># 定義資源限制</span></span><br><span class="line">    <span class="hljs-attr">resources:</span></span><br><span class="line">      <span class="hljs-comment"># 定義 requests 資源限制</span></span><br><span class="line">      <span class="hljs-attr">requests:</span></span><br><span class="line">        <span class="hljs-comment"># 限制 ephemeral-storage</span></span><br><span class="line">        <span class="hljs-attr">ephemeral-storage:</span> <span class="hljs-string">&quot;2Gi&quot;</span></span><br><span class="line">      <span class="hljs-comment"># 定義 limits 資源限制</span></span><br><span class="line">      <span class="hljs-attr">limits:</span></span><br><span class="line">        <span class="hljs-comment"># 限制 ephemeral-storage</span></span><br><span class="line">        <span class="hljs-attr">ephemeral-storage:</span> <span class="hljs-string">&quot;4Gi&quot;</span></span><br><span class="line">    <span class="hljs-comment"># 容器名稱</span></span><br><span class="line">  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">wp</span></span><br><span class="line">    <span class="hljs-comment"># 鏡像名稱</span></span><br><span class="line">    <span class="hljs-attr">image:</span> <span class="hljs-string">wordpress</span></span><br><span class="line">    <span class="hljs-comment"># 定義資源限制</span></span><br><span class="line">    <span class="hljs-attr">resources:</span></span><br><span class="line">      <span class="hljs-comment"># 定義 requests 資源限制</span></span><br><span class="line">      <span class="hljs-attr">requests:</span></span><br><span class="line">        <span class="hljs-comment"># 限制 ephemeral-storage</span></span><br><span class="line">        <span class="hljs-attr">ephemeral-storage:</span> <span class="hljs-string">&quot;2Gi&quot;</span></span><br><span class="line">      <span class="hljs-comment"># 定義 limits 資源限制</span></span><br><span class="line">      <span class="hljs-attr">limits:</span></span><br><span class="line">        <span class="hljs-comment"># 限制 ephemeral-storage</span></span><br><span class="line">        <span class="hljs-attr">ephemeral-storage:</span> <span class="hljs-string">&quot;4Gi&quot;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h6 id="Kubernetes-哪一個元件依據-ephemeral-storage-資源分配-pod-到適當的-node"><a href="#Kubernetes-哪一個元件依據-ephemeral-storage-資源分配-pod-到適當的-node" class="headerlink" title="Kubernetes, 哪一個元件依據 ephemeral-storage 資源分配 pod 到適當的 node?"></a><strong>Kubernetes, 哪一個元件依據 ephemeral-storage 資源分配 pod 到適當的 node?</strong></h6><p>scheduler</p>
<h6 id="Kubernetes-如果一個-pod-裡頭的某個容器的-writable-layer-以及-logs-使用量超過的-ephemeral-storage-的資源限制-會發生什麼事？"><a href="#Kubernetes-如果一個-pod-裡頭的某個容器的-writable-layer-以及-logs-使用量超過的-ephemeral-storage-的資源限制-會發生什麼事？" class="headerlink" title="Kubernetes, 如果一個 pod 裡頭的某個容器的 writable layer 以及 logs 使用量超過的 ephemeral-storage 的資源限制, 會發生什麼事？"></a><strong>Kubernetes, 如果一個 pod 裡頭的某個容器的 writable layer 以及 logs 使用量超過的 ephemeral-storage 的資源限制, 會發生什麼事？</strong></h6><p>該 pod 會被砍了</p>
<h6 id="Kubernetes-如果一個-pod-裡頭的所有容器使用的-ephemeral-storage-用量以及-emptyDir-volumes-超過了資院限制-會發生什麼事？"><a href="#Kubernetes-如果一個-pod-裡頭的所有容器使用的-ephemeral-storage-用量以及-emptyDir-volumes-超過了資院限制-會發生什麼事？" class="headerlink" title="Kubernetes, 如果一個 pod 裡頭的所有容器使用的 ephemeral-storage 用量以及 emptyDir volumes 超過了資院限制, 會發生什麼事？"></a><strong>Kubernetes, 如果一個 pod 裡頭的所有容器使用的 ephemeral-storage 用量以及 emptyDir volumes 超過了資院限制, 會發生什麼事？</strong></h6><p>該 pod 會被砍了</p>
<h2 id="參考資源"><a href="#參考資源" class="headerlink" title="# 參考資源"></a># 參考資源</h2><ul>
<li><a target="_blank" rel="noopener" href="https://link.medium.com/GJYhX4tlF3">Understanding resource limits in Kubernetes: memory</a></li>
<li><a target="_blank" rel="noopener" href="https://medium.com/@betz.mark/understanding-resource-limits-in-kubernetes-cpu-time-9eff74d3161b">Understanding resource limits in kubernetes: cpu time</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/run/#cpu-share-constraint">Docker Documentation</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/configuration/manage-compute-resources-container/">Kubernetes Documentation</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/kubernetes/enhancements/blob/master/keps/sig-node/20190129-hugepages.md">Kubernetes/enhancements</a></li>
</ul>

    
    </div>
    
    <div class="columns is-variable is-1 is-multiline is-mobile">
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/zh-tw/tags/Kubernetes/">#Kubernetes</a></span>
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/zh-tw/tags/Kubernetes-Resources/">#Kubernetes Resources</a></span>
    
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop  article-nav-prev">
            
            <a href="/zh-tw/config-liveness-readiness-startup-probes/">Kubernetes - Health Check</a>
            
        </span>
        <span class="column is-12-mobile is-half-desktop  article-nav-next">
            
            <a href="/zh-tw/gitSensitiveness/">一下子敏感, 一下子不敏感, Git 你搞得我好亂啊</a>
            
        </span>
    </div>
    
</article>


<div class="sharebox">
    
<div class="sharethis-inline-share-buttons"></div>
<script type='text/javascript' src='//platform-api.sharethis.com/js/sharethis.js#property=5c72643b9ea706001139fd89&amp;product=inline-share-buttons' async='async'></script>

</div>



<div class="comments">
    <h3 class="title is-4">留言</h3>
    
<script>
    var disqus_config = function () {
        this.page.url = 'https://tn710617.github.io/zh-tw/managing-compute-resources-for-containers/';
        this.page.identifier = 'zh-tw/managing-compute-resources-for-containers/';
        
        this.language = 'zh';
        
    };
    (function() {
        var d = document, s = d.createElement('script');  
        s.src = '//' + 'rayscodingjourney' + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>

<div id="disqus_thread">
    
    <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</div>

    </div>
</section>
    <footer class="footer">
    <div class="container">
        <div class="columns content">
            <div class="column is-narrow has-text-centered">
                &copy; 2022 Ray&nbsp;
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a
                        target="_blank" rel="noopener" href="http://github.com/ppoffice/hexo-theme-minos">Minos</a>
            </div>
            <div class="column is-hidden-mobile"></div>

            <script src='https://unpkg.com/mermaid@7.1.2/dist/mermaid.min.js'></script>
            <script>
                mermaid.initialize({ theme: 'default' });
            </script>

            
            
            <a class="navbar-item" title="GitHub" target="_blank" rel="noopener" href="https://github.com/tn710617">
                
                    <i class="fab fa-github"></i>
                
            </a>
            
            <a class="navbar-item" title="Medium" target="_blank" rel="noopener" href="https://medium.com/@raycodingjourney">
                
                    <i class="fab fa-medium"></i>
                
            </a>
            
            <a class="navbar-item" title="Linkedin" target="_blank" rel="noopener" href="https://www.linkedin.com/in/ray-lee-99315315a">
                
                    <i class="fab fa-linkedin"></i>
                
            </a>
            
            <a class="navbar-item" title="Facebook" target="_blank" rel="noopener" href="https://www.facebook.com/profile.php?id=100001626039430">
                
                    <i class="fab fa-facebook"></i>
                
            </a>
            
            <a class="navbar-item" title="CakeResume" target="_blank" rel="noopener" href="https://www.cakeresume.com/resumes/ray-6edaef/edit">
                
                    <i class="far fa-address-card"></i>
                
            </a>
            
            <a class="navbar-item" title="E-Mail" href="mailto:tn710617@gmail.com">
                
                    <i class="far fa-envelope"></i>
                
            </a>
            
            <a class="navbar-item" title="Skype" href="skype:adad0310?call|chat">
                
                    <i class="fab fa-skype"></i>
                
            </a>
            
            

        </div>
    </div>
</footer>

    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script>

<!-- test if the browser is outdated -->
<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" target="_blank" rel="noopener" href="http://outdatedbrowser.com/">Update my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.js"></script>
<script>
    $(document).ready(function () {
        // plugin function, place inside DOM ready function
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        })
    });
</script>

<script>
    window.FontAwesomeConfig = {
        searchPseudoElements: true
    }
    moment.locale("zh-CN");
</script>


    
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<script>
    MathJax.Hub.Config({
        "HTML-CSS": {matchFontHeight: false},
        SVG: {matchFontHeight: false},
        CommonHTML: {matchFontHeight: false}
    });
</script>

    
    
    
    
<script src="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/js/lightgallery-all.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/justifiedGallery/3.6.5/js/jquery.justifiedGallery.min.js"></script>
<script>
    (function ($) {
        $(document).ready(function () {
            if (typeof($.fn.lightGallery) === 'function') {
                $('.article.gallery').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof($.fn.justifiedGallery) === 'function') {
                $('.justified-gallery').justifiedGallery();
            }
        });
    })(jQuery);
</script>

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <style>
        .hljs {
            position: relative;
        }

        .hljs .clipboard-btn {
            float: right;
            color: #9a9a9a;
            background: none;
            border: none;
            cursor: pointer;
        }

        .hljs .clipboard-btn:hover {
          color: #8a8a8a;
        }

        .hljs > .clipboard-btn {
            display: none;
            position: absolute;
            right: 4px;
            top: 4px;
        }

        .hljs:hover > .clipboard-btn {
            display: inline;
        }

        .hljs > figcaption > .clipboard-btn {
            margin-right: 4px;
        }
    </style>
    <script>
      $(document).ready(function () {
        $('figure.hljs').each(function(i, figure) {
          var codeId = 'code-' + i;
          var code = figure.querySelector('.code');
          var copyButton = $('<button>Copy <i class="far fa-clipboard"></i></button>');
          code.id = codeId;
          copyButton.addClass('clipboard-btn');
          copyButton.attr('data-clipboard-target-id', codeId);

          var figcaption = figure.querySelector('figcaption');

          if (figcaption) {
            figcaption.append(copyButton[0]);
          } else {
            figure.prepend(copyButton[0]);
          }
        })

        var clipboard = new ClipboardJS('.clipboard-btn', {
          target: function(trigger) {
            return document.getElementById(trigger.getAttribute('data-clipboard-target-id'));
          }
        });
        clipboard.on('success', function(e) {
          e.clearSelection();
        })
      })
    </script>

    
    

    



<script src="/js/script.js"></script>


    
    <div class="searchbox ins-search">
    <div class="searchbox-mask"></div>
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="站內搜尋" />
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: '文章',
                PAGES: '頁面',
                CATEGORIES: '分類',
                TAGS: '標籤',
                UNTITLED: '(無標題)',
            },
            CONTENT_URL: '/content.zh-tw.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>

<script src="/js/insight.js"></script>

    
</body>
</html>