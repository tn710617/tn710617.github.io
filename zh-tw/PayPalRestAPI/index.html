<!DOCTYPE html>
<html class="has-navbar-fixed-top">
<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
<title>PayPal REST API 串接金流好簡單 - Ray&#39;s Coding Journey</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="description" content="前言本篇將會分享，如何使用 PayPal REST API，來做到以下的動作：  建立授權訂單 授權 請款 退款 部分款項凍結  本篇屬於個人學習筆記，所以可能會參雜一些個人的專案內容，請選擇性參考。">
<meta name="keywords" content="PayPal REST API,PayPal 退款,PayPal 授權,PayPal 請款,PayPal 取消授權,PayPal 建立授權訂單,PayPal 款項凍結">
<meta property="og:type" content="article">
<meta property="og:title" content="PayPal REST API 串接金流好簡單">
<meta property="og:url" content="https://tn710617.github.io/zh-tw/PayPalRestAPI/index.html">
<meta property="og:site_name" content="Ray&#39;s Coding Journey">
<meta property="og:description" content="前言本篇將會分享，如何使用 PayPal REST API，來做到以下的動作：  建立授權訂單 授權 請款 退款 部分款項凍結  本篇屬於個人學習筆記，所以可能會參雜一些個人的專案內容，請選擇性參考。">
<meta property="og:locale" content="zh-tw">
<meta property="og:image" content="https://i.imgur.com/3UoIFHW.png">
<meta property="og:image" content="https://i.imgur.com/OXoJrkx.png">
<meta property="og:updated_time" content="2019-03-14T08:48:28.538Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="PayPal REST API 串接金流好簡單">
<meta name="twitter:description" content="前言本篇將會分享，如何使用 PayPal REST API，來做到以下的動作：  建立授權訂單 授權 請款 退款 部分款項凍結  本篇屬於個人學習筆記，所以可能會參雜一些個人的專案內容，請選擇性參考。">
<meta name="twitter:image" content="https://i.imgur.com/3UoIFHW.png">


<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.css">


    <link href="/PayPalRestAPI/" rel="alternate" hreflang="en">








    <meta name="description" content="前言本篇將會分享，如何使用 PayPal REST API，來做到以下的動作：  建立授權訂單 授權 請款 退款 部分款項凍結  本篇屬於個人學習筆記，所以可能會參雜一些個人的專案內容，請選擇性參考。">
<meta name="keywords" content="PayPal REST API,PayPal 退款,PayPal 授權,PayPal 請款,PayPal 取消授權,PayPal 建立授權訂單,PayPal 款項凍結">
<meta property="og:type" content="article">
<meta property="og:title" content="PayPal REST API 串接金流好簡單">
<meta property="og:url" content="https://tn710617.github.io/zh-tw/PayPalRestAPI/index.html">
<meta property="og:site_name" content="Ray&#39;s Coding Journey">
<meta property="og:description" content="前言本篇將會分享，如何使用 PayPal REST API，來做到以下的動作：  建立授權訂單 授權 請款 退款 部分款項凍結  本篇屬於個人學習筆記，所以可能會參雜一些個人的專案內容，請選擇性參考。">
<meta property="og:locale" content="zh-tw">
<meta property="og:image" content="https://i.imgur.com/3UoIFHW.png">
<meta property="og:image" content="https://i.imgur.com/OXoJrkx.png">
<meta property="og:updated_time" content="2019-03-14T08:48:28.538Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="PayPal REST API 串接金流好簡單">
<meta name="twitter:description" content="前言本篇將會分享，如何使用 PayPal REST API，來做到以下的動作：  建立授權訂單 授權 請款 退款 部分款項凍結  本篇屬於個人學習筆記，所以可能會參雜一些個人的專案內容，請選擇性參考。">
<meta name="twitter:image" content="https://i.imgur.com/3UoIFHW.png">





    <link rel="icon" href="/images/favicon.png">


<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bulma/0.6.2/css/bulma.min.css">


    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/justifiedGallery/3.6.5/css/justifiedGallery.min.css">


<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/sunburst.min.css">

<link rel="stylesheet" href="/css/style.css">

<script defer src="//use.fontawesome.com/releases/v5.0.8/js/all.js"></script>


    
        
    
        
    
        
    
        
    
        
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-135063928-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-135063928-1');
</script>


    


</head>
<body>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="/zh-tw">
                
                    
                    Ray&#39;s Coding Journey
                    
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item " href="/zh-tw/archives">歸檔</a>
            
            <a class="navbar-item " href="/zh-tw/categories">分類</a>
            
            <a class="navbar-item " href="/zh-tw/tags">標籤</a>
            
            <a class="navbar-item " href="/zh-tw/schedule">行程</a>
            
            <a class="navbar-item " href="/zh-tw/about">關於</a>
            
            <a class="navbar-item " href="/zh-tw/friends">好友</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            <a class="navbar-item search" title="搜尋" href="javascript:;">
                <i class="fas fa-search"></i>
            </a>
            
            
            <div class="navbar-item is-hoverable has-dropdown is-hidden-mobile is-hidden-tablet-only toc">
                <a class="navbar-item" title="目錄">
                    <i class="fa fa-list"></i>
                </a>
                <div class="navbar-dropdown is-right">
                    
                    
                    
                    
                    <a class="navbar-item" href="#前言">1&nbsp;&nbsp;<b>前言</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#安裝-PayPal-REST-API-官方-SDK">2&nbsp;&nbsp;<b>安裝 PayPal REST API 官方 SDK</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#安裝">2.1&nbsp;&nbsp;安裝</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#設定">3&nbsp;&nbsp;<b>設定</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#個人設定">3.1&nbsp;&nbsp;個人設定</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#開始">4&nbsp;&nbsp;<b>開始</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#order-跟-payment-的差異">5&nbsp;&nbsp;<b>order 跟 payment 的差異</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#建立訂單-order">6&nbsp;&nbsp;<b>建立訂單 ( order )</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#下面是建立訂單功能會用到的-RequestBody">6.1&nbsp;&nbsp;下面是建立訂單功能會用到的 RequestBody</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#授權-authorization">7&nbsp;&nbsp;<b>授權 ( authorization )</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#授權的範例如下">7.1&nbsp;&nbsp;授權的範例如下:</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#提款-capture">8&nbsp;&nbsp;<b>提款 ( capture )</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#以下是提款-capture-的範例：">8.1&nbsp;&nbsp;以下是提款 ( capture ) 的範例：</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下是提款-capture-的-RequestBody">8.2&nbsp;&nbsp;以下是提款 ( capture ) 的 RequestBody</a>
                    
                    
                    
                    <a class="navbar-item" href="#以下是提款的邏輯">8.3&nbsp;&nbsp;以下是提款的邏輯</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#退款-refund">9&nbsp;&nbsp;<b>退款 ( refund )</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#以下是退款的-RequestBody">9.1&nbsp;&nbsp;以下是退款的 RequestBody</a>
                    
                    
                    
                    <a class="navbar-item" href="#退款的邏輯">9.2&nbsp;&nbsp;退款的邏輯</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#取消授權">10&nbsp;&nbsp;<b>取消授權</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#取得授權資料">11&nbsp;&nbsp;<b>取得授權資料</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#取得提款資料">12&nbsp;&nbsp;<b>取得提款資料</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#總結">13&nbsp;&nbsp;<b>總結</b></a>
                    
                </div>
            </div>
            

            
<div class="column is-narrow has-text-centered">
    <div class="dropdown is-up is-right is-hoverable" style="margin-top: -0.2em;">
        <div class="dropdown-trigger">
            <button class="button is-small" aria-haspopup="true" aria-controls="dropdown-menu7">
                <span class="icon">
                    <i class="fas fa-globe"></i>
                </span>
                <span>繁體中文</span>
                <span class="icon is-small">
            <i class="fas fa-angle-down" aria-hidden="true"></i>
          </span>
            </button>
        </div>
        <div class="dropdown-menu has-text-left" role="menu" style="top:100%">
            <div class="dropdown-content">
            
                <a href="/PayPalRestAPI/" class="dropdown-item">
                    English
                </a>
            
                <a href="/zh-tw/PayPalRestAPI/" class="dropdown-item">
                    繁體中文
                </a>
            
            </div>
        </div>
    </div>
</div>

        </div>
    </div>
</nav>

    <section class="section">
    <div class="container">
    <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            PayPal REST API 串接金流好簡單
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            <time datetime="2019-03-13T07:21:37.000Z" itemprop="datePublished">3月 13 2019</time>
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="/zh-tw/categories/金流/">金流</a>
        </span>
        
        
        <span class="column is-narrow">
            
            
            23 分钟 讀完 (大概 3461 字)
        </span>
        
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本篇將會分享，如何使用 PayPal REST API，來做到以下的動作：</p>
<ol>
<li>建立授權訂單</li>
<li>授權</li>
<li>請款</li>
<li>退款</li>
<li>部分款項凍結</li>
</ol>
<p>本篇屬於個人學習筆記，所以可能會參雜一些個人的專案內容，請選擇性參考。<br><a id="more"></a></p>
<h2 id="安裝-PayPal-REST-API-官方-SDK"><a href="#安裝-PayPal-REST-API-官方-SDK" class="headerlink" title="安裝 PayPal REST API 官方 SDK"></a>安裝 PayPal REST API 官方 SDK</h2><p>本篇使用的為目前 PayPal 最新釋出的 <a href="https://github.com/paypal/Checkout-PHP-SDK" target="_blank" rel="noopener">SDK 版本</a></p>
<h4 id="安裝"><a href="#安裝" class="headerlink" title="安裝"></a>安裝</h4><figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">composer require paypal/paypal-checkout-sdk</span><br></pre></td></tr></table></figure>
<h2 id="設定"><a href="#設定" class="headerlink" title="設定"></a>設定</h2><h4 id="個人設定"><a href="#個人設定" class="headerlink" title="個人設定"></a>個人設定</h4><ul>
<li><p>安裝完成之後，可在 SDK 的資料夾底下，找到範例，如下圖：<br><img src="https://i.imgur.com/3UoIFHW.png" alt></p>
</li>
<li><p>設定 <code>PayPalClient.php</code> 檔案，如下:</p>
<ol>
<li><a href="https://developer.paypal.com/developer/applications" target="_blank" rel="noopener">申請開發者帳號並登入</a></li>
<li><a href="https://developer.paypal.com/developer/applications/create" target="_blank" rel="noopener">建立一個App</a></li>
<li>取得 Client ID 以及 Secret<br><img src="https://i.imgur.com/OXoJrkx.png" alt></li>
<li>將取得的 Client ID 以及 Secret 填入， Ray 是設在環境變數</li>
</ol>
</li>
</ul>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">environment</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    $clientId = env(<span class="hljs-string">'PAYPAL_SANDBOX_API_ClientID'</span>);</span><br><span class="line">    $clientSecret = env(<span class="hljs-string">'PAYPAL_SANDBOX_API_SECRET'</span>);</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> SandboxEnvironment($clientId, $clientSecret);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="開始"><a href="#開始" class="headerlink" title="開始"></a>開始</h2><p>在上面提到的範例資料夾中，可以找到幾乎所有會用到的範例。這邊可以根據每個人的需求不同來客制，以下是 Ray 自己的版本<br>任何疑惑，請參考 <code>sample</code> 裡頭的範例，以及官方文件如下:<br><a href="https://developer.paypal.com/docs/api/orders/v2/" target="_blank" rel="noopener">order</a><br><a href="https://developer.paypal.com/docs/api/payments/v2/" target="_blank" rel="noopener">payment</a></p>
<h2 id="order-跟-payment-的差異"><a href="#order-跟-payment-的差異" class="headerlink" title="order 跟 payment 的差異"></a>order 跟 payment 的差異</h2><p>主要的差異如下：</p>
<ul>
<li>order： 只支援 PayPal 的會員。可以延後付款，並且視乎貨物的狀態做部分的請款</li>
<li><p>payment: 可以延後付款，但不可以分批請款。</p>
<p>詳細的介紹可以參考<a href="https://developer.paypal.com/docs/faq/#what-is-the-difference-between-an-order-authorizationcapture-and-payments-authorizationcapture" target="_blank" rel="noopener">原文解說</a></p>
</li>
</ul>
<h2 id="建立訂單-order"><a href="#建立訂單-order" class="headerlink" title="建立訂單 ( order )"></a>建立訂單 ( order )</h2><figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createOrder</span><span class="hljs-params">($toBeSavedInfo, Recipient $recipient, $debug = false)</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    <span class="hljs-comment">// 引用SDK</span></span><br><span class="line">    $request = <span class="hljs-keyword">new</span> OrdersCreateRequest();</span><br><span class="line">    $request-&gt;headers[<span class="hljs-string">"prefer"</span>] = <span class="hljs-string">"return=representation"</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="hljs-comment">// 這邊的RequestBody等等會貼在下面</span></span><br><span class="line">    $request-&gt;body = <span class="hljs-keyword">self</span>::buildRequestBody($toBeSavedInfo, $recipient);</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// 這邊引用剛剛設定好的 PayPalClient</span></span><br><span class="line">    $client = PayPalClient::client();</span><br><span class="line">    $response = $client-&gt;execute($request);</span><br><span class="line">    <span class="hljs-keyword">if</span> ($debug)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="hljs-keyword">print</span> <span class="hljs-string">"Status Code: &#123;$response-&gt;statusCode&#125;\n"</span>;</span><br><span class="line">        <span class="hljs-keyword">print</span> <span class="hljs-string">"Status: &#123;$response-&gt;result-&gt;status&#125;\n"</span>;</span><br><span class="line">        <span class="hljs-keyword">print</span> <span class="hljs-string">"Order ID: &#123;$response-&gt;result-&gt;id&#125;\n"</span>;</span><br><span class="line">        <span class="hljs-keyword">print</span> <span class="hljs-string">"Intent: &#123;$response-&gt;result-&gt;intent&#125;\n"</span>;</span><br><span class="line">        <span class="hljs-keyword">print</span> <span class="hljs-string">"Links:\n"</span>;</span><br><span class="line">        <span class="hljs-keyword">foreach</span> ($response-&gt;result-&gt;links <span class="hljs-keyword">as</span> $link)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="hljs-keyword">print</span> <span class="hljs-string">"\t&#123;$link-&gt;rel&#125;: &#123;$link-&gt;href&#125;\tCall Type: &#123;$link-&gt;method&#125;\n"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-comment">// To toggle printing the whole response body comment/uncomment below line</span></span><br><span class="line">        <span class="hljs-keyword">echo</span> json_encode($response-&gt;result, JSON_PRETTY_PRINT), <span class="hljs-string">"\n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="hljs-comment">// 建立建立完成後，我只取讓使用者用來確認的連結，預設 PayPal 提供了很多的連結，但是其他的我們都可以靠 API 來達成。</span></span><br><span class="line">    <span class="hljs-keyword">foreach</span> (($response-&gt;result-&gt;links) <span class="hljs-keyword">as</span> $link)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="hljs-keyword">if</span> ($link-&gt;rel === <span class="hljs-string">'approve'</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            $linkForApproval = $link-&gt;href;</span><br><span class="line">            <span class="hljs-keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// 這邊取得建立訂單之後的一些會用到的資訊，然後 return</span></span><br><span class="line">    $toBeSavedInfo[<span class="hljs-string">'payment_id'</span>] = $response-&gt;result-&gt;id;</span><br><span class="line">    $toBeSavedInfo[<span class="hljs-string">'statusCode'</span>] = $response-&gt;statusCode;</span><br><span class="line">    $toBeSavedInfo[<span class="hljs-string">'custom_id'</span>] = $response-&gt;result-&gt;purchase_units[<span class="hljs-number">0</span>]-&gt;custom_id;</span><br><span class="line">    $toBeSavedInfo[<span class="hljs-string">'PayPal_total_amount'</span>] = $response-&gt;result-&gt;purchase_units[<span class="hljs-number">0</span>]-&gt;amount-&gt;value;</span><br><span class="line">    $toBeSavedInfo[<span class="hljs-string">'orderStatus'</span>] = $response-&gt;result-&gt;status;</span><br><span class="line">    $toBeSavedInfo[<span class="hljs-string">'linkForApproval'</span>] = $linkForApproval;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">return</span> $toBeSavedInfo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="下面是建立訂單功能會用到的-RequestBody"><a href="#下面是建立訂單功能會用到的-RequestBody" class="headerlink" title="下面是建立訂單功能會用到的 RequestBody"></a>下面是建立訂單功能會用到的 RequestBody</h4><figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">buildRequestBody</span><span class="hljs-params">($toBeSavedInfo, Recipient $recipient)</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    <span class="hljs-comment">// 這邊的設定，使得我們可以在 PayPal 的付款頁面，看到多個商品的明細</span></span><br><span class="line">    $item = [];</span><br><span class="line">    $i = <span class="hljs-number">1</span>;</span><br><span class="line">    <span class="hljs-keyword">foreach</span> ($toBeSavedInfo[<span class="hljs-string">'orders'</span>] <span class="hljs-keyword">as</span> $order)</span><br><span class="line">    &#123;</span><br><span class="line">        $item[] = [</span><br><span class="line">            <span class="hljs-string">'name'</span>        =&gt; $order-&gt;item_name,</span><br><span class="line">            <span class="hljs-string">'description'</span> =&gt; $order-&gt;item_description,</span><br><span class="line">            <span class="hljs-string">'sku'</span>         =&gt; $i,</span><br><span class="line">            <span class="hljs-string">'unit_amount'</span> =&gt; [</span><br><span class="line">                <span class="hljs-string">'currency_code'</span> =&gt; $toBeSavedInfo[<span class="hljs-string">'mc_currency'</span>],</span><br><span class="line">                <span class="hljs-string">'value'</span>         =&gt; $order-&gt;unit_price,</span><br><span class="line">            ],</span><br><span class="line">            <span class="hljs-string">'quantity'</span>    =&gt; $order-&gt;quantity,</span><br><span class="line">        ];</span><br><span class="line">        $i ++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// 這邊我們指定 intent ，我設在環境變數，</span></span><br><span class="line">    <span class="hljs-keyword">return</span> [</span><br><span class="line">        <span class="hljs-string">'intent'</span>              =&gt; env(<span class="hljs-string">'PAYPAL_SANDBOX_INTENT_OF_CREATED_ORDERS'</span>),</span><br><span class="line">        <span class="hljs-string">'application_context'</span> =&gt;</span><br><span class="line">            [</span><br><span class="line">                <span class="hljs-string">'return_url'</span>           =&gt; env(<span class="hljs-string">'PAYPAL_SANDBOX_RETURN_URL'</span>),</span><br><span class="line">                <span class="hljs-string">'cancel_url'</span>           =&gt; env(<span class="hljs-string">'PAYPAL_SANDBOX_CANCEL_URL'</span>),</span><br><span class="line">                <span class="hljs-string">'brand_name'</span>           =&gt; env(<span class="hljs-string">'APP_NAME'</span>),</span><br><span class="line">                <span class="hljs-string">'locale'</span>               =&gt; env(<span class="hljs-string">'PAYPAL_SANDBOX_LOCALE'</span>),</span><br><span class="line">                <span class="hljs-string">'landing_page'</span>         =&gt; env(<span class="hljs-string">'PAYPAL_SANDBOX_LANDING_PAGE'</span>),</span><br><span class="line">                <span class="hljs-string">'shipping_preferences'</span> =&gt; env(<span class="hljs-string">'PAYPAL_SANDBOX_SHIPPING_PREFERENCES'</span>),</span><br><span class="line">                <span class="hljs-string">'user_action'</span>          =&gt; env(<span class="hljs-string">'PAYPAL_SANDBOX_USER_ACTION'</span>),</span><br><span class="line">            ],</span><br><span class="line">            <span class="hljs-comment">// 這邊可以設定 purchase_unit ，一個 purchase_unit 裡面可以設定税、運費、等等，這邊省略</span></span><br><span class="line">        <span class="hljs-string">'purchase_units'</span>      =&gt;</span><br><span class="line">            [</span><br><span class="line">                [</span><br><span class="line">                    <span class="hljs-string">'custom_id'</span> =&gt; $toBeSavedInfo[<span class="hljs-string">'merchant_trade_no'</span>],</span><br><span class="line">                    <span class="hljs-string">'amount'</span>    =&gt;</span><br><span class="line">                        [</span><br><span class="line">                            <span class="hljs-string">'currency_code'</span> =&gt; $toBeSavedInfo[<span class="hljs-string">'mc_currency'</span>],</span><br><span class="line">                            <span class="hljs-string">'value'</span>         =&gt; $toBeSavedInfo[<span class="hljs-string">'total_amount'</span>],</span><br><span class="line">                            <span class="hljs-string">'breakdown'</span>     =&gt;</span><br><span class="line">                                [</span><br><span class="line">                                    <span class="hljs-string">'item_total'</span> =&gt;</span><br><span class="line">                                        [</span><br><span class="line">                                            <span class="hljs-string">'currency_code'</span> =&gt; $toBeSavedInfo[<span class="hljs-string">'mc_currency'</span>],</span><br><span class="line">                                            <span class="hljs-string">'value'</span>         =&gt; $toBeSavedInfo[<span class="hljs-string">'total_amount'</span>],</span><br><span class="line">                                        ],</span><br><span class="line">                                ],</span><br><span class="line">                        ],</span><br><span class="line"></span><br><span class="line">                    <span class="hljs-string">'items'</span>    =&gt; $item,</span><br><span class="line">                    <span class="hljs-comment">// 這邊可以指定收件人</span></span><br><span class="line">                    <span class="hljs-string">'shipping'</span> =&gt;</span><br><span class="line">                        <span class="hljs-keyword">array</span>(</span><br><span class="line">                            <span class="hljs-string">'name'</span>    =&gt;</span><br><span class="line">                                <span class="hljs-keyword">array</span>(</span><br><span class="line">                                    <span class="hljs-string">'full_name'</span> =&gt; $recipient-&gt;name,</span><br><span class="line">                                ),</span><br><span class="line">                            <span class="hljs-string">'address'</span> =&gt;</span><br><span class="line">                                <span class="hljs-keyword">array</span>(</span><br><span class="line">                                    <span class="hljs-string">'address_line_1'</span> =&gt; $recipient-&gt;others,</span><br><span class="line">                                    <span class="hljs-string">'admin_area_2'</span>   =&gt; $recipient-&gt;district,</span><br><span class="line">                                    <span class="hljs-string">'admin_area_1'</span>   =&gt; $recipient-&gt;city,</span><br><span class="line">                                    <span class="hljs-string">'postal_code'</span>    =&gt; $recipient-&gt;postcode,</span><br><span class="line">                                    <span class="hljs-string">'country_code'</span>   =&gt; $recipient-&gt;country_code,</span><br><span class="line">                                ),</span><br><span class="line">                        ),</span><br><span class="line">                ],</span><br><span class="line">            ],</span><br><span class="line">    ];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="授權-authorization"><a href="#授權-authorization" class="headerlink" title="授權 ( authorization )"></a>授權 ( authorization )</h2><p>接下來，我們要使用 REST API 中的特別功能， Authorization 。 </p>
<ul>
<li>授權之後，我們有29天的時間可以使用 capture 來從使用者的帳戶裡面扣錢。 不過呢，雖然有效期限是29天，但是 PayPal 只能保證給予單次授權開始計算的三天內，使用者的帳戶裡頭會有足夠的金額。</li>
<li>意思就是說呢，在 authorization 開始計算的三天， PayPal 會暫時性的在付款方的 PayPal 帳戶中，凍結申請的款項，記住只有三天哦！ 這三天稱為 honor period 。</li>
<li>在首次的 authorization 之後，我們可以申請多次，最多10次的 authorization ，稱為 reauthorize 。<br>如果你覺得這樣次數還是太少，可以通過跟 <a href="https://www.paypal.com/contactus" target="_blank" rel="noopener">PayPal 客服聯絡</a>的方式，將次數提升到最多99次！</li>
<li>其實只要將時間算好，10次的授權應該很夠用了。平均三天授權一次，10次也一個月了，海運都到了！</li>
<li>授權可以更改金額，最高可以授權115% 或 不超過 75 USD 的金額，如果運費或者稅務方面，或是其他原因造成費用有些許變動的話，可以透過重新授權來更改費用。</li>
<li>細節可以參考<a href="https://developer.paypal.com/docs/classic/admin/auth-capture/" target="_blank" rel="noopener">官方文件</a></li>
</ul>
<h4 id="授權的範例如下"><a href="#授權的範例如下" class="headerlink" title="授權的範例如下:"></a>授權的範例如下:</h4><p>記住這是 Ray 自己的版本，大家可以參考官方的範例，再依照自己的需求作更改，或者乾脆取SDK裡面的功能自己寫一個！ 這才是我認為的最佳解！</p>
<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * This function can be used to perform authorization on the approved order.</span></span><br><span class="line"><span class="hljs-comment"> * Valid Approved order id should be passed as an argument.</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"> <span class="hljs-comment">// 這邊我們可以變更授權的金額，根據你的需求</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">authorizeOrder</span><span class="hljs-params">($orderId, $amount = null, $debug = false)</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    $request = <span class="hljs-keyword">new</span> OrdersAuthorizeRequest($orderId);</span><br><span class="line">    <span class="hljs-comment">// RequestBody 跟上面提到的差不多，可以參考官方的範例！</span></span><br><span class="line">    $request-&gt;body = <span class="hljs-keyword">self</span>::buildRequestBodyForAuthorizeOrder($amount);</span><br><span class="line"></span><br><span class="line">    $client = PayPalClient::client();</span><br><span class="line">    $response = $client-&gt;execute($request);</span><br><span class="line">    <span class="hljs-keyword">if</span> ($debug)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="hljs-keyword">print</span> <span class="hljs-string">"Status Code: &#123;$response-&gt;statusCode&#125;\n"</span>;</span><br><span class="line">        <span class="hljs-keyword">print</span> <span class="hljs-string">"Status: &#123;$response-&gt;result-&gt;status&#125;\n"</span>;</span><br><span class="line">        <span class="hljs-keyword">print</span> <span class="hljs-string">"Order ID: &#123;$response-&gt;result-&gt;id&#125;\n"</span>;</span><br><span class="line">        <span class="hljs-keyword">print</span> <span class="hljs-string">"Authorization ID: &#123;$response-&gt;result-&gt;purchase_units[0]-&gt;payments-&gt;authorizations[0]-&gt;id&#125;\n"</span>;</span><br><span class="line">        <span class="hljs-keyword">print</span> <span class="hljs-string">"Links:\n"</span>;</span><br><span class="line">        <span class="hljs-keyword">foreach</span> ($response-&gt;result-&gt;links <span class="hljs-keyword">as</span> $link)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="hljs-keyword">print</span> <span class="hljs-string">"\t&#123;$link-&gt;rel&#125;: &#123;$link-&gt;href&#125;\tCall Type: &#123;$link-&gt;method&#125;\n"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-keyword">print</span> <span class="hljs-string">"Authorization Links:\n"</span>;</span><br><span class="line">        <span class="hljs-keyword">foreach</span> ($response-&gt;result-&gt;purchase_units[<span class="hljs-number">0</span>]-&gt;payments-&gt;authorizations[<span class="hljs-number">0</span>]-&gt;links <span class="hljs-keyword">as</span> $link)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="hljs-keyword">print</span> <span class="hljs-string">"\t&#123;$link-&gt;rel&#125;: &#123;$link-&gt;href&#125;\tCall Type: &#123;$link-&gt;method&#125;\n"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-comment">// To toggle printing the whole response body comment/uncomment below line</span></span><br><span class="line">        <span class="hljs-keyword">echo</span> json_encode($response-&gt;result, JSON_PRETTY_PRINT), <span class="hljs-string">"\n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">return</span> $response;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>授權之後呢，我們需要驗證授權是否成功，所以我利用回傳的response，寫一個驗證的 function，如下：<br><figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkIfAuthorizedSuccessfully</span><span class="hljs-params">($response)</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    $newPayPal = (<span class="hljs-keyword">new</span> NewPayPal())-&gt;where(<span class="hljs-string">'payment_id'</span>, request()-&gt;token)-&gt;first();</span><br><span class="line">    <span class="hljs-comment">// 確認授權是否完成</span></span><br><span class="line">    <span class="hljs-keyword">if</span> (($response-&gt;result-&gt;status) !== <span class="hljs-string">'COMPLETED'</span>)</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-string">'Authorization isn\'t completed'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// 確認授權是否已開始</span></span><br><span class="line">    <span class="hljs-keyword">if</span> (($response-&gt;result-&gt;purchase_units[<span class="hljs-number">0</span>]-&gt;payments-&gt;authorizations[<span class="hljs-number">0</span>]-&gt;status) !== <span class="hljs-string">'CREATED'</span>)</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-string">'Authorization was not created'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// 確認幣別是否一致</span></span><br><span class="line">    <span class="hljs-keyword">if</span> (($response-&gt;result-&gt;purchase_units[<span class="hljs-number">0</span>]-&gt;payments-&gt;authorizations[<span class="hljs-number">0</span>]-&gt;amount-&gt;currency_code) !== ($newPayPal-&gt;mc_currency))</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-string">'The currency is mismatched'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// 確認授權金額是否正確。這邊是我自己的版本，有需要變動授權金額的話，這邊可以變一下。</span></span><br><span class="line">    <span class="hljs-keyword">if</span> (intval($response-&gt;result-&gt;purchase_units[<span class="hljs-number">0</span>]-&gt;payments-&gt;authorizations[<span class="hljs-number">0</span>]-&gt;amount-&gt;value) !== ($newPayPal-&gt;total_amount))</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-string">'The total amount is not correct'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="提款-capture"><a href="#提款-capture" class="headerlink" title="提款 ( capture )"></a>提款 ( capture )</h2><ul>
<li>就像上面提到的，成功授權之後，我們可以在29天內隨時向買家請款。</li>
<li>不過 PayPal 只有保證三天買家帳戶裡頭會有足夠的金額，又稱 honor period</li>
<li>一般來說，我們只要把時間算好，可以透過 授權 以及 再次授權 ，將 這筆金額臨時凍結30天。</li>
</ul>
<h4 id="以下是提款-capture-的範例："><a href="#以下是提款-capture-的範例：" class="headerlink" title="以下是提款 ( capture ) 的範例："></a>以下是提款 ( capture ) 的範例：</h4><figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">captureAuthorization</span><span class="hljs-params">(NewPayPal $newPayPal, $final_capture = false, $debug = false)</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    $NewPayPal = (<span class="hljs-keyword">new</span> NewPayPal)-&gt;where(<span class="hljs-string">'merchant_trade_no'</span>, $newPayPal-&gt;merchant_trade_no)-&gt;first();</span><br><span class="line">    <span class="hljs-comment">// 提款功能，需要帶入授權id</span></span><br><span class="line">    $request = <span class="hljs-keyword">new</span> AuthorizationsCaptureRequest($newPayPal-&gt;authorization_id);</span><br><span class="line">    <span class="hljs-comment">// 這邊帶入要提款的金額，如上所敘，提款金額是可以分批次的！ Final_capture 如果設定為true的話，會結束此次授權，此次授權之後無法再進行提款，若要提款需要再重新授權。</span></span><br><span class="line">    $request-&gt;body = <span class="hljs-keyword">self</span>::buildRequestBodyForCaptureAuthorization($NewPayPal-&gt;to_be_captured_amount, $final_capture, $newPayPal-&gt;mc_currency);</span><br><span class="line">    $client = PayPalClient::client();</span><br><span class="line">    $response = $client-&gt;execute($request);</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">if</span> ($debug)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="hljs-keyword">print</span> <span class="hljs-string">"Status Code: &#123;$response-&gt;statusCode&#125;\n"</span>;</span><br><span class="line">        <span class="hljs-keyword">print</span> <span class="hljs-string">"Status: &#123;$response-&gt;result-&gt;status&#125;\n"</span>;</span><br><span class="line">        <span class="hljs-keyword">print</span> <span class="hljs-string">"Capture ID: &#123;$response-&gt;result-&gt;id&#125;\n"</span>;</span><br><span class="line">        <span class="hljs-keyword">print</span> <span class="hljs-string">"Links:\n"</span>;</span><br><span class="line">        <span class="hljs-keyword">foreach</span> ($response-&gt;result-&gt;links <span class="hljs-keyword">as</span> $link)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="hljs-keyword">print</span> <span class="hljs-string">"\t&#123;$link-&gt;rel&#125;: &#123;$link-&gt;href&#125;\tCall Type: &#123;$link-&gt;method&#125;\n"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-comment">// To toggle printing the whole response body comment/uncomment below line</span></span><br><span class="line">        <span class="hljs-keyword">echo</span> json_encode($response-&gt;result, JSON_PRETTY_PRINT), <span class="hljs-string">"\n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-keyword">return</span> $response;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="以下是提款-capture-的-RequestBody"><a href="#以下是提款-capture-的-RequestBody" class="headerlink" title="以下是提款 ( capture ) 的 RequestBody"></a>以下是提款 ( capture ) 的 RequestBody</h4><figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">buildRequestBodyForCaptureAuthorization</span><span class="hljs-params">($amount = null, $final_capture = false, $currency = <span class="hljs-string">'USD'</span>)</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    <span class="hljs-keyword">if</span> ($amount != <span class="hljs-keyword">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="hljs-comment">// 指定提款的金額與幣別，需要跟授權的一致</span></span><br><span class="line">        <span class="hljs-keyword">return</span> [</span><br><span class="line">            <span class="hljs-string">"amount"</span>        =&gt; [</span><br><span class="line">                <span class="hljs-string">'currency_code'</span> =&gt; $currency,</span><br><span class="line">                <span class="hljs-string">'value'</span>         =&gt; $amount,</span><br><span class="line">            ],</span><br><span class="line">            <span class="hljs-string">'final_capture'</span> =&gt; $final_capture</span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-string">"&#123;&#125;"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="以下是提款的邏輯"><a href="#以下是提款的邏輯" class="headerlink" title="以下是提款的邏輯"></a>以下是提款的邏輯</h4><p>Ray 的邏輯是設定一個提款期限來決定什麼時候提款，因為每次退款都會扣掉手續費，所以 Ray 的想法是利用金額凍結取代退款，在提款期限之前，如果買家申請退款的話， Ray 這邊只需要去更改要提款的最終數字，這樣就可以避免掉手續費的部分。 Ray 自己設定的容許退款期限為七天，所以 Ray 會將這筆金額凍結七天，在七天後等到一切都確定了再依照最終的提款金額一次提款。<br>所以下面的function每天都會跑一次，如果已經過了提款期限就會真正執行提款，並更新該訂單在所有資料庫裡頭相對應的狀態。<br><figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">public static function dailyCaptureAuthorization()</span><br><span class="line">&#123;</span><br><span class="line">    $toBeCapturedPayments = NewPayPal::whereNotNull(&apos;authorization_id&apos;)-&gt;whereNull(&apos;capture_id&apos;)-&gt;where(&apos;to_be_captured_date&apos;, &apos;&lt;&apos;, Carbon::now()-&gt;toDateTimeString())-&gt;get();</span><br><span class="line">    foreach ($toBeCapturedPayments as $toBeCapturedPayment)</span><br><span class="line">    &#123;</span><br><span class="line">        $response = NewPayPal::captureAuthorization($toBeCapturedPayment);</span><br><span class="line">        if (($response-&gt;result-&gt;status) === &apos;COMPLETED&apos;)</span><br><span class="line">        &#123;</span><br><span class="line">            $toBeCapturedPayment-&gt;update([&apos;capture_id&apos; =&gt; $response-&gt;result-&gt;id, &apos;status&apos; =&gt; 7]);</span><br><span class="line">            foreach ($toBeCapturedPayment-&gt;orderRelations as $orderRelation)</span><br><span class="line">            &#123;</span><br><span class="line">                if (($orderRelation-&gt;status == 5) || ($orderRelation-&gt;status == 6))</span><br><span class="line">                &#123;</span><br><span class="line">                    $orderRelation-&gt;order-&gt;update([&apos;status&apos; =&gt; 7]);</span><br><span class="line">                    $orderRelation-&gt;update([&apos;status&apos; =&gt; 7]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="退款-refund"><a href="#退款-refund" class="headerlink" title="退款 ( refund )"></a>退款 ( refund )</h2><ul>
<li>退款的規則是，可以針對特定授權，進行一次性或者分批次的退款。</li>
<li>若屬於分批次，可以指定退款金額</li>
<li>若想要一次性，可以將整個 RequestBody 留空，像官方範例那樣<figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">refundOrder</span><span class="hljs-params">($captureId, $amount, $currency, $debug = false)</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    $request = <span class="hljs-keyword">new</span> CapturesRefundRequest($captureId);</span><br><span class="line">    <span class="hljs-comment">// 這邊帶入指定的退款金額以及幣別，幣別必須要跟授權的一樣哦</span></span><br><span class="line">    $request-&gt;body = <span class="hljs-keyword">self</span>::buildRequestBodyForRefundOrder($amount, $currency);</span><br><span class="line">    $client = PayPalClient::client();</span><br><span class="line">    $response = $client-&gt;execute($request);</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">if</span> ($debug)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="hljs-keyword">print</span> <span class="hljs-string">"Status Code: &#123;$response-&gt;statusCode&#125;\n"</span>;</span><br><span class="line">        <span class="hljs-keyword">print</span> <span class="hljs-string">"Status: &#123;$response-&gt;result-&gt;status&#125;\n"</span>;</span><br><span class="line">        <span class="hljs-keyword">print</span> <span class="hljs-string">"Order ID: &#123;$response-&gt;result-&gt;id&#125;\n"</span>;</span><br><span class="line">        <span class="hljs-keyword">print</span> <span class="hljs-string">"Links:\n"</span>;</span><br><span class="line">        <span class="hljs-keyword">foreach</span> ($response-&gt;result-&gt;links <span class="hljs-keyword">as</span> $link)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="hljs-keyword">print</span> <span class="hljs-string">"\t&#123;$link-&gt;rel&#125;: &#123;$link-&gt;href&#125;\tCall Type: &#123;$link-&gt;method&#125;\n"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-comment">// To toggle printing the whole response body comment/uncomment below line</span></span><br><span class="line">        <span class="hljs-keyword">echo</span> json_encode($response-&gt;result, JSON_PRETTY_PRINT), <span class="hljs-string">"\n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">return</span> $response;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="以下是退款的-RequestBody"><a href="#以下是退款的-RequestBody" class="headerlink" title="以下是退款的 RequestBody"></a>以下是退款的 RequestBody</h4><figure class="highlight php hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">buildRequestBodyForRefundOrder</span><span class="hljs-params">($amount = null, $currency = <span class="hljs-string">'USD'</span>, $final_capture = false)</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    <span class="hljs-comment">// 若金額有指定就為指定值，若無指定便為預設格式</span></span><br><span class="line">    <span class="hljs-keyword">if</span> ($amount != <span class="hljs-keyword">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> [</span><br><span class="line">            <span class="hljs-string">"amount"</span>        =&gt; [</span><br><span class="line">                <span class="hljs-string">'currency_code'</span> =&gt; $currency,</span><br><span class="line">                <span class="hljs-string">'value'</span>         =&gt; $amount,</span><br><span class="line">            ],</span><br><span class="line">            <span class="hljs-string">'final_capture'</span> =&gt; $final_capture</span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-string">"&#123;&#125;"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="退款的邏輯"><a href="#退款的邏輯" class="headerlink" title="退款的邏輯"></a>退款的邏輯</h4><ul>
<li>相對應提款時所做的操作，在商家真正對買家做出提款之前，買家所申請的退款請求都只是去更改資料庫的數字。</li>
<li>如果過了七天，但實屬特殊案例，買家也還是可以申請退款，不過到時候就會有手續費產生</li>
<li>以上邏輯只適用於 PayPal ，因為本專案整合兩家金流，所以上面的邏輯並不適用於歐付寶，不過總體來說，對買家來說都是沒有影響的。<figure class="highlight plain hljs"><table><tr><td class="code"><pre><span class="line">public static function refund(Order $order, NewPayPal $paymentServiceInstance, OrderRelations $orderRelation)</span><br><span class="line">&#123;</span><br><span class="line">    // 當該申請訂單為已授權，但尚未請款</span><br><span class="line">    if (($paymentServiceInstance-&gt;capture_id === null) &amp;&amp; ($paymentServiceInstance-&gt;authorization_id !== null))</span><br><span class="line">    &#123;</span><br><span class="line">        // 如上所敘，我們只更新資料庫的請款金額</span><br><span class="line">        $paymentServiceInstance-&gt;update([</span><br><span class="line">            &apos;to_be_captured_amount&apos; =&gt; $paymentServiceInstance-&gt;to_be_captured_amount - $order-&gt;total_amount,</span><br><span class="line">            &apos;total_amount&apos;          =&gt; $paymentServiceInstance-&gt;total_amount - $order-&gt;total_amount</span><br><span class="line">        ]);</span><br><span class="line">        $order-&gt;update([&apos;status&apos; =&gt; 4]);</span><br><span class="line">        $orderRelation-&gt;update([&apos;status&apos; =&gt; 4]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 當該訂單已經請款了</span><br><span class="line">    if ($paymentServiceInstance-&gt;capture_id !== null)</span><br><span class="line">    &#123;</span><br><span class="line">        // 真正執行退款 API ，將款項退給買家</span><br><span class="line">        $response = self::refundOrder($paymentServiceInstance-&gt;capture_id, $order-&gt;total_amount, $paymentServiceInstance-&gt;mc_currency);</span><br><span class="line">        // 如果退款確定成功，更新訂單狀態</span><br><span class="line">        if ($response-&gt;result-&gt;status == &apos;COMPLETED&apos;)</span><br><span class="line">        &#123;</span><br><span class="line">            $order-&gt;update([&apos;status&apos; =&gt; 4]);</span><br><span class="line">            $orderRelation-&gt;update([&apos;status&apos; =&gt; 4]);</span><br><span class="line">            $paymentServiceInstance-&gt;update([</span><br><span class="line">                &apos;total_amount&apos; =&gt; $paymentServiceInstance-&gt;total_amount - $order-&gt;total_amount</span><br><span class="line">            ]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="取消授權"><a href="#取消授權" class="headerlink" title="取消授權"></a>取消授權</h2><p>取消方法非常簡單，只要使用官方範例，並且依照格式帶入授權的id就可以，這邊就不特別舉例！<br>授權id在你成功授權的時候會回傳，在那時記得把它存起來！</p>
<h2 id="取得授權資料"><a href="#取得授權資料" class="headerlink" title="取得授權資料"></a>取得授權資料</h2><p>取得授權方法非常簡單，只要使用官方範例，並且依照格式帶入授權的id就可以，這邊就不特別舉例！<br>授權id在你成功授權的時候會回傳，在那時記得把它存起來！</p>
<h2 id="取得提款資料"><a href="#取得提款資料" class="headerlink" title="取得提款資料"></a>取得提款資料</h2><p>取得提款方法非常簡單，只要使用官方範例，並且依照格式帶入提款的id就可以，這邊就不特別舉例！<br>提款id在你成功提款的時候會回傳，在那時記得把它存起來！</p>
<h2 id="總結"><a href="#總結" class="headerlink" title="總結"></a>總結</h2><p>依照官方文件， PayPal REST API 是可以搭配 JavaScript 的 Smart Button 一起使用的，不過 Ray 負責的是後端的角色，所以這一部分就沒有深究。<br>看起來還蠻有趣的！有興趣的可以花時間研究一下！<br>PayPal 不愧是國際的金流系統，各項的支援都十分全面以及功能也十分多樣，可惜已經退出台灣了！不過據了解應該是因為相關法令的關係，退出在另一個角度來說也是在捍衛台灣的稅法，未嘗不是一件好事，這邊就不多做評論。<br>這陣子算是針對 PayPal 的金流深入的研究了一下，當然還有許多比較細緻的功能因為時間的關係還沒有去接觸到，待之後有時間有機會再來好好研究，再把心得過程都記錄下來分享給大家！</p>
<p>歡迎轉載，但麻煩請註明出處，感謝！</p>

    
    </div>
    
    <div class="columns is-variable is-1 is-multiline is-mobile">
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/zh-tw/tags/PayPal-REST-API/">#PayPal REST API</a></span>
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/zh-tw/tags/PayPal-退款/">#PayPal 退款</a></span>
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/zh-tw/tags/PayPal-授權/">#PayPal 授權</a></span>
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/zh-tw/tags/PayPal-請款/">#PayPal 請款</a></span>
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/zh-tw/tags/PayPal-取消授權/">#PayPal 取消授權</a></span>
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/zh-tw/tags/PayPal-建立授權訂單/">#PayPal 建立授權訂單</a></span>
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/zh-tw/tags/PayPal-款項凍結/">#PayPal 款項凍結</a></span>
    
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop  article-nav-prev">
            
            <a href="/zh-tw/flexibleGitFlow/">伸縮自如的 git flow</a>
            
        </span>
        <span class="column is-12-mobile is-half-desktop  article-nav-next">
            
            <a href="/zh-tw/implementATransactionViaPayPalIPN/">利用 PayPal 付款標準版 (PayPal Payment Standard) 以及 PayPal 即時付款通知 (PayPal IPN) 方式結帳付款</a>
            
        </span>
    </div>
    
</article>


<div class="sharebox">
    
<div class="sharethis-inline-share-buttons"></div>
<script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5c72643b9ea706001139fd89&amp;product=inline-share-buttons" async="async"></script>

</div>



<div class="comments">
    <h3 class="title is-4">留言</h3>
    
<script>
    var disqus_config = function () {
        this.page.url = 'https://tn710617.github.io/zh-tw/PayPalRestAPI/';
        this.page.identifier = 'zh-tw/PayPalRestAPI/';
        
        this.language = 'zh';
        
    };
    (function() {
        var d = document, s = d.createElement('script');  
        s.src = '//' + 'rayscodingjourney' + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>

<div id="disqus_thread">
    
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</div>

    </div>
</section>
    <footer class="footer">
    <div class="container">
        <div class="columns content">
            <div class="column is-narrow has-text-centered">
                &copy; 2019 Ray&nbsp;
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a href="http://github.com/ppoffice/hexo-theme-minos">Minos</a>
            </div>
            <div class="column is-hidden-mobile"></div>

            
            
                       <a class="navbar-item" title="GitHub" href="https://github.com/tn710617">
                           
                           <i class="fab fa-github"></i>
                           
                       </a>
                          
                       <a class="navbar-item" title="E-Mail" href="mailto:tn710617@gmail.com">
                           
                           <i class="far fa-envelope"></i>
                           
                       </a>
                          
                       <a class="navbar-item" title="Linkedin" href="https://www.linkedin.com/in/ray-lee-99315315a">
                           
                           <i class="fab fa-linkedin"></i>
                           
                       </a>
                          
                       <a class="navbar-item" title="Facebook" href="https://www.facebook.com/profile.php?id=100001626039430">
                           
                           <i class="fab fa-facebook"></i>
                           
                       </a>
                          
                       <a class="navbar-item" title="Skype" href="skype:adad0310?call|chat">
                           
                           <i class="fab fa-skype"></i>
                           
                       </a>
                          
                       
        </div>
    </div>
</footer>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script>

<!-- test if the browser is outdated -->
<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/">Update my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.js"></script>
<script>
    $(document).ready(function () {
        // plugin function, place inside DOM ready function
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        })
    });
</script>

<script>
    window.FontAwesomeConfig = {
        searchPseudoElements: true
    }
    moment.locale("zh-CN");
</script>


    
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<script>
    MathJax.Hub.Config({
        "HTML-CSS": {matchFontHeight: false},
        SVG: {matchFontHeight: false},
        CommonHTML: {matchFontHeight: false}
    });
</script>

    
    
    
    
<script src="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/js/lightgallery-all.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/justifiedGallery/3.6.5/js/jquery.justifiedGallery.min.js"></script>
<script>
    (function ($) {
        $(document).ready(function () {
            if (typeof($.fn.lightGallery) === 'function') {
                $('.article.gallery').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof($.fn.justifiedGallery) === 'function') {
                $('.justified-gallery').justifiedGallery();
            }
        });
    })(jQuery);
</script>

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <style>
        .hljs {
            position: relative;
        }

        .hljs .clipboard-btn {
            float: right;
            color: #9a9a9a;
            background: none;
            border: none;
        }

        .hljs > .clipboard-btn {
            display: none;
            position: absolute;
            right: 4px;
            top: 4px;
        }

        .hljs:hover > .clipboard-btn {
            display: inline;
        }

        .hljs > figcaption > .clipboard-btn {
            margin-right: 4px;
        }
    </style>
    <script>
      $(document).ready(function () {
        $('figure.hljs').each(function(i, figure) {
          var codeId = 'code-' + i;
          var code = figure.querySelector('.code');
          var copyButton = $('<button>Copy <i class="far fa-clipboard"></i></button>');
          code.id = codeId;
          copyButton.addClass('clipboard-btn');
          copyButton.attr('data-clipboard-target-id', codeId);

          var figcaption = figure.querySelector('figcaption');

          if (figcaption) {
            figcaption.append(copyButton[0]);
          } else {
            figure.prepend(copyButton[0]);
          }
        })

        var clipboard = new ClipboardJS('.clipboard-btn', {
          target: function(trigger) {
            return document.getElementById(trigger.getAttribute('data-clipboard-target-id'));
          }
        });
      })
    </script>

    
    

    


<script src="/js/script.js"></script>

    
    <div class="searchbox ins-search">
    <div class="searchbox-mask"></div>
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="站內搜尋">
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: '文章',
                PAGES: '頁面',
                CATEGORIES: '分類',
                TAGS: '標籤',
                UNTITLED: '(無標題)',
            },
            CONTENT_URL: '/content.zh-tw.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script src="/js/insight.js"></script>
    
</body>
</html>