<!DOCTYPE html>
<html class="has-navbar-fixed-top">
<head>
    <meta charset="utf-8">
<title>pm2 - My learning note - Learn or Die</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="description" content="IntroductionWhat’s pm2? pm2 is a process manager of Node.js  What does pm2 solve? pm2 can re-launch Node service after it crashes. pm2 can re-launch Node service after the server reboot pm2 can run mu">
<meta property="og:type" content="article">
<meta property="og:title" content="pm2 - My learning note">
<meta property="og:url" content="https://tn710617.github.io/pm2/index.html">
<meta property="og:site_name" content="Learn or Die">
<meta property="og:description" content="IntroductionWhat’s pm2? pm2 is a process manager of Node.js  What does pm2 solve? pm2 can re-launch Node service after it crashes. pm2 can re-launch Node service after the server reboot pm2 can run mu">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://i.imgur.com/WIv3pVR.png">
<meta property="article:published_time" content="2019-06-26T06:12:28.000Z">
<meta property="article:modified_time" content="2020-01-30T10:56:08.574Z">
<meta property="article:author" content="Ray">
<meta property="article:tag" content="pm2">
<meta property="article:tag" content="GitLab CI &#x2F; CD">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.imgur.com/WIv3pVR.png">


<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.css">


    <link href="/zh-tw/pm2/" rel="alternate"
          hreflang="zh-TW"/>








    <meta name="description" content="IntroductionWhat’s pm2? pm2 is a process manager of Node.js  What does pm2 solve? pm2 can re-launch Node service after it crashes. pm2 can re-launch Node service after the server reboot pm2 can run mu">
<meta property="og:type" content="article">
<meta property="og:title" content="pm2 - My learning note">
<meta property="og:url" content="https://tn710617.github.io/pm2/index.html">
<meta property="og:site_name" content="Learn or Die">
<meta property="og:description" content="IntroductionWhat’s pm2? pm2 is a process manager of Node.js  What does pm2 solve? pm2 can re-launch Node service after it crashes. pm2 can re-launch Node service after the server reboot pm2 can run mu">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://i.imgur.com/WIv3pVR.png">
<meta property="article:published_time" content="2019-06-26T06:12:28.000Z">
<meta property="article:modified_time" content="2020-01-30T10:56:08.574Z">
<meta property="article:author" content="Ray">
<meta property="article:tag" content="pm2">
<meta property="article:tag" content="GitLab CI &#x2F; CD">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.imgur.com/WIv3pVR.png">





    <link rel="icon" href="/images/favicon.png">


<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bulma/0.6.2/css/bulma.min.css">


    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/justifiedGallery/3.6.5/css/justifiedGallery.min.css">


<link rel="stylesheet"
      href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/sunburst.min.css">


<link rel="stylesheet" href="/css/style.css">


<script defer src="//use.fontawesome.com/releases/v5.0.8/js/all.js"></script>


    
        
    
        
    
        
    
        
    
        
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-135063928-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-135063928-1');
</script>


    


<meta name="generator" content="Hexo 6.2.0"></head>
<body>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="/">
                
                    
                    Learn or Die
                    
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item "
               href="/archives">Archives</a>
            
            <a class="navbar-item "
               href="/categories">Categories</a>
            
            <a class="navbar-item "
               href="/tags">Tags</a>
            
            <a class="navbar-item "
               href="/schedule">Schedule</a>
            
            <a class="navbar-item "
               href="/about">About</a>
            
            <a class="navbar-item "
               href="/japanese">Japanese</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            <a class="navbar-item search" title="Search" href="javascript:;">
                <i class="fas fa-search"></i>
            </a>
            
            
            <div class="navbar-item is-hoverable has-dropdown is-hidden-mobile is-hidden-tablet-only toc">
                <a class="navbar-item" title="Table of Contents">
                    <i class="fa fa-list"></i>
                </a>
                <div class="navbar-dropdown is-right">
                    
                    
                    
                    
                    <a class="navbar-item" href="#Introduction">1&nbsp;&nbsp;<b>Introduction</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#What’s-pm2">1.1&nbsp;&nbsp;What’s pm2?</a>
                    
                    
                    
                    <a class="navbar-item" href="#What-does-pm2-solve">1.2&nbsp;&nbsp;What does pm2 solve?</a>
                    
                    
                    
                    <a class="navbar-item" href="#Here-are-the-coverage-of-this-article">1.3&nbsp;&nbsp;Here are the coverage of this article:</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#installation">2&nbsp;&nbsp;<b>installation</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#pm2-with-CLI">3&nbsp;&nbsp;<b>pm2 with CLI</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#Launch-node-project-with-pm2-with-CLI-see-the-example-below">3.1&nbsp;&nbsp;Launch node project with pm2 with CLI, see the example below:</a>
                    
                    
                    
                    <a class="navbar-item" href="#The-flag">3.2&nbsp;&nbsp;The flag</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#cluster-mode">4&nbsp;&nbsp;<b>cluster mode</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#Process-management">5&nbsp;&nbsp;<b>Process management</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#Show-the-status-of-management">6&nbsp;&nbsp;<b>Show the status of management</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#Logs">7&nbsp;&nbsp;<b>Logs</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#Rotated-Log">8&nbsp;&nbsp;<b>Rotated Log</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#Installation">8.1&nbsp;&nbsp;Installation</a>
                    
                    
                    
                    <a class="navbar-item" href="#Find-the-config-file-at-home-user-pm2-module-conf-json">8.2&nbsp;&nbsp;Find the config file at /home/user/.pm2/module_conf.json</a>
                    
                    
                    
                    <a class="navbar-item" href="#Parameters">8.3&nbsp;&nbsp;Parameters</a>
                    
                    
                    
                    <a class="navbar-item" href="#Graph">8.4&nbsp;&nbsp;Graph</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#Terminal-Based-Dashboard">9&nbsp;&nbsp;<b>Terminal Based Dashboard</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#pm2-ecosystem">10&nbsp;&nbsp;<b>pm2 ecosystem</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#Generate-ecosystem-file">10.1&nbsp;&nbsp;Generate ecosystem file</a>
                    
                    
                    
                    <a class="navbar-item" href="#CLI">10.2&nbsp;&nbsp;CLI</a>
                    
                    
                    
                    <a class="navbar-item" href="#Start-specific-App-via-ecosystem-file">10.3&nbsp;&nbsp;Start specific App via ecosystem file</a>
                    
                    
                    
                    <a class="navbar-item" href="#Parameter-injection">10.4&nbsp;&nbsp;Parameter injection</a>
                    
                    
                    
                    <a class="navbar-item" href="#Parameter-example">10.5&nbsp;&nbsp;Parameter example</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#pm2-Deployment">11&nbsp;&nbsp;<b>pm2 Deployment</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#Prerequisite">11.1&nbsp;&nbsp;Prerequisite</a>
                    
                    
                    
                    <a class="navbar-item" href="#Initialise-remote-folder">11.2&nbsp;&nbsp;Initialise remote folder</a>
                    
                    
                    
                    <a class="navbar-item" href="#Deploy">11.3&nbsp;&nbsp;Deploy</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#CI-CD-Deployment">12&nbsp;&nbsp;<b>CI / CD Deployment</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#Auto-start-after-reboot">13&nbsp;&nbsp;<b>Auto start after reboot</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#Reload-after-when-content-changes">14&nbsp;&nbsp;<b>Reload after when content changes</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#update-pm2">15&nbsp;&nbsp;<b>update pm2</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#pm2-cheat-sheet">16&nbsp;&nbsp;<b>pm2 cheat sheet</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#Auto-completion">17&nbsp;&nbsp;<b>Auto completion</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#疑難雜症">18&nbsp;&nbsp;<b>疑難雜症</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#參考資料">19&nbsp;&nbsp;<b>參考資料</b></a>
                    
                </div>
            </div>
            

            
<div class="column is-narrow has-text-centered">
    <div class="dropdown is-up is-right is-hoverable" style="margin-top: -0.2em;">
        <div class="dropdown-trigger">
            <button class="button is-small" aria-haspopup="true" aria-controls="dropdown-menu7">
                <span class="icon">
                    <i class="fas fa-globe"></i>
                </span>
                <span>English</span>
                <span class="icon is-small">
            <i class="fas fa-angle-down" aria-hidden="true"></i>
          </span>
            </button>
        </div>
        <div class="dropdown-menu has-text-left" role="menu" style="top:100%">
            <div class="dropdown-content">
            
                <a href="/pm2/" class="dropdown-item">
                    English
                </a>
            
                <a href="/zh-tw/pm2/" class="dropdown-item">
                    繁體中文
                </a>
            
            </div>
        </div>
    </div>
</div>

        </div>
    </div>
</nav>

    <section class="section">
    <div class="container">
    <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            pm2 - My learning note
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            <time datetime="2019-06-26T06:12:28.000Z" itemprop="datePublished">Jun 26 2019</time>
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="/categories/Ops/">Ops</a>
        </span>
        
        
        <span class="column is-narrow">
            
            
            21 minutes read (About 3185 words)
        </span>
        
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><h3 id="What’s-pm2"><a href="#What’s-pm2" class="headerlink" title="What’s pm2?"></a>What’s pm2?</h3><ul>
<li>pm2 is a process manager of Node.js</li>
</ul>
<h3 id="What-does-pm2-solve"><a href="#What-does-pm2-solve" class="headerlink" title="What does pm2 solve?"></a>What does pm2 solve?</h3><ul>
<li>pm2 can re-launch Node service after it crashes.</li>
<li>pm2 can re-launch Node service after the server reboot</li>
<li>pm2 can run multiple processes with multiple cores of CPU to achieve Load Balancer like effect.<span id="more"></span>
<ul>
<li>It features kind of rolling update, 0 downtime upgrade with Graceful Reload</li>
<li>Multiple services with multiple processes, significantly boost the performance.</li>
<li>Schedule to restart periodically</li>
</ul>
</li>
<li>pm2 provides much information, including restart number, CPU usage, memory usage,  process id, etc.</li>
<li>pm2 allows auto-restart under specific condition, such as ‘up-time’, ‘memory usage’, etc.</li>
<li>pm2 can organise log, periodically split the log and keep the number we specify, delete exceeded ones.</li>
<li>pm2 provides simple deployment method, and support multiple server deployment</li>
<li>pm2 can integrate with CI / CD tool, as well as CI / CD deployment</li>
</ul>
<p><code>What are you waiting for?</code></p>
<h3 id="Here-are-the-coverage-of-this-article"><a href="#Here-are-the-coverage-of-this-article" class="headerlink" title="Here are the coverage of this article:"></a>Here are the coverage of this article:</h3><ul>
<li>Installation</li>
<li>pm2 with CLI</li>
<li>pm2 with ecosystem</li>
<li>pm2 with ecosystem on deployment</li>
<li>pm2 deployment with GitLab CI / CD Runner</li>
</ul>
<h2 id="installation"><a href="#installation" class="headerlink" title="installation"></a>installation</h2><ul>
<li>Global installation<figure class="highlight plaintext hljs"><table><tr><td class="code"><pre><span class="line">npm install pm2@latest -g</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="pm2-with-CLI"><a href="#pm2-with-CLI" class="headerlink" title="pm2 with CLI"></a>pm2 with CLI</h2><h3 id="Launch-node-project-with-pm2-with-CLI-see-the-example-below"><a href="#Launch-node-project-with-pm2-with-CLI-see-the-example-below" class="headerlink" title="Launch node project with pm2 with CLI, see the example below:"></a>Launch node project with pm2 with CLI, see the example below:</h3><figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">pm2 start location/fileName.js --name appName \</span><br><span class="line">--watch <span class="hljs-literal">true</span> \</span><br><span class="line">--max-memory-restart 500M \</span><br><span class="line">--<span class="hljs-built_in">log</span> ~/.pm2/logs/appName/ \</span><br><span class="line">--time <span class="hljs-literal">true</span> \</span><br><span class="line">--cron <span class="hljs-string">&quot;0 17 * * *&quot;</span> \</span><br><span class="line">--no-daemon <span class="hljs-literal">true</span> \</span><br><span class="line">--merge-logs</span><br></pre></td></tr></table></figure>
<p>As to the meaning of CLI mentioned above, refer to the followings</p>
<h3 id="The-flag"><a href="#The-flag" class="headerlink" title="The flag"></a>The flag</h3><ul>
<li><code>--name</code><br>Specify an app name</li>
<li><code>--watch</code><br>Watch and Restart app when files change</li>
<li><code>--max-memory-restart</code><br>Set memory threshold for app reload</li>
<li><code>--log</code><br>Specify log file</li>
<li><code>--output</code><br>specify out log file</li>
<li><code>--error</code><br>specify error log file</li>
<li><code>--log-date-format</code><br>prefix logs with custom formated timestamp</li>
<li><code>--merge-logs</code><br>when running mutiple process with same app name, do not split file by id</li>
<li><code>--arg1</code> <code>--arg2</code> <code>--arg3</code><br>Pass extra arguments to the script</li>
<li><code>--restart-delay</code><br>Delay between automatic restarts</li>
<li><code>--time</code><br>Prefix logs with time</li>
<li><code>--no-autorestart</code><br>Do not auto restart app</li>
<li><code>--cron</code><br>Specify cron for forced restart</li>
<li><code>--no-daemon</code><br>Attach to application log</li>
</ul>
<h2 id="cluster-mode"><a href="#cluster-mode" class="headerlink" title="cluster mode"></a>cluster mode</h2><ul>
<li>pm2 automatically detect the number of CPU, launching as many processes as possible. The above mentioned flags could be attached on cluster mode. Specify how many process you would like after <code>-i</code>. pm2 would automatically detect max number if you put <code>0</code> or <code>max</code><figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">pm2 start app.js -i max</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="Process-management"><a href="#Process-management" class="headerlink" title="Process management"></a>Process management</h2><ul>
<li><p>Kill the process directly and restart a new process</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">pm2 restart app_name</span><br></pre></td></tr></table></figure></li>
<li><p>If it’s cluster mode, <code>reload</code> would reload process one by one and always keep one alive to achieve 0 downtime upgrade</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">pm2 reload app_name</span><br></pre></td></tr></table></figure></li>
<li><p>Stop the app</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">pm2 stop app_name</span><br></pre></td></tr></table></figure></li>
<li><p>Stop and delete the app</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">pm2 delete app_name</span><br></pre></td></tr></table></figure></li>
<li><p>except for specifying app_name, you could also:<br><code>all</code> : all the Apps<br><code>id</code> : the id of the process</p>
</li>
</ul>
<h2 id="Show-the-status-of-management"><a href="#Show-the-status-of-management" class="headerlink" title="Show the status of management"></a>Show the status of management</h2><figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">pm2 [list|<span class="hljs-built_in">ls</span>|status]</span><br></pre></td></tr></table></figure>
<p><img src="https://i.imgur.com/WIv3pVR.png"></p>
<h2 id="Logs"><a href="#Logs" class="headerlink" title="Logs"></a>Logs</h2><ul>
<li><p>specify filepath to output both out and error logs</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">pm2 logs</span><br></pre></td></tr></table></figure></li>
<li><p>Display X lines of api log file</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">pm2 logs --lines 200</span><br></pre></td></tr></table></figure></li>
<li><p>Show logs at specified App id</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">pm2 logs <span class="hljs-built_in">id</span></span><br></pre></td></tr></table></figure></li>
<li><p>Formatted output</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">pm2 logs --format</span><br></pre></td></tr></table></figure></li>
<li><p>Output logs in json format</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">pm2 logs --json</span><br></pre></td></tr></table></figure></li>
<li><p>Empty all log files</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">pm2 flush</span><br></pre></td></tr></table></figure></li>
<li><p>Cancel logs<br>By specifying log path to <code>dev/null</code>, you could cancel log</p>
</li>
</ul>
<h2 id="Rotated-Log"><a href="#Rotated-Log" class="headerlink" title="Rotated Log"></a>Rotated Log</h2><p>If you’ve ever seen a single extremely big file with years of log, or you’ve ever found thousands of log files in a log folder, or you’ve ever come across weird log file naming, or you found a considerably huge amount consumed after you type <code>du -sh</code> in a folder, congratulations! Here is the solution.</p>
<h3 id="Installation"><a href="#Installation" class="headerlink" title="Installation"></a>Installation</h3><figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">pm2 install pm2-logrotate</span><br></pre></td></tr></table></figure>
<h3 id="Find-the-config-file-at-home-user-pm2-module-conf-json"><a href="#Find-the-config-file-at-home-user-pm2-module-conf-json" class="headerlink" title="Find the config file at /home/user/.pm2/module_conf.json"></a>Find the config file at <code>/home/user/.pm2/module_conf.json</code></h3><h3 id="Parameters"><a href="#Parameters" class="headerlink" title="Parameters"></a>Parameters</h3><ul>
<li>max_size (Defaults to 10M):<br>When a file size becomes higher than this value it will rotate it (its possible that the worker check the file after it actually pass the limit) . You can specify the unit at then end: 10G, 10M, 10K</li>
<li>retain (Defaults to 30 file logs):<br>This number is the number of rotated logs that are keep at any one time, it means that if you have retain = 7 you will have at most 7 rotated logs and your current one.</li>
<li>compress (Defaults to false):<br>Enable compression via gzip for all rotated logs</li>
<li>dateFormat (Defaults to YYYY-MM-DD_HH-mm-ss) :<br>Format of the data used the name the file of log</li>
<li>rotateModule (Defaults to true) :<br>Rotate the log of pm2’s module like other apps</li>
<li>workerInterval (Defaults to 30 in secs) :<br>You can control at which interval the worker is checking the log’s size (minimum is 1)</li>
<li>rotateInterval (Defaults to 0 0 * * * everyday at midnight):<br>This cron is used to a force rotate when executed. We are using node-schedule to schedule cron, so all valid cron for node-schedule is valid cron for this option. Cron style :</li>
<li>TZ (Defaults to system time):<br>This is the standard tz database timezone used to offset the log file saved. For instance, a value of Etc/GMT-1, with an hourly log, will save a file at hour 14 GMT with hour 13 GMT-1 in the log name.</li>
</ul>
<h3 id="Graph"><a href="#Graph" class="headerlink" title="Graph"></a>Graph</h3><figure class="highlight plaintext hljs"><table><tr><td class="code"><pre><span class="line">*    *    *    *    *    *</span><br><span class="line">┬    ┬    ┬    ┬    ┬    ┬</span><br><span class="line">│    │    │    │    │    |</span><br><span class="line">│    │    │    │    │    └ day of week (0 - 7) (0 or 7 is Sun)</span><br><span class="line">│    │    │    │    └───── month (1 - 12)</span><br><span class="line">│    │    │    └────────── day of month (1 - 31)</span><br><span class="line">│    │    └─────────────── hour (0 - 23)</span><br><span class="line">│    └──────────────────── minute (0 - 59)</span><br><span class="line">└───────────────────────── second (0 - 59, OPTIONAL)</span><br></pre></td></tr></table></figure>


<h2 id="Terminal-Based-Dashboard"><a href="#Terminal-Based-Dashboard" class="headerlink" title="Terminal Based Dashboard"></a>Terminal Based Dashboard</h2><figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">pm2 monit</span><br></pre></td></tr></table></figure>

<h2 id="pm2-ecosystem"><a href="#pm2-ecosystem" class="headerlink" title="pm2 ecosystem"></a>pm2 ecosystem</h2><p>CLI tool is good though, typo is so difficult to be eliminated. We could easily solve this problem by carefully crafting our ecosystem file. Except that some configs are meant to be changed in the future, we could eliminate typo issue. Besides, ecosystem cloud be controlled by Version Control System, like Git.</p>
<h3 id="Generate-ecosystem-file"><a href="#Generate-ecosystem-file" class="headerlink" title="Generate ecosystem file"></a>Generate ecosystem file</h3><figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">pm2 ecosystem</span><br></pre></td></tr></table></figure>

<h3 id="CLI"><a href="#CLI" class="headerlink" title="CLI"></a>CLI</h3><p>Same as above mentioned.</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">pm2 start ecosystem.config.js</span><br></pre></td></tr></table></figure>

<h3 id="Start-specific-App-via-ecosystem-file"><a href="#Start-specific-App-via-ecosystem-file" class="headerlink" title="Start specific App via ecosystem file"></a>Start specific App via ecosystem file</h3><p>We could start specific App that we’d crafted in the ecosystem.config.js file.</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">pm2 start ecosystem.config.js --only yourApp</span><br></pre></td></tr></table></figure>

<h3 id="Parameter-injection"><a href="#Parameter-injection" class="headerlink" title="Parameter injection"></a>Parameter injection</h3><p>Take a look on the following example. If I key in <code>pm2 start ecosystem --only app1 --env production</code>, then pm2 wil use the environment within env_production object.</p>
<h3 id="Parameter-example"><a href="#Parameter-example" class="headerlink" title="Parameter example"></a>Parameter example</h3><p>You could find tons of parameters below. Surely we are not going to use all of them, you could take a look on each of them and only leave those you need.</p>
<figure class="highlight js hljs"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="hljs-property">exports</span> = &#123;</span><br><span class="line">    <span class="hljs-attr">apps</span>: [</span><br><span class="line">        <span class="hljs-comment">// First application</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="hljs-comment">// application name (default to script filename without extension)</span></span><br><span class="line">            <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;app1&#x27;</span>,</span><br><span class="line">            <span class="hljs-comment">// script path relative to pm2 start</span></span><br><span class="line">            <span class="hljs-attr">script</span>: <span class="hljs-string">&#x27;./server.js&#x27;</span>,</span><br><span class="line">            <span class="hljs-comment">// the directory from which your app will be launched</span></span><br><span class="line">            <span class="hljs-attr">cwd</span>: <span class="hljs-string">&#x27;var/www/yourApp/&#x27;</span>,</span><br><span class="line">            <span class="hljs-comment">// mode to start your app, can be “cluster” or “fork”, default fork</span></span><br><span class="line">            <span class="hljs-attr">exec_mode</span>: <span class="hljs-string">&#x27;cluster&#x27;</span>,</span><br><span class="line">            <span class="hljs-comment">// number of app instance to be launched</span></span><br><span class="line">            <span class="hljs-attr">instances</span>: <span class="hljs-number">0</span>,</span><br><span class="line">            <span class="hljs-comment">// enable watch &amp; restart feature, if a file change in the folder or subfolder, your app will get reloaded</span></span><br><span class="line">            <span class="hljs-attr">watch</span>: <span class="hljs-literal">false</span>,</span><br><span class="line">            <span class="hljs-comment">// your app will be restarted if it exceeds the amount of memory specified. human-friendly format : it can be “10M”, “100K”, “2G” and so on…</span></span><br><span class="line">            <span class="hljs-attr">max_memory_restart</span>: <span class="hljs-string">&#x27;500M&#x27;</span>,</span><br><span class="line">            <span class="hljs-comment">// interpreter absolute path (default to node)</span></span><br><span class="line">            <span class="hljs-attr">interpreter</span>: <span class="hljs-string">&#x27;/root/.nvm/versions/node/v8.16.0/bin/node&#x27;</span>,</span><br><span class="line">            <span class="hljs-comment">// option to pass to the interpreter</span></span><br><span class="line">            <span class="hljs-attr">interpreter_args</span>: <span class="hljs-string">&quot;port=3001 sitename=&#x27;first pm2 app&#x27;&quot;</span>,</span><br><span class="line">            <span class="hljs-comment">// alias to interpreter_args</span></span><br><span class="line">            <span class="hljs-attr">node_args</span>: <span class="hljs-string">&quot;port=3001 sitename=&#x27;first pm2 app&#x27;&quot;</span>,</span><br><span class="line">            <span class="hljs-comment">// Specify cron for forced restart</span></span><br><span class="line">            <span class="hljs-attr">cron_restart</span>: <span class="hljs-string">&quot;0 17 * * *&quot;</span>,</span><br><span class="line">            <span class="hljs-comment">// Prefix logs with time</span></span><br><span class="line">            <span class="hljs-attr">time</span>: <span class="hljs-literal">true</span>,</span><br><span class="line">            <span class="hljs-comment">// string containing all arguments passed via CLI to script</span></span><br><span class="line">            <span class="hljs-attr">args</span>: <span class="hljs-string">&#x27;-a 13 -b 12&#x27;</span>,</span><br><span class="line">            <span class="hljs-comment">// list of regex to ignore some file or folder names by the watch feature</span></span><br><span class="line">            <span class="hljs-comment">// Format could be array like &quot;args&quot;: [&quot;--toto=heya coco&quot;, &quot;-d&quot;, &quot;1&quot;], or string like &quot;args&quot;: &quot;--to=&#x27;heya coco&#x27; -d 1&quot;</span></span><br><span class="line">            <span class="hljs-attr">ignore_watch</span>: [<span class="hljs-string">&quot;[\/\\]\./&quot;</span>, <span class="hljs-string">&quot;node_modules&quot;</span>],</span><br><span class="line">            <span class="hljs-comment">// default to true, [enable/disable source map file]</span></span><br><span class="line">            <span class="hljs-comment">// http://pm2.keymetrics.io/docs/usage/source-map-support/</span></span><br><span class="line">            <span class="hljs-comment">// https://www.html5rocks.com/en/tutorials/developertools/sourcemaps/</span></span><br><span class="line">            <span class="hljs-attr">source_map_support</span>: <span class="hljs-literal">true</span>,</span><br><span class="line">            <span class="hljs-comment">// instance_var, see documentation</span></span><br><span class="line">            <span class="hljs-comment">// http://pm2.keymetrics.io/docs/usage/environment/#specific-environment-variables</span></span><br><span class="line">            <span class="hljs-attr">instance_var</span>: <span class="hljs-string">&#x27;NODE_APP_INSTANCE&#x27;</span>,</span><br><span class="line">            <span class="hljs-comment">// log date format (see log section)</span></span><br><span class="line">            <span class="hljs-attr">log_date_format</span>: <span class="hljs-string">&#x27;YYYY-MM-DD HH:mm Z&#x27;</span>,</span><br><span class="line">            <span class="hljs-comment">// error file path (default to $HOME/.pm2/logs/XXXerr.log)</span></span><br><span class="line">            <span class="hljs-attr">error_file</span>: <span class="hljs-string">&#x27;/var/log&#x27;</span>,</span><br><span class="line">            <span class="hljs-comment">// output file path (default to $HOME/.pm2/logs/XXXout.log)</span></span><br><span class="line">            <span class="hljs-attr">out_file</span>: <span class="hljs-string">&#x27;/var/log&#x27;</span>,</span><br><span class="line">            <span class="hljs-comment">// if set to true, avoid to suffix logs file with the process id</span></span><br><span class="line">            <span class="hljs-attr">combine_logs</span>: <span class="hljs-literal">true</span>,</span><br><span class="line">            <span class="hljs-comment">// alias to combine_logs</span></span><br><span class="line">            <span class="hljs-attr">merge_logs</span>: <span class="hljs-literal">true</span>,</span><br><span class="line">            <span class="hljs-comment">// pid file path (default to $HOME/.pm2/pid/app-pm_id.pid)</span></span><br><span class="line">            <span class="hljs-attr">pid_file</span>: <span class="hljs-string">&#x27;user/.pm2/pid/app-pm_id.pid&#x27;</span>,</span><br><span class="line">            <span class="hljs-comment">// min uptime of the app to be considered started</span></span><br><span class="line">            <span class="hljs-comment">// format could be number 或 string. In number, 3000 means 3000 ms. If it&#x27;s string, &#x27;1h&#x27; means 1 hour, &#x27;5m&#x27; means 5 minutes, &#x27;10s&#x27; means 10 seconds</span></span><br><span class="line">            <span class="hljs-attr">min_uptime</span>: <span class="hljs-string">&#x27;5&#x27;</span>,</span><br><span class="line">            <span class="hljs-comment">// time in ms before forcing a reload if app not listening</span></span><br><span class="line">            <span class="hljs-attr">listen_timeout</span>: <span class="hljs-number">8000</span>,</span><br><span class="line">            <span class="hljs-comment">// time in milliseconds before sending a final SIGKILL</span></span><br><span class="line">            <span class="hljs-comment">// Refer to official documentation http://pm2.keymetrics.io/docs/usage/signals-clean-restart/</span></span><br><span class="line">            <span class="hljs-attr">kill_timeout</span>: <span class="hljs-number">1600</span>,</span><br><span class="line">            <span class="hljs-comment">// Instead of reload waiting for listen event, wait for process.send(‘ready’)</span></span><br><span class="line">            <span class="hljs-comment">// Refer to documentation http://pm2.keymetrics.io/docs/usage/signals-clean-restart/</span></span><br><span class="line">            <span class="hljs-attr">wait_ready</span>: <span class="hljs-literal">false</span>,</span><br><span class="line">            <span class="hljs-comment">// number of consecutive unstable restarts (less than 1sec interval or custom time via min_uptime) before your app is considered errored and stop being restarted</span></span><br><span class="line">            <span class="hljs-comment">// Refer to documentation http://pm2.keymetrics.io/docs/usage/signals-clean-restart/</span></span><br><span class="line">            <span class="hljs-attr">max_restarts</span>: <span class="hljs-number">10</span>,</span><br><span class="line">            <span class="hljs-comment">// time to wait before restarting a crashed app (in milliseconds). defaults to 0.</span></span><br><span class="line">            <span class="hljs-attr">restart_delay</span>: <span class="hljs-number">4000</span>,</span><br><span class="line">            <span class="hljs-comment">// true by default. if false, PM2 will not restart your app if it crashes or ends peacefully</span></span><br><span class="line">            <span class="hljs-attr">autorestart</span>: <span class="hljs-literal">true</span>,</span><br><span class="line">            <span class="hljs-comment">// true by default. if false, PM2 will start without vizion features (versioning control metadatas)</span></span><br><span class="line">            <span class="hljs-attr">vizion</span>: <span class="hljs-literal">true</span>,</span><br><span class="line">            <span class="hljs-comment">// a list of commands which will be executed after you perform a Pull/Upgrade operation from Keymetrics dashboard</span></span><br><span class="line">            <span class="hljs-attr">post_update</span>: [<span class="hljs-string">&quot;npm install&quot;</span>, <span class="hljs-string">&quot;echo launching the app&quot;</span>],</span><br><span class="line">            <span class="hljs-comment">// defaults to false. if true, you can start the same script several times which is usually not allowed by PM2</span></span><br><span class="line">            <span class="hljs-attr">force</span>: <span class="hljs-literal">false</span>,</span><br><span class="line">            <span class="hljs-comment">// If no environment parameters are passed in, the default env will be within `env` object</span></span><br><span class="line">            <span class="hljs-attr">env</span>: &#123;</span><br><span class="line">                <span class="hljs-attr">COMMON_VARIABLE</span>: <span class="hljs-string">&#x27;true&#x27;</span>,</span><br><span class="line">                <span class="hljs-attr">NODE_ENV</span>: <span class="hljs-string">&#x27;&#x27;</span>,</span><br><span class="line">                <span class="hljs-attr">ID</span>: <span class="hljs-string">&#x27;44&#x27;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="hljs-comment">// If env is specified, env parameter will be within `env_specifiedEnvironment` object, for example, pm2 start ecosystem.js --env production</span></span><br><span class="line">            <span class="hljs-attr">env_production</span>: &#123;</span><br><span class="line">                <span class="hljs-attr">NODE_ENV</span>: <span class="hljs-string">&#x27;production&#x27;</span>,</span><br><span class="line">                <span class="hljs-attr">ID</span>: <span class="hljs-string">&#x27;55&#x27;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="hljs-comment">// Same as above</span></span><br><span class="line">            <span class="hljs-attr">env_development</span>: &#123;</span><br><span class="line">                <span class="hljs-attr">NODE_ENV</span>: <span class="hljs-string">&#x27;development&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="hljs-comment">// Second app, those mentioned above will not be repeated below</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;app2&#x27;</span>,</span><br><span class="line">            <span class="hljs-attr">script</span>: <span class="hljs-string">&#x27;server.js&#x27;</span>,</span><br><span class="line">            <span class="hljs-comment">// Default mode, and it supports other languages as opposed to cluster mode.</span></span><br><span class="line">            <span class="hljs-attr">exec_mode</span>: <span class="hljs-string">&#x27;fork&#x27;</span>,</span><br><span class="line">            <span class="hljs-attr">instances</span>: <span class="hljs-number">0</span>,</span><br><span class="line">            <span class="hljs-attr">watch</span>: <span class="hljs-literal">false</span>,</span><br><span class="line">            <span class="hljs-attr">max_memory_restart</span>: <span class="hljs-string">&#x27;500M&#x27;</span>,</span><br><span class="line">            <span class="hljs-attr">interpreter</span>: <span class="hljs-string">&#x27;/root/.nvm/versions/node/v8.16.0/bin/node&#x27;</span>,</span><br><span class="line">            <span class="hljs-attr">time</span>: <span class="hljs-literal">true</span>,</span><br><span class="line">            <span class="hljs-attr">env</span>: &#123;</span><br><span class="line">                <span class="hljs-attr">COMMON_VARIABLE</span>: <span class="hljs-string">&#x27;true&#x27;</span>,</span><br><span class="line">                <span class="hljs-attr">NODE_ENV</span>: <span class="hljs-string">&#x27;&#x27;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="hljs-attr">env_staging</span>: &#123;</span><br><span class="line">                <span class="hljs-attr">NODE_ENV</span>: <span class="hljs-string">&#x27;staging&#x27;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="hljs-attr">env_test</span>: &#123;</span><br><span class="line">                <span class="hljs-attr">NODE_ENV</span>: <span class="hljs-string">&#x27;test&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="hljs-comment">// Deployment section</span></span><br><span class="line">    <span class="hljs-attr">deploy</span>: &#123;</span><br><span class="line">        <span class="hljs-comment">// production</span></span><br><span class="line">        <span class="hljs-attr">production</span>: &#123;</span><br><span class="line">            <span class="hljs-comment">// SSH user</span></span><br><span class="line">            <span class="hljs-attr">user</span>: <span class="hljs-string">&#x27;root&#x27;</span>,</span><br><span class="line">            <span class="hljs-comment">// SSH host</span></span><br><span class="line">            <span class="hljs-attr">host</span>: [<span class="hljs-string">&#x27;host1&#x27;</span>, <span class="hljs-string">&#x27;host2&#x27;</span>],</span><br><span class="line">            <span class="hljs-comment">// SSH key path</span></span><br><span class="line">            <span class="hljs-attr">key</span>: <span class="hljs-string">&#x27;path/to/some.pem&#x27;</span>,</span><br><span class="line">            <span class="hljs-comment">// GIT remote/branch</span></span><br><span class="line">            <span class="hljs-attr">ref</span>: <span class="hljs-string">&#x27;origin/master&#x27;</span>,</span><br><span class="line">            <span class="hljs-comment">// GIT remote</span></span><br><span class="line">            <span class="hljs-attr">repo</span>: <span class="hljs-string">&#x27;git@gitlab.com:user/yourProject.git&#x27;</span>,</span><br><span class="line">            <span class="hljs-comment">// path in the server</span></span><br><span class="line">            <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/var/www/yourProjectName&#x27;</span>,</span><br><span class="line">            <span class="hljs-comment">// Can be used to give options in the format used in the </span></span><br><span class="line">            <span class="hljs-comment">// configuration file. </span></span><br><span class="line">            <span class="hljs-comment">// This is useful for specifying options for which there </span></span><br><span class="line">            <span class="hljs-comment">// is no separate command-line flag, see &#x27;man ssh&#x27; can be</span></span><br><span class="line">            <span class="hljs-comment">// either a single string or an array of strings</span></span><br><span class="line">            <span class="hljs-string">&quot;ssh_options&quot;</span>: <span class="hljs-string">&quot;StrictHostKeyChecking=no&quot;</span>,</span><br><span class="line">            <span class="hljs-comment">// 在 pm2 要從 local 端連到 remote 端之前要執行的指令，可以多個指令，由 ; 分割，也可以指定 shell script 的檔案路徑</span></span><br><span class="line">            <span class="hljs-string">&quot;pre-setup&quot;</span>: <span class="hljs-string">&#x27;apt update -y; apt install git -y&#x27;</span>,</span><br><span class="line">            <span class="hljs-comment">// To prepare the host by installing required software (eg: git)</span></span><br><span class="line">            <span class="hljs-comment">// even before the setup process starts</span></span><br><span class="line">            <span class="hljs-comment">// can be multiple commands separated by the character &quot;;&quot;</span></span><br><span class="line">            <span class="hljs-comment">// or path to a script on your local machine</span></span><br><span class="line">            <span class="hljs-string">&quot;post-setup&quot;</span>: <span class="hljs-string">&quot;ls -la&quot;</span>,</span><br><span class="line">            <span class="hljs-comment">// Commands to execute locally (on the same machine you deploy things)</span></span><br><span class="line">            <span class="hljs-comment">// Can be multiple commands separated by the character &quot;;&quot;</span></span><br><span class="line">            <span class="hljs-string">&quot;pre-deploy-local&quot;</span> : <span class="hljs-string">&quot;echo &#x27;This is a local executed command&#x27;&quot;</span>,</span><br><span class="line">            <span class="hljs-comment">// Commands to be executed on the server after the repo has been cloned</span></span><br><span class="line">            <span class="hljs-string">&#x27;post-deploy&#x27;</span>: <span class="hljs-string">&#x27;sudo /root/.nvm/versions/node/v8.16.0/bin/npm install &amp;&amp; sudo /root/.nvm/versions/node/v8.16.0/bin/npm rebuild &amp;&amp; /root/.nvm/versions/node/v8.16.0/bin/pm2 reload ecosystem.config.js&#x27;</span>,</span><br><span class="line">            <span class="hljs-comment">// Environment variables that must be injected in all applications on this env</span></span><br><span class="line">            <span class="hljs-attr">env_production</span>: &#123;</span><br><span class="line">                 <span class="hljs-attr">NODE_ENV</span>: <span class="hljs-string">&#x27;production&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, </span><br><span class="line">        <span class="hljs-attr">staging</span>: &#123;</span><br><span class="line">            <span class="hljs-attr">user</span>: <span class="hljs-string">&#x27;root&#x27;</span>,</span><br><span class="line">            <span class="hljs-attr">host</span>: [<span class="hljs-string">&#x27;host3&#x27;</span>, <span class="hljs-string">&#x27;host4&#x27;</span>],</span><br><span class="line">            <span class="hljs-attr">ref</span>: <span class="hljs-string">&#x27;origin/staging&#x27;</span>,</span><br><span class="line">            <span class="hljs-attr">repo</span>: <span class="hljs-string">&#x27;git@gitlab.com:user/yourProject.git&#x27;</span>,</span><br><span class="line">            <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/var/www/yourProjectName&#x27;</span>,</span><br><span class="line">            <span class="hljs-string">&quot;ssh_options&quot;</span>: <span class="hljs-string">&quot;StrictHostKeyChecking=no&quot;</span>,</span><br><span class="line">            <span class="hljs-string">&quot;pre-setup&quot;</span>: <span class="hljs-string">&#x27;apt update -y; apt install git -y&#x27;</span>,</span><br><span class="line">            <span class="hljs-string">&quot;post-setup&quot;</span>: <span class="hljs-string">&quot;ls -la&quot;</span>,</span><br><span class="line">            <span class="hljs-string">&quot;pre-deploy-local&quot;</span> : <span class="hljs-string">&quot;echo &#x27;This is a local executed command&#x27;&quot;</span>,</span><br><span class="line">            <span class="hljs-string">&#x27;post-deploy&#x27;</span>: <span class="hljs-string">&#x27;sudo /root/.nvm/versions/node/v8.16.0/bin/npm install &amp;&amp; sudo /root/.nvm/versions/node/v8.16.0/bin/npm rebuild &amp;&amp; /root/.nvm/versions/node/v8.16.0/bin/pm2 reload ecosystem.config.js&#x27;</span>,</span><br><span class="line">            <span class="hljs-attr">env_production</span>: &#123;</span><br><span class="line">                 <span class="hljs-attr">NODE_ENV</span>: <span class="hljs-string">&#x27;staging&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="pm2-Deployment"><a href="#pm2-Deployment" class="headerlink" title="pm2 Deployment"></a>pm2 Deployment</h2><p>pm2 Deployment supports multiple server deployment, also, which could integrate with CI / CD tool, automatically deploy after submitting a commit.</p>
<h3 id="Prerequisite"><a href="#Prerequisite" class="headerlink" title="Prerequisite"></a>Prerequisite</h3><ul>
<li>Firstly, have you prepared the ssh key for local to remote? <code>The connection between local and remote is required.</code> Simply speaking, you need to put a private key locally, and put public key remotely. You could Google how to set up ssh key.</li>
<li>Secondly, since pm2 will ssh to remote server, and then clone our project from either GitHub or Gitlab. So make sure that <code>cloning from Git Repository to remote server is feasible.</code> You will need to put a private key on your remote server, and the public key on Git Repository. Please also Google how to set up the key on GitHub or GitLab</li>
<li>Since the first time we connect to remote server, ssh would prompt to ask if it’s okay to put the public key of remote server to local known host, we will need to config it in advance. Otherwise, the deployment would fail. We could cancel the hostKeyChecking feature.<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-built_in">echo</span> -e <span class="hljs-string">&quot;Host *\n\tStrictHostKeyChecking no\n\n&quot;</span> &gt; ~/.ssh/config</span><br></pre></td></tr></table></figure></li>
<li>And then, we need to properly craft ecosystem file, let’s refer to the deploy example above.</li>
<li>Finally, make sure ssh tunnel is not blocked (default port 22)</li>
</ul>
<h3 id="Initialise-remote-folder"><a href="#Initialise-remote-folder" class="headerlink" title="Initialise remote folder"></a>Initialise remote folder</h3><p>Before deploying, we need to set up the project on remote server. We could pass different parameters and pm2 would deploy accordingly.</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">pm2 deploy ecosystem.config.js production setup</span><br></pre></td></tr></table></figure>

<h3 id="Deploy"><a href="#Deploy" class="headerlink" title="Deploy"></a>Deploy</h3><ul>
<li>Deploy<br>After initially setting up our project on remote server, we could start to deploy.<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">pm2 deploy ecosystem.config.js production</span><br></pre></td></tr></table></figure></li>
<li>Here I’ve listed some parameters as follows, and you could also check details by <code>pm2 deploy help</code></li>
</ul>
<figure class="highlight plaintext hljs"><table><tr><td class="code"><pre><span class="line">pm2 deploy &lt;configuration_file&gt; &lt;environment&gt; &lt;command&gt;</span><br><span class="line"></span><br><span class="line">  Commands:</span><br><span class="line">    setup                run remote setup commands</span><br><span class="line">    update               update deploy to the latest release</span><br><span class="line">    revert [n]           revert to [n]th last deployment or 1</span><br><span class="line">    curr[ent]            output current release commit</span><br><span class="line">    prev[ious]           output previous release commit</span><br><span class="line">    exec|run &lt;cmd&gt;       execute the given &lt;cmd&gt;</span><br><span class="line">    list                 list previous deploy commits</span><br><span class="line">    [ref]                deploy to [ref], the &quot;ref&quot; setting, or latest tag</span><br></pre></td></tr></table></figure>
<ul>
<li><p>Relative commands of Deployment</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">pm2 startOrRestart all.json            <span class="hljs-comment"># Invoke restart on all apps in JSON</span></span><br><span class="line">pm2 startOrReload all.json             <span class="hljs-comment"># Invoke reload</span></span><br></pre></td></tr></table></figure></li>
<li><p>Force deployment<br>That means that you have changes in your local system that aren’t pushed inside your git repository, and since the deploy script get the update via git pull they will not be on your server. If you want to deploy without pushing any data, you can append the –force option:</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">pm2 deploy ecosystem.json production --force</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="CI-CD-Deployment"><a href="#CI-CD-Deployment" class="headerlink" title="CI / CD Deployment"></a>CI / CD Deployment</h2><ul>
<li>Implement deployment by integrating pm2 with GitLab CI / CD Runner, and here is the gitlab.yml example below:</li>
</ul>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-comment"># Use small-size image</span></span><br><span class="line">image: keymetrics/pm2:latest-alpine</span><br><span class="line">stages:</span><br><span class="line">- deploy</span><br><span class="line"></span><br><span class="line">Deploy:</span><br><span class="line">  stage: deploy</span><br><span class="line">  script:</span><br><span class="line">  <span class="hljs-comment"># If ssh-agent hasn&#x27;t been installed, install it.</span></span><br><span class="line">  - <span class="hljs-string">&#x27;which ssh-agent || ( apk add --update openssh )&#x27;</span></span><br><span class="line">  <span class="hljs-comment"># Install bash for pm2 CLI</span></span><br><span class="line">  - apk add --update bash</span><br><span class="line">  <span class="hljs-comment"># Install Git for connecting to remote server with pm2</span></span><br><span class="line">  - apk add --update git</span><br><span class="line">  <span class="hljs-comment"># Implement ssh agent</span></span><br><span class="line">  - <span class="hljs-built_in">eval</span> $(ssh-agent -s)</span><br><span class="line">  <span class="hljs-comment"># Add ssh key to ssh agent. You could config the public key as GitLab&#x27;s variable.</span></span><br><span class="line">  - <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$SSH_PRIVATE_KEY</span>&quot;</span> | ssh-add -</span><br><span class="line">  <span class="hljs-comment"># Execute pm2 CLI</span></span><br><span class="line">  - pm2 deploy ecosystem.config.js production update</span><br><span class="line">  </span><br><span class="line">  only:</span><br><span class="line">  - master</span><br></pre></td></tr></table></figure>
<ul>
<li>If you set it properly, a simple git push would trigger the CI / CD deployment</li>
</ul>
<h2 id="Auto-start-after-reboot"><a href="#Auto-start-after-reboot" class="headerlink" title="Auto start after reboot"></a>Auto start after reboot</h2><ul>
<li><p>Generate startup script</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">pm2 startup</span><br></pre></td></tr></table></figure></li>
<li><p>Cancel startup script</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">pm2 unstartup</span><br></pre></td></tr></table></figure></li>
<li><p>Save the current process for next default startup</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">pm2 save</span><br></pre></td></tr></table></figure></li>
<li><p>如果有更新 node 的版本，記得更新 script</p>
</li>
<li><p>If you upgrade your node, udpate your script as well</p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">pm2 unstartup &amp;&amp; pm2 startup &amp;&amp; pm2 save</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="Reload-after-when-content-changes"><a href="#Reload-after-when-content-changes" class="headerlink" title="Reload after when content changes"></a>Reload after when content changes</h2><p>Monitor files under the project folder and subfolder, and ignore <code>node_module</code></p>
<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line"><span class="hljs-built_in">cd</span> /path/to/my/app</span><br><span class="line">pm2 start env.js --watch --ignore-watch=<span class="hljs-string">&quot;node_modules&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="update-pm2"><a href="#update-pm2" class="headerlink" title="update pm2"></a>update pm2</h2><figure class="highlight plaintext hljs"><table><tr><td class="code"><pre><span class="line">npm install pm2@latest -g &amp;&amp; pm2 update</span><br></pre></td></tr></table></figure>

<h2 id="pm2-cheat-sheet"><a href="#pm2-cheat-sheet" class="headerlink" title="pm2 cheat sheet"></a>pm2 cheat sheet</h2><figure class="highlight plaintext hljs"><table><tr><td class="code"><pre><span class="line"># Fork mode</span><br><span class="line">pm2 start app.js --name my-api # Name process</span><br><span class="line"></span><br><span class="line"># Cluster mode</span><br><span class="line">pm2 start app.js -i 0        # Will start maximum processes with LB depending on available CPUs</span><br><span class="line">pm2 start app.js -i max      # Same as above, but deprecated.</span><br><span class="line">pm2 scale app +3             # Scales `app` up by 3 workers</span><br><span class="line">pm2 scale app 2              # Scales `app` up or down to 2 workers total</span><br><span class="line"></span><br><span class="line"># Listing</span><br><span class="line"></span><br><span class="line">pm2 list               # Display all processes status</span><br><span class="line">pm2 jlist              # Print process list in raw JSON</span><br><span class="line">pm2 prettylist         # Print process list in beautified JSON</span><br><span class="line"></span><br><span class="line">pm2 describe 0         # Display all informations about a specific process</span><br><span class="line"></span><br><span class="line">pm2 monit              # Monitor all processes</span><br><span class="line"></span><br><span class="line"># Logs</span><br><span class="line"></span><br><span class="line">pm2 logs [--raw]       # Display all processes logs in streaming</span><br><span class="line">pm2 flush              # Empty all log files</span><br><span class="line">pm2 reloadLogs         # Reload all logs</span><br><span class="line"></span><br><span class="line"># Actions</span><br><span class="line"></span><br><span class="line">pm2 stop all           # Stop all processes</span><br><span class="line">pm2 restart all        # Restart all processes</span><br><span class="line"></span><br><span class="line">pm2 reload all         # Will 0s downtime reload (for NETWORKED apps)</span><br><span class="line"></span><br><span class="line">pm2 stop 0             # Stop specific process id</span><br><span class="line">pm2 restart 0          # Restart specific process id</span><br><span class="line"></span><br><span class="line">pm2 delete 0           # Will remove process from pm2 list</span><br><span class="line">pm2 delete all         # Will remove all processes from pm2 list</span><br><span class="line"></span><br><span class="line"># Misc</span><br><span class="line"></span><br><span class="line">pm2 reset &lt;process&gt;    # Reset meta data (restarted time...)</span><br><span class="line">pm2 updatePM2          # Update in memory pm2</span><br><span class="line">pm2 ping               # Ensure pm2 daemon has been launched</span><br><span class="line">pm2 sendSignal SIGUSR2 my-app # Send system signal to script</span><br><span class="line">pm2 start app.js --no-daemon # Do not run in the background</span><br><span class="line">pm2 start app.js --no-vizion # By default, as well as ssh key is okay, pm2 would compare local and remote when restarting, and automatically pull the latest.</span><br><span class="line">pm2 start app.js --no-autorestart # Do not auto restart</span><br></pre></td></tr></table></figure>

<h2 id="Auto-completion"><a href="#Auto-completion" class="headerlink" title="Auto completion"></a>Auto completion</h2><ul>
<li>pm2 command support auto completion<figure class="highlight bash hljs"><table><tr><td class="code"><pre><span class="line">pm2 completion install</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="疑難雜症"><a href="#疑難雜症" class="headerlink" title="疑難雜症"></a>疑難雜症</h2><ul>
<li>Encounter <code>Error: ENOENT: no such file or directory, uv_cwd</code><ul>
<li>Refer <a target="_blank" rel="noopener" href="https://github.com/Unitech/pm2/issues/2057">here</a><h2 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h2><a target="_blank" rel="noopener" href="http://pm2.keymetrics.io/">pm2 官網</a><br><a target="_blank" rel="noopener" href="https://github.com/keymetrics/pm2-logrotate">pm2 logrotate</a></li>
</ul>
</li>
</ul>

    
    </div>
    
    <div class="columns is-variable is-1 is-multiline is-mobile">
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/tags/pm2/">#pm2</a></span>
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/tags/GitLab-CI-CD/">#GitLab CI / CD</a></span>
    
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop  article-nav-prev">
            
            <a href="/ftpServer/">Build a FTP Server on GCP VM with vsftpd</a>
            
        </span>
        <span class="column is-12-mobile is-half-desktop  article-nav-next">
            
            <a href="/ssh/">My learning note on SSH</a>
            
        </span>
    </div>
    
</article>


<div class="sharebox">
    
<div class="sharethis-inline-share-buttons"></div>
<script type='text/javascript' src='//platform-api.sharethis.com/js/sharethis.js#property=5c72643b9ea706001139fd89&amp;product=inline-share-buttons' async='async'></script>

</div>



<div class="comments">
    <h3 class="title is-4">Comments</h3>
    
<script>
    var disqus_config = function () {
        this.page.url = 'https://tn710617.github.io/pm2/';
        this.page.identifier = 'pm2/';
        
        this.language = 'en';
        
    };
    (function() {
        var d = document, s = d.createElement('script');  
        s.src = '//' + 'rayscodingjourney' + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>

<div id="disqus_thread">
    
    <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</div>

    </div>
</section>
    <footer class="footer">
    <div class="container">
        <div class="columns content">
            <div class="column is-narrow has-text-centered">
                &copy; 2022 Ray&nbsp;
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a
                        target="_blank" rel="noopener" href="http://github.com/ppoffice/hexo-theme-minos">Minos</a>
            </div>
            <div class="column is-hidden-mobile"></div>

            <script src='https://unpkg.com/mermaid@7.1.2/dist/mermaid.min.js'></script>
            <script>
                mermaid.initialize({ theme: 'default' });
            </script>

            
            
            <a class="navbar-item" title="GitHub" target="_blank" rel="noopener" href="https://github.com/tn710617">
                
                    <i class="fab fa-github"></i>
                
            </a>
            
            <a class="navbar-item" title="Medium" target="_blank" rel="noopener" href="https://medium.com/@raycodingjourney">
                
                    <i class="fab fa-medium"></i>
                
            </a>
            
            <a class="navbar-item" title="Linkedin" target="_blank" rel="noopener" href="https://www.linkedin.com/in/ray-lee-99315315a">
                
                    <i class="fab fa-linkedin"></i>
                
            </a>
            
            <a class="navbar-item" title="Facebook" target="_blank" rel="noopener" href="https://www.facebook.com/profile.php?id=100001626039430">
                
                    <i class="fab fa-facebook"></i>
                
            </a>
            
            <a class="navbar-item" title="CakeResume" target="_blank" rel="noopener" href="https://www.cakeresume.com/resumes/ray-6edaef/edit">
                
                    <i class="far fa-address-card"></i>
                
            </a>
            
            <a class="navbar-item" title="E-Mail" href="mailto:tn710617@gmail.com">
                
                    <i class="far fa-envelope"></i>
                
            </a>
            
            <a class="navbar-item" title="Skype" href="skype:adad0310?call|chat">
                
                    <i class="fab fa-skype"></i>
                
            </a>
            
            

        </div>
    </div>
</footer>

    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script>

<!-- test if the browser is outdated -->
<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" target="_blank" rel="noopener" href="http://outdatedbrowser.com/">Update my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.js"></script>
<script>
    $(document).ready(function () {
        // plugin function, place inside DOM ready function
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        })
    });
</script>

<script>
    window.FontAwesomeConfig = {
        searchPseudoElements: true
    }
    moment.locale("en-AU");
</script>


    
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<script>
    MathJax.Hub.Config({
        "HTML-CSS": {matchFontHeight: false},
        SVG: {matchFontHeight: false},
        CommonHTML: {matchFontHeight: false}
    });
</script>

    
    
    
    
<script src="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/js/lightgallery-all.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/justifiedGallery/3.6.5/js/jquery.justifiedGallery.min.js"></script>
<script>
    (function ($) {
        $(document).ready(function () {
            if (typeof($.fn.lightGallery) === 'function') {
                $('.article.gallery').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof($.fn.justifiedGallery) === 'function') {
                $('.justified-gallery').justifiedGallery();
            }
        });
    })(jQuery);
</script>

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <style>
        .hljs {
            position: relative;
        }

        .hljs .clipboard-btn {
            float: right;
            color: #9a9a9a;
            background: none;
            border: none;
            cursor: pointer;
        }

        .hljs .clipboard-btn:hover {
          color: #8a8a8a;
        }

        .hljs > .clipboard-btn {
            display: none;
            position: absolute;
            right: 4px;
            top: 4px;
        }

        .hljs:hover > .clipboard-btn {
            display: inline;
        }

        .hljs > figcaption > .clipboard-btn {
            margin-right: 4px;
        }
    </style>
    <script>
      $(document).ready(function () {
        $('figure.hljs').each(function(i, figure) {
          var codeId = 'code-' + i;
          var code = figure.querySelector('.code');
          var copyButton = $('<button>Copy <i class="far fa-clipboard"></i></button>');
          code.id = codeId;
          copyButton.addClass('clipboard-btn');
          copyButton.attr('data-clipboard-target-id', codeId);

          var figcaption = figure.querySelector('figcaption');

          if (figcaption) {
            figcaption.append(copyButton[0]);
          } else {
            figure.prepend(copyButton[0]);
          }
        })

        var clipboard = new ClipboardJS('.clipboard-btn', {
          target: function(trigger) {
            return document.getElementById(trigger.getAttribute('data-clipboard-target-id'));
          }
        });
        clipboard.on('success', function(e) {
          e.clearSelection();
        })
      })
    </script>

    
    

    



<script src="/js/script.js"></script>


    
    <div class="searchbox ins-search">
    <div class="searchbox-mask"></div>
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="Type something..." />
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: 'Posts',
                PAGES: 'Pages',
                CATEGORIES: 'Categories',
                TAGS: 'Tags',
                UNTITLED: '(Untitled)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>

<script src="/js/insight.js"></script>

    
</body>
</html>